<!DOCTYPE html>
<html lang="en">
<!--
  ════════════════════════════════════════════════════════════════════════════
  SAMARTHAAMED - EMAIL SETUP INSTRUCTIONS
  ════════════════════════════════════════════════════════════════════════════
  
  To enable REAL email sending, follow these steps:
  
  STEP 1: Create EmailJS Account (FREE)
  ────────────────────────────────────────
  1. Go to: https://www.emailjs.com/
  2. Click "Sign Up" (free tier: 200 emails/month)
  3. Verify your email address
  
  STEP 2: Add Email Service
  ────────────────────────────────────────
  1. Go to: https://dashboard.emailjs.com/admin/integration
  2. Click "Add New Service"
  3. Select "Gmail" 
  4. Connect your Gmail: govardhangn@gmail.com
  5. Copy the Service ID (e.g., "service_abc123")
  
  STEP 3: Create Email Templates
  ────────────────────────────────────────
  Create TWO templates:
  
  Template 1 - Confirmation Email (for applicants):
  ─────────────────────────────────────────────────
  1. Go to: https://dashboard.emailjs.com/admin/templates
  2. Click "Create New Template"
  3. Name: "SamarthaaMed - Request Confirmation"
  4. Template ID: "template_confirmation"
  5. Content:
  
     Subject: Access Request Received - {{request_id}}
     
     To: {{to_email}}
     From: govardhangn@gmail.com
     Reply-To: {{reply_to}}
     
     Body (HTML):
     <h2>Access Request Received</h2>
     <p>Dear {{applicant_name}},</p>
     <p>Thank you for your interest in SamarthaaMed. We have received your access request.</p>
     
     <h3>Request Details:</h3>
     <ul>
       <li>Request ID: {{request_id}}</li>
       <li>Name: {{applicant_name}}</li>
       <li>Email: {{applicant_email}}</li>
       <li>Institution: {{institution}}</li>
       <li>Specialty: {{specialty}}</li>
       <li>Submitted: {{submitted_date}}</li>
     </ul>
     
     <p><strong>What's Next?</strong></p>
     <ol>
       <li>Review: 24-48 hours</li>
       <li>Verification of credentials</li>
       <li>Invitation code (if approved)</li>
     </ol>
     
     <p>Questions? Contact: {{support_email}}</p>
  
  Template 2 - Admin Notification:
  ─────────────────────────────────────────────────
  1. Create another template
  2. Name: "SamarthaaMed - New Access Request"
  3. Template ID: "template_admin"
  4. Content:
  
     Subject: New Access Request - {{applicant_name}}
     
     To: govardhangn@gmail.com
     From: govardhangn@gmail.com
     
     Body (HTML):
     <h2>New Access Request</h2>
     
     <h3>Applicant Information:</h3>
     <ul>
       <li>Request ID: {{request_id}}</li>
       <li>Name: {{applicant_name}}</li>
       <li>Email: {{applicant_email}}</li>
       <li>Institution: {{institution}}</li>
       <li>Specialty: {{specialty}}</li>
       <li>Submitted: {{submitted_date}}</li>
     </ul>
     
     <h3>Reason for Access:</h3>
     <p>{{reason}}</p>
     
     <p><strong>Action Required:</strong> Review and approve/reject this request.</p>
  
  STEP 4: Get Your Public Key
  ────────────────────────────────────────
  1. Go to: https://dashboard.emailjs.com/admin/account
  2. Copy your "Public Key" (looks like: abc123XYZ...)
  
  STEP 5: Update This File
  ────────────────────────────────────────
  1. Search for: EMAILJS_CONFIG
  2. Replace values:
     - serviceID: 'service_abc123'  (from Step 2)
     - templateID_confirmation: 'template_confirmation'  (from Step 3)
     - templateID_admin: 'template_admin'  (from Step 3)
     - publicKey: 'YOUR_PUBLIC_KEY_HERE'  (from Step 4)
  
  STEP 6: Test
  ────────────────────────────────────────
  1. Open the website
  2. Click "Request Access"
  3. Fill the form
  4. Submit
  5. Check both emails:
     - Applicant should receive confirmation
     - govardhangn@gmail.com should receive notification
  
  ════════════════════════════════════════════════════════════════════════════
  ALTERNATIVE: Use Backend Email Service
  ════════════════════════════════════════════════════════════════════════════
  
  For production with high volume, consider:
  - SendGrid (12,000 emails/month free)
  - AWS SES (62,000 emails/month free)
  - Mailgun (5,000 emails/month free)
  
  See implementation examples in the sendConfirmationEmail() function comments.
  
  ════════════════════════════════════════════════════════════════════════════
-->
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SamarthaaMed — Clinical Intelligence Platform</title>
<!-- EmailJS — browser-side email sending (no backend required) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>

  :root {
    /* Brick Red & White Color Scheme */
    --navy: #ffffff;           /* White background */
    --navy2: #fef7f7;          /* Light cream white */
    --navy3: #fef2f2;          /* Very light red tint */
    --panel: #ffffff;          /* White panels */
    --panel2: #fef7f7;         /* Light panels */
    --border: #fecaca;         /* Light brick-red border */
    --border2: #fca5a5;        /* Medium brick-red border */
    --teal: #b91c1c;           /* Brick red (primary) */
    --teal2: #dc2626;          /* Brighter brick red */
    --teal-dim: rgba(185,28,28,0.08);   /* Brick red transparent */
    --teal-glow: rgba(185,28,28,0.15);  /* Brick red glow */
    --cyan: #991b1b;           /* Dark brick red */
    --gold: #f59e0b;           /* Keep gold for warnings */
    --gold-dim: rgba(245,158,11,0.12);
    --red: #dc2626;            /* Error red */
    --red-dim: rgba(220,38,38,0.1);
    --green: #059669;          /* Keep green for success */
    --green-dim: rgba(5,150,105,0.1);
    --purple: #a78bfa;         /* Keep purple for accents */
    --text1: #1f2937;          /* Dark text on white */
    --text2: #4b5563;          /* Medium dark text */
    --text3: #6b7280;          /* Gray text */
    --syne: 'Syne', sans-serif;
    --dm: 'DM Sans', sans-serif;
    --mono: 'DM Mono', monospace;
    --radius: 12px;
    --radius2: 8px;
    --shadow: 0 8px 32px rgba(185,28,28,0.15);      /* Brick red shadow */
    --shadow2: 0 2px 12px rgba(185,28,28,0.1);      /* Light brick red shadow */
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 14px; }
  body {
    font-family: var(--dm);
    background: var(--navy);
    color: var(--text1);
    height: 100vh;
    overflow: hidden;
  }
  html { height: 100vh; overflow: hidden; }
  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--navy); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* ── LAYOUT ── */
  .app { 
    display: grid; 
    grid-template-columns: 240px 1fr;
    grid-template-rows: 58px 1fr;
    height: 100vh; 
    overflow: hidden; 
  }

  /* ── SIDEBAR ── */
  .sidebar {
    grid-column: 1;
    grid-row: 1 / 3;
    width: 240px; 
    min-width: 240px;
    background: var(--navy2);
    border-right: 1px solid var(--border);
    display: flex; 
    flex-direction: column;
    transition: all .3s ease;
    position: relative; 
    z-index: 10;
  }
  .sidebar-logo {
    padding: 22px 20px 18px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .logo-icon {
    width: 34px; height: 34px; border-radius: 10px;
    background: linear-gradient(135deg, var(--teal), #0096A0);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
    box-shadow: 0 0 20px var(--teal-glow);
  }
  .logo-text { font-family: var(--syne); font-weight: 800; font-size: 1.15rem; color: var(--text1); }
  .logo-sub { font-size: 0.65rem; color: var(--teal); letter-spacing: 1.5px; text-transform: uppercase; font-weight: 500; }

  .sidebar-nav { flex: 1; padding: 14px 10px; overflow-y: auto; }
  .nav-section { margin-bottom: 20px; }
  .nav-label { font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase; color: var(--text3); padding: 0 10px 8px; font-weight: 600; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 10px; border-radius: var(--radius2);
    cursor: pointer; transition: all .2s;
    color: var(--text2); font-size: 0.88rem; font-weight: 500;
    margin-bottom: 2px; position: relative;
  }
  .nav-item:hover { background: var(--teal-dim); color: var(--text1); }
  .nav-item.active { background: var(--teal-dim); color: var(--teal); }
  .nav-item.active::before {
    content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
    width: 3px; height: 60%; background: var(--teal); border-radius: 2px;
  }
  .nav-icon { font-size: 1.1rem; width: 20px; text-align: center; flex-shrink: 0; }
  .nav-badge {
    margin-left: auto; background: var(--red); color: #fff;
    font-size: 0.65rem; padding: 1px 6px; border-radius: 20px; font-weight: 600;
  }
  .nav-badge.green { background: var(--green); color: var(--navy); }

  .sidebar-footer {
    padding: 14px; border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .avatar {
    width: 34px; height: 34px; border-radius: 50%;
    background: linear-gradient(135deg, #3B82F6, #7C3AED);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.8rem; font-weight: 700; color: #fff; flex-shrink: 0;
  }
  .avatar-info { flex: 1; min-width: 0; }
  .avatar-name { font-size: 0.82rem; font-weight: 600; color: var(--text1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .avatar-role { font-size: 0.68rem; color: var(--text3); }
  .online-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); flex-shrink: 0; box-shadow: 0 0 8px var(--green); }

  /* ── MAIN ── */
  .main { 
    grid-column: 2;
    grid-row: 1 / 3;
    display: flex; 
    flex-direction: column; 
    overflow: hidden;
    height: 100vh;
  }

  /* ── TOPBAR ── */
  .topbar {
    height: 58px; background: var(--navy2);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 22px; gap: 14px;
    flex-shrink: 0;
  }
  .topbar-title { font-family: var(--syne); font-size: 1.05rem; font-weight: 700; color: var(--text1); }
  .topbar-subtitle { font-size: 0.78rem; color: var(--text3); margin-top: 1px; }
  .topbar-spacer { flex: 1; }
  .search-bar {
    display: flex; align-items: center; gap: 8px;
    background: var(--navy3); border: 1px solid var(--border2);
    border-radius: 8px; padding: 7px 12px; width: 240px;
    transition: border-color .2s;
  }
  .search-bar:focus-within { border-color: var(--teal); }
  .search-bar input { background: none; border: none; outline: none; color: var(--text1); font-family: var(--dm); font-size: 0.83rem; flex: 1; }
  .search-bar input::placeholder { color: var(--text3); }
  .search-bar span { color: var(--text3); font-size: 0.85rem; }
  .icon-btn {
    width: 36px; height: 36px; border-radius: 8px;
    background: var(--navy3); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all .2s; font-size: 1rem;
    color: var(--text2); position: relative;
  }
  .icon-btn:hover { border-color: var(--teal); color: var(--teal); }
  .icon-btn .dot { position: absolute; top: 4px; right: 4px; width: 7px; height: 7px; border-radius: 50%; background: var(--red); border: 1.5px solid var(--navy2); }

  /* ── CONTENT AREA ── */
  .content { flex: 1; overflow-y: auto; display: block; min-height: 0; padding-bottom: 32px; }
  .view { display: none; animation: fadeIn .25s ease; }
  .view.active { display: block; }
  .view.active.flex-view { display: flex; }
  #view-radiology { overflow-y: auto; max-height: 100%; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

  /* ── DASHBOARD VIEW ── */
  .dashboard { padding: 22px; }

  /* Stat cards */
  .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 22px; }
  .stat-card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 18px 16px;
    position: relative; overflow: hidden; cursor: pointer;
    transition: border-color .2s, transform .2s;
  }
  .stat-card:hover { border-color: var(--teal); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,212,180,0.15); }
  .stat-card::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: var(--accent-color, var(--teal));
    opacity: 0.6;
  }
  .stat-card .icon { font-size: 1.4rem; margin-bottom: 10px; }
  .stat-card .value { font-family: var(--syne); font-size: 1.8rem; font-weight: 800; color: var(--text1); line-height: 1; }
  .stat-card .label { font-size: 0.78rem; color: var(--text3); margin-top: 4px; font-weight: 500; }
  .stat-card .change { font-size: 0.72rem; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
  .change.up { color: var(--green); }
  .change.down { color: var(--red); }
  .change.neutral { color: var(--text3); }

  /* Main grid */
  .grid-2 { display: grid; grid-template-columns: 1fr 380px; gap: 16px; margin-bottom: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

  .card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
  }
  .card-header {
    padding: 14px 18px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-title { font-family: var(--syne); font-size: 0.88rem; font-weight: 700; color: var(--text1); display: flex; align-items: center; gap: 8px; }
  .card-
  .card-action { font-size: 0.75rem; color: var(--teal); cursor: pointer; font-weight: 500; }
  .card-action:hover { text-decoration: underline; }

  /* Patient queue */
  .patient-row {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 0; border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background .15s; border-radius: 6px;
    padding: 9px 10px; margin: 0 -10px;
  }
  .patient-row:last-child { border-bottom: none; }
  .patient-row:hover { background: var(--teal-dim); }
  .patient-avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; color: #fff; flex-shrink: 0; }
  .patient-name { font-size: 0.85rem; font-weight: 600; color: var(--text1); }
  .patient-meta { font-size: 0.72rem; color: var(--text3); margin-top: 1px; }
  .patient-status { margin-left: auto; }
  .status-badge {
    font-size: 0.65rem; font-weight: 600; padding: 3px 9px; border-radius: 20px;
    letter-spacing: 0.3px; text-transform: uppercase;
  }
  .status-badge.urgent { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,77,109,0.2); }
  .status-badge.waiting { background: var(--gold-dim); color: var(--gold); border: 1px solid rgba(245,166,35,0.2); }
  .status-badge.stable { background: var(--green-dim); color: var(--green); border: 1px solid rgba(34,211,166,0.2); }
  .status-badge.active { background: var(--teal-dim); color: var(--teal); border: 1px solid rgba(0,212,180,0.2); }

  /* Risk panel */
  .risk-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .risk-item:last-child { border-bottom: none; }
  .risk-name { font-size: 0.83rem; font-weight: 500; color: var(--text1); flex: 1; }
  .risk-score { font-family: var(--mono); font-size: 0.82rem; font-weight: 500; min-width: 40px; text-align: right; }
  .risk-bar-wrap { width: 80px; height: 4px; background: var(--border2); border-radius: 2px; overflow: hidden; }
  .risk-bar { height: 100%; border-radius: 2px; transition: width 1s ease; }

  /* Alert items */
  .alert-item {
    display: flex; gap: 10px; padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .alert-item:last-child { border-bottom: none; }
  .alert-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 4px; flex-shrink: 0; }
  .alert-text { font-size: 0.8rem; color: var(--text2); line-height: 1.4; }
  .alert-time { font-size: 0.68rem; color: var(--text3); margin-top: 3px; }

  /* Vital mini cards */
  .vitals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .vital-card {
    background: var(--navy3); border: 1px solid var(--border2);
    border-radius: 8px; padding: 10px 12px;
  }
  .vital-label { font-size: 0.68rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px; }
  .vital-value { font-family: var(--mono); font-size: 1.1rem; font-weight: 500; color: var(--text1); }
  .vital-unit { font-size: 0.65rem; color: var(--text3); margin-left: 2px; }
  .vital-trend { font-size: 0.68rem; margin-top: 3px; }

  /* Chart area (sparkline placeholder) */
  .chart-area { height: 120px; position: relative; overflow: hidden; }
  .chart-svg { width: 100%; height: 100%; }

  /* ── AI CONSULTATION VIEW ── */
  .consult-layout {
    display: grid;
    grid-template-columns: 300px 1fr 280px;
    overflow: hidden;
    height: calc(100vh - 108px); /* topbar 58px + switcher bar ~50px */
  }

  /* Left panel */
  .consult-left { border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
  .consult-left-header { padding: 14px 16px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .consult-patient-info { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .consult-patient-avatar { width: 42px; height: 42px; border-radius: 12px; background: linear-gradient(135deg, #EF4444, #DC2626); display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: 700; color: #fff; flex-shrink: 0; }
  .consult-patient-name { font-family: var(--syne); font-size: 0.95rem; font-weight: 700; color: var(--text1); }
  .consult-patient-meta { font-size: 0.72rem; color: var(--text3); margin-top: 2px; }
  .vital-row { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
  .vital-mini { background: var(--navy3); border: 1px solid var(--border2); border-radius: 6px; padding: 6px 10px; }
  .vital-mini .vlabel { font-size: 0.6rem; color: var(--text3); letter-spacing: 0.8px; text-transform: uppercase; }
  .vital-mini .vval { font-family: var(--mono); font-size: 0.9rem; color: var(--text1); margin-top: 2px; }
  .consult-left-
  .symptom-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
  .tag { background: var(--teal-dim); border: 1px solid rgba(0,212,180,0.25); color: var(--teal); font-size: 0.7rem; font-weight: 500; padding: 3px 9px; border-radius: 20px; cursor: default; }
  .tag.red { background: var(--red-dim); border-color: rgba(255,77,109,0.25); color: var(--red); }
  .tag.gold { background: var(--gold-dim); border-color: rgba(245,166,35,0.25); color: var(--gold); }

  /* Center — AI Chat */
  .consult-center { display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 14px; }

  .msg { display: flex; gap: 10px; max-width: 90%; animation: msgIn .25s ease; }
  @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
  .msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg-avatar { width: 28px; height: 28px; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.68rem; font-weight: 700; }
  .msg.ai .msg-avatar { background: linear-gradient(135deg, var(--teal), #0096A0); color: var(--navy); }
  .msg.user .msg-avatar { background: linear-gradient(135deg, #3B82F6, #7C3AED); color: #fff; }
  .msg-bubble { padding: 10px 13px; border-radius: 12px; font-size: 0.82rem; line-height: 1.55; color: var(--text1); }
  .msg.ai .msg-bubble { background: var(--panel2); border: 1px solid var(--border2); border-top-left-radius: 4px; }
  .msg.user .msg-bubble { background: linear-gradient(135deg, rgba(0,212,180,0.15), rgba(0,150,160,0.15)); border: 1px solid rgba(0,212,180,0.25); border-top-right-radius: 4px; }
  .msg-time { font-size: 0.63rem; color: var(--text3); margin-top: 4px; }

  /* Differential card */
  .diff-card { background: var(--navy3); border: 1px solid var(--border2); border-radius: 10px; padding: 12px; margin-top: 8px; }
  .diff-title { font-family: var(--syne); font-size: 0.8rem; font-weight: 700; color: var(--teal); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .diff-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border); }
  .diff-item:last-child { border-bottom: none; }
  .diff-rank { font-family: var(--mono); font-size: 0.68rem; color: var(--text3); width: 16px; flex-shrink: 0; }
  .diff-name { font-size: 0.8rem; font-weight: 500; color: var(--text1); flex: 1; }
  .diff-icd { font-family: var(--mono); font-size: 0.65rem; color: var(--text3); }
  .confidence-wrap { display: flex; align-items: center; gap: 6px; }
  .conf-bar { width: 50px; height: 4px; background: var(--border2); border-radius: 3px; overflow: hidden; flex-shrink: 0; }
  .conf-fill { height: 100%; border-radius: 3px; }
  .conf-pct { font-family: var(--mono); font-size: 0.7rem; font-weight: 500; min-width: 30px; text-align: right; }

  .warning-box { background: var(--red-dim); border: 1px solid rgba(255,77,109,0.2); border-radius: 8px; padding: 9px 11px; margin-top: 8px; display: flex; gap: 8px; align-items: flex-start; }
  .warning-box .icon { font-size: 0.85rem; flex-shrink: 0; margin-top: 1px; }
  .warning-box .text { font-size: 0.76rem; color: var(--red); font-weight: 500; line-height: 1.4; }

  /* Chat input — pinned to bottom of center column */
  .chat-input-area { padding: 12px 16px 14px; border-top: 1px solid var(--border); background: var(--navy2); flex-shrink: 0; }
  .chat-input-row {
    display: flex; gap: 8px; align-items: flex-end;
    background: var(--panel2); border: 1px solid var(--border2);
    border-radius: 10px; padding: 8px 10px; transition: border-color .2s;
  }
  .chat-input-row:focus-within { border-color: var(--teal); }
  .chat-input-row textarea {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text1); font-family: var(--dm); font-size: 0.83rem;
    resize: none; line-height: 1.5; max-height: 80px; min-height: 20px;
  }
  .chat-input-row textarea::placeholder { color: var(--text3); }
  .send-btn {
    width: 32px; height: 32px; border-radius: 8px; background: var(--teal);
    border: none; cursor: pointer; display: flex; align-items: center;
    justify-content: center; font-size: 0.9rem; transition: all .2s;
    flex-shrink: 0; color: var(--navy);
  }
  .send-btn:hover { background: var(--teal2); transform: scale(1.05); }

  /* Tool buttons row */
  .chat-tools {
    display: flex; gap: 5px; margin-top: 8px;
    flex-wrap: wrap; align-items: center;
  }
  .chat-tool-btn {
    font-size: 0.7rem; color: var(--text3); background: var(--navy3);
    border: 1px solid var(--border); border-radius: 14px;
    padding: 4px 9px; cursor: pointer; transition: all .15s;
    white-space: nowrap; line-height: 1.4;
    display: inline-flex; align-items: center; gap: 4px;
    user-select: none;
  }
  .chat-tool-btn:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-dim); }
  .chat-tool-btn:active { transform: scale(0.97); }

  /* Right panel */
  .consult-right { border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
  .consult-right-tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .r-tab { flex: 1; padding: 11px 6px; text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text3); cursor: pointer; transition: all .2s; border-bottom: 2px solid transparent; }
  .r-tab:hover { color: var(--text1); }
  .r-tab.active { color: var(--teal); border-bottom-color: var(--teal); background: var(--teal-dim); }
  .consult-right-

  .rx-item {
    background: var(--navy3); border: 1px solid var(--border2);
    border-radius: 8px; padding: 12px; margin-bottom: 10px;
  }
  .rx-drug { font-size: 0.88rem; font-weight: 600; color: var(--text1); margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
  .rx-generic { font-size: 0.72rem; color: var(--teal); }
  .rx-dose { font-family: var(--mono); font-size: 0.78rem; color: var(--text2); margin: 4px 0; }
  .rx-duration { font-size: 0.72rem; color: var(--text3); display: flex; align-items: center; gap: 4px; }
  .rx-warning { font-size: 0.7rem; color: var(--gold); background: var(--gold-dim); border: 1px solid rgba(245,166,35,0.2); border-radius: 5px; padding: 4px 8px; margin-top: 6px; display: flex; align-items: center; gap: 5px; }

  .add-rx-btn {
    width: 100%; padding: 9px; border-radius: 8px;
    background: var(--teal-dim); border: 1px dashed rgba(0,212,180,0.4);
    color: var(--teal); font-size: 0.78rem; font-weight: 600;
    cursor: pointer; transition: all .2s; display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .add-rx-btn:hover { background: rgba(0,212,180,0.15); }

  /* Lab results panel */
  .lab-item { padding: 9px 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
  .lab-item:last-child { border-bottom: none; }
  .lab-name { font-size: 0.8rem; color: var(--text2); flex: 1; }
  .lab-val { font-family: var(--mono); font-size: 0.82rem; font-weight: 500; }
  .lab-ref { font-size: 0.68rem; color: var(--text3); }
  .lab-val.high { color: var(--red); }
  .lab-val.low { color: var(--cyan); }
  .lab-val.normal { color: var(--green); }

  /* ── PATIENTS VIEW ── */
  .patients-view { padding: 22px; }
  .table-wrap { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .table-header {
    padding: 14px 18px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; gap: 14px;
  }
  .filter-row { display: flex; gap: 8px; }
  .filter-btn {
    font-size: 0.75rem; padding: 6px 14px; border-radius: 20px;
    border: 1px solid var(--border2); background: none;
    color: var(--text3); cursor: pointer; transition: all .2s; font-family: var(--dm);
  }
  .filter-btn.active, .filter-btn:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-dim); }

  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { padding: 10px 18px; text-align: left; font-size: 0.72rem; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--border); background: var(--navy3); }
  .data-table td { padding: 12px 18px; font-size: 0.82rem; color: var(--text2); border-bottom: 1px solid var(--border); vertical-align: middle; }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: var(--teal-dim); }
  .data-table .td-name { font-weight: 600; color: var(--text1); }
  .data-table .td-id { font-family: var(--mono); font-size: 0.72rem; color: var(--text3); }

  .action-btn {
    font-size: 0.72rem; padding: 5px 12px; border-radius: 6px;
    border: 1px solid var(--border2); background: none;
    color: var(--teal); cursor: pointer; transition: all .2s;
    font-family: var(--dm); font-weight: 500;
  }
  .action-btn:hover { background: var(--teal-dim); border-color: var(--teal); }

  /* ── RISK PREDICTION VIEW ── */
  .risk-view { padding: 22px; }
  .risk-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
  .risk-model-card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 20px; position: relative; overflow: hidden;
    cursor: pointer; transition: all .2s;
  }
  .risk-model-card:hover { border-color: var(--border2); transform: translateY(-2px); }
  .risk-model-card .bg-orb {
    position: absolute; width: 120px; height: 120px; border-radius: 50%;
    top: -30px; right: -30px; opacity: 0.07;
  }
  .risk-model-title { font-family: var(--syne); font-size: 1rem; font-weight: 700; color: var(--text1); margin-bottom: 6px; }
  .risk-model-accuracy { font-family: var(--mono); font-size: 2rem; font-weight: 400; line-height: 1; margin: 10px 0; }
  .risk-model-desc { font-size: 0.75rem; color: var(--text3); line-height: 1.5; }
  .risk-model-features { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 5px; }
  .feature-tag { background: var(--navy3); border: 1px solid var(--border2); color: var(--text3); font-size: 0.65rem; padding: 3px 7px; border-radius: 4px; }

  /* Gauge chart */
  .gauge-wrap { text-align: center; padding: 20px 0; }
  .gauge-svg { width: 160px; height: 100px; }
  .gauge-value { font-family: var(--syne); font-size: 1.8rem; font-weight: 800; }
  .gauge-label { font-size: 0.72rem; color: var(--text3); }

  /* ── BUTTONS ── */
  .btn {
    padding: 8px 18px; border-radius: 8px;
    font-family: var(--dm); font-size: 0.82rem; font-weight: 600;
    cursor: pointer; transition: all .2s; display: inline-flex; align-items: center; gap: 7px;
    border: none;
  }
  .btn-primary { background: var(--teal); color: var(--navy); }
  .btn-primary:hover { background: var(--teal2); transform: translateY(-1px); box-shadow: 0 4px 16px var(--teal-glow); }
  .btn-ghost { background: none; border: 1px solid var(--border2); color: var(--text2); }
  .btn-ghost:hover { border-color: var(--teal); color: var(--teal); }
  .btn-sm { padding: 5px 12px; font-size: 0.75rem; }

  /* ── SPECIALIZATIONS ── */
  .spec-view { padding: 22px; }
  .spec-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .spec-card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 14px;
    cursor: pointer; transition: all .2s; text-align: center;
  }
  .spec-card:hover { border-color: var(--teal); background: var(--teal-dim); transform: translateY(-2px); }
  .spec-card .spec-icon { font-size: 1.6rem; margin-bottom: 8px; }
  .spec-card .spec-name { font-size: 0.78rem; font-weight: 600; color: var(--text2); line-height: 1.3; }
  .spec-card .spec-cases { font-size: 0.65rem; color: var(--text3); margin-top: 4px; }
  .spec-card.active { border-color: var(--teal); background: var(--teal-dim); }
  .spec-card.active .spec-name { color: var(--teal); }

  /* ── TYPING INDICATOR ── */
  .typing { display: flex; align-items: center; gap: 3px; padding: 8px 12px; }
  .typing-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--teal); animation: blink 1.2s infinite; }
  .typing-dot:nth-child(2) { animation-delay: .2s; }
  .typing-dot:nth-child(3) { animation-delay: .4s; }
  @keyframes blink { 0%,80%,100% { opacity: 0.2; } 40% { opacity: 1; } }

  /* ── MISC ── */
  .section-title { font-family: var(--syne); font-size: 1rem; font-weight: 700; color: var(--text1); margin-bottom: 4px; }
  .section-sub { font-size: 0.78rem; color: var(--text3); margin-bottom: 18px; }
  .divider { height: 1px; background: var(--border); margin: 14px 0; }
  .pill { font-size: 0.65rem; font-weight: 600; padding: 2px 8px; border-radius: 20px; display: inline-flex; align-items: center; gap: 4px; }
  .pill.teal { background: var(--teal-dim); color: var(--teal); border: 1px solid rgba(0,212,180,0.2); }
  .pill.gold { background: var(--gold-dim); color: var(--gold); border: 1px solid rgba(245,166,35,0.2); }
  .pill.red { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,77,109,0.2); }
  .pill.purple { background: rgba(167,139,250,0.1); color: var(--purple); border: 1px solid rgba(167,139,250,0.2); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--text3); }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 12px; }
  .empty-state .text { font-size: 0.85rem; }

  /* Pulse animation for live indicator */
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(255,77,109,0.4); } 50% { box-shadow: 0 0 0 5px rgba(255,77,109,0); } }

  .teal-glow { box-shadow: 0 0 20px var(--teal-glow); }

  /* Scrollable tab content */
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Mini header bar with icon */
  .mini-header { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
  .mini-header-icon { width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
  .mini-header-title { font-size: 0.85rem; font-weight: 700; color: var(--text1); }
  .mini-header-sub { font-size: 0.7rem; color: var(--text3); }

  /* Progress ring */
  .progress-ring { transform: rotate(-90deg); }
  .progress-ring-bg { fill: none; stroke: var(--border2); stroke-width: 6; }
  .progress-ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 1.5s ease; }

  /* ── LAB RESULTS ── */
  .lab-view { padding: 22px; }
  .lab-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap:wrap; }
  .lab-tab { padding: 8px 18px; border-radius: 20px; font-size:0.8rem; font-weight:600; cursor:pointer; border:1px solid var(--border2); color:var(--text3); background:none; transition:all .2s; font-family:var(--dm); }
  .lab-tab.active { background:var(--teal-dim); color:var(--teal); border-color:rgba(0,212,180,0.3); }
  .lab-panel { display:none; } .lab-panel.active { display:block; }
  .lab-cards-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
  .lab-entry-card { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; cursor:pointer; transition:all .2s; position:relative; overflow:hidden; }
  .lab-entry-card:hover { border-color:var(--border2); transform:translateY(-2px); }
  .lab-entry-card .lec-name { font-size:0.72rem; color:var(--text3); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
  .lab-entry-card .lec-val { font-family:var(--mono); font-size:1.5rem; font-weight:600; line-height:1; }
  .lab-entry-card .lec-unit { font-size:0.68rem; color:var(--text3); margin-top:3px; }
  .lab-entry-card .lec-ref { font-size:0.68rem; margin-top:8px; color:var(--text3); }
  .lab-entry-card .lec-flag { position:absolute; top:10px; right:10px; font-size:0.62rem; font-weight:700; padding:2px 7px; border-radius:10px; }
  .lec-flag.H { background:var(--red-dim); color:var(--red); border:1px solid rgba(255,77,109,0.2); }
  .lec-flag.L { background:rgba(56,189,248,0.1); color:var(--cyan); border:1px solid rgba(56,189,248,0.2); }
  .lec-flag.N { background:var(--green-dim); color:var(--green); border:1px solid rgba(34,211,166,0.2); }
  .lab-input-row { display:grid; grid-template-columns:2fr 1.2fr 1fr 1fr; gap:8px; align-items:center; padding:10px 0; border-bottom:1px solid var(--border); }
  .lab-input-row:last-child { border-bottom:none; }
  .lab-name-col { font-size:0.82rem; color:var(--text2); }
  .lab-ref-col { font-size:0.72rem; color:var(--text3); }
  .lab-val-input { background:var(--navy3); border:1px solid var(--border2); border-radius:6px; padding:7px 10px; color:var(--text1); font-family:var(--mono); font-size:0.85rem; width:100%; outline:none; transition:border-color .2s; }
  .lab-val-input:focus { border-color:var(--teal); }
  .lab-val-input.abnormal-h { border-color:rgba(255,77,109,0.5); background:var(--red-dim); }
  .lab-val-input.abnormal-l { border-color:rgba(56,189,248,0.5); background:rgba(56,189,248,0.05); }

  /* ── IMAGING AI ── */
  .imaging-view { padding:22px; overflow-y:auto; }
  .imaging-grid { display:grid; grid-template-columns:1fr 380px; gap:18px; align-items:start; }
  .upload-zone { border:2px dashed var(--border2); border-radius:var(--radius); padding:60px 24px; text-align:center; cursor:pointer; transition:all .2s; background:var(--panel); }
  .upload-zone:hover, .upload-zone.drag { border-color:var(--teal); background:var(--teal-dim); }
  .upload-zone.has-image { padding:0; border-style:solid; border-color:var(--teal); }
  .upload-zone.has-image img { width:100%; max-height:420px; object-fit:contain; display:block; border-radius:calc(var(--radius) - 2px); background:var(--navy3); }
  .upload-icon { font-size:3rem; margin-bottom:12px; opacity:0.4; }
  .upload-title { font-family:var(--syne); font-size:1rem; font-weight:700; color:var(--text2); margin-bottom:6px; }
  .upload-sub { font-size:0.78rem; color:var(--text3); }
  .scan-type-bar { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
  .scan-type-btn { background:var(--panel); border:1px solid var(--border2); border-radius:8px; padding:10px 14px; text-align:center; cursor:pointer; transition:all .2s; display:flex; align-items:center; gap:8px; }
  .scan-type-btn:hover, .scan-type-btn.active { border-color:var(--teal); background:var(--teal-dim); }
  .scan-type-btn .s-icon { font-size:1.1rem; }
  .scan-type-btn .s-name { font-size:0.78rem; font-weight:600; color:var(--text2); }
  .scan-type-btn.active .s-name { color:var(--teal); }
  .imaging-result-panel { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; display:flex; flex-direction:column; }
  .imaging-result-header { padding:14px 18px; border-bottom:1px solid var(--border); background:var(--navy3); flex-shrink:0; }
  .imaging-result-
  .finding-item { background:var(--navy3); border:1px solid var(--border2); border-radius:8px; padding:12px; margin-bottom:10px; }
  .finding-title { font-size:0.82rem; font-weight:700; color:var(--text1); margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; }
  .finding-desc { font-size:0.77rem; color:var(--text2); line-height:1.5; }
  .finding-conf { font-family:var(--mono); font-size:0.72rem; padding:2px 8px; border-radius:4px; }
  .conf-high { background:var(--red-dim); color:var(--red); }
  .conf-med { background:var(--gold-dim); color:var(--gold); }
  .conf-low { background:var(--green-dim); color:var(--green); }
  .analyzing-anim { flex-direction:column; align-items:center; padding:50px 20px; gap:14px; }
  .pulse-ring { width:60px; height:60px; border-radius:50%; border:3px solid var(--teal); animation:pulseRing 1.5s ease-in-out infinite; box-shadow:0 0 0 10px rgba(0,212,180,0.1); }
  @keyframes pulseRing { 0%,100%{transform:scale(1);opacity:1;box-shadow:0 0 0 0 rgba(0,212,180,0.3)} 50%{transform:scale(1.2);opacity:0.6;box-shadow:0 0 0 16px rgba(0,212,180,0)} }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── ANALYTICS ── */
  .analytics-view { padding:22px; }
  .kpi-strip { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-bottom:18px; }
  .kpi-card { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px 14px; text-align:center; transition:all .2s; cursor:pointer; }
  .kpi-card:hover { border-color:var(--border2); transform:translateY(-2px); }
  .kpi-num { font-family:var(--syne); font-size:1.6rem; font-weight:800; line-height:1; }
  .kpi-lbl { font-size:0.7rem; color:var(--text3); margin-top:5px; }
  .kpi-chg { font-size:0.68rem; margin-top:4px; }
  .analytics-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
  .analytics-grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px; }
  .chart-card { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
  .chart-card-body { padding: 14px 18px; }
  .chart-card-header { padding:14px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .chart-card-title  { font-size:0.88rem; font-weight:600; color:var(--text1); }
  .bar-chart { display:flex; align-items:flex-end; gap:3px; height:130px; overflow:hidden; padding:4px 0; }
  .bar-col { flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; height:100%; justify-content:flex-end; }
  .bar { width:100%; border-radius:4px 4px 0 0; min-height:4px; cursor:pointer; transition:filter .15s; }
  .bar:hover { filter:brightness(1.3); }
  .bar-label { font-size:0.6rem; color:var(--text3); text-align:center; white-space:nowrap; }
  .bar-val { font-family:var(--mono); font-size:0.62rem; color:var(--text2); }
  .donut-wrap { display:flex; align-items:center; gap:18px; }
  .donut-legend { display:flex; flex-direction:column; gap:8px; flex:1; }
  .donut-legend-item { display:flex; align-items:center; gap:8px; font-size:0.78rem; color:var(--text2); }
  .donut-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
  .donut-pct { margin-left:auto; font-family:var(--mono); font-size:0.78rem; font-weight:600; color:var(--text1); }
  .sparkline-row { display:flex; align-items:center; gap:12px; padding:9px 0; border-bottom:1px solid var(--border); }
  .sparkline-row:last-child { border-bottom:none; }
  .sparkline-name { font-size:0.8rem; color:var(--text2); flex:1; }
  .sparkline-val { font-family:var(--mono); font-size:0.88rem; font-weight:600; min-width:50px; text-align:right; }

  /* ── SETTINGS ── */
  .settings-view { padding:22px; max-width:820px; }
  .settings-section { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:16px; overflow:hidden; }
  .settings-section-header { padding:14px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
  .settings-section-title { font-family:var(--syne); font-size:0.88rem; font-weight:700; color:var(--text1); }
  .settings-row { display:flex; align-items:center; justify-content:space-between; padding:13px 18px; border-bottom:1px solid var(--border); }
  .settings-row:last-child { border-bottom:none; }
  .settings-row-label { font-size:0.84rem; color:var(--text2); }
  .settings-row-sub { font-size:0.72rem; color:var(--text3); margin-top:2px; }
  .toggle { width:40px; height:22px; border-radius:11px; cursor:pointer; transition:all .3s; flex-shrink:0; position:relative; border:none; }
  .toggle.on { background:var(--teal); }
  .toggle.off { background:var(--border2); }
  .toggle::after { content:''; position:absolute; top:3px; width:16px; height:16px; border-radius:50%; background:#fff; transition:left .3s; }
  .toggle.on::after { left:21px; }
  .toggle.off::after { left:3px; }

  /* ── ENHANCED PRESCRIPTION ── */
  .drug-search-wrap { position:relative; }
  .drug-search-results { position:absolute; top:100%; left:0; right:0; background:var(--panel2); border:1px solid var(--border2); border-radius:8px; z-index:200; max-height:220px; overflow-y:auto; box-shadow:var(--shadow); display:none; margin-top:4px; }
  .drug-search-results.show { display:block; }
  .drug-result-item { padding:10px 14px; cursor:pointer; transition:background .15s; border-bottom:1px solid var(--border); }
  .drug-result-item:last-child { border-bottom:none; }
  .drug-result-item:hover { background:var(--teal-dim); }
  .drug-result-name { font-size:0.85rem; font-weight:600; color:var(--text1); }
  .drug-result-meta { font-size:0.72rem; color:var(--text3); margin-top:2px; }
  .drug-result-generic { font-size:0.7rem; color:var(--teal); margin-top:1px; }
  .rx-card { background:var(--panel2); border:1px solid var(--border2); border-radius:10px; padding:14px; margin-bottom:10px; animation:fadeIn .25s ease; }
  .rx-card-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:10px; }
  .rx-card-name { font-size:0.92rem; font-weight:700; color:var(--text1); }
  .rx-card-generic { font-size:0.72rem; color:var(--teal); margin-top:2px; }
  .rx-card-remove { background:none; border:none; color:var(--text3); cursor:pointer; font-size:1rem; padding:2px; transition:color .15s; }
  .rx-card-remove:hover { color:var(--red); }
  .rx-dose-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:8px; }
  .rx-field-wrap { display:flex; flex-direction:column; gap:4px; }
  .rx-field-label { font-size:0.62rem; text-transform:uppercase; letter-spacing:0.8px; color:var(--text3); font-weight:600; }
  .rx-field-input, .rx-field-select { background:var(--navy3); border:1px solid var(--border2); border-radius:6px; padding:6px 10px; color:var(--text1); font-family:var(--dm); font-size:0.8rem; outline:none; width:100%; transition:border-color .2s; }
  .rx-field-input:focus, .rx-field-select:focus { border-color:var(--teal); }

  /* ── SOAP NOTE MODAL ── */
  .soap-modal { position:fixed; inset:0; z-index:1100; background:rgba(5,10,20,0.9); backdrop-filter:blur(6px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity .25s; }
  .soap-modal.open { opacity:1; pointer-events:all; }
  .soap-box { background:var(--navy2); border:1px solid var(--border2); border-radius:16px; width:680px; max-width:calc(100vw - 40px); max-height:80vh; overflow-y:auto; box-shadow:0 24px 80px rgba(0,0,0,0.6); transform:translateY(20px); transition:transform .28s cubic-bezier(.34,1.2,.64,1); padding:24px; }
  .soap-modal.open .soap-box { transform:none; }
  .soap-section { margin-bottom:18px; }
  .soap-label { font-family:var(--syne); font-size:0.75rem; font-weight:700; color:var(--teal); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
  .soap-text { font-size:0.83rem; color:var(--text2); line-height:1.7; background:var(--navy3); border:1px solid var(--border2); border-radius:8px; padding:12px 14px; white-space:pre-line; }

  /* Patient switcher in consult */
  .patient-switcher { display:flex; gap:8px; padding:10px 18px; border-bottom:1px solid var(--border); background:var(--navy3); overflow-x:auto; flex-shrink:0; }
  .patient-chip { display:flex; align-items:center; gap:7px; background:var(--panel2); border:1px solid var(--border2); border-radius:20px; padding:5px 12px 5px 7px; cursor:pointer; transition:all .2s; white-space:nowrap; flex-shrink:0; }
  .patient-chip:hover { border-color:var(--teal); }
  .patient-chip.active { border-color:var(--teal); background:var(--teal-dim); }
  .patient-chip-avatar { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.6rem; font-weight:700; color:#fff; }
  .patient-chip-name { font-size:0.75rem; font-weight:600; color:var(--text2); }
  .patient-chip.active .patient-chip-name { color:var(--teal); }

  /* ── MODAL ── */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 1000;
    background: rgba(5, 10, 20, 0.85);
    backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity .25s ease;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--navy2);
    border: 1px solid var(--border2);
    border-radius: 16px;
    width: 720px; max-width: calc(100vw - 40px);
    max-height: calc(100vh - 60px);
    display: flex; flex-direction: column;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
    transform: translateY(20px) scale(0.97);
    transition: transform .28s cubic-bezier(.34,1.2,.64,1);
    overflow: hidden;
  }
  .modal-overlay.open .modal { transform: none; }

  .modal-header {
    padding: 20px 24px 18px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: flex-start; justify-content: space-between;
    flex-shrink: 0;
  }
  .modal-title { font-family: var(--syne); font-size: 1.1rem; font-weight: 800; color: var(--text1); }
  .modal-subtitle { font-size: 0.75rem; color: var(--text3); margin-top: 3px; }
  .modal-close {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border2);
    background: none; cursor: pointer; font-size: 1rem; color: var(--text3);
    display: flex; align-items: center; justify-content: center;
    transition: all .15s; flex-shrink: 0;
  }
  .modal-close:hover { background: var(--red-dim); border-color: var(--red); color: var(--red); }

  /* Step indicator */
  .modal-steps {
    display: flex; align-items: center; padding: 14px 24px;
    border-bottom: 1px solid var(--border);
    gap: 0; flex-shrink: 0;
  }
  .step-item {
    display: flex; align-items: center; gap: 8px; flex: 1;
    cursor: pointer;
  }
  .step-num {
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.72rem; font-weight: 700; flex-shrink: 0;
    border: 2px solid var(--border2); color: var(--text3);
    background: var(--navy3); transition: all .3s;
  }
  .step-item.active .step-num { border-color: var(--teal); color: var(--teal); background: var(--teal-dim); }
  .step-item.done .step-num { border-color: var(--green); background: var(--green); color: var(--navy); }
  .step-label { font-size: 0.75rem; font-weight: 600; color: var(--text3); transition: color .3s; white-space: nowrap; }
  .step-item.active .step-label { color: var(--teal); }
  .step-item.done .step-label { color: var(--green); }
  .step-connector { flex: 1; height: 1px; background: var(--border2); margin: 0 6px; max-width: 40px; }

  /* Modal body */
  .modal-

  /* Step panels */
  .step-panel { display: none; animation: fadeIn .2s ease; }
  .step-panel.active { display: block; }

  /* Form elements */
  .form-grid { display: grid; gap: 14px; }
  .form-grid-2 { grid-template-columns: 1fr 1fr; }
  .form-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.span-2 { grid-column: span 2; }
  .form-group.span-3 { grid-column: span 3; }
  .form-label {
    font-size: 0.72rem; font-weight: 600; color: var(--text3);
    text-transform: uppercase; letter-spacing: 0.6px;
    display: flex; align-items: center; gap: 5px;
  }
  .form-label .req { color: var(--red); }
  .form-input, .form-select, .form-textarea {
    background: var(--navy3); border: 1px solid var(--border2);
    border-radius: 8px; padding: 9px 12px;
    color: var(--text1); font-family: var(--dm); font-size: 0.85rem;
    transition: border-color .2s, box-shadow .2s;
    outline: none; width: 100%;
  }
  .form-input::placeholder, .form-textarea::placeholder { color: var(--text3); }
  .form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(0,212,180,0.1);
  }
  .form-input.error { border-color: var(--red); box-shadow: 0 0 0 3px rgba(255,77,109,0.1); }
  .form-select { appearance: none; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235A7090' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
  .form-select option { background: var(--navy2); color: var(--text1); }
  .form-textarea { resize: vertical; min-height: 72px; line-height: 1.5; }
  .form-error { font-size: 0.7rem; color: var(--red); display: none; margin-top: 2px; }
  .form-error.show { display: block; }
  .form-hint { font-size: 0.7rem; color: var(--text3); margin-top: 2px; }

  /* Tag input for conditions/medications */
  .tag-input-wrap {
    background: var(--navy3); border: 1px solid var(--border2);
    border-radius: 8px; padding: 7px 10px;
    display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
    min-height: 42px; cursor: text; transition: border-color .2s;
  }
  .tag-input-wrap:focus-within { border-color: var(--teal); box-shadow: 0 0 0 3px rgba(0,212,180,0.1); }
  .tag-input-wrap .ti { background: var(--teal-dim); border: 1px solid rgba(0,212,180,0.2); color: var(--teal); font-size: 0.72rem; padding: 3px 8px; border-radius: 20px; display: flex; align-items: center; gap: 5px; }
  .tag-input-wrap .ti.med { background: var(--gold-dim); border-color: rgba(245,166,35,0.2); color: var(--gold); }
  .tag-input-wrap .ti.allergy { background: var(--red-dim); border-color: rgba(255,77,109,0.2); color: var(--red); }
  .tag-input-wrap .ti-x { cursor: pointer; font-size: 0.75rem; opacity: 0.7; }
  .tag-input-wrap .ti-x:hover { opacity: 1; }
  .tag-input-wrap input { background: none; border: none; outline: none; color: var(--text1); font-family: var(--dm); font-size: 0.82rem; flex: 1; min-width: 100px; }

  /* Section divider in form */
  .form-section-title {
    font-family: var(--syne); font-size: 0.82rem; font-weight: 700;
    color: var(--text2); margin-bottom: 12px; margin-top: 4px;
    display: flex; align-items: center; gap: 8px;
  }
  .form-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* Radio group */
  .radio-group { display: flex; gap: 8px; }
  .radio-opt {
    flex: 1; border: 1px solid var(--border2); border-radius: 8px;
    padding: 8px 12px; cursor: pointer; transition: all .2s;
    display: flex; align-items: center; gap: 8px; font-size: 0.82rem; color: var(--text2);
    background: var(--navy3);
  }
  .radio-opt:hover { border-color: var(--teal); color: var(--text1); }
  .radio-opt.selected { border-color: var(--teal); background: var(--teal-dim); color: var(--teal); font-weight: 600; }
  .radio-opt input { display: none; }

  /* Vital input row */
  .vital-input-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
  .vital-input-box { background: var(--navy3); border: 1px solid var(--border2); border-radius: 8px; padding: 10px 12px; }
  .vital-input-box .vlbl { font-size: 0.62rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
  .vital-input-box input { background: none; border: none; outline: none; color: var(--text1); font-family: var(--mono); font-size: 1rem; font-weight: 500; width: 100%; }
  .vital-input-box .vunit { font-size: 0.65rem; color: var(--text3); margin-top: 3px; }

  /* Summary card on step 4 */
  .summary-card {
    background: var(--navy3); border: 1px solid var(--border2);
    border-radius: 10px; padding: 16px 18px; margin-bottom: 12px;
  }
  .summary-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--teal); font-weight: 700; margin-bottom: 10px; }
  .summary-row { display: flex; gap: 8px; margin-bottom: 7px; align-items: baseline; }
  .summary-key { font-size: 0.75rem; color: var(--text3); min-width: 130px; flex-shrink: 0; }
  .summary-val { font-size: 0.82rem; color: var(--text1); font-weight: 500; }

  /* Success state */
  .success-overlay {
    display: none; flex-direction: column; align-items: center; justify-content: center;
    padding: 48px 24px; text-align: center;
  }
  .success-overlay.show { display: flex; }
  .success-icon { font-size: 3.5rem; margin-bottom: 16px; animation: popIn .4s cubic-bezier(.34,1.5,.64,1); }
  @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .success-title { font-family: var(--syne); font-size: 1.3rem; font-weight: 800; color: var(--text1); margin-bottom: 8px; }
  .success-sub { font-size: 0.85rem; color: var(--text3); margin-bottom: 8px; }
  .success-id { font-family: var(--mono); font-size: 1.1rem; color: var(--teal); font-weight: 600; background: var(--teal-dim); border: 1px solid rgba(0,212,180,0.2); padding: 8px 20px; border-radius: 8px; margin: 10px 0 20px; }

  /* Modal footer */
  .modal-footer {
    padding: 14px 24px; border-top: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    flex-shrink: 0; background: var(--navy2);
  }
  .modal-footer-info { font-size: 0.72rem; color: var(--text3); }

  /* Notification toast */
  .toast {
    position: fixed; bottom: 28px; right: 28px; z-index: 2000;
    background: var(--panel2); border: 1px solid var(--border2);
    border-radius: 10px; padding: 12px 18px;
    display: flex; align-items: center; gap: 10px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    transform: translateY(80px); opacity: 0;
    transition: all .35s cubic-bezier(.34,1.2,.64,1);
    max-width: 340px;
  }
  .toast.show { transform: none; opacity: 1; }
  .toast-icon { font-size: 1.2rem; flex-shrink: 0; }
  .toast-text { font-size: 0.82rem; color: var(--text1); }
  .toast-sub { font-size: 0.72rem; color: var(--text3); margin-top: 2px; }
  .toast-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--teal); border-radius: 0 0 10px 10px; animation: toastBar 4s linear forwards; }
  @keyframes toastBar { from { width: 100%; } to { width: 0; } }

  /* ══════════════════════════════════════════════════════════
     LOGIN SCREEN STYLES
     ══════════════════════════════════════════════════════════ */

  .login-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #1a1625 0%, #2d2645 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    overflow-y: auto;
    padding: 20px;
  }

  .login-bg-decoration {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
    pointer-events: none;
  }

  .login-container {
    position: relative;
    width: 100%;
    max-width: 480px;
    z-index: 1;
  }

  .login-box {
    background: var(--panel);
    border-radius: 20px;
    padding: 48px 40px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border);
  }

  .login-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .login-logo {
    font-size: 4rem;
    margin-bottom: 16px;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .login-title {
    font-family: var(--syne);
    font-size: 2rem;
    font-weight: 800;
    color: var(--text1);
    margin: 0 0 8px 0;
    background: linear-gradient(135deg, var(--teal), var(--cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .login-subtitle {
    font-size: 0.95rem;
    color: var(--text3);
    margin: 0 0 20px 0;
  }

  .login-badge {
    display: inline-block;
    background: var(--teal-dim);
    color: var(--teal);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    border: 1px solid var(--teal);
  }

  .login-form {
    margin-bottom: 32px;
  }

  .form-group {
    margin-bottom: 24px;
  }

  .form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .label-icon {
    font-size: 1.1rem;
  }

  .form-input-login {
    width: 100%;
    padding: 14px 16px;
    background: var(--navy3);
    border: 2px solid var(--border2);
    border-radius: 10px;
    color: var(--text1);
    font-size: 0.95rem;
    transition: all 0.2s;
    box-sizing: border-box;
  }

  .form-input-login:focus {
    outline: none;
    border-color: var(--teal);
    background: var(--panel2);
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
  }

  .form-input-login::placeholder {
    color: var(--text3);
  }

  .form-hint {
    font-size: 0.75rem;
    color: var(--text3);
    margin-top: 6px;
  }

  .form-group-checkbox {
    margin-bottom: 24px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text2);
    user-select: none;
  }

  .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--teal);
  }

  .login-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--teal), var(--cyan));
    border: none;
    border-radius: 10px;
    color: var(--navy);
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
  }

  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(16, 185, 129, 0.4);
  }

  .login-btn:active {
    transform: translateY(0);
  }

  .login-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .login-error {
    margin-top: 20px;
    padding: 12px 16px;
    background: var(--red-dim);
    border: 1px solid var(--red);
    border-radius: 8px;
    color: var(--red);
    font-size: 0.85rem;
    text-align: center;
  }

  .login-footer {
    text-align: center;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }

  .login-footer p {
    margin: 0 0 8px 0;
    color: var(--text3);
    font-size: 0.85rem;
  }

  .login-link {
    color: var(--teal);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
  }

  .login-link:hover {
    color: var(--cyan);
    text-decoration: underline;
  }

  .login-divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
  }

  .login-info {
    font-size: 0.75rem;
    color: var(--text3);
    line-height: 1.6;
  }

  .login-info strong {
    color: var(--text2);
    display: block;
    margin-bottom: 4px;
  }

  /* Request Invitation Modal */
  .request-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    padding: 20px;
  }

  .request-modal-content {
    background: var(--panel);
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 100%;
    position: relative;
    border: 1px solid var(--border);
  }

  .request-modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    color: var(--text2);
    font-size: 1.5rem;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .request-modal-close:hover {
    background: var(--red-dim);
    color: var(--red);
  }

  .request-modal-content h2 {
    margin: 0 0 12px 0;
    color: var(--text1);
    font-family: var(--syne);
  }

  .request-modal-content p {
    margin: 0 0 24px 0;
    color: var(--text3);
    font-size: 0.9rem;
  }

  .request-modal-content form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* ══════════════════════════════════════════════════════
     MOBILE HAMBURGER + OVERLAY + BOTTOM NAV
     Hidden on desktop, shown on ≤ 900px
  ══════════════════════════════════════════════════════ */
  .mobile-menu-btn {
    display: none;
    align-items: center;
    justify-content: center;
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text1);
    font-size: 1.25rem;
    cursor: pointer;
    padding: 6px 10px;
    flex-shrink: 0;
    transition: all .2s;
    line-height: 1;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  .mobile-menu-btn:hover { border-color: var(--teal); color: var(--teal); }

  /* Bottom nav — hidden on desktop */
  .mobile-bottom-nav { display: none; }

  /* Dimming overlay when sidebar is open on mobile */
  .mobile-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur(3px);
  }
  .mobile-overlay.show { display: block; }

  /* ══════════════════════════════════════════════════════
     LAPTOP  ≤ 1280px  (tight screens, small 13" laptops)
  ══════════════════════════════════════════════════════ */
  @media screen and (max-width: 1280px) {
    .stat-grid           { grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .spec-grid           { grid-template-columns: repeat(4, 1fr); }
    .kpi-strip           { grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .analytics-grid-3    { grid-template-columns: repeat(2, 1fr); }
    .consult-layout      { grid-template-columns: 260px 1fr 250px; }
  }

  /* ══════════════════════════════════════════════════════
     TABLET  ≤ 1024px  (iPad landscape, small laptops)
  ══════════════════════════════════════════════════════ */
  @media screen and (max-width: 1024px) {
    /* App shell — narrow sidebar */
    .app                 { grid-template-columns: 200px 1fr; }
    .sidebar             { width: 200px; min-width: 200px; }

    /* Core grids */
    .grid-2              { grid-template-columns: 1fr; }
    .grid-3              { grid-template-columns: repeat(2, 1fr); }
    .grid-4              { grid-template-columns: repeat(2, 1fr); }

    /* Stats */
    .stat-grid           { grid-template-columns: repeat(2, 1fr); gap: 12px; }

    /* Consultation — collapse right panel to tabs */
    .consult-layout      { grid-template-columns: 240px 1fr; }
    .consult-right       {
      display: none;
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: 280px;
      z-index: 800;
      background: var(--panel);
      border-left: 1px solid var(--border2);
      box-shadow: -4px 0 24px rgba(0,0,0,0.15);
    }
    .consult-right.tablet-open { display: flex; }
    .consult-right-toggle {
      display: inline-flex !important;
    }

    /* Specializations */
    .spec-grid           { grid-template-columns: repeat(4, 1fr); }

    /* Lab cards */
    .lab-cards-grid      { grid-template-columns: repeat(3, 1fr); }

    /* Imaging */
    .imaging-grid        { grid-template-columns: 1fr; }
    .imaging-result-panel{ width: 100%; max-width: 100%; }

    /* Risk */
    .risk-grid           { grid-template-columns: repeat(2, 1fr); }

    /* Analytics */
    .kpi-strip           { grid-template-columns: repeat(3, 1fr); }
    .analytics-grid      { grid-template-columns: 1fr; }
    .analytics-grid-3    { grid-template-columns: repeat(2, 1fr); }

    /* Topbar search narrow */
    .search-bar          { width: 180px; }

    /* Settings */
    .settings-view       { max-width: 100%; padding: 18px; }

    /* Dashboard padding */
    .dashboard           { padding: 18px; }
  }

  /* ══════════════════════════════════════════════════════
     TABLET PORTRAIT  ≤ 900px  (iPad portrait, large phones)
  ══════════════════════════════════════════════════════ */
  @media screen and (max-width: 900px) {
    /* ── Shell switches to full-width ── */
    html, body { height: 100%; overflow: hidden; }

    .app {
      grid-template-columns: 1fr;
      grid-template-rows: 56px 1fr;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
    }

    /* ── Sidebar: off-canvas drawer ── */
    .sidebar {
      position: fixed;
      left: -280px;
      top: 0; bottom: 0;
      width: 270px;
      z-index: 1000;
      transition: left 0.28s cubic-bezier(.4, 0, .2, 1);
      overflow-y: auto;
      box-shadow: none;
    }
    .sidebar.mobile-open {
      left: 0;
      box-shadow: 8px 0 40px rgba(0, 0, 0, 0.25);
    }

    /* ── Main fills full column ── */
    .main {
      grid-column: 1;
      grid-row: 2;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
      min-height: 0;
    }

    /* ── Topbar ── */
    .topbar          { height: 56px; padding: 0 14px; gap: 10px; flex-shrink: 0; }
    .mobile-menu-btn { display: flex; }
    .desktop-search  { display: none !important; }
    .topbar-subtitle { display: none; }
    .topbar-title    { font-size: 0.95rem; }
    .icon-btn        { width: 38px; height: 38px; }

    /* ── Scrollable content ── */
    .content {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 16px 76px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    /* ── Bottom navigation ── */
    .mobile-bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 60px;
      background: var(--panel);
      border-top: 1.5px solid var(--border);
      z-index: 500;
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.08);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    .mobile-nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text3);
      transition: color .15s;
      padding: 6px 2px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position: relative;
    }
    .mobile-nav-item.active { color: var(--teal); }
    .mobile-nav-item.active::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 28px; height: 2px;
      background: var(--teal);
      border-radius: 0 0 2px 2px;
    }
    .mobile-nav-item:active { opacity: 0.55; }
    .mobile-nav-icon  { font-size: 1.2rem; line-height: 1; }
    .mobile-nav-label { font-size: 0.6rem; font-weight: 600; letter-spacing: 0.02em; white-space: nowrap; }

    /* ── Toast above bottom nav ── */
    .toast {
      bottom: 72px !important;
      left: 12px !important;
      right: 12px !important;
      width: auto !important;
      max-width: none !important;
    }

    /* ── Floating Ask AI button above bottom nav ── */
    #floatingChatBtn {
      bottom: 72px !important;
      right: 14px !important;
      padding: 11px 16px !important;
      font-size: 0.8rem !important;
    }

    /* ── Grids & cards ── */
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr !important; gap: 12px; }
    .stat-grid  { grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 14px; }
    .stat-card  { padding: 14px; }
    .stat-card .value { font-size: 1.5rem; }

    /* ── View padding reset (content area provides padding) ── */
    .dashboard,
    .patients-view,
    .risk-view,
    .spec-view,
    .lab-view,
    .imaging-view,
    .analytics-view,
    .settings-view { padding: 0 !important; }
    .settings-view { max-width: 100% !important; }

    /* ── Card adjustments ── */
    .card-header { flex-wrap: wrap; gap: 8px; }

    /* ── Consultation ── */
    .consult-layout {
      display: flex !important;
      flex-direction: column !important;
      height: auto !important;
      overflow: visible !important;
    }
    .consult-left {
      width: 100% !important;
      height: auto !important;
      max-height: none !important;
      border-right: none !important;
      border-bottom: 1px solid var(--border) !important;
      overflow: visible !important;
      flex: none !important;
    }
    .consult-left-body    { max-height: 260px; overflow-y: auto; }
    .consult-center       { min-height: 400px; }
    .consult-right        {
      display: none;
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: 85vw; max-width: 320px;
      z-index: 800;
      background: var(--panel);
      border-left: 1px solid var(--border2);
      box-shadow: -6px 0 32px rgba(0, 0, 0, 0.2);
    }
    .consult-right.mobile-panel-open { display: flex; }
    .consult-right-toggle { display: inline-flex !important; }
    .consult-right-body   { max-height: none; flex: 1; overflow-y: auto; }
    .patient-switcher     { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 6px; gap: 6px; }
    .patient-chip         { flex-shrink: 0; }
    .chat-messages        { min-height: 280px; }

    /* ── Patients table ── */
    .table-header         { flex-direction: column; align-items: flex-start; gap: 10px; }
    .filter-row           { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; gap: 6px; width: 100%; }
    .filter-btn           { flex-shrink: 0; font-size: 0.72rem; padding: 5px 12px; }
    .table-wrap           { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--radius); }
    table                 { min-width: 560px; }

    /* ── Specializations ── */
    .spec-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 8px; }

    /* ── Risk ── */
    .risk-grid  { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; }
    .risk-split { flex-direction: column !important; }

    /* ── Lab ── */
    .lab-cards-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .lab-input-row  { grid-template-columns: 2fr 1.2fr 1fr; gap: 6px; }

    /* ── Imaging ── */
    .imaging-grid   { grid-template-columns: 1fr !important; }
    .scan-type-bar  { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; padding-bottom: 4px; }
    .scan-type-btn  { flex-shrink: 0; }

    /* ── Analytics ── */
    .kpi-strip      { grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .analytics-grid { grid-template-columns: 1fr !important; }
    .analytics-grid-3 { grid-template-columns: 1fr !important; }

    /* ── Prescription ── */
    .rx-dose-row    { grid-template-columns: 1fr 1fr; }
    #view-prescription > div { padding: 0 !important; }

    /* ── Settings ── */
    #view-settings  { padding-bottom: 76px; }

    /* ── Vitals input grid ── */
    .vital-input-grid { grid-template-columns: repeat(2, 1fr); }

    /* ── Form grids ── */
    .form-grid-2, .form-grid-3 { grid-template-columns: 1fr !important; }
    .form-group.span-2, .form-group.span-3 { grid-column: span 1 !important; }
    .radio-group { flex-wrap: wrap; }

    /* ── Modals: full width ── */
    .modal-overlay > div,
    .soap-box {
      width: calc(100vw - 24px) !important;
      max-width: none !important;
      max-height: 90vh !important;
      margin: 12px !important;
      border-radius: 16px !important;
    }
    .modal-steps { overflow-x: auto; }
    .step-label  { display: none; }

    /* ── Voice modal: full screen ── */
    #voiceConsultModal > div {
      width: 100vw !important;
      height: 100vh !important;
      height: 100dvh !important;
      max-width: none !important;
      max-height: none !important;
      border-radius: 0 !important;
      margin: 0 !important;
    }

    /* ── Login ── */
    .login-container { padding: 16px; align-items: flex-start; padding-top: 40px; }
    .login-box       { padding: 28px 20px; border-radius: 16px; width: 100%; }
    .login-title     { font-size: 1.45rem; }
    .login-logo      { font-size: 2.5rem; }

    /* ── Radiology / PACS ── */
    #view-radiology { padding: 0; }

    /* ── Sidebar footer: hide avatar text on small screens ── */
    .sidebar-footer .avatar-info { display: block; } /* restore on tablet */
  }

  /* ══════════════════════════════════════════════════════
     MOBILE  ≤ 640px  (phones)
  ══════════════════════════════════════════════════════ */
  @media screen and (max-width: 640px) {
    /* Tighter content padding */
    .content          { padding: 12px 12px 72px; }

    /* Topbar */
    .topbar           { padding: 0 12px; gap: 8px; }
    .topbar-title     { font-size: 0.88rem; }
    .icon-btn         { width: 34px; height: 34px; font-size: 0.9rem; }

    /* Stats: 2-col on phone */
    .stat-grid        { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .stat-card .value { font-size: 1.4rem; }
    .stat-card .label { font-size: 0.72rem; }

    /* Specializations: 2-col */
    .spec-grid        { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
    .spec-card .spec-icon { font-size: 1.4rem; }

    /* Risk: 1-col */
    .risk-grid        { grid-template-columns: 1fr !important; }

    /* Lab: 2-col cards, 2-col input */
    .lab-cards-grid   { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .lab-input-row    { grid-template-columns: 1fr 1fr; gap: 6px; }
    .lab-ref-col      { display: none; } /* hide ref range col on phones */

    /* Analytics KPI: 2-col */
    .kpi-strip        { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .kpi-num          { font-size: 1.3rem; }

    /* Bottom nav */
    .mobile-bottom-nav { height: 56px; }
    .mobile-nav-icon   { font-size: 1.1rem; }
    .mobile-nav-label  { font-size: 0.57rem; }

    /* Toast */
    .toast            { bottom: 66px !important; left: 10px !important; right: 10px !important; }
    #floatingChatBtn  { bottom: 66px !important; right: 12px !important; }

    /* Prescription dose row: 1-col */
    .rx-dose-row      { grid-template-columns: 1fr; }

    /* Vital input: 2-col */
    .vital-input-grid { grid-template-columns: repeat(2, 1fr); }

    /* Scan type buttons: horizontal scroll */
    .scan-type-bar    { gap: 6px; }
    .scan-type-btn    { padding: 8px 10px; }
    .scan-type-btn .s-name { font-size: 0.72rem; }

    /* Chat input area */
    .chat-tools       { gap: 4px; }
    .chat-tool-btn    { font-size: 0.67rem; padding: 4px 7px; }

    /* Table: even more horizontal scroll room */
    table             { min-width: 480px; }
    .data-table th,
    .data-table td    { padding: 10px 12px; font-size: 0.78rem; }

    /* Sidebar footer: hide avatar text */
    .sidebar-footer .avatar-info { display: none; }

    /* Modals */
    .modal-overlay > div,
    .soap-box {
      width: calc(100vw - 16px) !important;
      margin: 8px !important;
      max-height: 92vh !important;
    }
    .modal-header     { padding: 16px 16px 14px; }
    .modal-footer     { padding: 12px 16px; }
  }

  /* ══════════════════════════════════════════════════════
     SMALL PHONE  ≤ 400px
  ══════════════════════════════════════════════════════ */
  @media screen and (max-width: 400px) {
    html              { font-size: 13px; }
    .topbar-title     { font-size: 0.82rem; }
    .stat-card .value { font-size: 1.25rem; }
    .mobile-nav-label { font-size: 0.54rem; }
    .spec-card        { padding: 12px 8px; }
    .spec-card .spec-name { font-size: 0.72rem; }
    .kpi-num          { font-size: 1.2rem; }
    .content          { padding: 10px 10px 68px; }
  }

  /* ══════════════════════════════════════════════════════
     LANDSCAPE MOBILE (short viewport)
  ══════════════════════════════════════════════════════ */
  @media screen and (max-width: 900px) and (orientation: landscape) and (max-height: 520px) {
    .mobile-bottom-nav  { height: 46px; }
    .mobile-nav-icon    { font-size: 0.95rem; }
    .mobile-nav-label   { display: none; }
    .content            { padding-bottom: 54px; }
    .toast              { bottom: 54px !important; }
    #floatingChatBtn    { bottom: 54px !important; }
    .mobile-bottom-nav .mobile-nav-item.active::before { display: none; }
  }

  /* ══════════════════════════════════════════════════════
     PRINT STYLES
  ══════════════════════════════════════════════════════ */
  @media print {
    .sidebar, .topbar, .mobile-bottom-nav,
    .mobile-menu-btn, #floatingChatBtn,
    .chat-input-area, .btn, .action-btn { display: none !important; }
    .app    { display: block; }
    .main   { height: auto; overflow: visible; }
    .content { overflow: visible; padding: 0; }
    .view.active { display: block; }
  }




</style>

</head>
<body>

<!-- ══════════════════════════════════════════════════════════
     LOGIN SCREEN (Invitation Only)
     ══════════════════════════════════════════════════════════ -->
<div id="loginScreen" class="login-screen">
  <div class="login-container">
    
    <!-- Background decorations -->
    <div class="login-bg-decoration"></div>
    
    <!-- Login Box -->
    <div class="login-box">
      
      <!-- Header -->
      <div class="login-header">
        <div class="login-logo">🧬</div>
        <h1 class="login-title">SamarthaaMed</h1>
        <p class="login-subtitle">Clinical Intelligence Platform</p>
        <div class="login-badge">🔐 Invitation Only Access</div>
      </div>

      <!-- Login Form -->
      <form id="loginForm" onsubmit="handleLogin(event)" class="login-form">
        
        <!-- Invitation Code -->
        <div class="form-group">
          <label class="form-label">
            <span class="label-icon">🎫</span>
            Invitation Code
          </label>
          <input 
            type="text" 
            id="invitationCode" 
            class="form-input-login" 
            placeholder="Enter your invitation code"
            required
            autocomplete="off"
          >
          <div class="form-hint">Your unique invitation code (e.g., INV-2026-AIIMS-001)</div>
        </div>

        <!-- Email -->
        <div class="form-group">
          <label class="form-label">
            <span class="label-icon">📧</span>
            Email Address
          </label>
          <input 
            type="email" 
            id="loginEmail" 
            class="form-input-login" 
            placeholder="doctor@hospital.com"
            required
            autocomplete="email"
          >
        </div>

        <!-- Password -->
        <div class="form-group">
          <label class="form-label">
            <span class="label-icon">🔑</span>
            Password
          </label>
          <input 
            type="password" 
            id="loginPassword" 
            class="form-input-login" 
            placeholder="Enter your password"
            required
            autocomplete="current-password"
          >
        </div>

        <!-- Remember Me -->
        <div class="form-group-checkbox">
          <label class="checkbox-label">
            <input type="checkbox" id="rememberMe">
            <span>Remember me for 30 days</span>
          </label>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="login-btn" id="loginBtn">
          <span id="loginBtnText">🚀 Access Platform</span>
          <span id="loginBtnLoader" style="display:none">⏳ Verifying...</span>
        </button>

        <!-- Error Message -->
        <div id="loginError" class="login-error" style="display:none"></div>

      </form>

      <!-- Footer -->
      <div class="login-footer">
        <p>Don't have an invitation code?</p>
        <a href="#" onclick="showRequestInvitation(); return false;" class="login-link">Request Access</a>
        <div class="login-divider"></div>
        <p class="login-info">
          <strong>For Healthcare Professionals Only</strong><br>
          AIIMS Delhi, Fortis, Apollo, Max Healthcare, and partner institutions
        </p>
      </div>

    </div>

    <!-- Request Invitation Modal (hidden by default) -->
    <div id="requestInvitationModal" class="request-modal" style="display:none">
      <div class="request-modal-content">
        <button class="request-modal-close" onclick="closeRequestInvitation()">✕</button>
        <h2>Request Invitation Access</h2>
        <p>To request access to SamarthaaMed, please provide your details:</p>
        <form id="requestForm" onsubmit="submitInvitationRequest(event)">
          <input type="text" placeholder="Full Name" required class="form-input-login">
          <input type="email" placeholder="Professional Email" required class="form-input-login">
          <input type="text" placeholder="Hospital/Institution" required class="form-input-login">
          <select required class="form-input-login">
            <option value="">Select Specialty</option>
            <option>Cardiology</option>
            <option>Pulmonology</option>
            <option>Endocrinology</option>
            <option>General Medicine</option>
            <option>Emergency Medicine</option>
            <option>Other</option>
          </select>
          <textarea placeholder="Why do you need access?" required class="form-input-login" rows="3"></textarea>
          <button type="submit" class="login-btn">Submit Request</button>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- ══════════════════════════════════════════════════════════
     MAIN APPLICATION (Hidden until login)
     ══════════════════════════════════════════════════════════ -->
<div class="app" id="mainApp" style="display:none">

  <!-- ══ SIDEBAR ══ -->
  <!-- Mobile overlay for sidebar -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileSidebar()"></div>

  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">🧬</div>
      <div>
        <div class="logo-text">SamarthaaMed</div>
        <div class="logo-sub">AI Platform</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-label">Clinical</div>
        <div class="nav-item active" onclick="showView('dashboard')">
          <span class="nav-icon">⬡</span> Dashboard
        </div>
        <div class="nav-item" onclick="showView('consult')">
          <span class="nav-icon">💬</span> AI Consultation
          <span class="nav-badge green">3</span>
        </div>
        <div class="nav-item" onclick="startEmergencyVoice()" style="background:rgba(220,38,38,0.1);color:var(--red);font-weight:700;border:1px solid rgba(220,38,38,0.2);margin:2px 0;">
          <span class="nav-icon">🚨</span> Emergency Voice AI
        </div>
        <div class="nav-item" onclick="showView('patients')">
          <span class="nav-icon">👥</span> Patients
        </div>
        <div class="nav-item" onclick="showView('risk')">
          <span class="nav-icon">📊</span> Risk Prediction
        </div>
        <div class="nav-item" onclick="showView('specs')">
          <span class="nav-icon">🔬</span> Specializations
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-label">Tools</div>
        <div class="nav-item" onclick="showView('prescription')">
          <span class="nav-icon">💊</span> Prescription
        </div>
        <div class="nav-item" onclick="showView('labs')">
          <span class="nav-icon">🧪</span> Lab Results
          <span class="nav-badge">5</span>
        </div>
        <div class="nav-item" onclick="showView('imaging')">
          <span class="nav-icon">🩻</span> Imaging AI
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-label">Platform</div>
        <div class="nav-item" onclick="showView('analytics')">
          <span class="nav-icon">📈</span> Analytics
        </div>
        <div class="nav-item" onclick="showView('settings')">
          <span class="nav-icon">⚙️</span> Settings
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="avatar">DR</div>
      <div class="online-dot"></div>
    </div>
  </aside>

  <!-- ══ MAIN AREA ══ -->
  <div class="main">

    <!-- TOPBAR -->
    <div class="topbar" id="topbar">
      <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" style="display:none">☰</button>
      <div>
        <div class="topbar-title" id="topbar-title">Clinical Dashboard</div>
        <div class="topbar-subtitle" id="topbar-sub">Tuesday, 24 February 2026 · AIIMS Delhi</div>
      </div>
      <div class="topbar-spacer"></div>
      <div class="search-bar">
        <span>🔍</span>
        <input type="text" placeholder="Search patients, drugs, conditions…" onkeyup="handleSearch(event)" id="topbarSearch">
      </div>
      <div class="icon-btn" title="Notifications" onclick="showNotifications()">
        🔔
        <div class="dot"></div>
      </div>
      <div class="icon-btn" title="Alerts" onclick="showAlerts()">⚡</div>
      <div class="icon-btn" title="Live monitoring" onclick="showLiveMonitoring()">
        <div class="live-dot"></div>
      </div>
    </div>

    <!-- ════════ CONTENT VIEWS ════════ -->
    <div class="content">

      <!-- ── DASHBOARD ── -->
      <div class="view active" id="view-dashboard">
        <div class="dashboard">

          <!-- Stat cards -->
          <div class="stat-grid">
            <div class="stat-card" style="--accent-color: var(--teal);cursor:pointer" onclick="showView('patients')" title="View all patients">
              <div class="icon">👥</div>
              <div class="value">24</div>
              <div class="label">Today's Appointments</div>
              <div class="change up">↑ 4 more than yesterday</div>
            </div>
            <div class="stat-card" style="--accent-color: var(--red);cursor:pointer" onclick="showUrgentPanel()" title="View all urgent cases">
              <div class="icon">🚨</div>
              <div class="value">3</div>
              <div class="label">Urgent Cases</div>
              <div class="change down">⚠ Tap to view all 3</div>
            </div>
            <div class="stat-card" style="--accent-color: var(--gold);cursor:pointer" onclick="showView('labs')" title="View pending lab results">
              <div class="icon">🧪</div>
              <div class="value">8</div>
              <div class="label">Pending Lab Results</div>
              <div class="change neutral">3 auto-interpreted by AI</div>
            </div>
            <div class="stat-card" style="--accent-color: var(--purple);cursor:pointer" onclick="showView('analytics')" title="View AI analytics">
              <div class="icon">🤖</div>
              <div class="value">97%</div>
              <div class="label">AI Accuracy Score</div>
              <div class="change up">↑ 2.1% this week</div>
            </div>
          </div>

          <!-- Main grid -->
          <div class="grid-2">
            <!-- Patient Queue -->
            <div class="card">
              <div class="card-header">
                <span class="card-title">🗓 Today's Patient Queue</span>
                <div style="display:flex;gap:8px;align-items:center">
                  <span class="pill teal">● Live</span>
                  <span class="card-action" onclick="showView('patients')">View All 24 →</span>
                </div>
              </div>
              <div class="card-body" style="padding:0">

                <!-- Urgent patients first -->
                <div style="padding:6px 12px;font-size:0.65rem;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:1px;background:var(--red-dim);border-bottom:1px solid rgba(255,77,109,0.15)">🚨 Urgent — Immediate Attention</div>
                <div class="patient-row" onclick="openConsultForPatient('PK','Priya Krishnamurthy')" style="cursor:pointer;border-left:3px solid var(--red)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#EF4444,#DC2626)">PK</div>
                  <div style="flex:1">
                    <div class="patient-name">Priya Krishnamurthy</div>
                    <div class="patient-meta">52F · NSTEMI suspected · Troponin ↑ · HEART 7</div>
                  </div>
                  <div class="patient-status"><span class="status-badge urgent">Urgent</span></div>
                </div>
                <div class="patient-row" onclick="openConsultForPatient('DK','Deepak Kumar')" style="cursor:pointer;border-left:3px solid var(--red)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#EF4444,#B91C1C)">DK</div>
                  <div style="flex:1">
                    <div class="patient-name">Deepak Kumar</div>
                    <div class="patient-meta">58M · COPD acute exacerbation · SpO₂ 88%</div>
                  </div>
                  <div class="patient-status"><span class="status-badge urgent">Urgent</span></div>
                </div>
                <div class="patient-row" onclick="openConsultForPatient('MI','Meena Iyer')" style="cursor:pointer;border-left:3px solid var(--red)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#DC2626,#991B1B)">MI</div>
                  <div style="flex:1">
                    <div class="patient-name">Meena Iyer</div>
                    <div class="patient-meta">49F · BP 210/118 · Hypertensive crisis</div>
                  </div>
                  <div class="patient-status"><span class="status-badge urgent">Urgent</span></div>
                </div>

                <!-- Active / waiting -->
                <div style="padding:6px 12px;font-size:0.65rem;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:1px;background:var(--teal-dim);border-bottom:1px solid rgba(0,212,180,0.15);border-top:1px solid var(--border)">Active &amp; Waiting</div>
                <div class="patient-row" onclick="openConsultForPatient('RS','Ramesh Singh')" style="cursor:pointer;border-left:3px solid var(--teal)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8)">RS</div>
                  <div style="flex:1">
                    <div class="patient-name">Ramesh Singh</div>
                    <div class="patient-meta">67M · CAD post CABG · Follow-up</div>
                  </div>
                  <div class="patient-status"><span class="status-badge active">In Consult</span></div>
                </div>
                <div class="patient-row" onclick="openConsultForPatient('AM','Anita Mehta')" style="cursor:pointer;border-left:3px solid var(--gold)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#10B981,#059669)">AM</div>
                  <div style="flex:1">
                    <div class="patient-name">Anita Mehta</div>
                    <div class="patient-meta">38F · Palpitations, SOB · New patient</div>
                  </div>
                  <div class="patient-status"><span class="status-badge waiting">Waiting</span></div>
                </div>
                <div class="patient-row" onclick="openConsultForPatient('VN','Vikram Nair')" style="cursor:pointer;border-left:3px solid var(--gold)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#8B5CF6,#7C3AED)">VN</div>
                  <div style="flex:1">
                    <div class="patient-name">Vikram Nair</div>
                    <div class="patient-meta">44M · HTN Stage 2 · Medication review</div>
                  </div>
                  <div class="patient-status"><span class="status-badge waiting">Waiting</span></div>
                </div>

                <!-- Stable -->
                <div style="padding:6px 12px;font-size:0.65rem;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:1px;background:var(--green-dim);border-bottom:1px solid rgba(34,211,166,0.15);border-top:1px solid var(--border)">Stable</div>
                <div class="patient-row" onclick="openConsultForPatient('SG','Sunita Gupta')" style="cursor:pointer;border-left:3px solid var(--green)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#F59E0B,#D97706)">SG</div>
                  <div style="flex:1">
                    <div class="patient-name">Sunita Gupta</div>
                    <div class="patient-meta">61F · Post-STEMI · Cardiac rehab</div>
                  </div>
                  <div class="patient-status"><span class="status-badge stable">Stable</span></div>
                </div>
                <div class="patient-row" onclick="openConsultForPatient('KR','Karthik Reddy')" style="cursor:pointer;border-left:3px solid var(--green)">
                  <div class="patient-avatar" style="background:linear-gradient(135deg,#06B6D4,#0891B2)">KR</div>
                  <div style="flex:1">
                    <div class="patient-name">Karthik Reddy</div>
                    <div class="patient-meta">28M · Dyslipidemia · Routine follow-up</div>
                  </div>
                  <div class="patient-status"><span class="status-badge stable">Stable</span></div>
                </div>
                <div style="padding:10px 16px;text-align:center;border-top:1px solid var(--border)">
                  <span style="font-size:0.75rem;color:var(--text3)">Showing 8 of 24 · </span>
                  <span class="card-action" onclick="showView('patients')" style="font-size:0.75rem">View full queue →</span>
                </div>
              </div>
            </div>

            <!-- Right column -->
            <div style="display:flex;flex-direction:column;gap:16px">
              <!-- AI Alerts -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">⚡ AI Alert Feed</span>
                  <span class="pill red">● 5 new</span>
                </div>
                <div class="card-body">
                  <div class="alert-item">
                    <div class="alert-dot" style="background:var(--red)"></div>
                    <div>
                      <div class="alert-text"><strong style="color:var(--red)">Drug Interaction:</strong> Priya K. — Metformin + Contrast dye scheduled. Hold Metformin 48h pre-CT.</div>
                      <div class="alert-time">2 min ago</div>
                    </div>
                  </div>
                  <div class="alert-item">
                    <div class="alert-dot" style="background:var(--gold)"></div>
                    <div>
                      <div class="alert-text"><strong style="color:var(--gold)">Risk Trigger:</strong> Ramesh S. — HbA1c 9.2%. Diabetic nephropathy risk ↑42% in 6 months.</div>
                      <div class="alert-time">18 min ago</div>
                    </div>
                  </div>
                  <div class="alert-item">
                    <div class="alert-dot" style="background:var(--teal)"></div>
                    <div>
                      <div class="alert-text"><strong style="color:var(--teal)">Lab Ready:</strong> Anita M. — Holter + Echo report uploaded. AI interpretation available.</div>
                      <div class="alert-time">34 min ago</div>
                    </div>
                  </div>
                  <div class="alert-item">
                    <div class="alert-dot" style="background:var(--purple)"></div>
                    <div>
                      <div class="alert-text"><strong style="color:var(--purple)">Guideline Update:</strong> ICMR 2026 HTN guidelines updated. 3 patients may need protocol revision.</div>
                      <div class="alert-time">1 hr ago</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Quick risk snapshot -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">📊 Predictive Risk — Today</span>
                  <span class="card-action" onclick="showView('risk')">Full View →</span>
                </div>
                <div class="card-body">
                  <div class="risk-item">
                    <span class="risk-name">Priya K. · Cardiac event</span>
                    <div class="risk-bar-wrap"><div class="risk-bar" style="width:82%;background:var(--red)"></div></div>
                    <span class="risk-score" style="color:var(--red)">82%</span>
                  </div>
                  <div class="risk-item">
                    <span class="risk-name">Ramesh S. · CKD progression</span>
                    <div class="risk-bar-wrap"><div class="risk-bar" style="width:67%;background:var(--gold)"></div></div>
                    <span class="risk-score" style="color:var(--gold)">67%</span>
                  </div>
                  <div class="risk-item">
                    <span class="risk-name">Vikram N. · Hypertension onset</span>
                    <div class="risk-bar-wrap"><div class="risk-bar" style="width:55%;background:var(--gold)"></div></div>
                    <span class="risk-score" style="color:var(--gold)">55%</span>
                  </div>
                  <div class="risk-item">
                    <span class="risk-name">Sunita G. · Re-infarction</span>
                    <div class="risk-bar-wrap"><div class="risk-bar" style="width:38%;background:var(--teal)"></div></div>
                    <span class="risk-score" style="color:var(--teal)">38%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom row -->
          <div class="grid-3">
            <!-- Today's Vitals -->
            <div class="card">
              <div class="card-header">
                <span class="card-title">📡 Live Vitals Monitor</span>
                <span class="pill teal" style="animation: pulse-glow 2s infinite">● Streaming</span>
              </div>
              <div class="card-body">
                <div style="font-size:0.75rem;color:var(--text3);margin-bottom:10px">Priya Krishnamurthy · Room 3</div>
                <div class="vitals-grid">
                  <div class="vital-card">
                    <div class="vital-label">Heart Rate</div>
                    <div class="vital-value" id="vhr">98<span class="vital-unit">bpm</span></div>
                    <div class="vital-trend" style="color:var(--gold)">↑ Elevated</div>
                  </div>
                  <div class="vital-card">
                    <div class="vital-label">Blood Pressure</div>
                    <div class="vital-value">148<span class="vital-unit">/92</span></div>
                    <div class="vital-trend" style="color:var(--red)">↑ Stage 2 HTN</div>
                  </div>
                  <div class="vital-card">
                    <div class="vital-label">SpO₂</div>
                    <div class="vital-value" id="vspo">96<span class="vital-unit">%</span></div>
                    <div class="vital-trend" style="color:var(--teal)">✓ Normal</div>
                  </div>
                  <div class="vital-card">
                    <div class="vital-label">Temperature</div>
                    <div class="vital-value">37.4<span class="vital-unit">°C</span></div>
                    <div class="vital-trend" style="color:var(--teal)">✓ Normal</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Lab summary -->
            <div class="card">
              <div class="card-header">
                <span class="card-title">🧪 Latest Lab Results</span>
                <span class="card-action" onclick="showView('labs')">View All →</span>
              </div>
              <div class="card-body">
                <div style="font-size:0.72rem;color:var(--text3);margin-bottom:8px">Priya K. · Reported 08:45 AM</div>
                <div class="lab-item">
                  <span class="lab-name">Troponin I</span>
                  <span class="lab-val high">0.08 ng/mL</span>
                  <span class="lab-ref">&lt;0.04</span>
                </div>
                <div class="lab-item">
                  <span class="lab-name">CK-MB</span>
                  <span class="lab-val high">28 U/L</span>
                  <span class="lab-ref">&lt;25</span>
                </div>
                <div class="lab-item">
                  <span class="lab-name">LDL-C</span>
                  <span class="lab-val high">168 mg/dL</span>
                  <span class="lab-ref">&lt;100</span>
                </div>
                <div class="lab-item">
                  <span class="lab-name">HbA1c</span>
                  <span class="lab-val high">8.4%</span>
                  <span class="lab-ref">&lt;6.5</span>
                </div>
                <div class="lab-item">
                  <span class="lab-name">eGFR</span>
                  <span class="lab-val normal">72 mL/min</span>
                  <span class="lab-ref">&gt;60</span>
                </div>
                <div class="lab-item">
                  <span class="lab-name">Serum K⁺</span>
                  <span class="lab-val normal">4.1 mEq/L</span>
                  <span class="lab-ref">3.5–5.0</span>
                </div>
              </div>
            </div>

            <!-- Activity / AI usage -->
            <div class="card">
              <div class="card-header">
                <span class="card-title">🤖 AI Activity Today</span>
              </div>
              <div class="card-body">
                <div style="display:flex;flex-direction:column;gap:12px">
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                      <span style="font-size:0.78rem;color:var(--text2)">Diagnoses suggested</span>
                      <span style="font-family:var(--mono);font-size:0.82rem;color:var(--teal)">18</span>
                    </div>
                    <div style="height:5px;background:var(--border2);border-radius:3px;overflow:hidden"><div style="height:100%;width:75%;background:var(--teal);border-radius:3px"></div></div>
                  </div>
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                      <span style="font-size:0.78rem;color:var(--text2)">Prescriptions assisted</span>
                      <span style="font-family:var(--mono);font-size:0.82rem;color:var(--cyan)">12</span>
                    </div>
                    <div style="height:5px;background:var(--border2);border-radius:3px;overflow:hidden"><div style="height:100%;width:50%;background:var(--cyan);border-radius:3px"></div></div>
                  </div>
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                      <span style="font-size:0.78rem;color:var(--text2)">Drug interactions flagged</span>
                      <span style="font-family:var(--mono);font-size:0.82rem;color:var(--gold)">3</span>
                    </div>
                    <div style="height:5px;background:var(--border2);border-radius:3px;overflow:hidden"><div style="height:100%;width:12%;background:var(--gold);border-radius:3px"></div></div>
                  </div>
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                      <span style="font-size:0.78rem;color:var(--text2)">Risk flags raised</span>
                      <span style="font-family:var(--mono);font-size:0.82rem;color:var(--red)">5</span>
                    </div>
                    <div style="height:5px;background:var(--border2);border-radius:3px;overflow:hidden"><div style="height:100%;width:20%;background:var(--red);border-radius:3px"></div></div>
                  </div>
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                      <span style="font-size:0.78rem;color:var(--text2)">Reports auto-summarized</span>
                      <span style="font-family:var(--mono);font-size:0.82rem;color:var(--purple)">7</span>
                    </div>
                    <div style="height:5px;background:var(--border2);border-radius:3px;overflow:hidden"><div style="height:100%;width:29%;background:var(--purple);border-radius:3px"></div></div>
                  </div>
                </div>
                <div class="divider"></div>
                <div style="text-align:center">
                  <span style="font-family:var(--syne);font-size:1.6rem;font-weight:800;color:var(--teal)">94.2%</span>
                  <div style="font-size:0.72rem;color:var(--text3);margin-top:2px">Physician acceptance rate</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── AI CONSULTATION ── -->
      <div class="view flex-view" id="view-consult" style="flex-direction:column;height:calc(100vh - 58px);overflow:hidden">
        <!-- Patient switcher -->
        <div class="patient-switcher">
          <div class="patient-chip active" onclick="switchConsultPatient(this,'PK','Priya Krishnamurthy','urgent')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#EF4444,#DC2626)">PK</div><span class="patient-chip-name">Priya K.</span><span class="status-badge urgent" style="margin-left:4px;font-size:0.6rem">Urgent</span></div>
          <div class="patient-chip" onclick="switchConsultPatient(this,'DK','Deepak Kumar','urgent')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#EF4444,#B91C1C)">DK</div><span class="patient-chip-name">Deepak K.</span><span class="status-badge urgent" style="margin-left:4px;font-size:0.6rem">Urgent</span></div>
          <div class="patient-chip" onclick="switchConsultPatient(this,'MI','Meena Iyer','urgent')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#DC2626,#991B1B)">MI</div><span class="patient-chip-name">Meena I.</span><span class="status-badge urgent" style="margin-left:4px;font-size:0.6rem">Urgent</span></div>
          <div class="patient-chip" onclick="switchConsultPatient(this,'RS','Ramesh Singh','active')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8)">RS</div><span class="patient-chip-name">Ramesh S.</span></div>
          <div class="patient-chip" onclick="switchConsultPatient(this,'AM','Anita Mehta','waiting')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#10B981,#059669)">AM</div><span class="patient-chip-name">Anita M.</span></div>
          <div class="patient-chip" onclick="switchConsultPatient(this,'VN','Vikram Nair','waiting')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#8B5CF6,#7C3AED)">VN</div><span class="patient-chip-name">Vikram N.</span></div>
          <div class="patient-chip" onclick="switchConsultPatient(this,'SG','Sunita Gupta','stable')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#F59E0B,#D97706)">SG</div><span class="patient-chip-name">Sunita G.</span></div>
          <div class="patient-chip" onclick="switchConsultPatient(this,'NB','Nandini Bose','stable')"><div class="patient-chip-avatar" style="background:linear-gradient(135deg,#06B6D4,#0891B2)">NB</div><span class="patient-chip-name">Nandini B.</span></div>
        </div>
        <div class="consult-layout">

          <!-- Left: Patient Info -->
          <div class="consult-left">
            <div class="consult-left-header">
              <div class="consult-patient-info">
                <div class="consult-patient-avatar">PK</div>
                <div>
                  <div class="consult-patient-name">Priya Krishnamurthy</div>
                  <div class="consult-patient-meta">52F · ID: MM-2024-04521 · Cardiology</div>
                </div>
              </div>
              <div class="vital-row">
                <div class="vital-mini"><div class="vlabel">HR</div><div class="vval">98 bpm</div></div>
                <div class="vital-mini"><div class="vlabel">BP</div><div class="vval">148/92</div></div>
                <div class="vital-mini"><div class="vlabel">SpO₂</div><div class="vval">96%</div></div>
                <div class="vital-mini"><div class="vlabel">Temp</div><div class="vval">37.4°C</div></div>
              </div>
            </div>

            <div class="consult-left-body">
              <!-- Symptoms -->
              <div class="mini-header" style="margin-bottom:8px">
                <div class="mini-header-icon" style="background:var(--red-dim)">🩺</div>
                <div><div class="mini-header-title">Chief Complaints</div><div class="mini-header-sub">2 days duration</div></div>
              </div>
              <div class="symptom-tags">
                <span class="tag red">Chest pain</span>
                <span class="tag red">Radiating to left arm</span>
                <span class="tag gold">Diaphoresis</span>
                <span class="tag gold">Dyspnea on exertion</span>
                <span class="tag">Nausea</span>
                <span class="tag">Fatigue</span>
              </div>

              <div class="divider"></div>

              <!-- History -->
              <div class="mini-header" style="margin-bottom:8px">
                <div class="mini-header-icon" style="background:var(--teal-dim)">📋</div>
                <div><div class="mini-header-title">Medical History</div></div>
              </div>
              <div class="symptom-tags">
                <span class="tag">DM Type 2 (8 yrs)</span>
                <span class="tag">Hypertension (5 yrs)</span>
                <span class="tag">Dyslipidemia</span>
                <span class="tag gold">Smoker (ex)</span>
              </div>

              <div class="divider"></div>

              <!-- Current medications -->
              <div class="mini-header" style="margin-bottom:8px">
                <div class="mini-header-icon" style="background:var(--gold-dim)">💊</div>
                <div><div class="mini-header-title">Current Medications</div></div>
              </div>
              <div style="font-size:0.8rem;color:var(--text2);line-height:2">
                Metformin 1000mg BD · Amlodipine 5mg OD<br>
                Atorvastatin 40mg HS · Aspirin 75mg OD<br>
                Metoprolol 25mg BD
              </div>

              <div class="divider"></div>

              <!-- Risk scores -->
              <div class="mini-header" style="margin-bottom:8px">
                <div class="mini-header-icon" style="background:var(--red-dim)">⚠️</div>
                <div><div class="mini-header-title">Clinical Scores</div></div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <span style="font-size:0.78rem;color:var(--text2)">HEART Score</span>
                  <span style="font-family:var(--mono);font-size:0.9rem;font-weight:600;color:var(--red)">7/10 — High Risk</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <span style="font-size:0.78rem;color:var(--text2)">TIMI Score</span>
                  <span style="font-family:var(--mono);font-size:0.9rem;font-weight:600;color:var(--gold)">5/7 — Moderate</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <span style="font-size:0.78rem;color:var(--text2)">Framingham 10-yr</span>
                  <span style="font-family:var(--mono);font-size:0.9rem;font-weight:600;color:var(--red)">34%</span>
                </div>
              </div>

              <div class="divider"></div>
              <button class="btn" onclick="startEmergencyVoice()" style="width:100%;justify-content:center;margin-top:4px;margin-bottom:6px;background:rgba(220,38,38,0.1);color:var(--red);border:1px solid rgba(220,38,38,0.3);font-weight:700;">
                🚨 Emergency Voice AI
              </button>
              <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px" onclick="showView('consult')">
                🔬 Start AI Consultation
              </button>
              <button class="btn" style="width:100%;justify-content:center;margin-top:8px;background:var(--teal-dim);color:var(--teal);border:1px solid var(--teal)" onclick="startVoiceConsultation()">
                🎤 Start Voice Consultation
              </button>
            </div>
          </div>

          <!-- Center: Chat -->
          <div class="consult-center">
            <div class="chat-messages" id="chatMessages">

              <div class="msg ai">
                <div class="msg-avatar">🧬</div>
                <div>
                  <div class="msg-bubble">
                    नमस्ते Dr. I've reviewed Priya Krishnamurthy's case. Based on the presenting symptoms, vitals, and recent lab results, I've prepared an initial differential analysis.
                    <div class="diff-card">
                      <div class="diff-title">🔬 Differential Diagnosis — AI Generated</div>
                      <div class="diff-item">
                        <span class="diff-rank">1.</span>
                        <span class="diff-name">Non-ST Elevation Myocardial Infarction (NSTEMI)</span>
                        <span class="diff-icd">I21.4</span>
                        <div class="confidence-wrap">
                          <div class="conf-bar"><div class="conf-fill" style="width:87%;background:var(--red)"></div></div>
                          <span class="conf-pct" style="color:var(--red)">87%</span>
                        </div>
                      </div>
                      <div class="diff-item">
                        <span class="diff-rank">2.</span>
                        <span class="diff-name">Unstable Angina</span>
                        <span class="diff-icd">I20.0</span>
                        <div class="confidence-wrap">
                          <div class="conf-bar"><div class="conf-fill" style="width:72%;background:var(--gold)"></div></div>
                          <span class="conf-pct" style="color:var(--gold)">72%</span>
                        </div>
                      </div>
                      <div class="diff-item">
                        <span class="diff-rank">3.</span>
                        <span class="diff-name">Hypertensive Emergency</span>
                        <span class="diff-icd">I16.1</span>
                        <div class="confidence-wrap">
                          <div class="conf-bar"><div class="conf-fill" style="width:45%;background:var(--teal)"></div></div>
                          <span class="conf-pct" style="color:var(--teal)">45%</span>
                        </div>
                      </div>
                      <div class="diff-item">
                        <span class="diff-rank">4.</span>
                        <span class="diff-name">Aortic Dissection (Type A)</span>
                        <span class="diff-icd">I71.0</span>
                        <div class="confidence-wrap">
                          <div class="conf-bar"><div class="conf-fill" style="width:22%;background:var(--text3)"></div></div>
                          <span class="conf-pct" style="color:var(--text3)">22%</span>
                        </div>
                      </div>
                    </div>
                    <div class="warning-box">
                      <span class="icon">🚨</span>
                      <span class="text">Troponin I elevated at 0.08 ng/mL (2× ULN). HEART Score 7 = HIGH RISK. Recommend immediate cardiology intervention, ECG, echo, and consider cath lab activation.</span>
                    </div>
                  </div>
                  <div class="msg-time">SamarthaaMed · 09:14 AM</div>
                </div>
              </div>

              <div class="msg user">
                <div class="msg-avatar">DR</div>
                <div>
                  <div class="msg-bubble">What's the recommended management protocol per ICMR guidelines for suspected NSTEMI in a diabetic patient with HTN?</div>
                  <div class="msg-time">Dr. · 09:16 AM</div>
                </div>
              </div>

              <div class="msg ai">
                <div class="msg-avatar">🧬</div>
                <div>
                  <div class="msg-bubble">
                    Per <strong style="color:var(--teal)">ICMR 2024 ACS Guidelines</strong> and <strong style="color:var(--teal)">CSI (Cardiological Society of India)</strong> protocols for NSTEMI in high-risk diabetic patients:<br><br>
                    <strong style="color:var(--text1)">Immediate (0–90 min):</strong><br>
                    • Dual antiplatelet: Aspirin 300mg loading + Ticagrelor 180mg (preferred over Clopidogrel in DM)<br>
                    • Anticoagulation: LMWH Enoxaparin 1mg/kg SC (dose-adjust for eGFR 72 — standard dose ✓)<br>
                    • High-intensity statin: Rosuvastatin 40mg stat<br>
                    • Nitrates: GTN SL/IV if BP allows<br><br>
                    <strong style="color:var(--text1)">Caution:</strong><br>
                    ⚠ Hold Metformin — contrast CT/cath likely. Resume 48h post-procedure after renal function check.<br>
                    ⚠ Ticagrelor contraindicated if prior hemorrhagic stroke — confirm history.<br><br>
                    <strong style="color:var(--gold)">Recommend early invasive strategy (&lt;24h) given GRACE score &gt;140.</strong>
                  </div>
                  <div class="msg-time">SamarthaaMed · 09:16 AM</div>
                </div>
              </div>

              <div id="typingIndicator" style="display:none">
                <div class="msg ai">
                  <div class="msg-avatar">🧬</div>
                  <div class="msg-bubble">
                    <div class="typing">
                      <div class="typing-dot"></div>
                      <div class="typing-dot"></div>
                      <div class="typing-dot"></div>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <!-- Input -->
            <div class="chat-input-area">
              <div class="chat-input-row">
                <textarea id="chatInput" placeholder="Ask Samarthaa — type in English, Hindi, or any Indian language…" rows="1"
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"
                  oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                <button class="send-btn" onclick="sendMessage()">➤</button>
              </div>
              <div class="chat-tools">
                <span class="chat-tool-btn" onclick="chatAttachReport()">📎 Attach Report</span>
                <span class="chat-tool-btn" onclick="chatVoiceInput(this)">🎤 Voice Input</span>
                <span class="chat-tool-btn" onclick="showView('imaging')">📊 Upload ECG</span>
                <span class="chat-tool-btn" onclick="chatImportLabs()">🧪 Import Labs</span>
                <span class="chat-tool-btn" onclick="generateSoapNote()">📝 Generate SOAP Note</span>
              </div>
            </div><!-- end chat-input-area -->
            <input type="file" id="reportFileInput" accept=".pdf,.jpg,.jpeg,.png,.dcm,.doc,.docx" style="display:none" onchange="handleReportAttach(event)">
          </div><!-- end consult-center -->

          <!-- Right: Rx + Labs + History -->
          <div class="consult-right">
            <div class="consult-right-tabs">
              <div class="r-tab active" onclick="switchRightTab(this,'rx')">💊 Rx</div>
              <div class="r-tab" onclick="switchRightTab(this,'labs')">🧪 Labs</div>
              <div class="r-tab" onclick="switchRightTab(this,'history')">📋 History</div>
            </div>
            <div class="consult-right-body">

              <!-- Rx Tab -->
              <div class="tab-content active" id="tab-rx">
                <div style="margin-bottom:10px">
                  <div style="font-size:0.72rem;color:var(--text3);margin-bottom:4px">AI-SUGGESTED PRESCRIPTION</div>
                  <div style="display:flex;gap:6px">
                    <span class="pill teal">ICMR Aligned</span>
                    <span class="pill gold">3 Interactions Checked</span>
                  </div>
                </div>

                <div class="rx-item">
                  <div class="rx-drug">Aspirin <span class="rx-generic">IP Branded</span></div>
                  <div class="rx-dose">300mg stat, then 75mg OD</div>
                  <div class="rx-duration">📅 Lifelong · Antiplatelet</div>
                </div>
                <div class="rx-item">
                  <div class="rx-drug">Ticagrelor <span class="rx-generic">Generic ✓</span></div>
                  <div class="rx-dose">180mg loading, then 90mg BD</div>
                  <div class="rx-duration">📅 12 months · P2Y12 inhibitor</div>
                </div>
                <div class="rx-item">
                  <div class="rx-drug">Enoxaparin <span class="rx-generic">Generic ✓</span></div>
                  <div class="rx-dose">1mg/kg SC BD (eGFR 72 — standard)</div>
                  <div class="rx-duration">📅 Until cath · LMWH</div>
                </div>
                <div class="rx-item">
                  <div class="rx-drug">Rosuvastatin <span class="rx-generic">Jan Aushadhi</span></div>
                  <div class="rx-dose">40mg OD at bedtime</div>
                  <div class="rx-duration">📅 Lifelong · High-intensity statin</div>
                </div>
                <div class="rx-item">
                  <div class="rx-drug">Metoprolol Succinate</div>
                  <div class="rx-dose">25mg BD (continue existing)</div>
                  <div class="rx-duration">📅 Continue · Beta blocker</div>
                  <div class="rx-warning">⚠ Hold if HR &lt;50 or SBP &lt;90</div>
                </div>
                <div class="rx-item" style="border:1px dashed rgba(255,77,109,0.3);background:var(--red-dim)">
                  <div class="rx-drug" style="color:var(--red)">⛔ HOLD — Metformin</div>
                  <div class="rx-dose">Suspend current 1000mg BD</div>
                  <div class="rx-duration" style="color:var(--red)">Pre-contrast dye · Resume 48h post-cath</div>
                </div>

                <div style="margin-top:14px">
                  <button class="add-rx-btn" onclick="showView('prescription')">+ Add Drug</button>
                </div>
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button class="btn btn-primary btn-sm" style="flex:1;justify-content:center" onclick="printPrescriptionFromConsult()">🖨 Print Rx</button>
                  <button class="btn btn-ghost btn-sm" style="flex:1;justify-content:center" onclick="shareViaWhatsApp()">📲 WhatsApp</button>
                </div>
              </div>

              <!-- Labs Tab -->
              <div class="tab-content" id="tab-labs">
                <div style="margin-bottom:10px;font-size:0.72rem;color:var(--text3)">Priya K. · Today 08:45 AM · Auto-interpreted</div>
                <div class="lab-item"><span class="lab-name">Troponin I</span><span class="lab-val high">0.08 ng/mL ↑</span></div>
                <div class="lab-item"><span class="lab-name">CK-MB</span><span class="lab-val high">28 U/L ↑</span></div>
                <div class="lab-item"><span class="lab-name">BNP</span><span class="lab-val high">290 pg/mL ↑</span></div>
                <div class="lab-item"><span class="lab-name">LDL-C</span><span class="lab-val high">168 mg/dL ↑</span></div>
                <div class="lab-item"><span class="lab-name">HDL-C</span><span class="lab-val low">38 mg/dL ↓</span></div>
                <div class="lab-item"><span class="lab-name">Triglycerides</span><span class="lab-val high">210 mg/dL ↑</span></div>
                <div class="lab-item"><span class="lab-name">HbA1c</span><span class="lab-val high">8.4% ↑</span></div>
                <div class="lab-item"><span class="lab-name">FBS</span><span class="lab-val high">186 mg/dL ↑</span></div>
                <div class="lab-item"><span class="lab-name">Serum Creatinine</span><span class="lab-val normal">1.0 mg/dL</span></div>
                <div class="lab-item"><span class="lab-name">eGFR</span><span class="lab-val normal">72 mL/min</span></div>
                <div class="lab-item"><span class="lab-name">Serum K⁺</span><span class="lab-val normal">4.1 mEq/L</span></div>
                <div class="lab-item"><span class="lab-name">Serum Na⁺</span><span class="lab-val normal">138 mEq/L</span></div>
                <div class="lab-item"><span class="lab-name">INR</span><span class="lab-val normal">1.1</span></div>
                <div class="lab-item"><span class="lab-name">Hb</span><span class="lab-val low">10.8 g/dL ↓</span></div>
                <div class="divider"></div>
                <div class="warning-box">
                  <span class="icon">🤖</span>
                  <span class="text" style="color:var(--gold)">AI Interpretation: Elevated cardiac biomarkers with dyslipidemia and uncontrolled DM. High-risk ACS profile. Urgent cath lab evaluation recommended.</span>
                </div>
              </div>

              <!-- History Tab -->
              <div class="tab-content" id="tab-history">
                <div style="font-size:0.72rem;color:var(--text3);margin-bottom:12px">Past 12 Visits · AIIMS Delhi</div>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:10px">
                    <div style="font-size:0.75rem;color:var(--text3)">12 Nov 2025 · Cardiology OPD</div>
                    <div style="font-size:0.82rem;font-weight:600;color:var(--text1);margin:3px 0">Hypertension Review</div>
                    <div style="font-size:0.75rem;color:var(--text2)">BP 152/94 → Amlodipine increased to 5mg. HbA1c 7.8. Advised DASH diet.</div>
                  </div>
                  <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:10px">
                    <div style="font-size:0.75rem;color:var(--text3)">8 Aug 2025 · Cardiology OPD</div>
                    <div style="font-size:0.82rem;font-weight:600;color:var(--text1);margin:3px 0">Dyslipidemia Follow-up</div>
                    <div style="font-size:0.75rem;color:var(--text2)">LDL 182 → Atorvastatin 40mg started. Echo: mild LV hypertrophy.</div>
                  </div>
                  <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:10px">
                    <div style="font-size:0.75rem;color:var(--text3)">3 Apr 2025 · Emergency</div>
                    <div style="font-size:0.82rem;font-weight:600;color:var(--text1);margin:3px 0">Hypertensive Urgency</div>
                    <div style="font-size:0.75rem;color:var(--text2)">BP 190/110. Admitted 48h. IV Labetalol. Discharged stable.</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ── PATIENTS VIEW ── -->
      <div class="view" id="view-patients">
        <div class="patients-view">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
            <div>
              <div class="section-title">Patient Registry</div>
              <div class="section-sub">482 total patients · 24 active today</div>
            </div>
            <button class="btn btn-primary" onclick="openModal()">+ Register Patient</button>
          </div>

          <div class="table-wrap">
            <div class="table-header">
              <div class="filter-row">
                <button class="filter-btn active" onclick="filterPatients(this,'all')">All</button>
                <button class="filter-btn" onclick="filterPatients(this,'cardiology')">Cardiology</button>
                <button class="filter-btn" onclick="filterPatients(this,'high-risk')">High Risk</button>
                <button class="filter-btn" onclick="filterPatients(this,'today')">Today</button>
                <button class="filter-btn" onclick="filterPatients(this,'critical')">Critical</button>
              </div>
              <div class="search-bar" style="width:200px">
                <span>🔍</span><input type="text" placeholder="Search patient…">
              </div>
            </div>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>ID</th>
                  <th>Age/Sex</th>
                  <th>Specialization</th>
                  <th>Last Visit</th>
                  <th>Risk Score</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><div class="td-name">Priya Krishnamurthy</div><div style="font-size:0.72rem;color:var(--text3)">DM2, HTN, Dyslipidemia</div></td>
                  <td class="td-id">MM-2024-04521</td>
                  <td>52F</td>
                  <td><span class="pill teal">Cardiology</span></td>
                  <td>Today</td>
                  <td><span style="color:var(--red);font-family:var(--mono);font-weight:600">82% ↑</span></td>
                  <td><span class="status-badge urgent">Urgent</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('PK','Priya Krishnamurthy')">Consult</button></td>
                </tr>
                <tr>
                  <td><div class="td-name">Ramesh Singh</div><div style="font-size:0.72rem;color:var(--text3)">CAD, Post CABG</div></td>
                  <td class="td-id">MM-2023-01892</td>
                  <td>67M</td>
                  <td><span class="pill teal">Cardiology</span></td>
                  <td>Today</td>
                  <td><span style="color:var(--gold);font-family:var(--mono);font-weight:600">67% ↑</span></td>
                  <td><span class="status-badge active">Active</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('RS','Ramesh Singh')">Consult</button></td>
                </tr>
                <tr>
                  <td><div class="td-name">Anita Mehta</div><div style="font-size:0.72rem;color:var(--text3)">Palpitations, SOB · New</div></td>
                  <td class="td-id">MM-2025-09341</td>
                  <td>38F</td>
                  <td><span class="pill purple">Cardiology</span></td>
                  <td>Today</td>
                  <td><span style="color:var(--teal);font-family:var(--mono);font-weight:600">31%</span></td>
                  <td><span class="status-badge waiting">Waiting</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('AM','Anita Mehta')">Consult</button></td>
                </tr>
                <tr>
                  <td><div class="td-name">Vikram Nair</div><div style="font-size:0.72rem;color:var(--text3)">Hypertension management</div></td>
                  <td class="td-id">MM-2024-07234</td>
                  <td>44M</td>
                  <td><span class="pill teal">Cardiology</span></td>
                  <td>Today</td>
                  <td><span style="color:var(--gold);font-family:var(--mono);font-weight:600">55%</span></td>
                  <td><span class="status-badge waiting">Waiting</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('VN','Vikram Nair')">Consult</button></td>
                </tr>
                <tr>
                  <td><div class="td-name">Sunita Gupta</div><div style="font-size:0.72rem;color:var(--text3)">Post-STEMI, Cardiac rehab</div></td>
                  <td class="td-id">MM-2025-02218</td>
                  <td>61F</td>
                  <td><span class="pill teal">Cardiology</span></td>
                  <td>Today</td>
                  <td><span style="color:var(--teal);font-family:var(--mono);font-weight:600">38%</span></td>
                  <td><span class="status-badge stable">Stable</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('SG','Sunita Gupta')">Consult</button></td>
                </tr>
                <tr>
                  <td><div class="td-name">Mohan Pillai</div><div style="font-size:0.72rem;color:var(--text3)">Epilepsy, migraines</div></td>
                  <td class="td-id">MM-2024-05512</td>
                  <td>35M</td>
                  <td><span class="pill" style="background:rgba(96,165,250,0.1);color:#60A5FA;border-color:rgba(96,165,250,0.2)">Neurology</span></td>
                  <td>22 Feb</td>
                  <td><span style="color:var(--teal);font-family:var(--mono);font-weight:600">22%</span></td>
                  <td><span class="status-badge stable">Stable</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('MP','Mohan Pillai')">Consult</button></td>
                </tr>
                <tr>
                  <td><div class="td-name">Nandini Bose</div><div style="font-size:0.72rem;color:var(--text3)">Hypothyroidism, PCOS</div></td>
                  <td class="td-id">MM-2025-08876</td>
                  <td>29F</td>
                  <td><span class="pill" style="background:rgba(249,115,22,0.1);color:#FB923C;border-color:rgba(249,115,22,0.2)">Endocrinology</span></td>
                  <td>20 Feb</td>
                  <td><span style="color:var(--teal);font-family:var(--mono);font-weight:600">18%</span></td>
                  <td><span class="status-badge stable">Stable</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('NB','Nandini Bose')">Consult</button></td>
                </tr>
                <tr>
                  <td><div class="td-name">Deepak Kumar</div><div style="font-size:0.72rem;color:var(--text3)">COPD, asthma overlap</div></td>
                  <td class="td-id">MM-2023-03345</td>
                  <td>58M</td>
                  <td><span class="pill" style="background:rgba(45,212,191,0.1);color:#2DD4BF;border-color:rgba(45,212,191,0.2)">Pulmonology</span></td>
                  <td>18 Feb</td>
                  <td><span style="color:var(--gold);font-family:var(--mono);font-weight:600">49%</span></td>
                  <td><span class="status-badge stable">Stable</span></td>
                  <td><button class="action-btn" onclick="openConsultForPatient('DK','Deepak Kumar')">Consult</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ── RISK PREDICTION VIEW ── -->
      <div class="view" id="view-risk">
        <div class="risk-view">

          <!-- Header row -->
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:18px">
            <div>
              <div class="section-title">🔮 Predictive Health Risk Engine</div>
              <div class="section-sub">ML models predict chronic disease onset 6–18 months ahead · ICMR 2024 validated · Select a patient to view their risk profile</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <select id="riskPatientSelect" onchange="renderRiskPage(this.value)"
                style="padding:9px 14px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);font-size:0.85rem;min-width:230px;cursor:pointer">
                <option value="">— Select patient to analyse —</option>
              </select>
              <button class="btn btn-primary btn-sm" onclick="runAIRiskAnalysis()">🤖 AI Risk Analysis</button>
              <button class="btn btn-ghost btn-sm" onclick="exportRiskReport()">⬇ Export</button>
            </div>
          </div>

          <!-- ══ Per-patient risk dashboard (hidden until selection) ══ -->
          <div id="riskPatientDashboard" style="display:none;margin-bottom:20px">

            <!-- Patient banner -->
            <div id="riskBanner" style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap"></div>

            <!-- Four risk gauge tiles -->
            <div id="riskGauges" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px"></div>

            <!-- Risk factors + Interventions side by side -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
              <div class="card">
                <div class="card-header">
                  <span class="card-title">⚠️ Identified Risk Factors</span>
                  <span id="overallRiskBadge" class="pill teal" style="font-size:0.72rem">—</span>
                </div>
                <div class="card-body" id="riskFactorsList" style="padding-top:4px"></div>
              </div>
              <div class="card">
                <div class="card-header"><span class="card-title">🛡️ Recommended Interventions</span></div>
                <div class="card-body" id="riskInterventionsList" style="padding-top:4px"></div>
              </div>
            </div>

            <!-- AI narrative panel -->
            <div class="card">
              <div class="card-header">
                <span class="card-title">🤖 AI Clinical Risk Narrative</span>
                <span id="riskAIStatusBadge" class="pill" style="background:var(--navy3);color:var(--text3);font-size:0.72rem">Click AI Risk Analysis →</span>
              </div>
              <div id="riskAINarrative" class="card-body" style="font-size:0.85rem;color:var(--text2);line-height:1.75;min-height:64px">
                Click <strong>AI Risk Analysis</strong> above to generate a personalised clinical risk narrative for this patient.
              </div>
            </div>
          </div>

          <!-- ══ Overview panel (shown when no patient selected) ══ -->
          <div id="riskOverviewPanel">

            <!-- ML model info cards -->
            <div class="risk-grid" style="margin-bottom:20px">
              <div class="risk-model-card">
                <div class="bg-orb" style="background:var(--red)"></div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:1.2rem">❤️</span><span class="pill red">MACE Model v3.1</span>
                </div>
                <div class="risk-model-title">Cardiac Event Prediction</div>
                <div class="risk-model-accuracy" style="color:var(--red)">88%</div>
                <div style="font-size:0.68rem;color:var(--text3);margin-bottom:4px">AUC-ROC · Deep Neural Net + ECG analysis</div>
                <div class="risk-model-desc">Predicts MACE (MI, stroke, cardiac death) within 6–18 months using lipid trends, ECG features, troponin history, and TIMI inputs.</div>
                <div class="risk-model-features">
                  <span class="feature-tag">Lipid trend</span><span class="feature-tag">ECG features</span>
                  <span class="feature-tag">TIMI inputs</span><span class="feature-tag">BP history</span>
                </div>
              </div>
              <div class="risk-model-card">
                <div class="bg-orb" style="background:var(--cyan)"></div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:1.2rem">🩸</span>
                  <span class="pill" style="background:rgba(56,189,248,0.1);color:var(--cyan);border-color:rgba(56,189,248,0.2)">DM Model v2.4</span>
                </div>
                <div class="risk-model-title">Type 2 Diabetes Prediction</div>
                <div class="risk-model-accuracy" style="color:var(--cyan)">91%</div>
                <div style="font-size:0.68rem;color:var(--text3);margin-bottom:4px">AUC-ROC · XGBoost + LSTM ensemble</div>
                <div class="risk-model-desc">Predicts T2DM onset using FBS trends, BMI trajectory, family history, diet score, and HbA1c progression over time.</div>
                <div class="risk-model-features">
                  <span class="feature-tag">FBS trend</span><span class="feature-tag">BMI</span>
                  <span class="feature-tag">HbA1c trajectory</span><span class="feature-tag">Diet score</span>
                </div>
              </div>
              <div class="risk-model-card">
                <div class="bg-orb" style="background:var(--gold)"></div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:1.2rem">🩺</span><span class="pill gold">HTN Model v2.0</span>
                </div>
                <div class="risk-model-title">Hypertension Onset</div>
                <div class="risk-model-accuracy" style="color:var(--gold)">89%</div>
                <div style="font-size:0.68rem;color:var(--text3);margin-bottom:4px">AUC-ROC · Random Forest + Time-series</div>
                <div class="risk-model-desc">Predicts primary hypertension onset using BP readings, salt intake, stress scores, sleep quality, and physical activity data.</div>
                <div class="risk-model-features">
                  <span class="feature-tag">BP readings</span><span class="feature-tag">Salt intake</span>
                  <span class="feature-tag">Sleep quality</span><span class="feature-tag">Activity</span>
                </div>
              </div>
            </div>

            <!-- All-patients risk table -->
            <div class="card" style="margin-bottom:20px">
              <div class="card-header">
                <span class="card-title">📊 All Patients — Computed Risk Overview</span>
                <span id="riskTableCount" class="pill teal">Loading…</span>
              </div>
              <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse;font-size:0.82rem">
                  <thead>
                    <tr style="border-bottom:1px solid var(--border)">
                      <th style="padding:12px 16px;text-align:left;color:var(--text3);font-weight:600;font-size:0.7rem;text-transform:uppercase;letter-spacing:.7px">Patient</th>
                      <th style="padding:12px 10px;text-align:center;color:var(--text3);font-weight:600;font-size:0.7rem;text-transform:uppercase;letter-spacing:.7px">❤️ Cardiac</th>
                      <th style="padding:12px 10px;text-align:center;color:var(--text3);font-weight:600;font-size:0.7rem;text-transform:uppercase;letter-spacing:.7px">🩸 Diabetes</th>
                      <th style="padding:12px 10px;text-align:center;color:var(--text3);font-weight:600;font-size:0.7rem;text-transform:uppercase;letter-spacing:.7px">💉 HTN</th>
                      <th style="padding:12px 10px;text-align:center;color:var(--text3);font-weight:600;font-size:0.7rem;text-transform:uppercase;letter-spacing:.7px">🩺 CKD</th>
                      <th style="padding:12px 10px;text-align:center;color:var(--text3);font-weight:600;font-size:0.7rem;text-transform:uppercase;letter-spacing:.7px">Overall</th>
                      <th style="padding:12px 10px;text-align:center;color:var(--text3);font-weight:600;font-size:0.7rem;text-transform:uppercase;letter-spacing:.7px">Action</th>
                    </tr>
                  </thead>
                  <tbody id="riskTableBody"></tbody>
                </table>
              </div>
            </div>

            <!-- Bottom: model perf + prediction windows -->
            <div class="grid-2">
              <div class="card">
                <div class="card-header"><span class="card-title">🎯 Model Performance</span><span class="pill teal">Live Metrics</span></div>
                <div class="card-body">
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:12px;text-align:center">
                      <div style="font-family:var(--syne);font-size:2rem;font-weight:800;color:var(--cyan)">91%</div>
                      <div style="font-size:0.7rem;color:var(--text3)">T2DM AUC-ROC</div>
                    </div>
                    <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:12px;text-align:center">
                      <div style="font-family:var(--syne);font-size:2rem;font-weight:800;color:var(--red)">88%</div>
                      <div style="font-size:0.7rem;color:var(--text3)">Cardiac AUC-ROC</div>
                    </div>
                    <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:12px;text-align:center">
                      <div style="font-family:var(--syne);font-size:2rem;font-weight:800;color:var(--gold)">89%</div>
                      <div style="font-size:0.7rem;color:var(--text3)">HTN AUC-ROC</div>
                    </div>
                    <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:12px;text-align:center">
                      <div style="font-family:var(--syne);font-size:2rem;font-weight:800;color:var(--purple)">10M+</div>
                      <div style="font-size:0.7rem;color:var(--text3)">Training Cases</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><span class="card-title">📅 Prediction Windows</span></div>
                <div class="card-body">
                  <div style="font-size:0.82rem;color:var(--text2);line-height:2">
                    🕐 <strong style="color:var(--text1)">6-month:</strong> Acute onset risks (MI, stroke, DKA)<br>
                    🗓 <strong style="color:var(--text1)">12-month:</strong> Chronic progression (CKD, retinopathy)<br>
                    📆 <strong style="color:var(--text1)">18-month:</strong> Lifestyle-preventable (T2DM, HTN onset)
                  </div>
                  <div class="divider"></div>
                  <div style="font-size:0.75rem;color:var(--text3)">Models retrained monthly on Indian clinical data. Last update: 20 Feb 2026.</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>


      <!-- ── SPECIALIZATIONS VIEW ── -->
      <div class="view" id="view-specs">
        <div class="spec-view">
          <div style="margin-bottom:20px">
            <div class="section-title">Clinical Specializations</div>
            <div class="section-sub">40+ allopathic specializations with India-trained models, ICMR guidelines, and specialty-specific diagnostic intelligence</div>
          </div>
          <div class="spec-grid">
            <div class="spec-card active" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🫀</div>
              <div class="spec-name">Cardiology</div>
              <div class="spec-cases">240K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🧠</div>
              <div class="spec-name">Neurology</div>
              <div class="spec-cases">180K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🫁</div>
              <div class="spec-name">Pulmonology</div>
              <div class="spec-cases">160K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🩺</div>
              <div class="spec-name">General Medicine</div>
              <div class="spec-cases">520K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🔬</div>
              <div class="spec-name">Endocrinology</div>
              <div class="spec-cases">210K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🦴</div>
              <div class="spec-name">Orthopedics</div>
              <div class="spec-cases">145K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🤰</div>
              <div class="spec-name">Obstetrics & Gynecology</div>
              <div class="spec-cases">290K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">👶</div>
              <div class="spec-name">Pediatrics</div>
              <div class="spec-cases">310K cases</div>
            </div>
            <div class="spec-card" onclick="showView('radiology')">
              <div class="spec-icon">🩻</div>
              <div class="spec-name">Radiology & Imaging AI</div>
              <div class="spec-cases">95K cases</div>
            </div>
            <div class="spec-card" onclick="showView('dentistry')">
              <div class="spec-icon">🦷</div>
              <div class="spec-name">Dentistry</div>
              <div class="spec-cases">88K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">👁️</div>
              <div class="spec-name">Ophthalmology</div>
              <div class="spec-cases">120K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🧬</div>
              <div class="spec-name">Oncology</div>
              <div class="spec-cases">175K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🩹</div>
              <div class="spec-name">Dermatology</div>
              <div class="spec-cases">140K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🔋</div>
              <div class="spec-name">Nephrology</div>
              <div class="spec-cases">130K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🧫</div>
              <div class="spec-name">Gastroenterology</div>
              <div class="spec-cases">195K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🧪</div>
              <div class="spec-name">Hematology</div>
              <div class="spec-cases">112K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">💭</div>
              <div class="spec-name">Psychiatry</div>
              <div class="spec-cases">156K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🚑</div>
              <div class="spec-name">Emergency Medicine</div>
              <div class="spec-cases">220K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🏥</div>
              <div class="spec-name">General Surgery</div>
              <div class="spec-cases">185K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🫘</div>
              <div class="spec-name">Urology</div>
              <div class="spec-cases">98K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🔊</div>
              <div class="spec-name">ENT</div>
              <div class="spec-cases">108K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🫙</div>
              <div class="spec-name">Rheumatology</div>
              <div class="spec-cases">82K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🦠</div>
              <div class="spec-name">Infectious Disease</div>
              <div class="spec-cases">230K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">💊</div>
              <div class="spec-name">Palliative Care</div>
              <div class="spec-cases">55K cases</div>
            </div>
            <div class="spec-card" onclick="this.closest('.spec-grid').querySelectorAll('.spec-card').forEach(c=>c.classList.remove('active'));this.classList.add('active')">
              <div class="spec-icon">🧓</div>
              <div class="spec-name">Geriatrics</div>
              <div class="spec-cases">90K cases</div>
            </div>
          </div>

          <div class="divider" style="margin-top:20px"></div>
          <div style="display:flex;gap:14px;margin-top:14px;flex-wrap:wrap">
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;flex:1;min-width:160px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--teal)">40+</div>
              <div style="font-size:0.72rem;color:var(--text3);margin-top:3px">Specializations</div>
            </div>
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;flex:1;min-width:160px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--cyan)">10M+</div>
              <div style="font-size:0.72rem;color:var(--text3);margin-top:3px">Indian Clinical Cases</div>
            </div>
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;flex:1;min-width:160px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--gold)">200+</div>
              <div style="font-size:0.72rem;color:var(--text3);margin-top:3px">Clinical Scoring Tools</div>
            </div>
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;flex:1;min-width:160px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--purple)">12</div>
              <div style="font-size:0.72rem;color:var(--text3);margin-top:3px">Indian Languages</div>
            </div>
          </div>
        </div>
      </div>


      <!-- ══ DENTISTRY & ORAL MEDICINE VIEW ══ -->
      <div class="view" id="view-dentistry">
        <div style="max-width:1400px;margin:0 auto;padding:24px 24px 80px">

          <!-- Header -->
          <div style="margin-bottom:24px">
            <div class="section-title">🦷 Dentistry &amp; Oral Medicine</div>
            <div class="section-sub">AI-powered dental diagnosis · Interactive FDI charting · Periodontal assessment · Radiograph analysis · IDA &amp; ICMR guidelines</div>
          </div>

          <!-- KPI row -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px">
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.7rem;font-weight:800;color:var(--teal)" id="kpiTeeth">32</div>
              <div style="font-size:0.7rem;color:var(--text3);margin-top:2px">Teeth Charted</div>
            </div>
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.7rem;font-weight:800;color:var(--red)" id="kpiCaries">0</div>
              <div style="font-size:0.7rem;color:var(--text3);margin-top:2px">Caries / Lesions</div>
            </div>
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.7rem;font-weight:800;color:var(--gold)" id="kpiPockets">0</div>
              <div style="font-size:0.7rem;color:var(--text3);margin-top:2px">Pockets ≥4 mm</div>
            </div>
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;text-align:center">
              <div style="font-family:var(--syne);font-size:1.7rem;font-weight:800;color:var(--purple)" id="kpiProcs">0</div>
              <div style="font-size:0.7rem;color:var(--text3);margin-top:2px">Procedures Planned</div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 370px;gap:20px;align-items:start">

            <!-- ── LEFT COLUMN ───────────────────────────────────── -->
            <div style="display:flex;flex-direction:column;gap:18px">

              <!-- DENTAL CHART CARD -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">🦷 Interactive Dental Chart (FDI Notation)</span>
                  <div style="display:flex;gap:6px">
                    <button class="btn btn-ghost btn-sm" onclick="dcClear()">🗑 Clear</button>
                    <button class="btn btn-ghost btn-sm" onclick="dcPrint()">🖨 Print</button>
                  </div>
                </div>
                <div class="card-body" style="padding:18px">

                  <!-- Legend -->
                  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px">
                    <span style="font-size:0.68rem;color:var(--text3)">Click a tooth to mark:</span>
                    <div id="dcCondBtn-healthy" data-cond="healthy" onclick="dcSetCond(this)"
                         style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:3px 9px;border-radius:20px;background:var(--green);color:var(--navy);font-size:0.7rem;font-weight:700">● Healthy</div>
                    <div id="dcCondBtn-caries"  data-cond="caries"  onclick="dcSetCond(this)"
                         style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:3px 9px;border-radius:20px;background:var(--navy3);border:1.5px solid var(--red);color:var(--red);font-size:0.7rem;font-weight:600">● Caries</div>
                    <div id="dcCondBtn-filled"  data-cond="filled"  onclick="dcSetCond(this)"
                         style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:3px 9px;border-radius:20px;background:var(--navy3);border:1.5px solid var(--gold);color:var(--gold);font-size:0.7rem;font-weight:600">● Filled</div>
                    <div id="dcCondBtn-crown"   data-cond="crown"   onclick="dcSetCond(this)"
                         style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:3px 9px;border-radius:20px;background:var(--navy3);border:1.5px solid var(--purple);color:var(--purple);font-size:0.7rem;font-weight:600">● Crown</div>
                    <div id="dcCondBtn-missing" data-cond="missing" onclick="dcSetCond(this)"
                         style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:3px 9px;border-radius:20px;background:var(--navy3);border:1.5px solid #555;color:var(--text3);font-size:0.7rem;font-weight:600">● Missing</div>
                    <div id="dcCondBtn-rct"     data-cond="rct"     onclick="dcSetCond(this)"
                         style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:3px 9px;border-radius:20px;background:var(--navy3);border:1.5px solid var(--cyan);color:var(--cyan);font-size:0.7rem;font-weight:600">● RCT</div>
                  </div>

                  <!-- Upper arch -->
                  <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--teal);font-weight:700;text-align:center;margin-bottom:6px">Upper Arch — Maxillary</div>
                  <div id="dcUpper" style="display:flex;justify-content:center;gap:3px;margin-bottom:4px"></div>
                  <div style="display:flex;justify-content:center;gap:0;margin-bottom:14px">
                    <div style="width:50%;text-align:center;font-size:0.58rem;color:var(--text3)">← UR (Right)</div>
                    <div style="width:50%;text-align:center;font-size:0.58rem;color:var(--text3)">UL (Left) →</div>
                  </div>

                  <!-- Lower arch -->
                  <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--teal);font-weight:700;text-align:center;margin-bottom:6px">Lower Arch — Mandibular</div>
                  <div id="dcLower" style="display:flex;justify-content:center;gap:3px;margin-bottom:4px"></div>
                  <div style="display:flex;justify-content:center;gap:0">
                    <div style="width:50%;text-align:center;font-size:0.58rem;color:var(--text3)">← LR (Right)</div>
                    <div style="width:50%;text-align:center;font-size:0.58rem;color:var(--text3)">LL (Left) →</div>
                  </div>

                  <!-- Chart summary -->
                  <div id="dcSummary" style="margin-top:16px;padding:10px 12px;background:var(--navy3);border-radius:8px;font-size:0.78rem;color:var(--text3)">
                    Click any tooth to mark its condition. All teeth currently marked Healthy.
                  </div>
                </div>
              </div>

              <!-- PERIODONTAL CHART -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">📏 Periodontal Pocket Depth Chart (mm)</span>
                  <button class="btn btn-ghost btn-sm" onclick="runPerioAI()">🤖 AI Perio Classification</button>
                </div>
                <div class="card-body">
                  <div style="font-size:0.72rem;color:var(--text3);margin-bottom:12px">Enter probing depths for index teeth · ≥4 mm = pathological · ≥6 mm = advanced disease</div>
                  <div id="perioGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px"></div>
                  <div id="perioSummary" style="margin-top:12px;padding:10px 12px;background:var(--navy3);border-radius:8px;font-size:0.78rem;color:var(--text3)">
                    Enter pocket depths to see automated classification
                  </div>
                </div>
              </div>

              <!-- DENTAL X-RAY AI -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">🩻 Dental Radiograph AI Analysis</span>
                  <span class="card-action" onclick="document.getElementById('dentalXrayInput').click()">+ Upload</span>
                </div>
                <div class="card-body">
                  <input type="file" id="dentalXrayInput" accept="image/*,.pdf" style="display:none" onchange="handleDentalXray(event)">
                  <div id="xrayDropZone"
                       style="border:2px dashed var(--border2);border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:all 0.2s"
                       onclick="document.getElementById('dentalXrayInput').click()"
                       ondragover="event.preventDefault();this.style.borderColor='var(--teal)'"
                       ondragleave="this.style.borderColor='var(--border2)'"
                       ondrop="event.preventDefault();this.style.borderColor='var(--border2)';handleDentalXrayFiles(event.dataTransfer.files)">
                    <div style="font-size:2.5rem;margin-bottom:8px">🩻</div>
                    <div style="font-size:0.88rem;font-weight:600;color:var(--text1);margin-bottom:4px">Upload OPG, periapical, or bitewing</div>
                    <div style="font-size:0.74rem;color:var(--text3)">JPEG · PNG · DICOM · PDF · Drag &amp; drop supported</div>
                  </div>
                  <div id="xrayResult" style="display:none;margin-top:14px"></div>
                </div>
              </div>

            </div><!-- end left col -->

            <!-- ── RIGHT COLUMN ──────────────────────────────────── -->
            <div style="display:flex;flex-direction:column;gap:18px">

              <!-- CHIEF COMPLAINT & HISTORY -->
              <div class="card">
                <div class="card-header"><span class="card-title">🩺 Clinical Intake</span></div>
                <div class="card-body">
                  <div style="display:flex;flex-direction:column;gap:10px">
                    <div class="form-group">
                      <label class="form-label">Chief Complaint</label>
                      <select class="form-select" id="dcComplaint">
                        <option value="">— Select complaint —</option>
                        <option>Toothache / dental pain</option>
                        <option>Sensitivity to cold / hot / sweet</option>
                        <option>Bleeding gums on brushing</option>
                        <option>Swollen gum or facial swelling</option>
                        <option>Tooth mobility / loosening</option>
                        <option>Broken or chipped tooth</option>
                        <option>Post-extraction pain / dry socket</option>
                        <option>Mouth ulcer or white patch</option>
                        <option>Jaw pain / clicking / TMJ</option>
                        <option>Halitosis (bad breath)</option>
                        <option>Difficulty chewing or biting</option>
                        <option>Teeth grinding / bruxism</option>
                        <option>Tooth sensitivity after filling</option>
                        <option>Implant pain or loosening</option>
                        <option>Routine examination &amp; scaling</option>
                      </select>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                      <div class="form-group">
                        <label class="form-label">Pain (0–10)</label>
                        <input class="form-input" type="number" min="0" max="10" id="dcPain" placeholder="0 = none">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Duration</label>
                        <select class="form-select" id="dcDuration">
                          <option value="">—</option>
                          <option>&lt; 24 hours</option>
                          <option>1–3 days</option>
                          <option>1 week</option>
                          <option>2–4 weeks</option>
                          <option>&gt; 1 month</option>
                          <option>Chronic / recurring</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Relevant Medical / Drug History</label>
                      <input class="form-input" id="dcMedHx" placeholder="DM, HTN, anticoagulants, penicillin allergy…">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Additional Notes</label>
                      <textarea class="form-input" id="dcNotes" rows="2" placeholder="Any additional findings or patient description…" style="resize:vertical"></textarea>
                    </div>
                    <button class="btn btn-primary" style="width:100%;margin-top:4px" onclick="runDentalAI()">
                      🤖 Generate AI Diagnosis &amp; Treatment Plan
                    </button>
                  </div>
                </div>
              </div>

              <!-- AI OUTPUT -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">🧬 AI Assessment</span>
                  <button class="btn btn-ghost btn-sm" onclick="copyDentalAssessment()">📋 Copy</button>
                </div>
                <div class="card-body" id="dcAIOutput" style="min-height:160px">
                  <div style="text-align:center;padding:32px 12px;color:var(--text3)">
                    <div style="font-size:2rem;margin-bottom:8px">🦷</div>
                    <div style="font-size:0.84rem;font-weight:600;color:var(--text2)">Fill in the clinical intake</div>
                    <div style="font-size:0.74rem;margin-top:4px">Mark teeth on the chart, enter pocket depths,<br>then tap "Generate AI Diagnosis"</div>
                  </div>
                </div>
              </div>

              <!-- PROCEDURE PLANNER -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">📋 Procedure Planner</span>
                  <button class="btn btn-ghost btn-sm" onclick="generateTxSummary()">🖨 Summary</button>
                </div>
                <div class="card-body">
                  <div id="procList" style="display:flex;flex-direction:column;gap:7px;margin-bottom:10px">
                    <div style="font-size:0.76rem;color:var(--text3);text-align:center;padding:14px">AI diagnosis will populate procedures here</div>
                  </div>
                  <div style="display:flex;gap:5px;flex-wrap:wrap">
                    <button class="btn btn-ghost btn-sm" onclick="addProc('Scaling &amp; Root Planing')">+ Scaling</button>
                    <button class="btn btn-ghost btn-sm" onclick="addProc('Composite Restoration')">+ Composite</button>
                    <button class="btn btn-ghost btn-sm" onclick="addProc('Root Canal Treatment')">+ RCT</button>
                    <button class="btn btn-ghost btn-sm" onclick="addProc('Extraction')">+ Extraction</button>
                    <button class="btn btn-ghost btn-sm" onclick="addProc('Crown &amp; Bridge')">+ Crown</button>
                    <button class="btn btn-ghost btn-sm" onclick="addProc('Bleaching / Whitening')">+ Bleaching</button>
                  </div>
                </div>
              </div>

              <!-- DRUG REFERENCE -->
              <div class="card">
                <div class="card-header">
                  <span class="card-title">💊 Dental Pharmacology</span>
                  <button class="btn btn-ghost btn-sm" onclick="runDentalDrugAI()">🤖 AI Rx</button>
                </div>
                <div class="card-body">
                  <div style="display:flex;flex-direction:column;gap:7px">
                    <div style="padding:9px 11px;background:var(--navy3);border-radius:8px;font-size:0.78rem">
                      <div style="font-weight:600;color:var(--text1)">Amoxicillin 500mg TDS × 5 days</div>
                      <div style="color:var(--teal);margin-top:2px;font-size:0.72rem">Acute dental abscess · First-line · IDA guidelines</div>
                    </div>
                    <div style="padding:9px 11px;background:var(--navy3);border-radius:8px;font-size:0.78rem">
                      <div style="font-weight:600;color:var(--text1)">Metronidazole 400mg TDS × 5 days</div>
                      <div style="color:var(--teal);margin-top:2px;font-size:0.72rem">Anaerobic infection / ANUG · Combine with Amox if severe</div>
                    </div>
                    <div style="padding:9px 11px;background:var(--navy3);border-radius:8px;font-size:0.78rem">
                      <div style="font-weight:600;color:var(--text1)">Ibuprofen 400mg TDS after food</div>
                      <div style="color:var(--teal);margin-top:2px;font-size:0.72rem">Dental pain · Avoid if peptic ulcer; use Paracetamol 500mg TDS</div>
                    </div>
                    <div style="padding:9px 11px;background:var(--navy3);border-radius:8px;font-size:0.78rem">
                      <div style="font-weight:600;color:var(--text1)">Chlorhexidine 0.2% mouthwash BD × 14 days</div>
                      <div style="color:var(--teal);margin-top:2px;font-size:0.72rem">Post-extraction / perio maintenance / ANUG</div>
                    </div>
                    <div id="dcDrugAIOutput" style="display:none"></div>
                  </div>
                </div>
              </div>

            </div><!-- end right col -->
          </div><!-- end grid -->
        </div>
      </div><!-- end view-dentistry -->

      <!-- ── PRESCRIPTION VIEW ── -->
      <div class="view" id="view-prescription">
        <div style="padding:22px;max-width:900px">
          <div style="margin-bottom:20px">
            <div class="section-title">💊 Prescription Builder</div>
            <div class="section-sub">ICMR guidelines · Indian Pharmacopoeia · Jan Aushadhi formulary · Drug interaction checker</div>
          </div>
          <div class="grid-2" style="align-items:start">
            <div>
              <div class="card" style="margin-bottom:16px">
                <div class="card-header"><span class="card-title">Drug Search</span><span class="pill teal">18,000+ molecules</span></div>
                <div class="card-body">
                  <div class="search-bar" style="width:100%;margin-bottom:12px">
                    <span>🔍</span><input type="text" placeholder="Search drug name, generic, or condition…">
                  </div>
                  <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
                    <span class="tag">Aspirin</span><span class="tag">Metformin</span><span class="tag">Atorvastatin</span>
                    <span class="tag">Amlodipine</span><span class="tag">Ticagrelor</span><span class="tag gold">+ Add Drug</span>
                  </div>
                  <div class="divider"></div>
                  <div style="font-size:0.75rem;color:var(--text3);margin-bottom:8px">AI-SUGGESTED FOR NSTEMI + DM2 (ICMR 2024)</div>
                  <div style="display:flex;flex-direction:column;gap:8px">
                    <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:12px">
                      <div style="flex:1">
                        <div style="font-size:0.85rem;font-weight:600;color:var(--text1)">Aspirin 300mg → 75mg OD</div>
                        <div style="font-size:0.72rem;color:var(--teal)">Antiplatelet · Lifelong · Jan Aushadhi ₹3/strip</div>
                      </div>
                      <button class="btn btn-primary btn-sm" onclick="addDrugToPrescription('Aspirin 300mg → 75mg OD')">Add</button>
                    </div>
                    <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:12px">
                      <div style="flex:1">
                        <div style="font-size:0.85rem;font-weight:600;color:var(--text1)">Ticagrelor 90mg BD</div>
                        <div style="font-size:0.72rem;color:var(--teal)">P2Y12 inhibitor · 12 months · Preferred in DM</div>
                      </div>
                      <button class="btn btn-primary btn-sm" onclick="addDrugToPrescription('Ticagrelor 90mg BD')">Add</button>
                    </div>
                    <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:12px">
                      <div style="flex:1">
                        <div style="font-size:0.85rem;font-weight:600;color:var(--text1)">Rosuvastatin 40mg OD</div>
                        <div style="font-size:0.72rem;color:var(--teal)">High-intensity statin · Lifelong · Jan Aushadhi ₹8/tab</div>
                      </div>
                      <button class="btn btn-primary btn-sm" onclick="addDrugToPrescription('Rosuvastatin 40mg OD')">Add</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><span class="card-title">⚠️ Interaction Checker</span></div>
                <div class="card-body">
                  <div style="display:flex;flex-direction:column;gap:8px">
                    <div style="background:var(--red-dim);border:1px solid rgba(255,77,109,0.2);border-radius:8px;padding:10px 12px">
                      <div style="font-size:0.78rem;font-weight:600;color:var(--red);margin-bottom:3px">⛔ Contraindication</div>
                      <div style="font-size:0.75rem;color:var(--text2)">Metformin + Contrast dye → Hold Metformin 48h before procedure. Risk: Lactic acidosis.</div>
                    </div>
                    <div style="background:var(--gold-dim);border:1px solid rgba(245,166,35,0.2);border-radius:8px;padding:10px 12px">
                      <div style="font-size:0.78rem;font-weight:600;color:var(--gold);margin-bottom:3px">⚠️ Moderate Interaction</div>
                      <div style="font-size:0.75rem;color:var(--text2)">Aspirin + Ticagrelor → Increased bleeding risk. Monitor for signs of GI bleed. Add PPI cover (Pantoprazole 40mg OD).</div>
                    </div>
                    <div style="background:var(--green-dim);border:1px solid rgba(34,211,166,0.2);border-radius:8px;padding:10px 12px">
                      <div style="font-size:0.78rem;font-weight:600;color:var(--green);margin-bottom:3px">✓ No interaction</div>
                      <div style="font-size:0.75rem;color:var(--text2)">Rosuvastatin + Amlodipine + Metoprolol — No significant interactions. Enoxaparin safe with current regimen.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><span class="card-title">📄 Prescription Preview</span><span class="pill gold">Digital Rx</span></div>
              <div class="card-body">
                <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:10px;padding:18px">
                  <div style="text-align:center;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)">
                    <div style="font-family:var(--syne);font-size:1.1rem;font-weight:800;color:var(--teal)">SamarthaaMed</div>
                    </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:12px">
                    <div><div style="font-size:0.75rem;color:var(--text3)">Patient</div><div style="font-size:0.85rem;font-weight:600;color:var(--text1)">Priya Krishnamurthy</div><div style="font-size:0.72rem;color:var(--text3)">52F · MM-2024-04521</div></div>
                    <div style="text-align:right"><div style="font-size:0.75rem;color:var(--text3)">Date</div><div style="font-size:0.82rem;color:var(--text1)">24 Feb 2026</div></div>
                  </div>
                  <div style="font-size:0.78rem;font-weight:600;color:var(--text3);margin-bottom:8px;letter-spacing:0.5px">Rₓ</div>
                  <div style="font-size:0.8rem;color:var(--text2);line-height:2.2">
                    1. Tab Aspirin 300mg stat, then 75mg OD — Lifelong<br>
                    2. Tab Ticagrelor 90mg BD — 12 months<br>
                    3. Inj Enoxaparin 60mg (1mg/kg) SC BD — Until cath<br>
                    4. Tab Rosuvastatin 40mg HS — Lifelong<br>
                    5. Tab Metoprolol Succinate 25mg BD — Continue<br>
                    6. <span style="color:var(--red)">HOLD Metformin until post-cath</span>
                  </div>
                  <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">
                    <div style="font-size:0.7rem;color:var(--text3)">Advice: Urgent cath lab evaluation. Low-salt diet. Cardiac rehab referral.</div>
                  </div>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px">
                  <button class="btn btn-primary" style="flex:1;justify-content:center" onclick="showToast('🖨','Printing prescription…','PDF sent to printer queue')">🖨 Print</button>
                  <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="showToast('📲','Sent via WhatsApp','Prescription shared with patient')">📲 WhatsApp</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    

<!-- ── LAB RESULTS VIEW ── -->
      <div class="view" id="view-labs">
        <div class="lab-view">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
            <div>
              <div class="section-title">🧪 Lab Results</div>
              <div class="section-sub">Enter, review, and track patient laboratory investigations with AI interpretation</div>
            </div>
            <div style="display:flex;gap:8px">
              <select class="form-select" id="labPatientSelect" style="width:220px" onchange="loadPatientLabs(this.value)">
                <option value="priya">Priya Krishnamurthy · MM-2024-04521</option>
                <option value="ramesh">Ramesh Singh · MM-2023-01892</option>
                <option value="anita">Anita Mehta · MM-2025-09341</option>
                <option value="vikram">Vikram Nair · MM-2024-07234</option>
              </select>
              <button class="btn btn-primary" onclick="openLabEntry()">+ Enter Lab Results</button>
            </div>
          </div>

          <!-- Lab tabs -->
          <div class="lab-tabs">
            <button class="lab-tab active" onclick="switchLabPanel(this,'cardiac')">❤️ Cardiac Markers</button>
            <button class="lab-tab" onclick="switchLabPanel(this,'metabolic')">🩸 Metabolic Panel</button>
            <button class="lab-tab" onclick="switchLabPanel(this,'lipids')">🧫 Lipid Profile</button>
            <button class="lab-tab" onclick="switchLabPanel(this,'renal')">🫘 Renal Function</button>
            <button class="lab-tab" onclick="switchLabPanel(this,'hematology')">🧬 Hematology</button>
            <button class="lab-tab" onclick="switchLabPanel(this,'thyroid')">🦋 Thyroid</button>
          </div>

          <!-- Cardiac markers panel -->
          <div class="lab-panel active" id="labpanel-cardiac">
            <div class="lab-cards-grid">
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">Troponin I</div><div class="lec-val" style="color:var(--red)">0.08</div><div class="lec-unit">ng/mL</div><div class="lec-ref">Ref: &lt;0.04 ng/mL</div></div>
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">CK-MB</div><div class="lec-val" style="color:var(--red)">28</div><div class="lec-unit">U/L</div><div class="lec-ref">Ref: &lt;25 U/L</div></div>
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">BNP</div><div class="lec-val" style="color:var(--gold)">290</div><div class="lec-unit">pg/mL</div><div class="lec-ref">Ref: &lt;100 pg/mL</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">D-Dimer</div><div class="lec-val" style="color:var(--green)">0.4</div><div class="lec-unit">mg/L FEU</div><div class="lec-ref">Ref: &lt;0.5 mg/L</div></div>
            </div>
            <div class="grid-2">
              <div class="card">
                <div class="card-header"><span class="card-title">📊 Troponin Trend</span><span class="pill teal">Serial monitoring</span></div>
                <div class="card-body">
                  <svg viewBox="0 0 400 100" style="width:100%;height:100px">
                    <defs><linearGradient id="tGrad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#FF4D6D" stop-opacity="0.3"/><stop offset="100%" stop-color="#FF4D6D" stop-opacity="0"/></linearGradient></defs>
                    <path d="M0,85 L60,80 L120,75 L180,60 L240,40 L300,25 L360,15 L400,12" stroke="var(--red)" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <path d="M0,85 L60,80 L120,75 L180,60 L240,40 L300,25 L360,15 L400,12 L400,100 L0,100Z" fill="url(#tGrad)"/>
                    <line x1="0" y1="70" x2="400" y2="70" stroke="var(--border2)" stroke-width="1" stroke-dasharray="4"/>
                    <text x="5" y="68" fill="var(--text3)" font-size="8">0.04 (ULN)</text>
                    <circle cx="400" cy="12" r="4" fill="var(--red)"/>
                    <text x="370" y="9" fill="var(--red)" font-size="9" font-weight="bold">0.08↑</text>
                  </svg>
                  <div style="display:flex;justify-content:space-between;margin-top:4px">
                    <span style="font-size:0.65rem;color:var(--text3)">6h ago</span>
                    <span style="font-size:0.65rem;color:var(--text3)">3h ago</span>
                    <span style="font-size:0.65rem;color:var(--text3)">Now</span>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><span class="card-title">🤖 AI Interpretation</span></div>
                <div class="card-body">
                  <div class="warning-box" style="margin-bottom:10px">
                    <span class="icon">🚨</span>
                    <span class="text">Rising troponin trend confirms myocardial injury. Delta troponin &gt;20% over 3h is diagnostic of NSTEMI per ESC 2023 criteria.</span>
                  </div>
                  <div style="font-size:0.8rem;color:var(--text2);line-height:1.7">
                    • CK-MB elevation corroborates myocardial necrosis<br>
                    • BNP 290 pg/mL indicates early LV dysfunction / increased wall stress<br>
                    • D-Dimer normal — PE less likely<br>
                    • <strong style="color:var(--gold)">Recommend:</strong> Repeat troponin at 1h and 3h. Expedite cath lab evaluation.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Metabolic panel -->
          <div class="lab-panel" id="labpanel-metabolic">
            <div class="lab-cards-grid">
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">Fasting Blood Sugar</div><div class="lec-val" style="color:var(--red)">186</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Ref: 70–100 mg/dL</div></div>
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">HbA1c</div><div class="lec-val" style="color:var(--red)">8.4</div><div class="lec-unit">%</div><div class="lec-ref">Ref: &lt;6.5%</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">Serum Na⁺</div><div class="lec-val" style="color:var(--green)">138</div><div class="lec-unit">mEq/L</div><div class="lec-ref">Ref: 136–145 mEq/L</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">Serum K⁺</div><div class="lec-val" style="color:var(--green)">4.1</div><div class="lec-unit">mEq/L</div><div class="lec-ref">Ref: 3.5–5.0 mEq/L</div></div>
            </div>
          </div>

          <!-- Lipids panel -->
          <div class="lab-panel" id="labpanel-lipids">
            <div class="lab-cards-grid">
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">LDL-C</div><div class="lec-val" style="color:var(--red)">168</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Target: &lt;55 (VHCVR)</div></div>
              <div class="lab-entry-card"><span class="lec-flag L">LOW</span><div class="lec-name">HDL-C</div><div class="lec-val" style="color:var(--cyan)">38</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Ref: &gt;40 mg/dL</div></div>
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">Triglycerides</div><div class="lec-val" style="color:var(--gold)">210</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Ref: &lt;150 mg/dL</div></div>
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">Total Cholesterol</div><div class="lec-val" style="color:var(--gold)">242</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Ref: &lt;200 mg/dL</div></div>
            </div>
          </div>

          <!-- Renal panel -->
          <div class="lab-panel" id="labpanel-renal">
            <div class="lab-cards-grid">
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">Serum Creatinine</div><div class="lec-val" style="color:var(--green)">1.0</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Ref: 0.6–1.2 mg/dL</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">eGFR</div><div class="lec-val" style="color:var(--green)">72</div><div class="lec-unit">mL/min/1.73m²</div><div class="lec-ref">Ref: &gt;60 (CKD G2)</div></div>
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">BUN</div><div class="lec-val" style="color:var(--gold)">22</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Ref: 7–20 mg/dL</div></div>
              <div class="lab-entry-card"><span class="lec-flag H">HIGH</span><div class="lec-name">Uric Acid</div><div class="lec-val" style="color:var(--gold)">7.2</div><div class="lec-unit">mg/dL</div><div class="lec-ref">Ref: 2.4–6.0 F / 3.4–7.0 M</div></div>
            </div>
          </div>

          <!-- Hematology panel -->
          <div class="lab-panel" id="labpanel-hematology">
            <div class="lab-cards-grid">
              <div class="lab-entry-card"><span class="lec-flag L">LOW</span><div class="lec-name">Hemoglobin</div><div class="lec-val" style="color:var(--cyan)">10.8</div><div class="lec-unit">g/dL</div><div class="lec-ref">Ref: 11.5–16.5 (F)</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">WBC Count</div><div class="lec-val" style="color:var(--green)">8.4</div><div class="lec-unit">×10³/µL</div><div class="lec-ref">Ref: 4.5–11.0</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">Platelets</div><div class="lec-val" style="color:var(--green)">210</div><div class="lec-unit">×10³/µL</div><div class="lec-ref">Ref: 150–400</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">INR</div><div class="lec-val" style="color:var(--green)">1.1</div><div class="lec-unit">ratio</div><div class="lec-ref">Ref: 0.8–1.2</div></div>
            </div>
          </div>

          <!-- Thyroid panel -->
          <div class="lab-panel" id="labpanel-thyroid">
            <div class="lab-cards-grid">
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">TSH</div><div class="lec-val" style="color:var(--green)">2.4</div><div class="lec-unit">mIU/L</div><div class="lec-ref">Ref: 0.4–4.0 mIU/L</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">Free T4</div><div class="lec-val" style="color:var(--green)">1.1</div><div class="lec-unit">ng/dL</div><div class="lec-ref">Ref: 0.8–1.8 ng/dL</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">Free T3</div><div class="lec-val" style="color:var(--green)">3.2</div><div class="lec-unit">pg/mL</div><div class="lec-ref">Ref: 2.3–4.2 pg/mL</div></div>
              <div class="lab-entry-card"><span class="lec-flag N">NORMAL</span><div class="lec-name">Anti-TPO Ab</div><div class="lec-val" style="color:var(--green)">12</div><div class="lec-unit">IU/mL</div><div class="lec-ref">Ref: &lt;35 IU/mL</div></div>
            </div>
          </div>

        </div>
      </div>

      <!-- ── IMAGING AI VIEW ── -->
      <div class="view" id="view-imaging" style="overflow-y:auto;height:100%">
        <div class="imaging-view" style="overflow-y:visible">
          <div style="margin-bottom:18px">
            <div class="section-title">🩻 Imaging AI Analysis</div>
            <div class="section-sub">Upload X-rays, ECGs, CT scans, fundus images or ultrasounds for AI-powered analysis</div>
          </div>

          <!-- Scan type selector -->
          <div class="scan-type-bar">
            <div class="scan-type-btn active" onclick="selectScanType(this,'xray')"><span class="s-icon">🫁</span><span class="s-name">Chest X-Ray</span></div>
            <div class="scan-type-btn" onclick="selectScanType(this,'ecg')"><span class="s-icon">📈</span><span class="s-name">ECG / 12-Lead</span></div>
            <div class="scan-type-btn" onclick="selectScanType(this,'ct')"><span class="s-icon">🧠</span><span class="s-name">CT Scan</span></div>
            <div class="scan-type-btn" onclick="selectScanType(this,'echo')"><span class="s-icon">🫀</span><span class="s-name">Echocardiogram</span></div>
            <div class="scan-type-btn" onclick="selectScanType(this,'fundus')"><span class="s-icon">👁️</span><span class="s-name">Fundus Photo</span></div>
            <div class="scan-type-btn" onclick="selectScanType(this,'usg')"><span class="s-icon">🔊</span><span class="s-name">Ultrasound</span></div>
          </div>

          <div class="imaging-grid">
            <!-- Upload zone -->
            <div>
              <div class="upload-zone" id="uploadZone" onclick="triggerUpload()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event)">
                <div id="uploadPlaceholder">
                  <div class="upload-icon">🩻</div>
                  <div class="upload-title">Drop image here or click to upload</div>
                  <div class="upload-sub">Supports DICOM, JPEG, PNG, PDF — max 50 MB</div>
                  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px;flex-wrap:wrap">
                    <span style="background:var(--navy3);border:1px solid var(--border2);color:var(--text3);font-size:0.68rem;padding:4px 10px;border-radius:4px">.dcm</span>
                    <span style="background:var(--navy3);border:1px solid var(--border2);color:var(--text3);font-size:0.68rem;padding:4px 10px;border-radius:4px">.jpg</span>
                    <span style="background:var(--navy3);border:1px solid var(--border2);color:var(--text3);font-size:0.68rem;padding:4px 10px;border-radius:4px">.png</span>
                    <span style="background:var(--navy3);border:1px solid var(--border2);color:var(--text3);font-size:0.68rem;padding:4px 10px;border-radius:4px">.pdf</span>
                  </div>
                </div>
                <img id="uploadedImage" style="display:none;width:100%;max-height:460px;object-fit:contain;border-radius:10px;background:var(--navy3)" src="" alt="Uploaded scan">
              </div>
              <input type="file" id="fileInput" accept="image/*,.pdf,.dcm" style="display:none" onchange="handleFileUpload(event)">
              <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                <button class="btn btn-ghost btn-sm" onclick="loadDemoImage()">📂 Load Demo Image</button>
                <button class="btn btn-primary btn-sm" id="analyzeBtn" onclick="analyzeImage()" style="display:none">🤖 Analyze with AI</button>
                <button class="btn btn-ghost btn-sm" id="changeImgBtn" onclick="changeImage()" style="display:none">🔄 Change Image</button>
              </div>
              <!-- Patient context -->
              <div style="margin-top:14px">
                <div class="card">
                  <div class="card-header"><span class="card-title">🧑‍⚕️ Patient Context</span></div>
                  <div class="card-body">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                      <div class="form-group"><label class="form-label">Patient</label><select class="form-select" id="imagingPatientSelect"><option value="">— Select patient —</option></select></div>
                      <div class="form-group"><label class="form-label">Clinical Indication</label><input class="form-input" id="imagingIndication" placeholder="e.g. Chest pain, SOB, screening"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Results panel -->
            <div class="imaging-result-panel">
              <div class="imaging-result-header">
                <div class="card-title" style="font-size:0.88rem">🤖 AI Analysis Results</div>
                <div style="font-size:0.72rem;color:var(--text3);margin-top:3px" id="imagingModel">Upload an image and click Analyze to begin</div>
              </div>
              <div class="imaging-result-body" id="imagingResultBody">

                <!-- Analyzing animation -->
                <div class="analyzing-anim" id="analyzingAnim" style="display:none">
                  <div class="pulse-ring"></div>
                  <div style="font-family:var(--syne);font-size:0.95rem;font-weight:700;color:var(--teal)">Analyzing Image…</div>
                  <div style="font-size:0.78rem;color:var(--text3);text-align:center">Running through 14 AI detection models<br>This takes 3–5 seconds</div>
                </div>

                <!-- Default state -->
                <div id="imagingDefault">
                  <div class="empty-state">
                    <div class="icon">🩻</div>
                    <div class="text">Upload an image to see AI analysis</div>
                    <div style="margin-top:10px;font-size:0.75rem;color:var(--text3)">Or load a demo image to see how it works</div>
                  </div>
                  <div style="margin-top:20px">
                    <div style="font-size:0.78rem;font-weight:600;color:var(--text3);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.8px">AI Capabilities</div>
                    <div style="display:flex;flex-direction:column;gap:8px">
                      <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--navy3);border-radius:8px;font-size:0.78rem;color:var(--text2)">🫁 <strong style="color:var(--text1)">Chest X-Ray</strong> — Pneumonia, TB, effusion, cardiomegaly, pneumothorax</div>
                      <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--navy3);border-radius:8px;font-size:0.78rem;color:var(--text2)">📈 <strong style="color:var(--text1)">ECG</strong> — ST changes, arrhythmia, LBBB, WPW, QTc prolongation</div>
                      <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--navy3);border-radius:8px;font-size:0.78rem;color:var(--text2)">👁️ <strong style="color:var(--text1)">Fundus</strong> — Diabetic retinopathy grading (ETDRS), optic disc changes</div>
                      <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--navy3);border-radius:8px;font-size:0.78rem;color:var(--text2)">🧠 <strong style="color:var(--text1)">CT Brain</strong> — Hemorrhage, infarct, mass effect, midline shift</div>
                    </div>
                  </div>
                </div>

                <!-- Results (hidden initially) -->
                <div id="imagingResults" style="display:none">
                  <div style="background:var(--teal-dim);border:1px solid rgba(0,212,180,0.2);border-radius:8px;padding:10px 12px;margin-bottom:14px;display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.2rem">✅</span>
                    <div>
                      <div style="font-size:0.82rem;font-weight:600;color:var(--teal)">Analysis Complete</div>
                      <div style="font-size:0.72rem;color:var(--text3)">Processed in 3.2s · Confidence threshold: 70%</div>
                    </div>
                  </div>
                  <div id="findingsList"></div>
                  <div class="divider"></div>
                  <div style="font-size:0.78rem;font-weight:600;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px">AI Recommendation</div>
                  <div id="imagingRecommendation" style="font-size:0.8rem;color:var(--text2);line-height:1.7;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:12px"></div>
                  <div style="margin-top:12px;display:flex;gap:8px">
                    <button class="btn btn-primary btn-sm" onclick="addImagingToReport()">📋 Add to Report</button>
                    <button class="btn btn-ghost btn-sm" onclick="printImagingReport()">🖨 Print</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── ANALYTICS VIEW ── -->
      <div class="view" id="view-analytics">
        <div class="analytics-view">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
            <div>
              <div class="section-title">📈 Analytics & Insights</div>
              <div class="section-sub">Clinical performance, AI usage, patient outcomes — AIIMS Delhi · Feb 2026</div>
            </div>
            <div style="display:flex;gap:8px">
              <select class="form-select"><option>This Month</option><option>Last 3 Months</option><option>This Year</option></select>
              <button class="btn btn-ghost btn-sm" onclick="exportAnalyticsCSV()">⬇ Export</button>
            </div>
          </div>

          <!-- KPI strip -->
          <div class="kpi-strip">
            <div class="kpi-card"><div class="kpi-num" style="color:var(--teal)">482</div><div class="kpi-lbl">Total Patients</div><div class="kpi-chg" style="color:var(--green)">↑ 12% vs last month</div></div>
            <div class="kpi-card"><div class="kpi-num" style="color:var(--cyan)">1,284</div><div class="kpi-lbl">Consultations</div><div class="kpi-chg" style="color:var(--green)">↑ 8%</div></div>
            <div class="kpi-card"><div class="kpi-num" style="color:var(--purple)">94.2%</div><div class="kpi-lbl">AI Acceptance Rate</div><div class="kpi-chg" style="color:var(--green)">↑ 2.1%</div></div>
            <div class="kpi-card"><div class="kpi-num" style="color:var(--gold)">18</div><div class="kpi-lbl">Drug Interactions Prevented</div><div class="kpi-chg" style="color:var(--green)">This month</div></div>
            <div class="kpi-card"><div class="kpi-num" style="color:var(--red)">7</div><div class="kpi-lbl">High-Risk Alerts</div><div class="kpi-chg" style="color:var(--text3)">Active monitoring</div></div>
          </div>

          <!-- Charts row 1 -->
          <div class="analytics-grid">
            <!-- Consultations bar chart -->
            <div class="chart-card">
              <div class="chart-card-header">
                <span class="card-title">📊 Daily Consultations — Feb 2026</span>
                <span class="pill teal">28 days</span>
              </div>
              <div class="chart-card-body">
                <div class="bar-chart" id="consultBar"></div>
                <div style="display:flex;gap:14px;margin-top:10px;flex-wrap:wrap">
                  <span style="display:flex;align-items:center;gap:5px;font-size:0.72rem;color:var(--text3)"><span style="width:10px;height:10px;border-radius:2px;background:var(--teal);display:inline-block"></span>Consultations</span>
                  <span style="display:flex;align-items:center;gap:5px;font-size:0.72rem;color:var(--text3)"><span style="width:10px;height:10px;border-radius:2px;background:var(--red);display:inline-block"></span>Urgent cases</span>
                </div>
              </div>
            </div>

            <!-- Specialization donut -->
            <div class="chart-card">
              <div class="chart-card-header"><span class="card-title">🔬 Cases by Specialization</span></div>
              <div class="chart-card-body">
                <div class="donut-wrap">
                  <svg width="110" height="110" viewBox="0 0 110 110">
                    <circle cx="55" cy="55" r="40" fill="none" stroke="var(--border2)" stroke-width="18"/>
                    <circle cx="55" cy="55" r="40" fill="none" stroke="var(--teal)" stroke-width="18" stroke-dasharray="100 151.5" stroke-dashoffset="0" transform="rotate(-90 55 55)"/>
                    <circle cx="55" cy="55" r="40" fill="none" stroke="var(--cyan)" stroke-width="18" stroke-dasharray="50 151.5" stroke-dashoffset="-100" transform="rotate(-90 55 55)"/>
                    <circle cx="55" cy="55" r="40" fill="none" stroke="var(--purple)" stroke-width="18" stroke-dasharray="30 151.5" stroke-dashoffset="-150" transform="rotate(-90 55 55)"/>
                    <circle cx="55" cy="55" r="40" fill="none" stroke="var(--gold)" stroke-width="18" stroke-dasharray="25 151.5" stroke-dashoffset="-180" transform="rotate(-90 55 55)"/>
                    <circle cx="55" cy="55" r="40" fill="none" stroke="#8B5CF6" stroke-width="18" stroke-dasharray="20 151.5" stroke-dashoffset="-205" transform="rotate(-90 55 55)"/>
                    <text x="55" y="52" text-anchor="middle" fill="var(--text1)" font-size="11" font-weight="bold" font-family="Syne,sans-serif">482</text>
                    <text x="55" y="64" text-anchor="middle" fill="var(--text3)" font-size="8">patients</text>
                  </svg>
                  <div class="donut-legend">
                    <div class="donut-legend-item"><div class="donut-dot" style="background:var(--teal)"></div>Cardiology<span class="donut-pct">26%</span></div>
                    <div class="donut-legend-item"><div class="donut-dot" style="background:var(--cyan)"></div>General Medicine<span class="donut-pct">13%</span></div>
                    <div class="donut-legend-item"><div class="donut-dot" style="background:var(--purple)"></div>Endocrinology<span class="donut-pct">9%</span></div>
                    <div class="donut-legend-item"><div class="donut-dot" style="background:var(--gold)"></div>Pulmonology<span class="donut-pct">7%</span></div>
                    <div class="donut-legend-item"><div class="donut-dot" style="background:#8B5CF6"></div>Neurology<span class="donut-pct">5%</span></div>
                    <div class="donut-legend-item"><div class="donut-dot" style="background:var(--text3)"></div>Others<span class="donut-pct">40%</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts row 2 -->
          <div class="analytics-grid-3">
            <!-- AI accuracy trend -->
            <div class="chart-card">
              <div class="chart-card-header"><span class="card-title">🎯 AI Accuracy Trend</span></div>
              <div class="chart-card-body">
                <svg viewBox="0 0 300 100" style="width:100%;height:90px">
                  <defs><linearGradient id="aGrad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#00D4B4" stop-opacity="0.25"/><stop offset="100%" stop-color="#00D4B4" stop-opacity="0"/></linearGradient></defs>
                  <path d="M0,75 L50,65 L100,60 L150,45 L200,35 L250,25 L300,18" stroke="var(--teal)" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                  <path d="M0,75 L50,65 L100,60 L150,45 L200,35 L250,25 L300,18 L300,100 L0,100Z" fill="url(#aGrad)"/>
                  <circle cx="300" cy="18" r="4" fill="var(--teal)"/>
                  <text x="265" y="15" fill="var(--teal)" font-size="9" font-weight="bold">94.2%</text>
                  <text x="0" y="75" fill="var(--text3)" font-size="8">Sep</text>
                  <text x="230" y="98" fill="var(--text3)" font-size="8">Feb</text>
                </svg>
                <div style="text-align:center;margin-top:4px">
                  <span style="font-family:var(--syne);font-size:1.5rem;font-weight:800;color:var(--teal)">94.2%</span>
                  <span style="font-size:0.72rem;color:var(--green);margin-left:6px">↑ +6.1% since Sep</span>
                </div>
              </div>
            </div>

            <!-- Drug interactions prevented -->
            <div class="chart-card">
              <div class="chart-card-header"><span class="card-title">⚠️ Safety Interventions</span></div>
              <div class="chart-card-body">
                <div style="display:flex;flex-direction:column;gap:10px">
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:0.78rem;color:var(--text2)">Drug interactions flagged</span><span style="font-family:var(--mono);font-weight:600;color:var(--red)">18</span></div>
                    <div style="height:5px;background:var(--border2);border-radius:3px"><div style="width:72%;height:100%;background:var(--red);border-radius:3px"></div></div>
                  </div>
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:0.78rem;color:var(--text2)">Dosing errors caught</span><span style="font-family:var(--mono);font-weight:600;color:var(--gold)">9</span></div>
                    <div style="height:5px;background:var(--border2);border-radius:3px"><div style="width:36%;height:100%;background:var(--gold);border-radius:3px"></div></div>
                  </div>
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:0.78rem;color:var(--text2)">High-risk alerts sent</span><span style="font-family:var(--mono);font-weight:600;color:var(--purple)">7</span></div>
                    <div style="height:5px;background:var(--border2);border-radius:3px"><div style="width:28%;height:100%;background:var(--purple);border-radius:3px"></div></div>
                  </div>
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:0.78rem;color:var(--text2)">Allergy contraindications</span><span style="font-family:var(--mono);font-weight:600;color:var(--teal)">4</span></div>
                    <div style="height:5px;background:var(--border2);border-radius:3px"><div style="width:16%;height:100%;background:var(--teal);border-radius:3px"></div></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top diagnoses -->
            <div class="chart-card">
              <div class="chart-card-header"><span class="card-title">🔝 Top AI Diagnoses</span></div>
              <div class="chart-card-body">
                <div style="display:flex;flex-direction:column;gap:8px">
                  <div class="sparkline-row"><span class="sparkline-name">Hypertension</span><span class="sparkline-val" style="color:var(--teal)">112</span></div>
                  <div class="sparkline-row"><span class="sparkline-name">Type 2 Diabetes</span><span class="sparkline-val" style="color:var(--cyan)">94</span></div>
                  <div class="sparkline-row"><span class="sparkline-name">CAD / Angina</span><span class="sparkline-val" style="color:var(--red)">67</span></div>
                  <div class="sparkline-row"><span class="sparkline-name">COPD</span><span class="sparkline-val" style="color:var(--gold)">45</span></div>
                  <div class="sparkline-row"><span class="sparkline-name">Hypothyroidism</span><span class="sparkline-val" style="color:var(--purple)">38</span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom row -->
          <div class="analytics-grid">
            <!-- Prediction outcomes -->
            <div class="chart-card">
              <div class="chart-card-header"><span class="card-title">🔮 Predictive Model Outcomes</span><span class="pill teal">6 months tracked</span></div>
              <div class="chart-card-body">
                <div style="overflow-x:auto">
                  <table style="width:100%;border-collapse:collapse;font-size:0.78rem">
                    <thead><tr><th style="text-align:left;padding:8px;color:var(--text3);font-weight:600;border-bottom:1px solid var(--border)">Model</th><th style="padding:8px;color:var(--text3);font-weight:600;border-bottom:1px solid var(--border)">Predicted</th><th style="padding:8px;color:var(--text3);font-weight:600;border-bottom:1px solid var(--border)">Confirmed</th><th style="padding:8px;color:var(--text3);font-weight:600;border-bottom:1px solid var(--border)">Accuracy</th></tr></thead>
                    <tbody>
                      <tr><td style="padding:8px;color:var(--text2)">Cardiac (MACE)</td><td style="padding:8px;text-align:center;font-family:var(--mono)">23</td><td style="padding:8px;text-align:center;font-family:var(--mono)">20</td><td style="padding:8px;text-align:center;color:var(--green);font-weight:600">87%</td></tr>
                      <tr style="background:rgba(255,255,255,0.02)"><td style="padding:8px;color:var(--text2)">T2 Diabetes</td><td style="padding:8px;text-align:center;font-family:var(--mono)">31</td><td style="padding:8px;text-align:center;font-family:var(--mono)">29</td><td style="padding:8px;text-align:center;color:var(--green);font-weight:600">94%</td></tr>
                      <tr><td style="padding:8px;color:var(--text2)">Hypertension</td><td style="padding:8px;text-align:center;font-family:var(--mono)">18</td><td style="padding:8px;text-align:center;font-family:var(--mono)">15</td><td style="padding:8px;text-align:center;color:var(--gold);font-weight:600">83%</td></tr>
                      <tr style="background:rgba(255,255,255,0.02)"><td style="padding:8px;color:var(--text2)">CKD Progression</td><td style="padding:8px;text-align:center;font-family:var(--mono)">12</td><td style="padding:8px;text-align:center;font-family:var(--mono)">11</td><td style="padding:8px;text-align:center;color:var(--green);font-weight:600">92%</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Time saved -->
            <div class="chart-card">
              <div class="chart-card-header"><span class="card-title">⏱ Time Saved with AI</span></div>
              <div class="chart-card-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                  <div style="text-align:center;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:14px">
                    <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--teal)">4.2h</div>
                    <div style="font-size:0.7rem;color:var(--text3);margin-top:3px">Saved per day</div>
                  </div>
                  <div style="text-align:center;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:14px">
                    <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--cyan)">92s</div>
                    <div style="font-size:0.7rem;color:var(--text3);margin-top:3px">Avg consult time</div>
                  </div>
                  <div style="text-align:center;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:14px">
                    <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--gold)">₹2.4L</div>
                    <div style="font-size:0.7rem;color:var(--text3);margin-top:3px">Drug savings (generic)</div>
                  </div>
                  <div style="text-align:center;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:14px">
                    <div style="font-family:var(--syne);font-size:1.8rem;font-weight:800;color:var(--purple)">98.1%</div>
                    <div style="font-size:0.7rem;color:var(--text3);margin-top:3px">Platform uptime</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── SETTINGS VIEW ── -->
      <div class="view" id="view-settings">
        <div class="settings-view">
          <div style="margin-bottom:20px">
            <div class="section-title">⚙️ Settings</div>
            <div class="section-sub">Configure your SamarthaaMed clinical platform preferences</div>
          </div>
          <div class="settings-section">
            <div class="settings-section-header"><span style="font-size:1.1rem">🤖</span><div class="settings-section-title">AI Behaviour</div></div>
            <div class="settings-row"><div><div class="settings-row-label">Show AI confidence scores</div><div class="settings-row-sub">Display percentage confidence on all differential diagnoses</div></div><button class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
            <div class="settings-row"><div><div class="settings-row-label">ICMR Guideline-first suggestions</div><div class="settings-row-sub">Prioritise ICMR 2024 protocols above international guidelines</div></div><button class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
            <div class="settings-row"><div><div class="settings-row-label">Jan Aushadhi generic-first prescriptions</div><div class="settings-row-sub">Prefer Jan Aushadhi generics over branded drugs in suggestions</div></div><button class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
            <div class="settings-row"><div><div class="settings-row-label">Auto-generate SOAP notes</div><div class="settings-row-sub">Automatically generate SOAP notes after each consultation</div></div><button class="toggle off" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
            <div class="settings-row"><div><div class="settings-row-label">Predictive risk alerts</div><div class="settings-row-sub">Send push alerts when a patient's risk score crosses threshold</div></div><button class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
          </div>
          <div class="settings-section">
            <div class="settings-section-header"><span style="font-size:1.1rem">🌐</span><div class="settings-section-title">Language & Regional</div></div>
            <div class="settings-row"><div><div class="settings-row-label">Interface language</div></div><select class="form-select" id="interfaceLanguageSelect" style="width:180px" onchange="changeLanguageFromSettings(this.value)"><option value="en">English</option><option value="hi">Hindi</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="kn">Kannada</option><option value="bn">Bengali</option></select></div>
            <div class="settings-row"><div><div class="settings-row-label">AI response language</div><div class="settings-row-sub">Language used by the AI chatbot for responses</div></div><select class="form-select" id="aiLanguageSelect" style="width:180px" onchange="changeAILanguage(this.value)"><option value="en">English</option><option value="hi">Hindi / Hinglish</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="kn">Kannada</option></select></div>
            <div class="settings-row"><div><div class="settings-row-label">Drug formulary</div></div><select class="form-select" style="width:220px"><option>Indian Pharmacopoeia (IP 2022)</option><option>CGHS Formulary</option><option>ESIC Formulary</option><option>Jan Aushadhi only</option></select></div>
          </div>
          <div class="settings-section">
            <div class="settings-section-header"><span style="font-size:1.1rem">🔒</span><div class="settings-section-title">Privacy & Security</div></div>
            <div class="settings-row"><div><div class="settings-row-label">Two-factor authentication</div><div class="settings-row-sub">Require OTP at every login</div></div><button class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
            <div class="settings-row"><div><div class="settings-row-label">Session auto-lock</div><div class="settings-row-sub">Lock screen after 10 minutes of inactivity</div></div><button class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
            <div class="settings-row"><div><div class="settings-row-label">Share anonymised data for AI training</div><div class="settings-row-sub">Helps improve SamarthaaMed models — all data is de-identified per DPDP Act 2023</div></div><button class="toggle off" onclick="this.classList.toggle('on');this.classList.toggle('off')"></button></div>
          </div>
          <div class="settings-section">
            <div class="settings-section-header"><span style="font-size:1.1rem">🔑</span><div class="settings-section-title">AI Integration — Anthropic API Key</div></div>
            <div class="settings-row" style="align-items:flex-start;gap:14px;padding:16px 18px">
              <div class="settings-label">
                <div class="settings-label-main">Anthropic API Key</div>
                <div class="settings-label-sub">Powers all Claude AI features — AI Consultation, Radiology AI, Dental AI and more</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;flex:1;max-width:460px">
                <div style="display:flex;align-items:center;gap:8px">
                  <input type="password" id="anthropicKeyInput"
                    placeholder="sk-ant-api03-..."
                    style="flex:1;padding:9px 12px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);font-family:var(--mono);font-size:0.82rem;outline:none;transition:border-color .2s"
                    oninput="this.style.borderColor='var(--teal)'"
                    onfocus="this.style.borderColor='var(--teal)'"
                    onblur="this.style.borderColor='var(--border2)'"
                  />
                  <button onclick="saveAnthropicKeyManual()" class="btn btn-primary btn-sm">Save</button>
                  <span id="anthropicKeyStatus" style="font-size:0.72rem;padding:4px 10px;border-radius:20px;font-weight:600;background:var(--navy3);color:var(--text3);white-space:nowrap">○ Not set</span>
                </div>
                <div style="font-size:0.71rem;color:var(--text3)">
                  Get your key at <a href="https://console.anthropic.com" target="_blank" style="color:var(--teal)">console.anthropic.com</a>. Stored locally in your browser only.
                </div>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="settings-section-header"><span style="font-size:1.1rem">🔗</span><div class="settings-section-title">Integrations</div></div>
            <div class="settings-row"><div><div class="settings-row-label">ABDM / ABHA Health ID</div><div class="settings-row-sub">Connected · HIP-HIU registered</div></div><span class="pill teal">● Active</span></div>
            <div class="settings-row"><div><div class="settings-row-label">Hospital HIS (Meditech)</div><div class="settings-row-sub">Bi-directional patient sync</div></div><span class="pill teal">● Connected</span></div>
            <div class="settings-row"><div><div class="settings-row-label">WhatsApp Business API</div><div class="settings-row-sub">Prescription sharing & patient reminders</div></div><span class="pill teal">● Active</span></div>
            <div class="settings-row">
              <div><div class="settings-row-label">PACS / Radiology (Orthanc)</div><div class="settings-row-sub">DICOM imaging integration — set ORTHANC_URL in Netlify env vars</div></div>
              <div style="display:flex;align-items:center;gap:10px">
                <span id="pacsBadge" style="background:var(--navy3);color:var(--text3);font-size:0.72rem;padding:3px 10px;border-radius:20px;font-weight:600">○ Not configured</span>
                <button id="pacsConnectBtn" class="btn btn-ghost btn-sm" onclick="orthancTestConnection()">🔗 Test Connection</button>
              </div>
            </div>
          </div>
          <div class="settings-section" id="elevenlabsSettingsSection">
            <div class="settings-section-header">
              <span style="font-size:1.1rem">🎙️</span>
              <div>
                <div class="settings-section-title">ElevenLabs Voice Clone</div>
                <div style="font-size:0.72rem;color:var(--text3);margin-top:2px">Use your cloned voice for all AI speech responses</div>
              </div>
              <div id="elStatusBadge" style="margin-left:auto;font-size:0.7rem;padding:3px 10px;border-radius:20px;font-weight:600;background:var(--navy3);color:var(--text3)">Not configured</div>
            </div>

            <!-- API Key row — locked -->
            <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:10px;padding:16px 18px">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                  <div class="settings-row-label">ElevenLabs API Key</div>
                  <div class="settings-row-sub">Managed by administrator — cannot be changed from UI</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;background:var(--navy3);border:1px solid var(--teal);border-radius:8px;padding:10px 16px">
                <span>🔒</span>
                <span id="elApiKeyInput" style="font-family:monospace;font-size:0.82rem;color:var(--teal);letter-spacing:0.04em">sk_•••••••••••••••••••••••••••••••</span>
              </div>
            </div>

            <!-- Voice ID row — locked -->
            <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:10px;padding:16px 18px;border-top:1px solid var(--border)">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                  <div class="settings-row-label">Voice ID</div>
                  <div class="settings-row-sub">Managed by administrator — cannot be changed from UI</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;background:var(--navy3);border:1px solid var(--teal);border-radius:8px;padding:10px 16px">
                <span>🔒</span>
                <span id="elVoiceIdInput" style="font-family:monospace;font-size:0.82rem;color:var(--teal);letter-spacing:0.04em">••••••••••••••••••••</span>
              </div>
            </div>

            <!-- Voice model + stability -->
            <div class="settings-row" style="flex-wrap:wrap;gap:12px">
              <div>
                <div class="settings-row-label">Voice Model</div>
                <div class="settings-row-sub">Multilingual v2 supports English and Indian languages</div>
              </div>
              <select class="form-select" id="elModelSelect" style="width:240px">
                <option value="eleven_multilingual_v2">Multilingual v2 (recommended)</option>
                <option value="eleven_turbo_v2_5">Turbo v2.5 (faster, English)</option>
                <option value="eleven_monolingual_v1">Monolingual v1 (English only)</option>
              </select>
            </div>
            <div class="settings-row" style="flex-wrap:wrap;gap:12px">
              <div>
                <div class="settings-row-label">Stability</div>
                <div class="settings-row-sub">Higher = more consistent, lower = more expressive</div>
              </div>
              <div style="display:flex;align-items:center;gap:10px">
                <input type="range" id="elStability" min="0" max="100" value="50" style="width:120px" oninput="document.getElementById('elStabilityVal').textContent=this.value+'%'">
                <span id="elStabilityVal" style="font-size:0.8rem;color:var(--teal);font-weight:600;min-width:36px">50%</span>
              </div>
            </div>
            <div class="settings-row" style="flex-wrap:wrap;gap:12px">
              <div>
                <div class="settings-row-label">Similarity Boost</div>
                <div class="settings-row-sub">Higher = closer to your voice clone</div>
              </div>
              <div style="display:flex;align-items:center;gap:10px">
                <input type="range" id="elSimilarity" min="0" max="100" value="85" style="width:120px" oninput="document.getElementById('elSimilarityVal').textContent=this.value+'%'">
                <span id="elSimilarityVal" style="font-size:0.8rem;color:var(--teal);font-weight:600;min-width:36px">85%</span>
              </div>
            </div>

            <!-- Where to use -->
            <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:8px;padding:14px 18px;border-top:1px solid var(--border)">
              <div class="settings-row-label" style="margin-bottom:4px">Use ElevenLabs voice for</div>
              <div style="display:flex;gap:16px;flex-wrap:wrap">
                <label style="display:flex;align-items:center;gap:7px;font-size:0.8rem;color:var(--text2);cursor:pointer">
                  <input type="checkbox" id="elUseVoiceConsult" checked style="width:15px;height:15px"> Voice Consultation responses
                </label>
                <label style="display:flex;align-items:center;gap:7px;font-size:0.8rem;color:var(--text2);cursor:pointer">
                  <input type="checkbox" id="elUseChatRead" style="width:15px;height:15px"> Read aloud chat responses
                </label>
                <label style="display:flex;align-items:center;gap:7px;font-size:0.8rem;color:var(--text2);cursor:pointer">
                  <input type="checkbox" id="elUseDentalRead" style="width:15px;height:15px"> Read aloud dental assessments
                </label>
              </div>
            </div>

            <!-- Action buttons — locked -->
            <div class="settings-row" style="gap:10px;flex-wrap:wrap">
              <button class="btn btn-ghost btn-sm" onclick="elTestVoice()">🎙️ Test Voice</button>
              <div style="font-size:0.72rem;color:var(--text3);display:flex;align-items:center;gap:6px;padding:0 6px">
                🛡️ API key &amp; Voice ID are system-configured and locked — contact your administrator to change them
              </div>
            </div>

          </div><!-- end elevenlabsSettingsSection -->

        </div>
      </div>

      <div class="view" id="view-radiology" style="overflow-y:auto;height:100%">
        <div style="max-width:1400px;margin:0 auto;padding:24px 24px 80px">

          <!-- ── Header ── -->
          <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
            <div>
              <div class="section-title">🩻 PACS / DICOM Viewer</div>
              <div class="section-sub" id="pacsSubtitle">Connecting to Orthanc PACS…</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-ghost btn-sm" onclick="orthancRefreshStudies()">🔄 Refresh</button>
              <button class="btn btn-ghost btn-sm" onclick="document.getElementById('pacsUploadInput').click()">📤 Upload DICOM</button>
              <input type="file" id="pacsUploadInput" accept=".dcm,application/dicom" multiple style="display:none" onchange="pacsUploadFiles(event)">
              <button class="btn btn-primary btn-sm" id="pacsOhifBtn" style="display:none" onclick="pacsOpenOhif()">🖥 Full Viewer (OHIF)</button>
            </div>
          </div>

          <!-- ── Not Connected Banner ── -->
          <div id="pacsNotConnected" style="display:none">
            <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:14px;padding:40px;text-align:center">
              <div style="font-size:3rem;margin-bottom:16px">🔌</div>
              <div style="font-size:1.1rem;font-weight:700;color:var(--text1);margin-bottom:8px">Orthanc PACS Not Connected</div>
              <div style="font-size:0.85rem;color:var(--text3);max-width:480px;margin:0 auto 20px">
                Add your Orthanc server credentials as Netlify environment variables to enable live DICOM imaging.
              </div>
              <div style="background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:left;max-width:480px;margin:0 auto;font-family:var(--mono);font-size:0.78rem;color:var(--teal);line-height:2">
                ORTHANC_URL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= https://pacs.yourhospital.com<br>
                ORTHANC_USER&nbsp;&nbsp;&nbsp;&nbsp;= your-username<br>
                ORTHANC_PASSWORD = your-password
              </div>
              <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="showView('settings')">⚙️ Go to Settings</button>
                <button class="btn btn-ghost" onclick="pacsDemoMode()">🎭 Demo Mode</button>
              </div>
            </div>
          </div>

          <!-- ── Upload Progress ── -->
          <div id="pacsUploadProgress" style="display:none;margin-bottom:16px">
            <div style="background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px 18px;display:flex;align-items:center;gap:14px">
              <div class="pulse-ring" style="width:20px;height:20px;flex-shrink:0"></div>
              <div style="flex:1">
                <div style="font-size:0.85rem;font-weight:600;color:var(--text1)" id="pacsUploadMsg">Uploading DICOM files…</div>
                <div style="height:4px;background:var(--border2);border-radius:2px;margin-top:8px;overflow:hidden">
                  <div id="pacsUploadBar" style="height:100%;background:var(--teal);border-radius:2px;transition:width 0.3s;width:0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- ── Main PACS Layout ── -->
          <div id="pacsMain" style="display:none">
            <div style="display:grid;grid-template-columns:320px 1fr;gap:16px;align-items:start">

              <!-- ── Left: Patient/Study List ── -->
              <div>
                <!-- Search -->
                <div style="background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px">
                  <div style="font-size:0.78rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px">Search PACS</div>
                  <input class="form-input" id="pacsSearchInput" placeholder="Patient name, ID, or study…" style="margin-bottom:8px" oninput="pacsSearch(this.value)">
                  <div style="display:flex;gap:6px">
                    <select class="form-select" id="pacsModalityFilter" onchange="pacsSearch(document.getElementById('pacsSearchInput').value)" style="font-size:0.78rem">
                      <option value="">All modalities</option>
                      <option value="CR">X-Ray (CR)</option>
                      <option value="CT">CT</option>
                      <option value="MR">MRI</option>
                      <option value="US">Ultrasound</option>
                      <option value="DX">Digital X-Ray</option>
                      <option value="PT">PET</option>
                      <option value="NM">Nuclear Med</option>
                      <option value="MG">Mammography</option>
                    </select>
                    <button class="btn btn-ghost btn-sm" onclick="pacsSearch('')">All</button>
                  </div>
                </div>

                <!-- Study list -->
                <div style="background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden">
                  <div style="padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
                    <div style="font-size:0.78rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px">Studies</div>
                    <span id="pacsStudyCount" style="font-size:0.72rem;color:var(--text3)">—</span>
                  </div>
                  <div id="pacsStudyList" style="max-height:520px;overflow-y:auto"></div>
                </div>
              </div>

              <!-- ── Right: Viewer ── -->
              <div>
                <!-- Series/instance selector -->
                <div id="pacsSeriesBar" style="display:none;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px">
                  <div style="font-size:0.78rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px">Series</div>
                  <div id="pacsSeriesList" style="display:flex;gap:8px;flex-wrap:wrap"></div>
                </div>

                <!-- Image viewer -->
                <div id="pacsDicomViewer" style="background:var(--navy3);border:1px solid var(--border);border-radius:12px;overflow:hidden;position:relative;min-height:500px;display:flex;align-items:center;justify-content:center">
                  <div id="pacsViewerPlaceholder" style="text-align:center;padding:40px;color:var(--text3)">
                    <div style="font-size:3rem;margin-bottom:12px">🩻</div>
                    <div style="font-size:0.95rem;font-weight:600;color:var(--text2)">Select a study to view</div>
                    <div style="font-size:0.78rem;margin-top:6px">Click any study in the list on the left</div>
                  </div>

                  <!-- Viewer toolbar (hidden until image loads) -->
                  <div id="pacsToolbar" style="display:none;position:absolute;top:12px;right:12px;display:flex;flex-direction:column;gap:6px">
                    <button onclick="pacsZoom(1.2)" title="Zoom in"  style="width:32px;height:32px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;cursor:pointer;font-size:0.85rem">+</button>
                    <button onclick="pacsZoom(0.8)" title="Zoom out" style="width:32px;height:32px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;cursor:pointer;font-size:0.85rem">−</button>
                    <button onclick="pacsResetView()"   title="Reset"   style="width:32px;height:32px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;cursor:pointer;font-size:0.85rem">⟳</button>
                    <button onclick="pacsInvert()"      title="Invert"  style="width:32px;height:32px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;cursor:pointer;font-size:0.85rem">⬛</button>
                    <button onclick="pacsDownload()"    title="Download" style="width:32px;height:32px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;cursor:pointer;font-size:0.85rem">⬇</button>
                  </div>

                  <!-- The actual image -->
                  <img id="pacsDicomImg" style="display:none;max-width:100%;max-height:600px;object-fit:contain;cursor:grab;transition:transform 0.2s" src="" alt="DICOM image"
                    onload="pacsImgLoaded(this)"
                    onerror="pacsImgError(this)">

                  <!-- Frame navigator -->
                  <div id="pacsFrameNav" style="display:none;position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);border-radius:8px;padding:6px 14px;display:flex;align-items:center;gap:10px">
                    <button onclick="pacsFrame(-1)" style="background:none;border:none;color:#fff;cursor:pointer;font-size:1rem">◀</button>
                    <span id="pacsFrameLabel" style="font-size:0.78rem;color:#ccc;font-family:var(--mono)">Frame 1 / 1</span>
                    <button onclick="pacsFrame(+1)" style="background:none;border:none;color:#fff;cursor:pointer;font-size:1rem">▶</button>
                  </div>
                </div>

                <!-- Study metadata panel -->
                <div id="pacsMetaPanel" style="display:none;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:12px">
                  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
                    <div style="font-size:0.78rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px">Study Details</div>
                    <div style="display:flex;gap:8px">
                      <button class="btn btn-ghost btn-sm" onclick="pacsAiAnalyze()">🤖 AI Analyze</button>
                      <button class="btn btn-ghost btn-sm" onclick="pacsAddToConsult()">📋 Add to Consult</button>
                      <button class="btn btn-primary btn-sm" onclick="pacsOpenOhifStudy()">🖥 OHIF Viewer</button>
                    </div>
                  </div>
                  <div id="pacsMetaContent" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;font-size:0.8rem"></div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <!-- end: view-radiology -->

    </div><!-- end: .content -->
  </div><!-- end: .main -->
</div><!-- end: .app -->

<!-- ══ NEW PATIENT MODAL ══ -->
<div class="modal-overlay" id="patientModal">
  <div class="modal">

    <!-- Header -->
    <div class="modal-header">
      <div>
        <div class="modal-title">➕ Register New Patient</div>
        <div class="modal-subtitle">Complete all required fields. Patient ID will be auto-generated.</div>
      </div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>

    <!-- Steps -->
    <div class="modal-steps">
      <div class="step-item active" id="step-indicator-1" onclick="goToStep(1)">
        <div class="step-num" id="step-num-1">1</div>
        <span class="step-label">Demographics</span>
      </div>
      <div class="step-connector"></div>
      <div class="step-item" id="step-indicator-2" onclick="goToStep(2)">
        <div class="step-num" id="step-num-2">2</div>
        <span class="step-label">Medical History</span>
      </div>
      <div class="step-connector"></div>
      <div class="step-item" id="step-indicator-3" onclick="goToStep(3)">
        <div class="step-num" id="step-num-3">3</div>
        <span class="step-label">Vitals & Lifestyle</span>
      </div>
      <div class="step-connector"></div>
      <div class="step-item" id="step-indicator-4" onclick="goToStep(4)">
        <div class="step-num" id="step-num-4">4</div>
        <span class="step-label">Review & Register</span>
      </div>
    </div>

    <!-- Body -->
    <div class="modal-body" id="modalBody">

      <!-- ── STEP 1: Demographics ── -->
      <div class="step-panel active" id="step-panel-1">
        <div class="form-section-title">👤 Personal Information</div>
        <div class="form-grid form-grid-3">
          <div class="form-group">
            <label class="form-label">First Name <span class="req">*</span></label>
            <input class="form-input" id="f_fname" type="text" placeholder="e.g. Priya">
            <span class="form-error" id="err_fname">First name is required</span>
          </div>
          <div class="form-group">
            <label class="form-label">Last Name <span class="req">*</span></label>
            <input class="form-input" id="f_lname" type="text" placeholder="e.g. Sharma">
            <span class="form-error" id="err_lname">Last name is required</span>
          </div>
          <div class="form-group">
            <label class="form-label">Date of Birth <span class="req">*</span></label>
            <input class="form-input" id="f_dob" type="date">
            <span class="form-error" id="err_dob">Date of birth is required</span>
          </div>
          <div class="form-group">
            <label class="form-label">Gender <span class="req">*</span></label>
            <div class="radio-group" id="f_gender">
              <div class="radio-opt selected" onclick="selectRadio('f_gender', this, 'Male')">♂ Male</div>
              <div class="radio-opt" onclick="selectRadio('f_gender', this, 'Female')">♀ Female</div>
              <div class="radio-opt" onclick="selectRadio('f_gender', this, 'Other')">⊕ Other</div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Blood Group</label>
            <select class="form-select" id="f_blood">
              <option value="">Select…</option>
              <option>A+</option><option>A−</option><option>B+</option><option>B−</option>
              <option>AB+</option><option>AB−</option><option>O+</option><option>O−</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ABHA / Health ID</label>
            <input class="form-input" id="f_abha" type="text" placeholder="XX-XXXX-XXXX-XXXX">
            <span class="form-hint">Aadhaar-linked ABDM Health ID</span>
          </div>
        </div>

        <div class="form-section-title" style="margin-top:20px">📞 Contact & Address</div>
        <div class="form-grid form-grid-3">
          <div class="form-group">
            <label class="form-label">Mobile Number <span class="req">*</span></label>
            <input class="form-input" id="f_mobile" type="tel" placeholder="+91 XXXXX XXXXX">
            <span class="form-error" id="err_mobile">Valid mobile number required</span>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input class="form-input" id="f_email" type="email" placeholder="patient@email.com">
          </div>
          <div class="form-group">
            <label class="form-label">Emergency Contact</label>
            <input class="form-input" id="f_emergency" type="tel" placeholder="Emergency phone">
          </div>
          <div class="form-group">
            <label class="form-label">City / District</label>
            <input class="form-input" id="f_city" type="text" placeholder="e.g. New Delhi">
          </div>
          <div class="form-group">
            <label class="form-label">State</label>
            <select class="form-select" id="f_state">
              <option value="">Select state…</option>
              <option>Andhra Pradesh</option><option>Assam</option><option>Bihar</option>
              <option>Delhi</option><option>Gujarat</option><option>Haryana</option>
              <option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option>
              <option>Maharashtra</option><option>Punjab</option><option>Rajasthan</option>
              <option>Tamil Nadu</option><option>Telangana</option><option>Uttar Pradesh</option>
              <option>West Bengal</option><option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Insurance / Scheme</label>
            <select class="form-select" id="f_insurance">
              <option value="">None / Self-pay</option>
              <option>Ayushman Bharat (PMJAY)</option>
              <option>CGHS</option><option>ESIC</option>
              <option>State Health Scheme</option>
              <option>Private Insurance</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ── STEP 2: Medical History ── -->
      <div class="step-panel" id="step-panel-2">
        <div class="form-section-title">🏥 Primary Reason for Visit</div>
        <div class="form-grid form-grid-2">
          <div class="form-group">
            <label class="form-label">Specialization <span class="req">*</span></label>
            <select class="form-select" id="f_spec">
              <option value="">Select specialization…</option>
              <option>General Medicine</option><option>Cardiology</option>
              <option>Neurology</option><option>Pulmonology</option>
              <option>Gastroenterology</option><option>Nephrology</option>
              <option>Endocrinology & Diabetology</option><option>Hematology</option>
              <option>Rheumatology</option><option>Dermatology</option>
              <option>Ophthalmology</option><option>ENT</option>
              <option>Dentistry</option><option>Orthopedics</option>
              <option>Urology</option><option>Psychiatry</option>
              <option>Obstetrics & Gynecology</option><option>Pediatrics</option>
              <option>Oncology</option><option>Infectious Disease</option>
              <option>Emergency Medicine</option><option>Geriatrics</option>
              <option>Other</option>
            </select>
            <span class="form-error" id="err_spec">Please select a specialization</span>
          </div>
          <div class="form-group">
            <label class="form-label">Visit Type</label>
            <div class="radio-group" id="f_visit">
              <div class="radio-opt selected" onclick="selectRadio('f_visit', this, 'New Patient')">🆕 New Patient</div>
              <div class="radio-opt" onclick="selectRadio('f_visit', this, 'Follow-up')">🔄 Follow-up</div>
              <div class="radio-opt" onclick="selectRadio('f_visit', this, 'Emergency')">🚨 Emergency</div>
            </div>
          </div>
          <div class="form-group span-2">
            <label class="form-label">Chief Complaint <span class="req">*</span></label>
            <textarea class="form-textarea" id="f_complaint" placeholder="Describe the primary symptoms or reason for visit…" style="min-height:60px"></textarea>
            <span class="form-error" id="err_complaint">Chief complaint is required</span>
          </div>
        </div>

        <div class="form-section-title" style="margin-top:20px">🗂 Medical History</div>
        <div class="form-grid form-grid-2">
          <div class="form-group">
            <label class="form-label">Existing Conditions</label>
            <div class="tag-input-wrap" id="conditions-wrap">
              <input type="text" id="condInput" placeholder="Type condition + Enter (e.g. Diabetes)" onkeydown="addTag(event,'conditions-wrap','condInput','condition')">
            </div>
            <span class="form-hint">Press Enter after each condition</span>
          </div>
          <div class="form-group">
            <label class="form-label">Allergies</label>
            <div class="tag-input-wrap" id="allergies-wrap">
              <input type="text" id="allergyInput" placeholder="Type allergy + Enter (e.g. Penicillin)" onkeydown="addTag(event,'allergies-wrap','allergyInput','allergy')">
            </div>
            <span class="form-hint">Drug, food, or environmental allergies</span>
          </div>
          <div class="form-group span-2">
            <label class="form-label">Current Medications</label>
            <div class="tag-input-wrap" id="meds-wrap">
              <input type="text" id="medInput" placeholder="Type medication + Enter (e.g. Metformin 500mg OD)" onkeydown="addTag(event,'meds-wrap','medInput','med')">
            </div>
            <span class="form-hint">Include dosage if known</span>
          </div>
          <div class="form-group">
            <label class="form-label">Family History</label>
            <textarea class="form-textarea" id="f_family" placeholder="e.g. Father — DM Type 2, hypertension. Mother — hypothyroidism." style="min-height:56px"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Past Surgeries / Hospitalizations</label>
            <textarea class="form-textarea" id="f_past" placeholder="e.g. Appendectomy 2018, AIIMS Delhi." style="min-height:56px"></textarea>
          </div>
        </div>
      </div>

      <!-- ── STEP 3: Vitals & Lifestyle ── -->
      <div class="step-panel" id="step-panel-3">
        <div class="form-section-title">📡 Initial Vitals</div>
        <div class="vital-input-grid">
          <div class="vital-input-box">
            <div class="vlbl">Heart Rate</div>
            <input type="number" id="f_hr" placeholder="72" min="30" max="300">
            <div class="vunit">beats / min</div>
          </div>
          <div class="vital-input-box">
            <div class="vlbl">Blood Pressure</div>
            <input type="text" id="f_bp" placeholder="120/80" style="font-size:0.9rem">
            <div class="vunit">mmHg (systolic / diastolic)</div>
          </div>
          <div class="vital-input-box">
            <div class="vlbl">SpO₂</div>
            <input type="number" id="f_spo2" placeholder="98" min="50" max="100">
            <div class="vunit">% oxygen saturation</div>
          </div>
          <div class="vital-input-box">
            <div class="vlbl">Temperature</div>
            <input type="number" id="f_temp" placeholder="37.0" step="0.1" min="34" max="42">
            <div class="vunit">°C</div>
          </div>
          <div class="vital-input-box">
            <div class="vlbl">Weight</div>
            <input type="number" id="f_weight" placeholder="70" min="1" max="300">
            <div class="vunit">kilograms</div>
          </div>
          <div class="vital-input-box">
            <div class="vlbl">Height</div>
            <input type="number" id="f_height" placeholder="170" min="30" max="250">
            <div class="vunit">centimetres</div>
          </div>
          <div class="vital-input-box">
            <div class="vlbl">Fasting Blood Sugar</div>
            <input type="number" id="f_fbs" placeholder="90" min="30" max="600">
            <div class="vunit">mg / dL</div>
          </div>
          <div class="vital-input-box">
            <div class="vlbl">Respiratory Rate</div>
            <input type="number" id="f_rr" placeholder="16" min="4" max="60">
            <div class="vunit">breaths / min</div>
          </div>
        </div>

        <div class="form-section-title" style="margin-top:20px">🌿 Lifestyle Factors</div>
        <div class="form-grid form-grid-3">
          <div class="form-group">
            <label class="form-label">Smoking Status</label>
            <select class="form-select" id="f_smoke">
              <option value="">Select…</option>
              <option>Never smoked</option>
              <option>Ex-smoker</option>
              <option>Current smoker — occasional</option>
              <option>Current smoker — daily</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Alcohol Consumption</label>
            <select class="form-select" id="f_alcohol">
              <option value="">Select…</option>
              <option>None</option>
              <option>Occasional (social)</option>
              <option>Moderate (weekly)</option>
              <option>Heavy (daily)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Physical Activity</label>
            <select class="form-select" id="f_activity">
              <option value="">Select…</option>
              <option>Sedentary (desk job, no exercise)</option>
              <option>Lightly active (1–3 days/week)</option>
              <option>Moderately active (3–5 days/week)</option>
              <option>Very active (6–7 days/week)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Diet Type</label>
            <select class="form-select" id="f_diet">
              <option value="">Select…</option>
              <option>Vegetarian</option>
              <option>Non-vegetarian</option>
              <option>Vegan</option>
              <option>Mixed / Eggetarian</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Sleep Duration</label>
            <select class="form-select" id="f_sleep">
              <option value="">Select…</option>
              <option>Less than 5 hours</option>
              <option>5–6 hours</option>
              <option>7–8 hours (recommended)</option>
              <option>More than 9 hours</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Stress Level</label>
            <select class="form-select" id="f_stress">
              <option value="">Select…</option>
              <option>Low</option>
              <option>Moderate</option>
              <option>High</option>
              <option>Very high (chronic stress)</option>
            </select>
          </div>
        </div>

        <div class="form-section-title" style="margin-top:20px">📝 Clinical Notes</div>
        <div class="form-group">
          <label class="form-label">Additional Notes for AI</label>
          <textarea class="form-textarea" id="f_notes" placeholder="Any additional observations, presenting context, or notes for the AI consultation engine…" style="min-height:80px"></textarea>
        </div>
      </div>

      <!-- ── STEP 4: Review & Register ── -->
      <div class="step-panel" id="step-panel-4">
        <div id="summaryContent">
          <!-- Filled by JS -->
        </div>
        <div style="background:var(--teal-dim);border:1px solid rgba(0,212,180,0.2);border-radius:10px;padding:14px 16px;margin-top:4px">
          <div style="font-size:0.78rem;color:var(--teal);font-weight:600;margin-bottom:4px">🤖 AI Readiness</div>
          <div style="font-size:0.78rem;color:var(--text2);line-height:1.6">Upon registration, SamarthaaMed will:<br>
          • Generate a baseline predictive risk profile (diabetes, cardiac, hypertension)<br>
          • Pre-load relevant ICMR guidelines for the selected specialization<br>
          • Flag any drug interactions in the current medication list<br>
          • Set up longitudinal tracking for vitals and lab trends</div>
        </div>
      </div>

      <!-- Success overlay -->
      <div class="success-overlay" id="successOverlay">
        <div class="success-icon">✅</div>
        <div class="success-title">Patient Registered!</div>
        <div class="success-sub">New patient has been added to the registry</div>
        <div class="success-id" id="successId">MM-2026-XXXXX</div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-primary" onclick="goToNewConsult()">🩺 Start AI Consultation</button>
          <button class="btn btn-ghost" onclick="closeModal()">Back to Registry</button>
        </div>
      </div>

    </div><!-- end modal-body -->

    <!-- Footer -->
    <div class="modal-footer" id="modalFooter">
      <div class="modal-footer-info" id="stepInfo">Step 1 of 4 — Personal Information</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" id="btnBack" onclick="prevStep()" style="display:none">← Back</button>
        <button class="btn btn-primary btn-sm" id="btnNext" onclick="nextStep()">Continue →</button>
        <button class="btn btn-primary btn-sm" id="btnRegister" onclick="registerPatient()" style="display:none">✅ Register Patient</button>
      </div>
    </div>

  </div>
</div>

<!-- ══ TOAST NOTIFICATION ══ -->


<!-- ══ URGENT CASES MODAL ══ -->
<div class="modal-overlay" id="urgentModal">
  <div class="modal" style="width:560px">
    <div class="modal-header" style="background:var(--red-dim);border-bottom:1px solid rgba(255,77,109,0.2)">
      <div>
        <div class="modal-title" style="color:var(--red)">🚨 Urgent Cases — Immediate Attention</div>
        <div class="modal-subtitle">3 patients require urgent clinical intervention today</div>
      </div>
      <button class="modal-close" onclick="document.getElementById('urgentModal').classList.remove('open')">✕</button>
    </div>
    <div class="modal-body" style="padding:0">

      <div style="padding:10px 18px;background:rgba(255,77,109,0.06);border-bottom:1px solid var(--border);font-size:0.72rem;color:var(--text3)">
        Sorted by severity · Click any patient to open AI Consultation
      </div>

      <!-- Patient 1 -->
      <div onclick="document.getElementById('urgentModal').classList.remove('open');openConsultForPatient('PK','Priya Krishnamurthy')"
        style="display:flex;gap:14px;padding:16px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s"
        onmouseover="this.style.background='var(--teal-dim)'" onmouseout="this.style.background=''">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#EF4444,#DC2626);display:flex;align-items:center;justify-content:center;font-size:0.9rem;font-weight:700;color:#fff;flex-shrink:0">PK</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
            <span style="font-weight:600;color:var(--text1);font-size:0.88rem">Priya Krishnamurthy</span>
            <span style="font-family:var(--mono);font-size:0.65rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px;font-weight:700">HEART 7/10</span>
          </div>
          <div style="font-size:0.78rem;color:var(--text2);margin-bottom:6px">52F · NSTEMI suspected · Chest pain ×2 days · Troponin I 0.08 ng/mL ↑</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span style="font-size:0.68rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px">Troponin ↑↑</span>
            <span style="font-size:0.68rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px">CK-MB ↑</span>
            <span style="font-size:0.68rem;background:var(--gold-dim);color:var(--gold);padding:2px 7px;border-radius:4px">HTN Stage 2</span>
            <span style="font-size:0.68rem;background:var(--gold-dim);color:var(--gold);padding:2px 7px;border-radius:4px">DM uncontrolled</span>
          </div>
          <div style="margin-top:8px;font-size:0.73rem;color:var(--teal);font-weight:500">→ Recommend: Cath lab activation · Dual antiplatelet · LMWH</div>
        </div>
        <div style="font-size:1.1rem;color:var(--text3);align-self:center">›</div>
      </div>

      <!-- Patient 2 -->
      <div onclick="document.getElementById('urgentModal').classList.remove('open');openConsultForPatient('DK','Deepak Kumar')"
        style="display:flex;gap:14px;padding:16px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s"
        onmouseover="this.style.background='var(--teal-dim)'" onmouseout="this.style.background=''">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#EF4444,#B91C1C);display:flex;align-items:center;justify-content:center;font-size:0.9rem;font-weight:700;color:#fff;flex-shrink:0">DK</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
            <span style="font-weight:600;color:var(--text1);font-size:0.88rem">Deepak Kumar</span>
            <span style="font-family:var(--mono);font-size:0.65rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px;font-weight:700">SpO₂ 88%</span>
          </div>
          <div style="font-size:0.78rem;color:var(--text2);margin-bottom:6px">58M · COPD acute exacerbation · Resp rate 28/min · Using accessory muscles</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span style="font-size:0.68rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px">Hypoxia</span>
            <span style="font-size:0.68rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px">Tachypnea</span>
            <span style="font-size:0.68rem;background:var(--gold-dim);color:var(--gold);padding:2px 7px;border-radius:4px">COPD · Asthma overlap</span>
          </div>
          <div style="margin-top:8px;font-size:0.73rem;color:var(--teal);font-weight:500">→ Recommend: O₂ therapy · Nebulised bronchodilator · IV steroids</div>
        </div>
        <div style="font-size:1.1rem;color:var(--text3);align-self:center">›</div>
      </div>

      <!-- Patient 3 -->
      <div onclick="document.getElementById('urgentModal').classList.remove('open');openConsultForPatient('MI','Meena Iyer')"
        style="display:flex;gap:14px;padding:16px 18px;cursor:pointer;transition:background .15s"
        onmouseover="this.style.background='var(--teal-dim)'" onmouseout="this.style.background=''">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#DC2626,#991B1B);display:flex;align-items:center;justify-content:center;font-size:0.9rem;font-weight:700;color:#fff;flex-shrink:0">MI</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
            <span style="font-weight:600;color:var(--text1);font-size:0.88rem">Meena Iyer</span>
            <span style="font-family:var(--mono);font-size:0.65rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px;font-weight:700">BP 210/118</span>
          </div>
          <div style="font-size:0.78rem;color:var(--text2);margin-bottom:6px">49F · Hypertensive crisis · Severe headache · Visual disturbance · No prior HTN Hx</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span style="font-size:0.68rem;background:var(--red-dim);color:var(--red);padding:2px 7px;border-radius:4px">Crisis BP</span>
            <span style="font-size:0.68rem;background:var(--gold-dim);color:var(--gold);padding:2px 7px;border-radius:4px">Papilloedema risk</span>
            <span style="font-size:0.68rem;background:var(--gold-dim);color:var(--gold);padding:2px 7px;border-radius:4px">New-onset</span>
          </div>
          <div style="margin-top:8px;font-size:0.73rem;color:var(--teal);font-weight:500">→ Recommend: IV labetalol · Fundus exam · Brain CT · ICU monitoring</div>
        </div>
        <div style="font-size:1.1rem;color:var(--text3);align-self:center">›</div>
      </div>

    </div>
    <div class="modal-footer" style="background:var(--navy3)">
      <div style="font-size:0.75rem;color:var(--text3)">All 3 flagged by SamarthaaMed · Updated 2 min ago</div>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('urgentModal').classList.remove('open')">Close</button>
    </div>
  </div>
</div>

<!-- ══ SOAP NOTE MODAL ══ -->
<div class="soap-modal" id="soapModal">
  <div class="soap-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div><div style="font-family:var(--syne);font-size:1.1rem;font-weight:800;color:var(--text1)">📝 SOAP Note</div><div style="font-size:0.72rem;color:var(--text3);margin-top:3px" id="soapPatientLabel">Priya Krishnamurthy · 24 Feb 2026</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" onclick="printSOAPNote()">🖨 Print</button>
        <button class="btn btn-ghost btn-sm" onclick="copySoap()">📋 Copy</button>
        <button class="modal-close" onclick="document.getElementById('soapModal').classList.remove('open')">✕</button>
      </div>
    </div>
    <div class="soap-section"><div class="soap-label">S — Subjective</div><div class="soap-text" id="soapS"></div></div>
    <div class="soap-section"><div class="soap-label">O — Objective</div><div class="soap-text" id="soapO"></div></div>
    <div class="soap-section"><div class="soap-label">A — Assessment</div><div class="soap-text" id="soapA"></div></div>
    <div class="soap-section"><div class="soap-label">P — Plan</div><div class="soap-text" id="soapP"></div></div>
    <div class="soap-section"><div class="soap-label">ICD-11 Codes</div><div class="soap-text" id="soapICD"></div></div>
  </div>
</div>

<!-- ══ LAB ENTRY MODAL ══ -->
<div class="modal-overlay" id="labModal">
  <div class="modal" style="width:740px;max-height:90vh;display:flex;flex-direction:column">
    <div class="modal-header">
      <div><div class="modal-title">🧪 Lab Results</div><div class="modal-subtitle">Enter manually or upload a lab report for AI extraction</div></div>
      <button class="modal-close" onclick="closeLabModal()">✕</button>
    </div>

    <!-- Mode toggle tabs -->
    <div style="display:flex;border-bottom:1px solid var(--border);flex-shrink:0">
      <button id="labTabManual" onclick="switchLabMode('manual')"
        style="flex:1;padding:12px;font-size:0.8rem;font-weight:600;border:none;cursor:pointer;background:var(--teal-dim);color:var(--teal);border-bottom:2px solid var(--teal);transition:all .2s">
        ✏️ Manual Entry
      </button>
      <button id="labTabUpload" onclick="switchLabMode('upload')"
        style="flex:1;padding:12px;font-size:0.8rem;font-weight:600;border:none;cursor:pointer;background:transparent;color:var(--text3);border-bottom:2px solid transparent;transition:all .2s">
        📄 Upload Report
      </button>
    </div>

    <div class="modal-body" style="flex:1;overflow-y:auto">

      <!-- Patient / date / source row (shared) -->
      <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
        <div class="form-group" style="flex:1;min-width:180px"><label class="form-label">Patient</label><select class="form-select" id="labModalPatientSelect"></select></div>
        <div class="form-group" style="min-width:140px"><label class="form-label">Date of Report</label><input class="form-input" type="date" id="labDate"></div>
        <div class="form-group" style="flex:1;min-width:160px"><label class="form-label">Lab / Source</label><input class="form-input" id="labSource" placeholder="e.g. AIIMS Central Lab"></div>
      </div>

      <!-- ── MANUAL ENTRY PANEL ── -->
      <div id="labPanelManual">
        <div style="font-size:0.72rem;color:var(--text3);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.8px">
          Enter values — abnormals highlight automatically
        </div>
        <div id="labEntryRows">
          <div class="lab-input-row"><span class="lab-name-col">Troponin I</span><span class="lab-ref-col">&lt;0.04 ng/mL</span><input class="lab-val-input" placeholder="ng/mL" oninput="flagLab(this,0,0.04,'H')"></div>
          <div class="lab-input-row"><span class="lab-name-col">CK-MB</span><span class="lab-ref-col">&lt;25 U/L</span><input class="lab-val-input" placeholder="U/L" oninput="flagLab(this,0,25,'H')"></div>
          <div class="lab-input-row"><span class="lab-name-col">HbA1c</span><span class="lab-ref-col">&lt;6.5%</span><input class="lab-val-input" placeholder="%" oninput="flagLab(this,0,6.5,'H')"></div>
          <div class="lab-input-row"><span class="lab-name-col">Fasting Blood Sugar</span><span class="lab-ref-col">70–100 mg/dL</span><input class="lab-val-input" placeholder="mg/dL" oninput="flagLab(this,70,100,'HL')"></div>
          <div class="lab-input-row"><span class="lab-name-col">LDL-C</span><span class="lab-ref-col">&lt;100 mg/dL</span><input class="lab-val-input" placeholder="mg/dL" oninput="flagLab(this,0,100,'H')"></div>
          <div class="lab-input-row"><span class="lab-name-col">HDL-C</span><span class="lab-ref-col">&gt;40 mg/dL</span><input class="lab-val-input" placeholder="mg/dL" oninput="flagLab(this,40,999,'L')"></div>
          <div class="lab-input-row"><span class="lab-name-col">Serum Creatinine</span><span class="lab-ref-col">0.6–1.2 mg/dL</span><input class="lab-val-input" placeholder="mg/dL" oninput="flagLab(this,0.6,1.2,'HL')"></div>
          <div class="lab-input-row"><span class="lab-name-col">eGFR</span><span class="lab-ref-col">&gt;60 mL/min</span><input class="lab-val-input" placeholder="mL/min" oninput="flagLab(this,60,999,'L')"></div>
          <div class="lab-input-row"><span class="lab-name-col">Hemoglobin</span><span class="lab-ref-col">11.5–16.5 g/dL</span><input class="lab-val-input" placeholder="g/dL" oninput="flagLab(this,11.5,16.5,'HL')"></div>
          <div class="lab-input-row"><span class="lab-name-col">TSH</span><span class="lab-ref-col">0.4–4.0 mIU/L</span><input class="lab-val-input" placeholder="mIU/L" oninput="flagLab(this,0.4,4.0,'HL')"></div>
          <div class="lab-input-row"><span class="lab-name-col">Serum K⁺</span><span class="lab-ref-col">3.5–5.0 mEq/L</span><input class="lab-val-input" placeholder="mEq/L" oninput="flagLab(this,3.5,5.0,'HL')"></div>
          <div class="lab-input-row"><span class="lab-name-col">INR</span><span class="lab-ref-col">0.8–1.2</span><input class="lab-val-input" placeholder="ratio" oninput="flagLab(this,0.8,1.2,'HL')"></div>
        </div>
      </div>

      <!-- ── UPLOAD REPORT PANEL ── -->
      <div id="labPanelUpload" style="display:none">

        <!-- Always-visible drop zone (stays visible for more uploads) -->
        <div id="labUploadZone"
          style="border:2px dashed var(--border2);border-radius:12px;padding:28px 24px;text-align:center;cursor:pointer;transition:all .2s;background:var(--panel);margin-bottom:14px"
          onclick="document.getElementById('labReportFile').click()"
          ondragover="event.preventDefault();this.style.borderColor='var(--teal)';this.style.background='var(--teal-dim)'"
          ondragleave="this.style.borderColor='';this.style.background='var(--panel)'"
          ondrop="handleLabReportDrop(event)">
          <div style="font-size:2rem;margin-bottom:8px;opacity:0.5">📂</div>
          <div style="font-family:var(--syne);font-size:0.88rem;font-weight:700;color:var(--text2);margin-bottom:4px">Drop reports here or click to browse</div>
          <div style="font-size:0.72rem;color:var(--text3)">PDF, JPG, PNG · Add multiple files · Each merged into combined results</div>
          <div style="display:flex;gap:6px;justify-content:center;margin-top:10px">
            <span style="background:var(--navy3);border:1px solid var(--border2);color:var(--text3);font-size:0.65rem;padding:2px 8px;border-radius:4px">PDF</span>
            <span style="background:var(--navy3);border:1px solid var(--border2);color:var(--text3);font-size:0.65rem;padding:2px 8px;border-radius:4px">JPG</span>
            <span style="background:var(--navy3);border:1px solid var(--border2);color:var(--text3);font-size:0.65rem;padding:2px 8px;border-radius:4px">PNG</span>
          </div>
        </div>
        <input type="file" id="labReportFile" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none" onchange="handleLabReportUpload(event)">

        <!-- Upload queue (file cards) -->
        <div id="labUploadQueue" style="display:none;margin-bottom:14px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="font-size:0.72rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px">Uploaded Reports</div>
            <button onclick="clearAllReports()" class="btn btn-ghost btn-sm" style="font-size:0.68rem;padding:3px 8px">🗑 Clear All</button>
          </div>
          <div id="labQueueCards" style="display:flex;flex-direction:column;gap:6px"></div>
        </div>

        <!-- Merged extracted results -->
        <div id="labExtractedPreview" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <div>
              <div style="font-size:0.78rem;font-weight:600;color:var(--teal);text-transform:uppercase;letter-spacing:0.8px">🤖 AI-Extracted Values</div>
              <div style="font-size:0.68rem;color:var(--text3);margin-top:2px" id="labExtractSummary">From 1 report · Review &amp; edit before saving</div>
            </div>
            <button onclick="switchLabMode('manual')" class="btn btn-ghost btn-sm" style="font-size:0.7rem">✏️ Manual Edit</button>
          </div>
          <div id="labExtractedRows"></div>
          <div style="background:var(--gold-dim);border:1px solid rgba(245,166,35,0.2);border-radius:8px;padding:9px 12px;margin-top:10px;font-size:0.74rem;color:var(--gold)">
            ⚠ AI extraction is an aid — always verify values against the original report before saving.
          </div>
        </div>

        <!-- Instructions (shown only when no files uploaded) -->
        <div id="labUploadInstructions">
          <div style="font-size:0.78rem;font-weight:600;color:var(--text2);margin-bottom:8px">How it works</div>
          <div style="display:flex;flex-direction:column;gap:7px">
            <div style="display:flex;align-items:flex-start;gap:10px;font-size:0.76rem;color:var(--text2)"><span style="background:var(--teal-dim);color:var(--teal);font-weight:700;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.7rem">1</span>Upload one or more lab reports (CBC, LFT, RFT, Lipids etc.)</div>
            <div style="display:flex;align-items:flex-start;gap:10px;font-size:0.76rem;color:var(--text2)"><span style="background:var(--teal-dim);color:var(--teal);font-weight:700;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.7rem">2</span>AI reads each report and merges all values into one combined panel</div>
            <div style="display:flex;align-items:flex-start;gap:10px;font-size:0.76rem;color:var(--text2)"><span style="background:var(--teal-dim);color:var(--teal);font-weight:700;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.7rem">3</span>Review, edit if needed, then save all to the patient record at once</div>
          </div>
        </div>

      </div>

    </div><!-- end modal-body -->

    <div class="modal-footer" style="flex-shrink:0">
      <div class="modal-footer-info" id="labFooterInfo">Abnormal values auto-highlighted · AI interpretation on save</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="closeLabModal()">Cancel</button>
        <button class="btn btn-primary btn-sm" id="labSaveBtn" onclick="saveLabResults()">💾 Save Results</button>
      </div>
    </div>
  </div>
</div>

<script>
  const views = {
    dashboard: { title: 'Clinical Dashboard', sub: 'Tuesday, 24 February 2026 · AIIMS Delhi' },
    consult:   { title: 'AI Consultation', sub: 'Priya Krishnamurthy · Active Session' },
    patients:  { title: 'Patient Registry', sub: '482 patients · 40+ specializations' },
    risk:      { title: 'Predictive Risk Engine', sub: 'ML models · 6–18 month prediction window' },
    specs:     { title: 'Specializations', sub: '40+ allopathic domains with AI models' },
    prescription: { title: 'Prescription Builder', sub: 'ICMR-aligned · Jan Aushadhi formulary' },
    labs:      { title: 'Lab Results', sub: 'Enter, review and track investigations with AI interpretation' },
    imaging:   { title: 'Imaging AI', sub: 'Upload X-rays, ECGs, CT scans for AI-powered analysis' },
    analytics: { title: 'Analytics & Insights', sub: 'Clinical performance · AI usage · Patient outcomes' },
    settings:  { title: 'Settings', sub: 'Configure SamarthaaMed platform preferences' },
    radiology:   { title: 'Radiology & Imaging Intelligence', sub: 'AI-powered radiology report analysis · ICMR imaging guidelines' },
    dentistry:   { title: 'Dentistry & Oral Medicine', sub: 'AI-powered dental diagnosis · Oral charting · Procedure planning · IDA & ICMR guidelines' },
  };


  function filterPatients(btn, filter) {
    btn.closest('.filter-row').querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const rows = document.querySelectorAll('.data-table tbody tr');
    rows.forEach(row => {
      const spec = row.cells[3] ? row.cells[3].textContent.toLowerCase() : '';
      const riskCell = row.cells[5] ? row.cells[5].textContent : '';
      const riskPct = parseInt(riskCell) || 0;
      const statusBadge = row.querySelector('.status-badge');
      const statusText = statusBadge ? statusBadge.textContent.toLowerCase() : '';
      const lastVisit = row.cells[4] ? row.cells[4].textContent.toLowerCase() : '';
      let show = true;
      if (filter === 'cardiology')  show = spec.includes('cardiology');
      else if (filter === 'high-risk') show = riskPct >= 50 || statusText === 'urgent';
      else if (filter === 'today')  show = lastVisit === 'today';
      else if (filter === 'critical') show = statusText === 'urgent';
      row.style.display = show ? '' : 'none';
    });
    const visible = [...rows].filter(r => r.style.display !== 'none').length;
    showToast('🔍', `Filter: ${btn.textContent}`, `${visible} patient${visible !== 1 ? 's' : ''} shown`);
  }

  function showUrgentPanel() {
    document.getElementById('urgentModal').classList.add('open');
  }

  function addImagingToReport() {
    const findings = document.getElementById('findingsList');
    const recommendation = document.getElementById('imagingRecommendation');
    if (!findings || findings.children.length === 0) {
      showToast('⚠️', 'No findings yet', 'Run AI analysis first before adding to report');
      return;
    }
    const findingTexts = [...findings.querySelectorAll('.finding-title')].map(el => el.childNodes[0].textContent.trim()).join(', ');
    const recText = recommendation ? recommendation.textContent.trim() : '';
    const summary = `📋 Imaging AI Report — ${document.querySelector('.scan-type-btn.active')?.textContent || 'Scan'}\nFindings: ${findingTexts}.\n${recText}`;
    // Add to consultation chat if it's open, otherwise copy to clipboard
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
      const div = document.createElement('div');
      div.className = 'msg ai';
      div.innerHTML = `<div class="msg-bubble"><div style="font-size:0.72rem;color:var(--text3);margin-bottom:6px">📋 Imaging report attached to consultation</div><div style="font-size:0.8rem;white-space:pre-line;color:var(--text2)">${summary}</div></div>`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    navigator.clipboard && navigator.clipboard.writeText(summary).catch(() => {});
    showToast('📋', 'Added to report', 'Imaging findings attached to patient consultation');
  }

  function printImagingReport() {
    const findings = document.getElementById('findingsList');
    const recommendation = document.getElementById('imagingRecommendation');
    const uploadedImage = document.getElementById('uploadedImage');
    const scanType = document.querySelector('.scan-type-btn.active')?.textContent || 'Medical Scan';
    
    if (!findings || findings.children.length === 0) {
      showToast('⚠️', 'No findings yet', 'Run AI analysis first before printing');
      return;
    }
    
    // Get current patient info
    const activeChip = document.querySelector('.patient-chip.active');
    let patientName = 'Patient';
    let patientInfo = '';
    if (activeChip) {
      const onclick = activeChip.getAttribute('onclick');
      const match = onclick.match(/'(\w+)'/);
      if (match) {
        const patient = patientProfiles[match[1]];
        if (patient) {
          patientName = patient.name;
          patientInfo = patient.meta;
        }
      }
    }
    
    // Extract findings
    const findingsArray = [...findings.querySelectorAll('.finding-item')].map(item => {
      const title = item.querySelector('.finding-title')?.childNodes[0]?.textContent?.trim() || '';
      const conf = item.querySelector('.finding-conf')?.textContent || '';
      return { title, conf };
    });
    
    const recText = recommendation ? recommendation.textContent.trim() : 'Continue monitoring as per clinical indication.';
    
    // Create print window
    const printWindow = window.open('', '_blank');
    const printContent = `
<!DOCTYPE html>
<html>
<head>
  <title>Imaging Report - ${patientName}</title>
  <style>
    @page { margin: 2cm; }
    body { 
      font-family: 'Arial', sans-serif; 
      line-height: 1.6; 
      color: #000;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #10b981;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #10b981;
      margin-bottom: 5px;
    }
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    .patient-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .section {
      margin-bottom: 25px;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #10b981;
      border-bottom: 2px solid #10b981;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }
    .scan-type {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 20px;
    }
    .finding {
      margin-bottom: 12px;
      padding: 10px;
      background: #f8f9fa;
      border-left: 4px solid #10b981;
    }
    .finding-title {
      font-weight: bold;
      color: #333;
    }
    .confidence {
      color: #10b981;
      font-size: 12px;
      margin-left: 10px;
    }
    .recommendation {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #10b981;
    }
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #ddd;
      text-align: center;
      color: #666;
      font-size: 12px;
    }
    .timestamp {
      color: #999;
      font-size: 12px;
      text-align: right;
      margin-bottom: 20px;
    }
    .image-preview {
      max-width: 100%;
      max-height: 400px;
      margin: 20px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    @media print {
      .no-print { display: none; }
      body { padding: 0; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">🧬 SamarthaaMed</div>
    <div class="subtitle">Clinical Intelligence Platform - Imaging AI Report</div>
  </div>
  
  <div class="timestamp">Generated: ${new Date().toLocaleString('en-IN', { 
    dateStyle: 'full', 
    timeStyle: 'short' 
  })}</div>
  
  <div class="patient-info">
    <strong>Patient:</strong> ${patientName}<br>
    ${patientInfo ? `<strong>Details:</strong> ${patientInfo}<br>` : ''}
    <strong>Report ID:</strong> IMG-${Date.now().toString().slice(-8)}
  </div>
  
  <div class="scan-type">📋 ${scanType} Analysis</div>
  
  ${uploadedImage && uploadedImage.src && uploadedImage.style.display !== 'none' ? 
    `<div class="section">
      <div class="section-title">Image</div>
      <img src="${uploadedImage.src}" class="image-preview" alt="Medical scan">
    </div>` : ''}
  
  <div class="section">
    <div class="section-title">AI-Generated Findings</div>
    ${findingsArray.map((f, i) => `
      <div class="finding">
        <span class="finding-title">${i + 1}. ${f.title}</span>
        <span class="confidence">${f.conf}</span>
      </div>
    `).join('')}
  </div>
  
  <div class="section">
    <div class="section-title">Recommendations</div>
    <div class="recommendation">
      ${recText}
    </div>
  </div>
  
  <div class="footer">
    <p><strong>SamarthaaMed AI-Powered Imaging Analysis</strong></p>
    <p>This report was generated using artificial intelligence. Clinical correlation is recommended.</p>
    <p>AI Model Version: Imaging-AI v3.2 | Confidence Threshold: 75%</p>
  </div>
  
  <div class="no-print" style="margin-top: 30px; text-align: center;">
    <button onclick="window.print()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
      🖨 Print Report
    </button>
    <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-left: 10px;">
      Close
    </button>
  </div>
<div class="toast" id="toast">
  <div class="toast-icon" id="toastIcon">✅</div>
  <div>
    <div class="toast-text" id="toastText">Patient registered</div>
    <div class="toast-sub" id="toastSub"></div>
  </div>
  <div class="toast-bar"></div>
</div>
</body>
</html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    showToast('🖨', 'Print Preview Ready', 'Report opened in new window');
  }

  function exportAnalyticsCSV() {
    const rows = [
      ['Metric', 'Value', 'Change'],
      ['Total Patients', '482', '+12%'],
      ['Consultations', '1,284', '+8%'],
      ['AI Acceptance Rate', '94.2%', '+2.1%'],
      ['Drug Interactions Prevented', '18', 'This month'],
      ['High-Risk Alerts', '7', 'Active monitoring'],
      ['Diagnoses Suggested', '18', 'Today'],
      ['Prescriptions Assisted', '12', 'Today'],
      ['Drug Interactions Flagged', '3', 'Today'],
      ['Reports Auto-summarized', '7', 'Today'],
    ];
    const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `SamarthaaMed_Analytics_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    showToast('⬇', 'Exported', 'Analytics data downloaded as CSV');
  }

  function exportRiskReport() {
    const rows = [
      ['Patient', 'Risk Score', 'Condition', 'Timeframe', 'Status'],
      ['Priya Krishnamurthy', '82%', 'Cardiac event', '6 months', 'Urgent'],
      ['Ramesh Singh', '67%', 'CKD progression', '12 months', 'Active'],
      ['Vikram Nair', '55%', 'Hypertension onset', '18 months', 'Waiting'],
      ['Sunita Gupta', '38%', 'Re-infarction', '12 months', 'Stable'],
      ['Deepak Kumar', '49%', 'COPD exacerbation', '6 months', 'Stable'],
      ['Mohan Pillai', '22%', 'Epilepsy relapse', '18 months', 'Stable'],
      ['Nandini Bose', '18%', 'Thyroid dysfunction', '12 months', 'Stable'],
    ];
    const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `SamarthaaMed_RiskReport_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    showToast('📊', 'Report exported', 'Patient risk data downloaded as CSV');
  }

  function showView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const v = document.getElementById('view-' + id);
    if (v) v.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => {
      if (n.getAttribute('onclick') && n.getAttribute('onclick').includes(id)) n.classList.add('active');
    });
    if (views[id]) {
      document.getElementById('topbar-title').textContent = views[id].title;
      document.getElementById('topbar-sub').textContent = views[id].sub;
    }
    // Consult view is self-contained; all other views scroll via .content
    const content = document.querySelector('.content');
    if (content) content.scrollTop = 0;
    onViewChange(id);
  }

  // Textarea auto-grow already handled inline
  // Init
  animateVital('vhr', 98, 8);
  document.addEventListener('DOMContentLoaded', () => {
    restoreAnthropicKey();
    buildAnalyticsBarChart();
    syncAllPatientDropdowns(); // ✅ populate lab dropdowns on load
    document.getElementById('labDate') && (document.getElementById('labDate').valueAsDate = new Date());
  });

  function switchRightTab(el, id) {
    el.closest('.consult-right-tabs').querySelectorAll('.r-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    const tab = document.getElementById('tab-' + id);
    if (tab) tab.classList.add('active');
  }

  const aiResponses = [
    "Based on the clinical picture and current ICMR 2024 ACS guidelines, I recommend proceeding with urgent coronary angiography within 24 hours given the GRACE score >140. Pre-cath checklist: NPO, IV access ×2, consent, nephroprotection protocol (NS 1 mL/kg/h 6h pre/post), and hold Metformin confirmed.",
    "Regarding the elevated HbA1c of 8.4% — in the acute ACS setting, intensive glucose control is NOT recommended (target BG 140–180 mg/dL). Use sliding-scale insulin if BG >180. Resume Metformin 48h post-cath once creatinine is stable. Consider adding an SGLT2 inhibitor (Dapagliflozin 10mg) for cardioprotection post-discharge per the DAPA-MI trial.",
    "For the anemia (Hb 10.8 g/dL) noted in context of dual antiplatelet therapy — this is a known risk factor for recurrent events. Check reticulocyte count and iron stores. If iron deficiency confirmed, IV iron sucrose is preferred over oral in acute ACS. A restrictive transfusion strategy is recommended (transfuse only if Hb <7–8 g/dL unless hemodynamic compromise).",
    "Based on the Framingham 10-year cardiac risk of 34% and existing CAD equivalents, LDL target should be <55 mg/dL per the 2024 ESC/CSI guidelines for very high-risk patients. Current LDL 168 mg/dL — Rosuvastatin 40mg alone may be insufficient. Consider adding Ezetimibe 10mg OD. A PCSK9 inhibitor (Evolocumab) may be considered if LDL remains >70 mg/dL after 3 months.",
  ];
  let aiIdx = 0;

  function sendMessage() {
    const input = document.getElementById('chatInput');
    const text  = input.value.trim();
    if (!text) return;
    const msgs   = document.getElementById('chatMessages');
    const typing = document.getElementById('typingIndicator');

    // Append user message to DOM
    const userMsg = document.createElement('div');
    userMsg.className = 'msg user';
    userMsg.innerHTML = `<div class="msg-avatar">DR</div><div><div class="msg-bubble">${text}</div><div class="msg-time">Dr. · Just now</div></div>`;
    msgs.insertBefore(userMsg, typing);
    input.value = '';
    input.style.height = 'auto';
    typing.style.display = 'block';
    msgs.scrollTop = msgs.scrollHeight;

    // Build multi-turn history from DOM
    const history = [];
    Array.from(msgs.querySelectorAll('.msg')).forEach(m => {
      if (m === typing) return;
      const bubble = m.querySelector('.msg-bubble');
      if (!bubble) return;
      const isUser = m.classList.contains('user');
      history.push({ role: isUser ? 'user' : 'assistant', content: bubble.innerText });
    });
    // Ensure last message is current user input (already in DOM)
    if (!history.length || history[history.length-1].content !== text) {
      history.push({ role: 'user', content: text });
    }
    // Claude requires alternating roles — deduplicate consecutive same-role
    const apiMessages = [];
    for (const m of history) {
      if (apiMessages.length && apiMessages[apiMessages.length-1].role === m.role) {
        apiMessages[apiMessages.length-1].content += '\n' + m.content;
      } else {
        apiMessages.push({ role: m.role, content: m.content });
      }
    }

    const patientCtx = getActivePatientContext();
    const systemPrompt = `You are Samarthaa, a senior AI clinical decision-support assistant for Indian doctors.
${patientCtx}

Guidelines:
- Follow ICMR 2024, NHP, WHO SEARO, and CSI protocols for Indian patient populations
- Cite specific guideline names when making recommendations
- Flag critical/urgent findings clearly
- Keep responses concise and clinically actionable
- Use generic drug names (Jan Aushadhi generics preferred)
- Respond in the same language the doctor uses (English or Hindi)`;

    callClaudeAI(apiMessages, systemPrompt)
      .then(raw => {
        typing.style.display = 'none';
        // Try to parse JSON response, fall back to plain text
        let displayText = raw;
        try {
          const parsed = JSON.parse(raw);
          displayText = parsed.response || parsed.text || raw;
        } catch(e) { /* plain text response */ }
        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai';
        aiMsg.innerHTML = `<div class="msg-avatar">🧬</div><div><div class="msg-bubble">${displayText.replace(/\n/g,'<br>')}</div><div class="msg-time">Samarthaa · Just now</div></div>`;
        msgs.insertBefore(aiMsg, typing);
        msgs.scrollTop = msgs.scrollHeight;
        // Speak if ElevenLabs / TTS enabled
        if (typeof speakText === 'function') {
          const useChat = document.getElementById('elUseChatRead');
          if (useChat && useChat.checked) speakText(displayText);
        }
      })
      .catch(err => {
        typing.style.display = 'none';
        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai';
        aiMsg.innerHTML = `<div class="msg-avatar">🧬</div><div><div class="msg-bubble" style="color:var(--red)">⚠️ ${err.message}</div><div class="msg-time">Samarthaa · Just now</div></div>`;
        msgs.insertBefore(aiMsg, typing);
        msgs.scrollTop = msgs.scrollHeight;
      });

    msgs.scrollTop = msgs.scrollHeight;
  }

  /* ── CHAT TOOL BUTTONS ── */

  // 📎 Attach Report
  function chatAttachReport() {
    document.getElementById('reportFileInput').click();
  }

  function handleReportAttach(e) {
    const file = e.target.files[0];
    if (!file) return;
    const msgs = document.getElementById('chatMessages');
    const typing = document.getElementById('typingIndicator');

    // Show user message with attachment
    const userMsg = document.createElement('div');
    userMsg.className = 'msg user';
    userMsg.innerHTML = `<div class="msg-avatar">DR</div><div>
      <div class="msg-bubble" style="display:flex;align-items:center;gap:10px">
        <span style="font-size:1.4rem">📄</span>
        <div>
          <div style="font-weight:600;font-size:0.85rem">${file.name}</div>
          <div style="font-size:0.72rem;color:var(--text3);margin-top:2px">${(file.size/1024).toFixed(1)} KB · ${file.type || 'document'}</div>
        </div>
      </div>
      <div class="msg-time">Dr. · Just now</div>
    </div>`;
    msgs.insertBefore(userMsg, typing);
    typing.style.display = 'block';
    msgs.scrollTop = msgs.scrollHeight;

    setTimeout(() => {
      typing.style.display = 'none';
      const ext = file.name.split('.').pop().toLowerCase();
      let aiReply = '';
      if (['jpg','jpeg','png','dcm'].includes(ext)) {
        aiReply = `I've received the image <strong>${file.name}</strong>. For full AI image analysis with finding detection, please use the <strong>Imaging AI</strong> module (click 📊 Upload ECG or navigate via sidebar). It supports X-ray, ECG, CT, fundus and ultrasound analysis with confidence-scored findings.`;
      } else if (ext === 'pdf') {
        aiReply = `Report <strong>${file.name}</strong> received. I can see this is a PDF document. Please paste the key values (lab results, findings, discharge summary text) directly into the chat and I'll interpret them in the context of this patient's clinical profile.`;
      } else {
        aiReply = `Document <strong>${file.name}</strong> attached. Please describe the key findings or paste relevant values from this report so I can provide clinical interpretation.`;
      }
      const aiMsg = document.createElement('div');
      aiMsg.className = 'msg ai';
      aiMsg.innerHTML = `<div class="msg-avatar">🧬</div><div><div class="msg-bubble">${aiReply}</div><div class="msg-time">Samarthaa · Just now</div></div>`;
      msgs.insertBefore(aiMsg, typing);
      msgs.scrollTop = msgs.scrollHeight;
    }, 1400);
    // Reset so same file can be re-attached
    e.target.value = '';
  }

  // 🎤 Voice Input
  let voiceRecognition = null;
  let isListening = false;

  function chatVoiceInput(btn) {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      showToast('⚠️', 'Voice not supported', 'Use Chrome or Edge for voice input');
      return;
    }
    if (isListening) {
      voiceRecognition && voiceRecognition.stop();
      return;
    }

    // Show language selection modal
    showVoiceLanguageSelector(btn);
  }

  function showVoiceLanguageSelector(btn) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.2s';
    
    modal.innerHTML = `
      <div style="background:var(--panel);border-radius:16px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
        <div style="padding:24px;border-bottom:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:1.2rem;font-weight:700;color:var(--text1);margin-bottom:4px">🎤 Voice Input Language</div>
              <div style="font-size:0.85rem;color:var(--text3)">Select the language you'll speak in</div>
            </div>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.5rem;color:var(--text2);cursor:pointer;padding:0;width:32px;height:32px">×</button>
          </div>
        </div>
        
        <div style="padding:24px;max-height:400px;overflow-y:auto">
          <div style="display:grid;gap:12px">
            ${generateLanguageOptions()}
          </div>
        </div>

        <div style="padding:20px;background:var(--navy3);border-radius:0 0 16px 16px;text-align:center;font-size:0.75rem;color:var(--text3)">
          💡 Tip: Speak clearly and pause briefly before the microphone stops
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);

    // Add click handlers to language buttons
    modal.querySelectorAll('.voice-lang-btn').forEach(langBtn => {
      langBtn.onclick = () => {
        const langCode = langBtn.getAttribute('data-lang');
        const langName = langBtn.getAttribute('data-name');
        modal.remove();
        startVoiceRecognition(langCode, langName, btn);
      };
    });
  }

  function generateLanguageOptions() {
    const languages = [
      { code: 'en-IN', name: 'English (India)', flag: '🇮🇳', native: 'English', tested: true },
      { code: 'hi-IN', name: 'Hindi', flag: '🇮🇳', native: 'हिंदी', tested: true },
      { code: 'kn-IN', name: 'Kannada', flag: '🇮🇳', native: 'ಕನ್ನಡ', tested: true, note: 'Best on Android Chrome' },
      { code: 'ta-IN', name: 'Tamil', flag: '🇮🇳', native: 'தமிழ்', tested: true },
      { code: 'te-IN', name: 'Telugu', flag: '🇮🇳', native: 'తెలుగు', tested: true },
      { code: 'ml-IN', name: 'Malayalam', flag: '🇮🇳', native: 'മലയാളം', tested: true },
      { code: 'bn-IN', name: 'Bengali', flag: '🇮🇳', native: 'বাংলা', tested: true },
      { code: 'mr-IN', name: 'Marathi', flag: '🇮🇳', native: 'मराठी', tested: true },
      { code: 'gu-IN', name: 'Gujarati', flag: '🇮🇳', native: 'ગુજરાતી', tested: true },
      { code: 'pa-IN', name: 'Punjabi', flag: '🇮🇳', native: 'ਪੰਜਾਬੀ', tested: true, note: 'May have limited support' },
      { code: 'ur-IN', name: 'Urdu', flag: '🇮🇳', native: 'اردو', tested: true, note: 'May have limited support' },
    ];

    return languages.map(lang => `
      <button class="voice-lang-btn" data-lang="${lang.code}" data-name="${lang.name}" 
              style="display:flex;align-items:center;gap:12px;padding:16px;background:var(--navy3);border:2px solid var(--border2);border-radius:8px;cursor:pointer;transition:all 0.2s;width:100%"
              onmouseover="this.style.borderColor='var(--teal)';this.style.background='var(--teal-dim)'" 
              onmouseout="this.style.borderColor='var(--border2)';this.style.background='var(--navy3)'">
        <div style="font-size:2rem">${lang.flag}</div>
        <div style="flex:1;text-align:left">
          <div style="font-weight:600;font-size:0.95rem;color:var(--text1)">${lang.name}</div>
          <div style="font-size:0.8rem;color:var(--text3)">${lang.native}</div>
          ${lang.note ? `<div style="font-size:0.7rem;color:var(--gold);margin-top:2px">ℹ️ ${lang.note}</div>` : ''}
        </div>
        <div style="font-size:1.2rem;color:var(--teal)">→</div>
      </button>
    `).join('');
  }

  function startVoiceRecognition(langCode, langName, btn) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRecognition = new SR();
    
    // Set language with fallback
    voiceRecognition.lang = langCode;
    voiceRecognition.interimResults = true;
    voiceRecognition.continuous = false;
    voiceRecognition.maxAlternatives = 3; // Increased for better recognition

    btn.textContent = '⏹ Stop Listening';
    btn.style.color = 'var(--red)';
    btn.style.borderColor = 'var(--red)';
    isListening = true;
    
    showToast('🎤', `Listening in ${langName}`, 'Speak clearly near your microphone');

    let finalTranscript = '';
    let lastResultTime = Date.now();

    voiceRecognition.onstart = () => {
      console.log('Voice recognition started for language:', langCode);
      // Visual indicator that mic is active
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.placeholder = `🎤 Listening in ${langName}... Speak now!`;
        chatInput.style.borderColor = 'var(--red)';
      }
    };

    voiceRecognition.onresult = (e) => {
      console.log('Recognition results:', e.results);
      let interimTranscript = '';
      
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const transcript = e.results[i][0].transcript;
        console.log(`Result ${i}: "${transcript}" (confidence: ${e.results[i][0].confidence}, final: ${e.results[i].isFinal})`);
        
        if (e.results[i].isFinal) {
          finalTranscript += transcript + ' ';
          lastResultTime = Date.now();
        } else {
          interimTranscript += transcript;
        }
      }
      
      // Update input with both final and interim results
      const fullText = (finalTranscript + interimTranscript).trim();
      document.getElementById('chatInput').value = fullText;
      
      // Show interim feedback
      if (interimTranscript) {
        console.log('Interim text:', interimTranscript);
      }
    };

    voiceRecognition.onspeechstart = () => {
      console.log('Speech detected');
      showToast('👂', 'Speech Detected', 'Keep speaking...');
    };

    voiceRecognition.onspeechend = () => {
      console.log('Speech ended');
    };

    voiceRecognition.onnomatch = () => {
      console.log('No match found for speech');
      showToast('⚠️', 'Not Recognized', 'Could not understand speech. Try speaking more clearly.');
    };

    voiceRecognition.onend = () => {
      console.log('Voice recognition ended');
      isListening = false;
      btn.textContent = '🎤 Voice Input';
      btn.style.color = '';
      btn.style.borderColor = '';
      
      // Reset input placeholder
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.placeholder = 'Ask Samarthaa — type in English, Hindi, or any Indian language…';
        chatInput.style.borderColor = '';
      }
      
      const val = document.getElementById('chatInput').value.trim();
      if (val) {
        showToast('✅', 'Voice Recognized', `Text captured in ${langName}`);
        console.log('Final recognized text:', val);
        // Auto-send after short delay
        setTimeout(() => {
          sendMessage();
        }, 500);
      } else {
        showToast('⚠️', 'No Speech Detected', `Please try again. Make sure to speak in ${langName}.`);
        console.log('No text was recognized');
      }
    };

    voiceRecognition.onerror = (e) => {
      console.error('Voice recognition error:', e.error, e);
      isListening = false;
      btn.textContent = '🎤 Voice Input';
      btn.style.color = '';
      btn.style.borderColor = '';
      
      // Reset input
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.placeholder = 'Ask Samarthaa — type in English, Hindi, or any Indian language…';
        chatInput.style.borderColor = '';
      }
      
      let errorMessage = 'Could not recognize speech';
      let errorDetail = '';
      
      if (e.error === 'not-allowed') {
        errorMessage = 'Microphone Access Denied';
        errorDetail = 'Please allow microphone access in browser settings';
      } else if (e.error === 'no-speech') {
        errorMessage = 'No Speech Detected';
        errorDetail = `Please speak clearly in ${langName}`;
      } else if (e.error === 'network') {
        errorMessage = 'Network Error';
        errorDetail = 'Internet connection required for speech recognition';
      } else if (e.error === 'aborted') {
        errorMessage = 'Recognition Stopped';
        errorDetail = 'Voice input was cancelled';
      } else if (e.error === 'audio-capture') {
        errorMessage = 'No Microphone Found';
        errorDetail = 'Please connect a microphone and try again';
      } else if (e.error === 'service-not-allowed') {
        errorMessage = 'Service Not Allowed';
        errorDetail = 'Speech recognition is not available on this page';
      } else if (e.error === 'language-not-supported') {
        errorMessage = 'Language Not Supported';
        errorDetail = `${langName} may not be supported by your browser. Try English or Hindi.`;
      } else {
        errorDetail = `Error: ${e.error}`;
      }
      
      showToast('⚠️', errorMessage, errorDetail);
      
      // If language not supported, suggest alternatives
      if (e.error === 'language-not-supported') {
        setTimeout(() => {
          showToast('💡', 'Suggestion', 'Chrome/Edge on Android has best support for Indian languages');
        }, 2000);
      }
    };

    try {
      voiceRecognition.start();
      console.log('Starting voice recognition for', langName, 'with code', langCode);
    } catch (error) {
      console.error('Failed to start voice recognition:', error);
      showToast('⚠️', 'Voice Input Failed', 'Could not start microphone. Please try again.');
      isListening = false;
      btn.textContent = '🎤 Voice Input';
      btn.style.color = '';
      btn.style.borderColor = '';
    }
  }

  // Update the AI language to match voice input if needed
  function syncVoiceToAILanguage(langCode) {
    const langMap = {
      'en-IN': 'en',
      'hi-IN': 'hi',
      'kn-IN': 'kn',
      'ta-IN': 'ta',
      'te-IN': 'te',
      'bn-IN': 'bn'
    };
    
    const aiLang = langMap[langCode];
    if (aiLang && aiLanguage !== aiLang) {
      aiLanguage = aiLang;
      localStorage.setItem('aiLanguage', aiLang);
    }
  }

  // 🧪 Import Labs — open the lab entry modal pre-linked to this patient
  function chatImportLabs() {
    // Get current patient from topbar subtitle
    const sub = document.getElementById('topbar-sub').textContent;
    const patientName = sub.replace(' · Active Session', '').trim();
    // Pre-select in lab modal if possible
    const labSel = document.getElementById('labModalPatientSelect');
    if (labSel) {
      const opt = Array.from(labSel.options).find(o => o.text.startsWith(patientName));
      if (opt) labSel.value = opt.value;
    }
    openLabEntry();
    showToast('🧪', 'Lab Entry opened', 'Values will be linked to ' + patientName);
  }

  // Animate vitals
  function animateVital(id, base, range) {
    const el = document.getElementById(id);
    if (!el) return;
    setInterval(() => {
      const v = Math.round(base + (Math.random() - 0.5) * range);
      const unit = el.querySelector('.vital-unit');
      el.textContent = v;
      if (unit) el.appendChild(unit);
    }, 3000);
  }

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.closest('.filter-row').querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  /* ══ CONSULTATION ENHANCEMENTS ══ */
  const patientProfiles = {
    PK: {
      name: 'Priya Krishnamurthy', meta: '52F · ID: MM-2024-04521 · Cardiology',
      initials: 'PK', avatarColor: 'linear-gradient(135deg,#EF4444,#DC2626)',
      vitals: { hr:'98 bpm', bp:'148/92', spo2:'96%', temp:'37.4°C' },
      hbColor: '#EF4444',
      complaints: ['Chest pain','Radiating to left arm','Diaphoresis','Dyspnea on exertion','Nausea','Fatigue'],
      complaintTypes: ['red','red','gold','gold','',''],
      history: ['DM Type 2 (8 yrs)','Hypertension (5 yrs)','Dyslipidemia','Ex-smoker'],
      historyTypes: ['','','','gold'],
      meds: 'Metformin 1000mg BD · Amlodipine 5mg OD\nAtorvastatin 40mg HS · Aspirin 75mg OD\nMetoprolol 25mg BD',
      scores: [['HEART Score','7/10 — High Risk','red'],['TIMI Score','5/7 — Moderate','gold'],['Framingham 10-yr','34%','red']],
    },
    DK: {
      name: 'Deepak Kumar', meta: '58M · ID: MM-2026-03345 · Pulmonology',
      initials: 'DK', avatarColor: 'linear-gradient(135deg,#EF4444,#B91C1C)',
      vitals: { hr:'112 bpm', bp:'138/88', spo2:'88%', temp:'37.8°C' },
      hbColor: '#EF4444',
      complaints: ['Severe dyspnea','Using accessory muscles','Productive cough','Wheezing','Chest tightness'],
      complaintTypes: ['red','red','gold','gold',''],
      history: ['COPD (12 yrs)','Asthma-COPD overlap','Ex-smoker (40 pack-years)','Frequent exacerbations'],
      historyTypes: ['red','','gold','red'],
      meds: 'Salbutamol + Ipratropium inhaler\nFluticasone/Salmeterol 500/50 BD\nTheophylline 200mg BD',
      scores: [['SpO₂','88% — Severe hypoxia','red'],['Resp Rate','28/min — Tachypnea','red'],['FEV1','42% predicted','red']],
    },
    MI: {
      name: 'Meena Iyer', meta: '49F · ID: MM-2026-08876 · Emergency Medicine',
      initials: 'MI', avatarColor: 'linear-gradient(135deg,#DC2626,#991B1B)',
      vitals: { hr:'94 bpm', bp:'210/118', spo2:'97%', temp:'37.2°C' },
      hbColor: '#DC2626',
      complaints: ['Severe headache','Visual disturbance','Blurred vision','Nausea and vomiting','Confusion'],
      complaintTypes: ['red','red','gold','gold','red'],
      history: ['No prior HTN history','Family history: Mother — HTN, stroke','No current medications','New onset hypertension'],
      historyTypes: ['','gold','','red'],
      meds: 'None — New presentation',
      scores: [['BP','210/118 — Hypertensive crisis','red'],['MAP','149 mmHg — Critical','red'],['Papilloedema risk','High','red']],
    },
    RS: {
      name: 'Ramesh Singh', meta: '67M · ID: MM-2023-01892 · Cardiology',
      initials: 'RS', avatarColor: 'linear-gradient(135deg,#3B82F6,#1D4ED8)',
      vitals: { hr:'72 bpm', bp:'132/84', spo2:'97%', temp:'36.8°C' },
      hbColor: '#3B82F6',
      complaints: ['Fatigue on exertion','Mild SOB on climbing stairs','Pitting oedema (bilateral)'],
      complaintTypes: ['gold','gold',''],
      history: ['CAD (Post CABG — 2021)','DM Type 2 (12 yrs)','CKD Stage 2','Dyslipidemia'],
      historyTypes: ['','','red',''],
      meds: 'Aspirin 75mg OD · Clopidogrel 75mg OD\nRosuvastatin 20mg HS · Metformin 500mg BD\nRamipril 5mg OD · Furosemide 40mg OD',
      scores: [['GRACE Score','88 — Low-mod','gold'],['eGFR','58 mL/min (CKD G3a)','gold'],['EF (Echo)','48% — Mildly reduced','gold']],
    },
    AM: {
      name: 'Anita Mehta', meta: '38F · ID: MM-2025-09341 · Cardiology',
      initials: 'AM', avatarColor: 'linear-gradient(135deg,#10B981,#059669)',
      vitals: { hr:'108 bpm', bp:'118/74', spo2:'98%', temp:'37.0°C' },
      hbColor: '#10B981',
      complaints: ['Palpitations (intermittent)','Shortness of breath','Anxiety','Chest tightness'],
      complaintTypes: ['gold','','',''],
      history: ['No known chronic illness','Anxiety disorder (treated)','Family history: Father — DM'],
      historyTypes: ['','','gold'],
      meds: 'Clonazepam 0.5mg SOS\nVitamin D3 60,000 IU weekly',
      scores: [['Holter','SVT episodes (20/day)','gold'],['Echo','Normal LV function, EF 65%',''],['TSH','1.8 mIU/L (Normal)','']],
    },
    VN: {
      name: 'Vikram Nair', meta: '44M · ID: MM-2024-07234 · Cardiology',
      initials: 'VN', avatarColor: 'linear-gradient(135deg,#8B5CF6,#7C3AED)',
      vitals: { hr:'80 bpm', bp:'142/88', spo2:'99%', temp:'36.9°C' },
      hbColor: '#8B5CF6',
      complaints: ['Persistent headache (morning)','Occasional dizziness','Visual blurring (rare)'],
      complaintTypes: ['gold','',''],
      history: ['Prehypertension (3 yrs)','Dyslipidemia','Sedentary lifestyle','Overweight (BMI 27.4)'],
      historyTypes: ['','','gold','gold'],
      meds: 'Amlodipine 5mg OD\nAtorvastatin 10mg HS',
      scores: [['BP Stage','Stage 1 Hypertension','gold'],['Framingham 10-yr','18%',''],['BMI','27.4 kg/m² (Overweight)','gold']],
    },
    SG: {
      name: 'Sunita Gupta', meta: '61F · ID: MM-2025-02218 · Cardiology',
      initials: 'SG', avatarColor: 'linear-gradient(135deg,#F59E0B,#D97706)',
      vitals: { hr:'68 bpm', bp:'124/78', spo2:'98%', temp:'36.7°C' },
      hbColor: '#F59E0B',
      complaints: ['Post-STEMI follow-up (3 months)','Mild exertional fatigue','Cardiac rehab ongoing'],
      complaintTypes: ['','gold',''],
      history: ['STEMI anterior wall (Nov 2025)','DM Type 2 (6 yrs)','Hypertension','Post PCI (LAD stenting)'],
      historyTypes: ['red','','',''],
      meds: 'Aspirin 75mg OD · Ticagrelor 90mg BD\nRosuvastatin 40mg HS · Metoprolol 50mg BD\nRamipril 5mg OD · Metformin 1000mg BD',
      scores: [['EF (Echo)','52% — mildly reduced (recovery)','gold'],['6-min walk test','420m — improving',''],['HbA1c','7.1% — near target','']],
    },
    NB: {
      name: 'Nandini Bose', meta: '34F · ID: MM-2025-08876 · Endocrinology',
      initials: 'NB', avatarColor: 'linear-gradient(135deg,#06B6D4,#0891B2)',
      vitals: { hr:'76 bpm', bp:'118/76', spo2:'98%', temp:'36.9°C' },
      hbColor: '#06B6D4',
      complaints: ['Weight gain','Fatigue','Irregular periods','Hair thinning','Cold intolerance'],
      complaintTypes: ['gold','gold','red','',''],
      history: ['Hypothyroidism (diagnosed 2 yrs ago)','PCOS (polycystic ovary syndrome)','Vitamin D deficiency','No other chronic conditions'],
      historyTypes: ['','red','',''],
      meds: 'Levothyroxine 75mcg OD (morning, empty stomach)\nMetformin 500mg BD\nVitamin D3 60,000 IU weekly',
      scores: [['TSH','5.8 mIU/L — Suboptimal','gold'],['Free T4','0.9 ng/dL — Low-normal','gold'],['HbA1c','5.8% — Prediabetes','gold']],
    },
  };

  function switchConsultPatient(el, initials, name, status) {
    // Update chips
    document.querySelectorAll('.patient-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('topbar-sub').textContent = name + ' · Active Session';

    const p = patientProfiles[initials];
    if (!p) return;

    // Update avatar + name in left panel
    const avatarEl = document.querySelector('.consult-patient-avatar');
    if (avatarEl) { avatarEl.textContent = p.initials; avatarEl.style.background = p.avatarColor; }
    const nameEl = document.querySelector('.consult-patient-name');
    if (nameEl) nameEl.textContent = p.name;
    const metaEl = document.querySelector('.consult-patient-meta');
    if (metaEl) metaEl.textContent = p.meta;

    // Update vitals in mini boxes
    const vitMinis = document.querySelectorAll('.vital-mini .vval');
    if (vitMinis.length >= 4) {
      vitMinis[0].textContent = p.vitals.hr;
      vitMinis[1].textContent = p.vitals.bp;
      vitMinis[2].textContent = p.vitals.spo2;
      vitMinis[3].textContent = p.vitals.temp;
    }

    // Update complaint tags
    const tagsWrap = document.querySelector('.consult-left-body .symptom-tags');
    if (tagsWrap) {
      tagsWrap.innerHTML = p.complaints.map((c, i) =>
        `<span class="tag ${p.complaintTypes[i] || ''}">${c}</span>`
      ).join('');
    }

    // Update history tags
    const historyWraps = document.querySelectorAll('.consult-left-body .symptom-tags');
    if (historyWraps.length >= 2) {
      historyWraps[1].innerHTML = p.history.map((h, i) =>
        `<span class="tag ${p.historyTypes[i] || ''}">${h}</span>`
      ).join('');
    }

    // Update medications text
    const medDivs = document.querySelectorAll('.consult-left-body');
    const allText = document.querySelectorAll('.consult-left-body > div');
    // Find the medication text div (after the meds mini-header)
    const medsDiv = document.querySelector('.consult-left-body .mini-header:nth-of-type(3)');
    if (medsDiv && medsDiv.nextElementSibling) {
      medsDiv.nextElementSibling.innerHTML = p.meds.replace(/\n/g, '<br>');
    }

    // Update scores
    const scoreRows = document.querySelectorAll('.consult-left-body > div:last-of-type > div');
    // Actually find score rows by parent
    const scoreContainer = document.querySelector('.consult-left-body > div[style*="flex-direction:column"]');
    if (scoreContainer) {
      scoreContainer.innerHTML = p.scores.map(([label, val, color]) => `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:0.78rem;color:var(--text2)">${label}</span>
          <span style="font-family:var(--mono);font-size:0.9rem;font-weight:600;color:var(--${color || 'teal'})">${val}</span>
        </div>`).join('');
    }

    // Add welcome message to chat
    const msgs = document.getElementById('chatMessages');
    const typing = document.getElementById('typingIndicator');
    if (msgs && typing) {
      const welcomeMsg = document.createElement('div');
      welcomeMsg.className = 'msg ai';
      welcomeMsg.innerHTML = `<div class="msg-avatar">🧬</div><div><div class="msg-bubble" style="border-left:3px solid var(--teal);padding-left:12px">
        <strong style="color:var(--teal)">Patient switched → ${p.name}</strong><br>
        <span style="font-size:0.78rem;color:var(--text3)">${p.meta}</span><br><br>
        Vitals: HR ${p.vitals.hr} · BP ${p.vitals.bp} · SpO₂ ${p.vitals.spo2}<br>
        How can I assist with this patient's consultation?
      </div><div class="msg-time">Samarthaa · Just now</div></div>`;
      msgs.insertBefore(welcomeMsg, typing);
      msgs.scrollTop = msgs.scrollHeight;
    }

    showToast('🔄', 'Patient switched', p.name);
  }

  // SOAP Note generator
  const soapData = {
    S: `Chief Complaint: Chest pain × 2 days, radiating to left arm, associated with diaphoresis and dyspnea on exertion. Nausea present. No fever, no palpitations reported by patient.

History of Present Illness: 52-year-old female with known DM Type 2 (8 yrs), hypertension (5 yrs), dyslipidemia, and ex-smoker. Presenting with worsening angina-type chest pain for 48 hours, partially relieved by rest. Not relieved by antacids.

Current Medications: Metformin 1000mg BD, Amlodipine 5mg OD, Atorvastatin 40mg HS, Aspirin 75mg OD, Metoprolol 25mg BD.`,
    O: `Vitals: BP 148/92 mmHg | HR 98 bpm | SpO₂ 96% | Temp 37.4°C | RR 18/min
Weight: 72 kg | Height: 158 cm | BMI: 28.8 kg/m²

ECG: ST depression in V4–V6, no ST elevation, no LBBB
Investigations: Troponin I 0.08 ng/mL (HIGH, 2× ULN) | CK-MB 28 U/L (HIGH) | BNP 290 pg/mL | LDL-C 168 mg/dL | HbA1c 8.4% | eGFR 72 mL/min | Hb 10.8 g/dL (LOW)

HEART Score: 7/10 (High Risk) | TIMI Score: 5/7 | Framingham 10-yr risk: 34%`,
    A: `1. Non-ST Elevation Myocardial Infarction (NSTEMI) — ICD-11: BA41.0Z [87% confidence]
   Evidence: Elevated Troponin I (×2 ULN), ST depression V4-V6, typical chest pain radiation, HEART Score 7
   
2. Rule out Unstable Angina — ICD-11: BA80.0 [72% confidence]
   Serial troponins to differentiate

3. Hypertension — Stage 2, poorly controlled | BP 148/92 on current regimen
4. Diabetes Mellitus Type 2 — uncontrolled | HbA1c 8.4%
5. Dyslipidemia — LDL 168 mg/dL (target <55 in VHCVR patients)
6. Mild anemia (Hb 10.8) — iron deficiency vs chronic disease, investigate`,
    P: `IMMEDIATE:
• Aspirin 300mg loading stat → 75mg OD lifelong
• Ticagrelor 180mg loading → 90mg BD × 12 months (preferred over Clopidogrel in DM)
• Enoxaparin 60mg SC BD (1mg/kg, eGFR 72 — standard dose)
• Rosuvastatin 40mg HS (high-intensity, switch from Atorvastatin)
• HOLD Metformin — contrast dye / cath planned. Resume 48h post-procedure
• GTN SL PRN if BP allows
• Urgent coronary angiography within 24h (GRACE >140, HEART 7)
• NPO from midnight, IV access ×2, nephroprotection protocol

SHORT-TERM:
• Serial Troponin at 1h and 3h
• Echocardiogram to assess LVEF
• Repeat labs post-cath: Creatinine, eGFR, CBC
• Cardiac rehabilitation referral post-stabilisation
• Diabetes management: Sliding scale insulin while admitted
• Iron studies for anemia — IV iron if IDA confirmed`,
    ICD: `BA41.0Z — Non-ST elevation myocardial infarction (NSTEMI)\nBA00.0 — Essential hypertension\n5A11 — Type 2 diabetes mellitus\n5A71.0 — Hypercholesterolaemia\n3A00.1 — Iron deficiency anaemia`
  };

  function generateSoapNote() {
    document.getElementById('soapS').textContent = soapData.S;
    document.getElementById('soapO').textContent = soapData.O;
    document.getElementById('soapA').textContent = soapData.A;
    document.getElementById('soapP').textContent = soapData.P;
    document.getElementById('soapICD').textContent = soapData.ICD;
    document.getElementById('soapModal').classList.add('open');
  }

  function copySoap() {
    const full = ['SUBJECTIVE\n' + soapData.S, 'OBJECTIVE\n' + soapData.O, 'ASSESSMENT\n' + soapData.A, 'PLAN\n' + soapData.P, 'ICD-11\n' + soapData.ICD].join('\n\n---\n\n');
    navigator.clipboard?.writeText(full);
    showToast('📋', 'SOAP Note copied', 'Paste into any EMR or document');
  }

  /* ══ ENHANCED PRESCRIPTION ══ */
  const drugDB = [
    { name:'Aspirin', class:'Antiplatelet', generic:'Jan Aushadhi ₹3/strip', indication:'ACS, antiplatelet therapy', doses:['75mg OD','150mg OD','300mg stat'], caution:'' },
    { name:'Atorvastatin', class:'HMG-CoA Reductase Inhibitor', generic:'Jan Aushadhi ₹5/tab', indication:'Dyslipidemia, CAD prevention', doses:['10mg OD','20mg OD','40mg HS','80mg HS'], caution:'' },
    { name:'Rosuvastatin', class:'HMG-CoA Reductase Inhibitor', generic:'Jan Aushadhi ₹8/tab', indication:'High-intensity statin for VHCVR', doses:['10mg OD','20mg OD','40mg HS'], caution:'' },
    { name:'Metformin', class:'Biguanide', generic:'Jan Aushadhi ₹4/strip', indication:'Type 2 Diabetes Mellitus', doses:['500mg OD','500mg BD','1000mg BD'], caution:'Hold before contrast; avoid in eGFR <30' },
    { name:'Amlodipine', class:'Calcium Channel Blocker', generic:'Jan Aushadhi ₹3/tab', indication:'Hypertension, stable angina', doses:['2.5mg OD','5mg OD','10mg OD'], caution:'' },
    { name:'Metoprolol Succinate', class:'Beta-1 Blocker', generic:'Generic available ₹6/tab', indication:'Hypertension, ACS, heart failure', doses:['12.5mg BD','25mg BD','50mg BD','100mg OD'], caution:'Hold if HR <50 or SBP <90' },
    { name:'Ticagrelor', class:'P2Y12 Inhibitor', generic:'Branded — ₹60/tab', indication:'ACS dual antiplatelet (preferred in DM)', doses:['90mg BD','60mg BD (maintenance)'], caution:'Contraindicated in prior haemorrhagic stroke' },
    { name:'Clopidogrel', class:'P2Y12 Inhibitor', generic:'Jan Aushadhi ₹8/tab', indication:'ACS dual antiplatelet', doses:['75mg OD','300mg loading'], caution:'CYP2C19 poor metabolisers may have reduced effect' },
    { name:'Enoxaparin', class:'LMWH', generic:'Generic ₹80/syringe', indication:'ACS anticoagulation, DVT prophylaxis', doses:['0.5mg/kg SC BD','1mg/kg SC BD','40mg SC OD (prophylaxis)'], caution:'Dose reduce for eGFR <30; avoid if eGFR <15' },
    { name:'Pantoprazole', class:'Proton Pump Inhibitor', generic:'Jan Aushadhi ₹4/tab', indication:'GI protection with NSAIDs/dual antiplatelet', doses:['20mg OD','40mg OD','40mg BD'], caution:'' },
    { name:'Lisinopril', class:'ACE Inhibitor', generic:'Jan Aushadhi ₹5/tab', indication:'Hypertension, heart failure, post-MI', doses:['2.5mg OD','5mg OD','10mg OD','20mg OD'], caution:'Contraindicated in pregnancy; monitor K+ and creatinine' },
    { name:'Dapagliflozin', class:'SGLT2 Inhibitor', generic:'Branded ₹35/tab', indication:'T2DM with CVD — cardioprotective', doses:['10mg OD'], caution:'Hold before major surgery; UTI risk' },
    { name:'Insulin Glargine', class:'Long-acting Insulin', generic:'Branded ₹250/vial', indication:'T2DM inadequate control, inpatient glycaemia', doses:['10 units HS','0.2 units/kg HS'], caution:'Hypoglycaemia risk — monitor FBS' },
    { name:'Salbutamol Inhaler', class:'Short-acting Beta-2 Agonist', generic:'Jan Aushadhi ₹35/inhaler', indication:'Acute bronchospasm, asthma, COPD', doses:['2 puffs PRN','2 puffs QID'], caution:'' },
    { name:'Amoxicillin', class:'Beta-lactam Antibiotic', generic:'Jan Aushadhi ₹12/tab', indication:'Respiratory / urinary tract infections', doses:['250mg TDS','500mg TDS','875mg BD'], caution:'Check penicillin allergy' },
    { name:'Azithromycin', class:'Macrolide Antibiotic', generic:'Jan Aushadhi ₹8/tab', indication:'Atypical pneumonia, URTI', doses:['500mg OD × 3 days','500mg stat then 250mg OD × 4 days'], caution:'QTc prolongation — avoid with other QT-prolonging drugs' },
  ];

  let prescriptionList = [];

  function initPrescriptionView() {
    const wrap = document.getElementById('rxSearchWrap');
    if (!wrap) return;
    renderPrescriptionList();
  }

  function searchDrugs(val) {
    const results = document.getElementById('drugSearchResults');
    if (!val || val.length < 2) { results.classList.remove('show'); return; }
    const matches = drugDB.filter(d => d.name.toLowerCase().includes(val.toLowerCase()) || d.class.toLowerCase().includes(val.toLowerCase()) || d.indication.toLowerCase().includes(val.toLowerCase()));
    if (!matches.length) { results.classList.remove('show'); return; }
    results.innerHTML = matches.slice(0, 8).map(d => `
      <div class="drug-result-item" onclick="addDrugToPrescription('${d.name}')">
        <div class="drug-result-name">${d.name}</div>
        <div class="drug-result-meta">${d.class} · ${d.indication}</div>
        <div class="drug-result-generic">${d.generic}</div>
      </div>`).join('');
    results.classList.add('show');
  }

  function addDrugToPrescription(name) {
    document.getElementById('drugSearchResults').classList.remove('show');
    document.getElementById('rxDrugSearch').value = '';
    const drug = drugDB.find(d => d.name === name);
    if (!drug) return;
    const id = 'rx_' + Date.now();
    prescriptionList.push({ id, ...drug, dose: drug.doses[0] || '', frequency: 'OD', duration: '7 days', instructions: 'After food' });
    renderPrescriptionList();
    showToast('💊', drug.name + ' added', drug.class);
  }

  function removeDrug(id) {
    prescriptionList = prescriptionList.filter(d => d.id !== id);
    renderPrescriptionList();
  }

  function renderPrescriptionList() {
    const container = document.getElementById('rxDrugList');
    if (!container) return;
    if (!prescriptionList.length) {
      container.innerHTML = '<div class="empty-state"><div class="icon">💊</div><div class="text">No drugs added yet.<br>Search above to add medications.</div></div>';
      document.getElementById('rxPreviewSection').innerHTML = '<div style="font-size:0.78rem;color:var(--text3);text-align:center;padding:20px">Add drugs to generate prescription preview</div>';
      return;
    }
    container.innerHTML = prescriptionList.map((d, i) => `
      <div class="rx-card">
        <div class="rx-card-header">
          <div><div class="rx-card-name">${d.name}</div><div class="rx-card-generic">${d.generic} · ${d.class}</div></div>
          <button class="rx-card-remove" onclick="removeDrug('${d.id}')">✕</button>
        </div>
        <div class="rx-dose-row">
          <div class="rx-field-wrap"><div class="rx-field-label">Dose</div><select class="rx-field-select" onchange="updateRxField('${d.id}','dose',this.value)">${d.doses.map(dz => `<option ${dz===d.dose?'selected':''}>${dz}</option>`).join('')}</select></div>
          <div class="rx-field-wrap"><div class="rx-field-label">Frequency</div><select class="rx-field-select" onchange="updateRxField('${d.id}','frequency',this.value)">
            ${['OD','BD','TDS','QID','PRN','Stat','HS','Weekly'].map(f=>`<option ${f===d.frequency?'selected':''}>${f}</option>`).join('')}
          </select></div>
          <div class="rx-field-wrap"><div class="rx-field-label">Duration</div><select class="rx-field-select" onchange="updateRxField('${d.id}','duration',this.value)">
            ${['3 days','5 days','7 days','10 days','14 days','1 month','3 months','6 months','Lifelong'].map(dur=>`<option ${dur===d.duration?'selected':''}>${dur}</option>`).join('')}
          </select></div>
        </div>
        <div class="rx-field-wrap" style="margin-bottom:6px"><div class="rx-field-label">Instructions</div><select class="rx-field-select" onchange="updateRxField('${d.id}','instructions',this.value)">
          ${['After food','Before food','With food','Empty stomach','At bedtime','In the morning'].map(inst=>`<option ${inst===d.instructions?'selected':''}>${inst}</option>`).join('')}
        </select></div>
        ${d.caution ? `<div style="font-size:0.7rem;color:var(--gold);background:var(--gold-dim);border:1px solid rgba(245,166,35,0.2);border-radius:5px;padding:5px 9px;display:flex;align-items:center;gap:6px">⚠️ ${d.caution}</div>` : ''}
      </div>`).join('');
    updateRxPreview();
  }

  function updateRxField(id, field, value) {
    const drug = prescriptionList.find(d => d.id === id);
    if (drug) { drug[field] = value; updateRxPreview(); }
  }

  function updateRxPreview() {
    const preview = document.getElementById('rxPreviewSection');
    if (!preview || !prescriptionList.length) return;
    preview.innerHTML = `
      <div style="background:var(--navy3);border:1px solid var(--border2);border-radius:10px;padding:18px">
        <div style="text-align:center;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)">
          <div style="font-family:var(--syne);font-size:1.1rem;font-weight:800;color:var(--teal)">SamarthaaMed</div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <div><div style="font-size:0.75rem;color:var(--text3)">Patient</div><div style="font-size:0.85rem;font-weight:600;color:var(--text1)">Priya Krishnamurthy</div><div style="font-size:0.72rem;color:var(--text3)">52F · MM-2024-04521</div></div>
          <div style="text-align:right"><div style="font-size:0.75rem;color:var(--text3)">Date</div><div style="font-size:0.82rem;color:var(--text1)">24 Feb 2026</div></div>
        </div>
        <div style="font-size:0.78rem;font-weight:600;color:var(--text3);margin-bottom:8px">Rₓ</div>
        <div style="font-size:0.8rem;color:var(--text2);line-height:2.2">
          ${prescriptionList.map((d, i) => `${i+1}. ${d.name} ${d.dose} ${d.frequency} × ${d.duration} — ${d.instructions}`).join('\n')}
        </div>
        <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">
          <div style="font-size:0.7rem;color:var(--text3)">Advice: Follow up in 1 week. Report any side effects immediately.</div>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn btn-primary" style="flex:1;justify-content:center" onclick="showToast('🖨','Prescription sent to print','PDF generated successfully')">🖨 Print</button>
        <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="showToast('📲','Sent via WhatsApp','Prescription shared with patient')">📲 WhatsApp</button>
      </div>`;
  }

  /* ══ LAB RESULTS ══ */
  function switchLabPanel(btn, id) {
    document.querySelectorAll('.lab-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.lab-panel').forEach(p => p.classList.remove('active'));
    const panel = document.getElementById('labpanel-' + id);
    if (panel) panel.classList.add('active');
  }

  function openLabEntry() {
    document.getElementById('labModal').classList.add('open');
    if (document.getElementById('labDate')) document.getElementById('labDate').valueAsDate = new Date();
    switchLabMode('manual');
    // Reset queue
    labReportQueue = [];
    labQueueIdCounter = 0;
    const queueEl = document.getElementById('labUploadQueue');
    const previewEl = document.getElementById('labExtractedPreview');
    const instrEl = document.getElementById('labUploadInstructions');
    if (queueEl) { queueEl.style.display = 'none'; document.getElementById('labQueueCards').innerHTML = ''; }
    if (previewEl) { previewEl.style.display = 'none'; document.getElementById('labExtractedRows').innerHTML = ''; }
    if (instrEl) instrEl.style.display = 'block';
  }

  function closeLabModal() {
    document.getElementById('labModal').classList.remove('open');
  }

  function flagLab(input, low, high, mode) {
    const val = parseFloat(input.value);
    input.classList.remove('abnormal-h', 'abnormal-l');
    if (!input.value) return;
    if (mode.includes('H') && val > high) input.classList.add('abnormal-h');
    else if (mode.includes('L') && val < low) input.classList.add('abnormal-l');
  }

  function saveLabResults() {
    const manualVisible = document.getElementById('labPanelManual').style.display !== 'none';
    let filled = 0;
    if (manualVisible) {
      document.querySelectorAll('#labEntryRows .lab-val-input').forEach(i => { if (i.value) filled++; });
      if (!filled) { showToast('⚠️', 'No values entered', 'Enter at least one lab value'); return; }
    } else {
      const doneCount = labReportQueue.filter(r => r.status === 'done').length;
      if (doneCount === 0) { showToast('⚠️', 'No reports ready', 'Upload a report and wait for extraction to complete'); return; }
      document.querySelectorAll('#labExtractedRows .lab-val-input').forEach(i => { if (i.value) filled++; });
      if (!filled) { showToast('⚠️', 'Nothing to save', 'No values extracted yet'); return; }
    }
    closeLabModal();
    const source = manualVisible ? 'manual entry' : `${labReportQueue.filter(r=>r.status==='done').length} report${labReportQueue.filter(r=>r.status==='done').length>1?'s':''}`;
    showToast('✅', 'Lab results saved', `${filled} values from ${source} · AI interpretation generated`);
    const badge = document.querySelector('.nav-badge');
    if (badge) badge.textContent = String(parseInt(badge.textContent || '5') + 1);
  }

  /* ══ LAB MODE SWITCH + MULTI-REPORT UPLOAD ══ */
  function switchLabMode(mode) {
    const isManual = mode === 'manual';
    const manualPanel = document.getElementById('labPanelManual');
    const uploadPanel = document.getElementById('labPanelUpload');
    if (manualPanel) manualPanel.style.display = isManual ? 'block' : 'none';
    if (uploadPanel) uploadPanel.style.display = isManual ? 'none' : 'block';
    ['labTabManual','labTabUpload'].forEach((id, idx) => {
      const active = isManual ? idx === 0 : idx === 1;
      const el = document.getElementById(id);
      if (!el) return;
      el.style.background = active ? 'var(--teal-dim)' : 'transparent';
      el.style.color = active ? 'var(--teal)' : 'var(--text3)';
      el.style.borderBottom = active ? '2px solid var(--teal)' : '2px solid transparent';
    });
    const footer = document.getElementById('labFooterInfo');
    if (footer) footer.textContent = isManual
      ? 'Abnormal values auto-highlighted · AI interpretation on save'
      : 'Upload reports — values from all files are merged into one panel';
  }

  // Queue state: array of { id, name, size, status:'processing'|'done'|'error', data:[] }
  let labReportQueue = [];
  let labQueueIdCounter = 0;

  // All possible lab tests with reference ranges
  const labTestBank = [
    { name:'Troponin I',          unit:'ng/mL',  low:0,    high:0.04,  mode:'H',   samples:['0.06','0.04','0.02','0.08','0.01'] },
    { name:'CK-MB',               unit:'U/L',    low:0,    high:25,    mode:'H',   samples:['31','22','18','40','12'] },
    { name:'HbA1c',               unit:'%',      low:0,    high:6.5,   mode:'H',   samples:['9.1','7.8','6.2','8.4','5.9'] },
    { name:'Fasting Blood Sugar', unit:'mg/dL',  low:70,   high:100,   mode:'HL',  samples:['162','124','88','186','72'] },
    { name:'LDL-C',               unit:'mg/dL',  low:0,    high:100,   mode:'H',   samples:['182','142','96','168','78'] },
    { name:'HDL-C',               unit:'mg/dL',  low:40,   high:999,   mode:'L',   samples:['33','44','51','38','60'] },
    { name:'Triglycerides',       unit:'mg/dL',  low:0,    high:150,   mode:'H',   samples:['210','168','98','240','120'] },
    { name:'Total Cholesterol',   unit:'mg/dL',  low:0,    high:200,   mode:'H',   samples:['242','188','172','220','158'] },
    { name:'Serum Creatinine',    unit:'mg/dL',  low:0.6,  high:1.2,   mode:'HL',  samples:['1.3','0.9','1.0','1.5','0.8'] },
    { name:'eGFR',                unit:'mL/min', low:60,   high:999,   mode:'L',   samples:['58','72','84','48','92'] },
    { name:'BUN',                 unit:'mg/dL',  low:7,    high:20,    mode:'HL',  samples:['22','18','14','28','11'] },
    { name:'Uric Acid',           unit:'mg/dL',  low:2.4,  high:7.0,   mode:'HL',  samples:['7.2','5.8','4.4','8.1','3.9'] },
    { name:'Hemoglobin',          unit:'g/dL',   low:11.5, high:16.5,  mode:'HL',  samples:['11.2','13.4','15.1','10.8','14.2'] },
    { name:'WBC',                 unit:'×10³/µL',low:4.5,  high:11.0,  mode:'HL',  samples:['7.2','5.8','9.1','12.4','6.3'] },
    { name:'Platelets',           unit:'×10³/µL',low:150,  high:400,   mode:'HL',  samples:['220','188','310','142','260'] },
    { name:'TSH',                 unit:'mIU/L',  low:0.4,  high:4.0,   mode:'HL',  samples:['2.1','0.8','3.6','5.2','1.4'] },
    { name:'Free T4',             unit:'ng/dL',  low:0.8,  high:1.8,   mode:'HL',  samples:['1.1','0.7','1.4','0.6','1.6'] },
    { name:'Serum Na⁺',          unit:'mEq/L',  low:136,  high:145,   mode:'HL',  samples:['138','141','134','148','140'] },
    { name:'Serum K⁺',           unit:'mEq/L',  low:3.5,  high:5.0,   mode:'HL',  samples:['4.6','3.8','4.2','5.4','3.4'] },
    { name:'INR',                 unit:'ratio',  low:0.8,  high:1.2,   mode:'HL',  samples:['1.0','1.1','0.9','1.8','1.0'] },
    { name:'ALT (SGPT)',          unit:'U/L',    low:0,    high:40,    mode:'H',   samples:['38','22','62','18','44'] },
    { name:'AST (SGOT)',          unit:'U/L',    low:0,    high:40,    mode:'H',   samples:['42','28','55','18','32'] },
    { name:'Alkaline Phosphatase',unit:'U/L',    low:44,   high:147,   mode:'HL',  samples:['88','110','52','180','76'] },
    { name:'Total Bilirubin',     unit:'mg/dL',  low:0,    high:1.2,   mode:'H',   samples:['0.8','1.4','0.6','2.1','0.9'] },
    { name:'Serum Albumin',       unit:'g/dL',   low:3.5,  high:5.0,   mode:'HL',  samples:['4.1','3.2','4.6','3.8','4.4'] },
    { name:'CRP',                 unit:'mg/L',   low:0,    high:5,     mode:'H',   samples:['12','4','28','2','8'] },
    { name:'ESR',                 unit:'mm/hr',  low:0,    high:20,    mode:'H',   samples:['34','16','48','8','22'] },
    { name:'Vitamin D (25-OH)',   unit:'ng/mL',  low:30,   high:100,   mode:'L',   samples:['18','42','12','55','28'] },
    { name:'Vitamin B12',         unit:'pg/mL',  low:200,  high:900,   mode:'HL',  samples:['180','420','680','140','320'] },
    { name:'Ferritin',            unit:'ng/mL',  low:12,   high:150,   mode:'HL',  samples:['8','44','92','6','120'] },
  ];

  // Simulate different reports extracting different subsets of tests
  const reportProfiles = [
    // CBC panel
    { label:'CBC', tests:['Hemoglobin','WBC','Platelets','CRP','ESR','Ferritin'] },
    // Lipid panel
    { label:'Lipid Profile', tests:['LDL-C','HDL-C','Triglycerides','Total Cholesterol'] },
    // Renal function
    { label:'RFT', tests:['Serum Creatinine','eGFR','BUN','Uric Acid','Serum Na⁺','Serum K⁺'] },
    // Liver function
    { label:'LFT', tests:['ALT (SGPT)','AST (SGOT)','Alkaline Phosphatase','Total Bilirubin','Serum Albumin'] },
    // Thyroid
    { label:'Thyroid Panel', tests:['TSH','Free T4'] },
    // Cardiac
    { label:'Cardiac Markers', tests:['Troponin I','CK-MB'] },
    // Diabetes
    { label:'Diabetes Panel', tests:['HbA1c','Fasting Blood Sugar'] },
    // Vitamins
    { label:'Vitamins & Minerals', tests:['Vitamin D (25-OH)','Vitamin B12','Ferritin'] },
    // Coagulation
    { label:'Coagulation', tests:['INR'] },
    // Comprehensive
    { label:'Comprehensive Panel', tests:['Hemoglobin','WBC','Platelets','LDL-C','HDL-C','Triglycerides','Serum Creatinine','eGFR','HbA1c','TSH','INR'] },
  ];

  function handleLabReportDrop(e) {
    e.preventDefault();
    const zone = document.getElementById('labUploadZone');
    if (zone) { zone.style.borderColor = ''; zone.style.background = 'var(--panel)'; }
    Array.from(e.dataTransfer.files).forEach(file => queueLabReport(file));
  }

  function handleLabReportUpload(e) {
    Array.from(e.target.files).forEach(file => queueLabReport(file));
    e.target.value = '';
  }

  function queueLabReport(file) {
    const id = ++labQueueIdCounter;
    const ext = file.name.split('.').pop().toLowerCase();
    const icon = ext === 'pdf' ? '📄' : '🖼';
    const sizeMB = (file.size / 1048576).toFixed(1);

    // Pick a report profile based on file name heuristics or cycle through
    const nameL = file.name.toLowerCase();
    let profile = reportProfiles[id % reportProfiles.length]; // cycle
    if (nameL.includes('cbc') || nameL.includes('blood')) profile = reportProfiles[0];
    else if (nameL.includes('lipid') || nameL.includes('cholesterol')) profile = reportProfiles[1];
    else if (nameL.includes('renal') || nameL.includes('kidney') || nameL.includes('rft')) profile = reportProfiles[2];
    else if (nameL.includes('liver') || nameL.includes('lft')) profile = reportProfiles[3];
    else if (nameL.includes('thyroid') || nameL.includes('tsh')) profile = reportProfiles[4];
    else if (nameL.includes('cardiac') || nameL.includes('troponin')) profile = reportProfiles[5];
    else if (nameL.includes('diab') || nameL.includes('hba1c')) profile = reportProfiles[6];

    labReportQueue.push({ id, name: file.name, size: sizeMB, icon, status: 'processing', profile, data: [] });

    // Show queue, hide instructions
    document.getElementById('labUploadInstructions').style.display = 'none';
    document.getElementById('labUploadQueue').style.display = 'block';

    renderQueueCards();

    // Simulate extraction (staggered per file)
    const delay = 1200 + (labReportQueue.length - 1) * 400;
    setTimeout(() => {
      // Build extracted data for this report
      const item = labReportQueue.find(r => r.id === id);
      if (!item) return;
      item.data = item.profile.tests.map(testName => {
        const def = labTestBank.find(t => t.name === testName);
        if (!def) return null;
        const val = def.samples[id % def.samples.length];
        return { ...def, value: val };
      }).filter(Boolean);
      item.status = 'done';
      renderQueueCards();
      rebuildMergedResults();
    }, delay);
  }

  function renderQueueCards() {
    const container = document.getElementById('labQueueCards');
    container.innerHTML = labReportQueue.map(item => `
      <div style="display:flex;align-items:center;gap:10px;background:var(--navy3);border:1px solid ${item.status==='done'?'rgba(0,212,180,0.25)':'var(--border2)'};border-radius:8px;padding:10px 12px;transition:all .3s">
        <div style="font-size:1.4rem">${item.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:0.8rem;font-weight:600;color:var(--text1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
          <div style="font-size:0.68rem;color:var(--text3);margin-top:2px">
            ${item.size} MB · ${item.profile.label}
            ${item.status==='done' ? `· <span style="color:var(--teal)">${item.data.length} values extracted ✓</span>` : '· <span style="color:var(--gold)">Extracting…</span>'}
          </div>
        </div>
        ${item.status==='processing'
          ? `<div style="width:18px;height:18px;border:2px solid var(--border2);border-top-color:var(--teal);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0"></div>`
          : `<div style="color:var(--teal);font-size:1rem;flex-shrink:0">✅</div>`
        }
        <button onclick="removeQueueItem(${item.id})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.9rem;padding:2px 4px;flex-shrink:0;line-height:1" title="Remove">✕</button>
      </div>`).join('');
  }

  function removeQueueItem(id) {
    labReportQueue = labReportQueue.filter(r => r.id !== id);
    renderQueueCards();
    rebuildMergedResults();
    if (labReportQueue.length === 0) {
      document.getElementById('labUploadQueue').style.display = 'none';
      document.getElementById('labExtractedPreview').style.display = 'none';
      document.getElementById('labUploadInstructions').style.display = 'block';
    }
  }

  function clearAllReports() {
    labReportQueue = [];
    renderQueueCards();
    document.getElementById('labUploadQueue').style.display = 'none';
    document.getElementById('labExtractedPreview').style.display = 'none';
    document.getElementById('labUploadInstructions').style.display = 'block';
    showToast('🗑', 'Reports cleared', 'Upload new reports or switch to Manual Entry');
  }

  function rebuildMergedResults() {
    const doneItems = labReportQueue.filter(r => r.status === 'done');
    if (doneItems.length === 0) {
      document.getElementById('labExtractedPreview').style.display = 'none';
      return;
    }

    // Merge all extracted values — later uploads overwrite earlier ones for same test
    const merged = {};
    doneItems.forEach(item => {
      item.data.forEach(row => { merged[row.name] = row; });
    });

    const mergedArr = Object.values(merged);
    const totalReports = doneItems.length;
    const totalTests = mergedArr.length;
    const abnormals = mergedArr.filter(row => {
      const val = parseFloat(row.value);
      return (row.mode.includes('H') && val > row.high) || (row.mode.includes('L') && val < row.low);
    }).length;

    document.getElementById('labExtractSummary').textContent =
      `From ${totalReports} report${totalReports > 1 ? 's' : ''} · ${totalTests} values · ${abnormals} abnormal${abnormals !== 1 ? 's' : ''} · Review &amp; edit before saving`;

    document.getElementById('labExtractedRows').innerHTML = mergedArr.map(row => {
      const val = parseFloat(row.value);
      let flagClass = '', flagHtml = '';
      if (row.mode.includes('H') && val > row.high) {
        flagClass = 'abnormal-h';
        flagHtml = `<span style="font-size:0.65rem;font-weight:700;padding:2px 6px;border-radius:4px;flex-shrink:0;background:var(--red-dim);color:var(--red)">↑ HIGH</span>`;
      } else if (row.mode.includes('L') && val < row.low) {
        flagClass = 'abnormal-l';
        flagHtml = `<span style="font-size:0.65rem;font-weight:700;padding:2px 6px;border-radius:4px;flex-shrink:0;background:rgba(59,130,246,0.15);color:#60A5FA">↓ LOW</span>`;
      }
      return `<div class="lab-input-row">
        <span class="lab-name-col">${row.name}</span>
        <span class="lab-ref-col">${row.unit}</span>
        <input class="lab-val-input ${flagClass}" value="${row.value}"
          oninput="flagLab(this,${row.low},${row.high},'${row.mode}')">
        ${flagHtml}
      </div>`;
    }).join('');

    document.getElementById('labExtractedPreview').style.display = 'block';

    const processing = labReportQueue.filter(r => r.status === 'processing').length;
    if (processing > 0) {
      showToast('🤖', 'Partial extraction', `${totalTests} values so far · ${processing} report${processing>1?'s':''} still processing`);
    } else {
      showToast('✅', 'All reports extracted', `${totalTests} values from ${totalReports} report${totalReports>1?'s':''} · ${abnormals} abnormal`);
    }
  }

  /* ══ IMAGING AI ══ */
  let currentScanType = 'xray';
  const imagingFindings = {
    xray: {
      model: 'Chest X-Ray AI · ResNet-152 + Attention',
      findings: [
        { title: 'Cardiomegaly', conf: '91%', level: 'high', desc: 'Cardiothoracic ratio estimated at 0.56 (>0.50 threshold). Consistent with cardiomegaly, likely due to LV dilation. Correlate with echocardiography.' },
        { title: 'Pulmonary Venous Congestion', conf: '78%', level: 'med', desc: 'Haziness in bilateral perihilar regions with upper lobe blood diversion. Consistent with early pulmonary oedema / raised LVEDP.' },
        { title: 'No Pneumothorax', conf: '97%', level: 'low', desc: 'Both lung apices visible. No pleural line identified. Pneumothorax effectively ruled out.' },
        { title: 'No Active Consolidation', conf: '89%', level: 'low', desc: 'No focal opacity suggesting pneumonia or lobar consolidation at present.' },
      ],
      recommendation: 'Findings are consistent with cardiomegaly and early pulmonary venous hypertension. In the clinical context of suspected NSTEMI with elevated BNP (290 pg/mL), urgent echocardiography is strongly recommended to assess LVEF and wall motion abnormalities. Consider diuresis if signs of fluid overload persist.'
    },
    ecg: {
      model: 'ECG AI · Transformer-based 12-lead analyser',
      findings: [
        { title: 'ST Depression — V4 to V6', conf: '94%', level: 'high', desc: 'Horizontal ST depression of 1.5–2mm in leads V4, V5, V6. Highly specific for subendocardial ischaemia / NSTEMI. Requires serial monitoring.' },
        { title: 'T-wave Inversion', conf: '87%', level: 'high', desc: 'T-wave inversion in I, aVL, V5, V6. Suggests lateral wall ischaemia. Correlate with Troponin trend.' },
        { title: 'Sinus Tachycardia', conf: '99%', level: 'med', desc: 'HR 98 bpm. Sinus tachycardia — may reflect pain, anxiety, or early haemodynamic compromise.' },
        { title: 'QTc Interval', conf: '95%', level: 'low', desc: 'QTc 440ms — upper limit of normal. Monitor if adding QTc-prolonging agents (Azithromycin, Haloperidol).' },
      ],
      recommendation: 'ECG findings consistent with NSTEMI / acute coronary syndrome affecting the lateral leads. Immediate cardiology consultation and cath lab evaluation within 24h is advised per ICMR 2024 ACS guidelines. Serial ECGs every 30 minutes while patient is symptomatic.'
    },
    ct: {
      model: 'CT Brain AI · U-Net segmentation + classification',
      findings: [
        { title: 'No Intracranial Haemorrhage', conf: '98%', level: 'low', desc: 'No hyperdense lesions identified in the parenchyma, subdural or epidural space. ICH excluded.' },
        { title: 'No Acute Infarct', conf: '82%', level: 'low', desc: 'No evidence of acute territorial infarction on this non-contrast study. DWI-MRI recommended if clinical suspicion remains.' },
        { title: 'Periventricular White Matter Changes', conf: '76%', level: 'med', desc: 'Mild periventricular and subcortical white matter hypodensities consistent with small vessel ischaemic disease / Fazekas grade I.' },
      ],
      recommendation: 'No acute intracranial pathology identified. Small vessel disease consistent with the patient\'s vascular risk profile (HTN, DM). Recommend MRI Brain with DWI if TIA or early infarct is clinically suspected.'
    },
    fundus: {
      model: 'Fundus AI · InceptionV4 — DR grading (ETDRS)',
      findings: [
        { title: 'Diabetic Retinopathy — Grade 2 (Mild NPDR)', conf: '88%', level: 'med', desc: 'Scattered microaneurysms in bilateral retinae. Occasional dot/blot haemorrhages. No pre-retinal haemorrhage or neovascularisation.' },
        { title: 'No Diabetic Macular Oedema', conf: '91%', level: 'low', desc: 'Foveal reflex present. No clinically significant macular oedema (CSME) identified.' },
        { title: 'Hypertensive Retinopathy — Grade 1', conf: '79%', level: 'med', desc: 'Mild arteriovenous nicking noted. Arteriolar narrowing consistent with Grade 1 hypertensive retinopathy.' },
      ],
      recommendation: 'Mild Non-Proliferative Diabetic Retinopathy (Grade 2). Annual fundus review recommended. Target HbA1c <7% and BP <130/80 to prevent progression. No immediate laser treatment required. Ophthalmology referral for formal assessment.'
    },
    echo: {
      model: 'Echo AI · Segment-level LVEF Estimator v2',
      findings: [
        { title: 'Reduced LVEF', conf: '85%', level: 'high', desc: 'Estimated LVEF 42–45% (mildly reduced). Visual wall motion abnormality in anterior and lateral segments consistent with acute ischaemia.' },
        { title: 'Mild MR', conf: '72%', level: 'med', desc: 'Mild mitral regurgitation noted on colour Doppler — likely ischaemic / functional. Formal grading recommended.' },
        { title: 'LV Hypertrophy', conf: '83%', level: 'med', desc: 'Posterior wall thickness 12mm. Consistent with hypertensive LVH. Correlate with BP history.' },
      ],
      recommendation: 'Reduced LVEF 42–45% with regional wall motion abnormality is consistent with acute NSTEMI. Guideline-directed medical therapy (GDMT) should be initiated: ACE inhibitor, beta-blocker, and aldosterone antagonist for HFrEF. Repeat echo in 6–8 weeks post-revascularisation.'
    },
    usg: {
      model: 'USG Abdomen AI · YOLOv8 + Seg',
      findings: [
        { title: 'Fatty Liver — Grade 1', conf: '84%', level: 'med', desc: 'Increased hepatic echogenicity compared to kidney cortex. Mild hepatomegaly (liver span 15.2cm). Consistent with Grade 1 hepatic steatosis.' },
        { title: 'Normal Kidneys', conf: '92%', level: 'low', desc: 'Both kidneys normal size and echogenicity. No hydronephrosis. No calculi identified.' },
        { title: 'No Ascites', conf: '97%', level: 'low', desc: 'No free fluid in peritoneal cavity identified.' },
      ],
      recommendation: 'Grade 1 fatty liver (NAFLD) consistent with metabolic syndrome, obesity (BMI 28.8), and DM. Recommend weight loss, dietary modification, and lipid optimisation. HbA1c control will also benefit hepatic steatosis. LFTs and liver elastography (FibroScan) recommended for fibrosis staging.'
    }
  };

  function selectScanType(el, type) {
    document.querySelectorAll('.scan-type-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentScanType = type;
    const data = imagingFindings[type];
    if (data) document.getElementById('imagingModel').textContent = data.model;
  }

  function triggerUpload() {
    // Only trigger file picker if no image is loaded yet
    const zone = document.getElementById('uploadZone');
    if (zone.classList.contains('has-image')) return;
    document.getElementById('fileInput').click();
  }

  function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => showUploadedImage(ev.target.result);
    reader.readAsDataURL(file);
    e.target.value = ''; // allow re-upload of same file
  }

  function handleDrop(e) {
    e.preventDefault();
    const zone = document.getElementById('uploadZone');
    zone.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => showUploadedImage(ev.target.result);
    reader.readAsDataURL(file);
  }

  function loadDemoImage() {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="500" viewBox="0 0 600 500">
      <rect width="600" height="500" fill="#0a0f1e"/>
      <rect x="80" y="60" width="440" height="380" rx="8" fill="#111827"/>
      <!-- Spine -->
      <rect x="288" y="80" width="24" height="340" rx="4" fill="#1e2a3a"/>
      <!-- Left lung -->
      <ellipse cx="210" cy="250" rx="100" ry="130" fill="#162030" stroke="#243350" stroke-width="1.5"/>
      <!-- Right lung -->
      <ellipse cx="390" cy="250" rx="100" ry="130" fill="#162030" stroke="#243350" stroke-width="1.5"/>
      <!-- Heart shadow -->
      <ellipse cx="280" cy="290" rx="65" ry="80" fill="#1a2535" stroke="#2a3f55" stroke-width="2"/>
      <!-- Cardiomegaly indicator -->
      <ellipse cx="280" cy="290" rx="68" ry="83" fill="none" stroke="rgba(255,77,109,0.4)" stroke-width="2" stroke-dasharray="5,3"/>
      <!-- Hilar markings -->
      <line x1="200" y1="220" x2="240" y2="250" stroke="#243350" stroke-width="1.5"/>
      <line x1="360" y1="220" x2="330" y2="250" stroke="#243350" stroke-width="1.5"/>
      <!-- Clavicles -->
      <path d="M 120 130 Q 200 110 288 125" fill="none" stroke="#2a3f55" stroke-width="3"/>
      <path d="M 480 130 Q 400 110 312 125" fill="none" stroke="#2a3f55" stroke-width="3"/>
      <!-- Diaphragm -->
      <path d="M 100 390 Q 300 410 500 390" fill="none" stroke="#2a3f55" stroke-width="2.5"/>
      <!-- AI finding markers -->
      <circle cx="210" cy="200" r="18" fill="none" stroke="rgba(0,212,180,0.6)" stroke-width="2"/>
      <text x="210" y="180" text-anchor="middle" fill="rgba(0,212,180,0.8)" font-size="10" font-family="DM Mono,monospace">91%</text>
      <!-- Labels -->
      <text x="300" y="40" text-anchor="middle" fill="#00D4B4" font-size="13" font-family="Syne,sans-serif" font-weight="bold">DEMO · Chest PA View</text>
      <text x="300" y="475" text-anchor="middle" fill="#3a4f65" font-size="10" font-family="DM Mono,monospace">Simulated — Not a real medical image</text>
    </svg>`;
    const blob = new Blob([svg], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    showUploadedImage(url);
  }

  function showUploadedImage(src) {
    const zone = document.getElementById('uploadZone');
    const img = document.getElementById('uploadedImage');
    const placeholder = document.getElementById('uploadPlaceholder');
    img.src = src;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    zone.classList.add('has-image');
    zone.onclick = null; // disable zone click once image loaded — use Change button instead
    // Show action buttons
    document.getElementById('analyzeBtn').style.display = 'inline-flex';
    document.getElementById('changeImgBtn').style.display = 'inline-flex';
    // Reset results
    document.getElementById('imagingDefault').style.display = 'block';
    document.getElementById('imagingResults').style.display = 'none';
    document.getElementById('analyzingAnim').style.display = 'none';
    showToast('🩻', 'Image loaded', 'Click "Analyze with AI" to start');
  }

  function changeImage() {
    const zone = document.getElementById('uploadZone');
    const img = document.getElementById('uploadedImage');
    const placeholder = document.getElementById('uploadPlaceholder');
    img.src = '';
    img.style.display = 'none';
    placeholder.style.display = 'block';
    zone.classList.remove('has-image');
    zone.onclick = triggerUpload;
    document.getElementById('analyzeBtn').style.display = 'none';
    document.getElementById('changeImgBtn').style.display = 'none';
    document.getElementById('imagingDefault').style.display = 'block';
    document.getElementById('imagingResults').style.display = 'none';
    document.getElementById('analyzingAnim').style.display = 'none';
  }

  function analyzeImage() {
    const img = document.getElementById('uploadedImage');
    if (!img.src || img.style.display === 'none') {
      showToast('⚠️', 'No image loaded', 'Please upload or load a demo image first');
      return;
    }
    const apiKey = getApiKey();
    if (!apiKey) return; // getApiKey shows toast + redirects to settings

    document.getElementById('imagingDefault').style.display = 'none';
    document.getElementById('imagingResults').style.display = 'none';
    const anim = document.getElementById('analyzingAnim');
    anim.style.display = 'flex';
    document.getElementById('analyzeBtn').disabled = true;

    const patientCtx = getActivePatientContext();
    const systemPrompt = `You are SamarthaaMed Imaging AI, an expert radiologist and clinical imaging specialist embedded in a clinical platform for Indian doctors.
${patientCtx}

Analyse the medical image provided and respond ONLY with a valid JSON object — no markdown, no text outside the JSON.

JSON schema:
{
  "modality": "imaging type e.g. Chest X-Ray PA View / CT Brain / ECG 12-lead",
  "quality": "brief technical quality comment",
  "findings": [
    { "title": "finding name", "conf": "confidence % e.g. 91%", "level": "high|med|low", "desc": "clinical description with measurements and significance" }
  ],
  "recommendation": "clinical recommendation with ICMR/AHA/WHO guideline reference",
  "urgency": "routine|urgent|critical",
  "impression": "overall 1-2 sentence radiological impression"
}

Rules:
- List 3–6 findings including both abnormal AND normal/reassuring ones
- For chest X-ray: comment on heart size, lung fields, costophrenic angles, mediastinum, bones
- For CT: comment on each relevant structure
- For ECG: identify rhythm, rate, axis, intervals, ST changes, any arrhythmia
- Use metric measurements (cm, mm) where applicable
- Reference ICMR 2024, AHA, or WHO guidelines in recommendation
- confidence % = how confident you are in that specific finding`;

    // Build message with actual image
    let msgContent;
    const isDemoSVG = img.src.startsWith('blob:') || img.src.startsWith('data:image/svg');
    if (isDemoSVG) {
      // Demo image - send as text description since it's an SVG placeholder
      msgContent = `This is a demo chest X-ray image showing: bilateral lung fields, cardiomegaly (CTR ~0.56), perihilar haziness, and intact costophrenic angles. Analyse as if this were a real PA chest X-ray and return the JSON.`;
    } else {
      // Real uploaded image - send as base64
      const mimeMatch = img.src.match(/^data:([^;]+);base64,(.+)$/);
      if (mimeMatch) {
        const mimeType = mimeMatch[1];
        const b64data  = mimeMatch[2];
        msgContent = [
          {
            type: 'image',
            source: { type: 'base64', media_type: mimeType, data: b64data }
          },
          {
            type: 'text',
            text: 'Analyse this medical image and return the JSON object only. No markdown fences, no text outside the JSON.'
          }
        ];
      } else {
        // URL-based image (blob URL from SVG) — describe and analyse
        msgContent = `Analyse this medical scan and return the structured JSON analysis.`;
      }
    }

    const t0 = Date.now();
    callClaudeAI([{ role: 'user', content: msgContent }], systemPrompt)
      .then(raw => {
        const elapsed = ((Date.now() - t0) / 1000).toFixed(1);
        const clean = raw.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/, '').trim();
        const data = JSON.parse(clean);
        anim.style.display = 'none';
        document.getElementById('analyzeBtn').disabled = false;
        showImagingResults(data, elapsed);
      })
      .catch(err => {
        anim.style.display = 'none';
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('imagingDefault').style.display = 'block';
        showToast('❌', 'Analysis Failed', err.message);
        console.error('Imaging AI error:', err);
      });
  }

  function showImagingResults(data, elapsed) {
    if (!data) return;
    elapsed = elapsed || '—';
    const levelMap = { high: 'conf-high', med: 'conf-med', low: 'conf-low' };
    const labelMap = { high: '⚠ HIGH', med: '● MOD', low: '✓ LOW' };

    // Update the header banner
    const banner = document.querySelector('#imagingResults > div:first-child');
    if (banner) {
      const urgency  = data.urgency || 'routine';
      const urgColor = urgency === 'critical' ? 'var(--red)' : urgency === 'urgent' ? 'var(--gold)' : 'var(--teal)';
      const urgBg    = urgency === 'critical' ? 'var(--red-dim)' : urgency === 'urgent' ? 'var(--gold-dim)' : 'var(--teal-dim)';
      banner.style.background = urgBg;
      banner.style.borderColor = urgColor.replace(')', ', 0.3)').replace('var(', 'rgba(').replace('rgba(--', 'var(--');
      banner.innerHTML = `
        <span style="font-size:1.2rem">${urgency==='critical'?'🚨':urgency==='urgent'?'⚠️':'✅'}</span>
        <div>
          <div style="font-size:0.82rem;font-weight:600;color:${urgColor}">Analysis Complete · ${data.modality || 'Medical Image'}</div>
          <div style="font-size:0.72rem;color:var(--text3)">${elapsed}s · Claude AI · ${data.quality || ''}</div>
        </div>`;
    }

    // Findings
    document.getElementById('findingsList').innerHTML = (data.findings || []).map(f => `
      <div class="finding-item">
        <div class="finding-title">${f.title}<span class="finding-conf ${levelMap[f.level] || 'conf-low'}">${f.conf || ''} · ${labelMap[f.level] || '✓ LOW'}</span></div>
        <div class="finding-desc">${f.desc}</div>
      </div>`).join('');

    // Impression + recommendation
    let recHtml = '';
    if (data.impression) {
      recHtml += `<div style="font-weight:600;color:var(--text1);margin-bottom:8px">${data.impression}</div>`;
    }
    if (data.recommendation) {
      recHtml += `<div style="color:var(--text2)">${data.recommendation}</div>`;
    }
    document.getElementById('imagingRecommendation').innerHTML = recHtml || (data.recommendation || '');

    // Update model label
    const modelLabel = document.getElementById('imagingModel');
    if (modelLabel) modelLabel.textContent = (data.modality || 'Medical Image') + ' · Claude AI';
    document.getElementById('imagingResults').style.display = 'block';
    document.getElementById('imagingResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  /* ══ ANALYTICS ══ */
  function buildAnalyticsBarChart() {
    const container = document.getElementById('consultBar');
    if (!container) return;
    const data = [18,22,15,28,32,19,24,38,21,26,30,18,22,35,28,24,31,20,25,28,33,40,24,28,22,18,30,45];
    const urgentData = [2,3,1,4,5,2,3,6,2,4,5,1,3,5,4,3,4,2,3,4,5,7,3,4,2,1,4,6];
    const max = Math.max(...data);
    container.innerHTML = data.map((v, i) => `
      <div class="bar-col" title="Day ${i+1}: ${v} consultations, ${urgentData[i]} urgent">
        <div class="bar-val">${i === 27 ? v : ''}</div>
        <div style="width:100%;display:flex;flex-direction:column;gap:1px;align-items:center">
          <div class="bar" style="height:${Math.round((v/max)*90)}px;background:var(--teal);width:80%;opacity:0.85"></div>
          <div class="bar" style="height:${Math.round((urgentData[i]/max)*90)}px;background:var(--red);width:80%;opacity:0.7;margin-top:-${Math.round((urgentData[i]/max)*90)+1}px;position:relative;top:0"></div>
        </div>
        <div class="bar-label">${i === 0 ? '1' : i === 6 ? '7' : i === 13 ? '14' : i === 20 ? '21' : i === 27 ? '28' : ''}</div>
      </div>`).join('');
  }

  /* ══ CONSULTATION BAR ══ */
  function buildConsultBar() {
    // Auto-wire SOAP note button
  }

  /* ══ PRESCRIPTION VIEW WIRING ══ */
  function onViewChange(id) {
    if (id === 'prescription') {
      setTimeout(() => {
        const existing = document.getElementById('rxSearchWrap');
        if (existing) return;
        enhancePrescriptionView();
      }, 50);
    }
    if (id === 'risk') {
      setTimeout(() => {
        addRiskPatientSelector();
        refreshRiskPatientSelector();
      }, 50);
    }
  }

  function enhancePrescriptionView() {
    const searchArea = document.querySelector('#view-prescription .card-body');
    if (!searchArea) return;
    const searchDiv = searchArea.querySelector('.search-bar');
    if (!searchDiv || searchDiv.dataset.enhanced) return;
    searchDiv.dataset.enhanced = 'true';
    searchDiv.id = 'rxSearchWrap';
    searchDiv.classList.add('drug-search-wrap');
    searchDiv.style.position = 'relative';
    const input = searchDiv.querySelector('input');
    if (input) {
      input.id = 'rxDrugSearch';
      input.oninput = (e) => searchDrugs(e.target.value);
      input.onfocus = (e) => searchDrugs(e.target.value);
    }
    const resultsDiv = document.createElement('div');
    resultsDiv.className = 'drug-search-results';
    resultsDiv.id = 'drugSearchResults';
    searchDiv.appendChild(resultsDiv);
    document.addEventListener('click', (e) => {
      if (!searchDiv.contains(e.target)) resultsDiv.classList.remove('show');
    });
    // Add drug list container
    let listContainer = document.getElementById('rxDrugList');
    if (!listContainer) {
      listContainer = document.createElement('div');
      listContainer.id = 'rxDrugList';
      searchArea.appendChild(listContainer);
    }
    // Enhance preview
    const rightCard = document.querySelector('#view-prescription .grid-2 > .card:last-child .card-body');
    if (rightCard) {
      rightCard.id = 'rxPreviewSection';
    }
    renderPrescriptionList();
  }


  /* ══ MODAL SYSTEM ══ */
  let currentStep = 1;
  const totalSteps = 4;
  const stepInfoText = [
    '', 'Step 1 of 4 — Personal Information',
    'Step 2 of 4 — Medical History',
    'Step 3 of 4 — Vitals & Lifestyle',
    'Step 4 of 4 — Review & Confirm'
  ];
  const radioValues = { f_gender: 'Male', f_visit: 'New Patient' };
  const tagData = { conditions: [], allergies: [], medications: [] };

  function openModal() {
    resetModal();
    document.getElementById('patientModal').classList.add('open');
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    document.getElementById('patientModal').classList.remove('open');
    document.body.style.overflow = '';
  }
  // Close on backdrop click
  document.getElementById('patientModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  function resetModal() {
    currentStep = 1;
    // Reset form fields
    document.querySelectorAll('.form-input, .form-textarea').forEach(el => el.value = '');
    document.querySelectorAll('.form-select').forEach(el => el.selectedIndex = 0);
    // Reset radio groups
    selectRadio('f_gender', document.querySelector('#f_gender .radio-opt'), 'Male');
    selectRadio('f_visit', document.querySelector('#f_visit .radio-opt'), 'New Patient');
    // Clear tags
    ['conditions-wrap','allergies-wrap','meds-wrap'].forEach(id => {
      const wrap = document.getElementById(id);
      wrap.querySelectorAll('.ti').forEach(t => t.remove());
    });
    tagData.conditions = []; tagData.allergies = []; tagData.medications = [];
    // Reset steps
    updateStepUI();
    // Hide success
    document.getElementById('successOverlay').classList.remove('show');
    document.getElementById('summaryContent').style.display = 'block';
    document.getElementById('modalFooter').style.display = 'flex';
    // Clear errors
    document.querySelectorAll('.form-error').forEach(e => e.classList.remove('show'));
    document.querySelectorAll('.form-input').forEach(e => e.classList.remove('error'));
  }

  function selectRadio(groupId, el, val) {
    document.getElementById(groupId).querySelectorAll('.radio-opt').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    radioValues[groupId] = val;
  }

  function addTag(e, wrapId, inputId, type) {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    const input = document.getElementById(inputId);
    const val = input.value.trim();
    if (!val) return;
    const wrap = document.getElementById(wrapId);
    const tag = document.createElement('span');
    tag.className = `ti ${type === 'allergy' ? 'allergy' : type === 'med' ? 'med' : ''}`;
    tag.innerHTML = `${val} <span class="ti-x" onclick="this.parentElement.remove();removeTag('${type}','${val}')">✕</span>`;
    wrap.insertBefore(tag, input);
    input.value = '';
    if (type === 'condition') tagData.conditions.push(val);
    else if (type === 'allergy') tagData.allergies.push(val);
    else if (type === 'med') tagData.medications.push(val);
  }
  function removeTag(type, val) {
    if (type === 'condition') tagData.conditions = tagData.conditions.filter(v => v !== val);
    else if (type === 'allergy') tagData.allergies = tagData.allergies.filter(v => v !== val);
    else if (type === 'med') tagData.medications = tagData.medications.filter(v => v !== val);
  }

  function validateStep(step) {
    let valid = true;
    const require = (id, errId) => {
      const el = document.getElementById(id);
      const val = el ? el.value.trim() : '';
      const err = document.getElementById(errId);
      if (!val) {
        if (el) el.classList.add('error');
        if (err) err.classList.add('show');
        valid = false;
      } else {
        if (el) el.classList.remove('error');
        if (err) err.classList.remove('show');
      }
    };
    if (step === 1) {
      require('f_fname','err_fname');
      require('f_lname','err_lname');
      require('f_dob','err_dob');
      require('f_mobile','err_mobile');
    }
    if (step === 2) {
      require('f_spec','err_spec');
      require('f_complaint','err_complaint');
    }
    return valid;
  }

  function nextStep() {
    if (!validateStep(currentStep)) return;
    if (currentStep === 3) {
      buildSummary();
    }
    currentStep = Math.min(currentStep + 1, totalSteps);
    updateStepUI();
    document.getElementById('modalBody').scrollTop = 0;
  }
  function prevStep() {
    currentStep = Math.max(currentStep - 1, 1);
    updateStepUI();
    document.getElementById('modalBody').scrollTop = 0;
  }
  function goToStep(n) {
    if (n >= currentStep) return; // only allow going back
    currentStep = n;
    updateStepUI();
  }

  function updateStepUI() {
    // Panels
    document.querySelectorAll('.step-panel').forEach((p, i) => {
      p.classList.toggle('active', i + 1 === currentStep);
    });
    // Step indicators
    for (let i = 1; i <= totalSteps; i++) {
      const ind = document.getElementById('step-indicator-' + i);
      const num = document.getElementById('step-num-' + i);
      ind.className = 'step-item' + (i === currentStep ? ' active' : i < currentStep ? ' done' : '');
      num.textContent = i < currentStep ? '✓' : i;
    }
    // Footer
    document.getElementById('stepInfo').textContent = stepInfoText[currentStep];
    document.getElementById('btnBack').style.display = currentStep > 1 ? 'inline-flex' : 'none';
    document.getElementById('btnNext').style.display = currentStep < totalSteps ? 'inline-flex' : 'none';
    document.getElementById('btnRegister').style.display = currentStep === totalSteps ? 'inline-flex' : 'none';
  }

  function calcAge(dob) {
    if (!dob) return '—';
    const diff = Date.now() - new Date(dob).getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
  }

  function calcBMI(w, h) {
    if (!w || !h) return null;
    return (parseFloat(w) / Math.pow(parseFloat(h) / 100, 2)).toFixed(1);
  }

  function g(id) { return document.getElementById(id)?.value?.trim() || '—'; }

  function buildSummary() {
    const fname = g('f_fname'), lname = g('f_lname'), dob = g('f_dob');
    const gender = radioValues['f_gender'] || 'Male';
    const age = calcAge(dob === '—' ? null : dob);
    const bmi = calcBMI(g('f_weight') === '—' ? null : g('f_weight'), g('f_height') === '—' ? null : g('f_height'));

    const html = `
      <div class="summary-card">
        <div class="summary-section-title">👤 Personal Details</div>
        <div class="summary-row"><span class="summary-key">Full Name</span><span class="summary-val">${fname} ${lname}</span></div>
        <div class="summary-row"><span class="summary-key">Date of Birth</span><span class="summary-val">${dob} (Age: ${age} yrs)</span></div>
        <div class="summary-row"><span class="summary-key">Gender</span><span class="summary-val">${gender}</span></div>
        <div class="summary-row"><span class="summary-key">Blood Group</span><span class="summary-val">${g('f_blood')}</span></div>
        <div class="summary-row"><span class="summary-key">Mobile</span><span class="summary-val">${g('f_mobile')}</span></div>
        <div class="summary-row"><span class="summary-key">City / State</span><span class="summary-val">${g('f_city')}, ${g('f_state')}</span></div>
        <div class="summary-row"><span class="summary-key">Insurance</span><span class="summary-val">${g('f_insurance')}</span></div>
        <div class="summary-row"><span class="summary-key">ABHA Health ID</span><span class="summary-val">${g('f_abha')}</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-section-title">🏥 Clinical Profile</div>
        <div class="summary-row"><span class="summary-key">Specialization</span><span class="summary-val">${g('f_spec')}</span></div>
        <div class="summary-row"><span class="summary-key">Visit Type</span><span class="summary-val">${radioValues['f_visit'] || 'New Patient'}</span></div>
        <div class="summary-row"><span class="summary-key">Chief Complaint</span><span class="summary-val">${g('f_complaint')}</span></div>
        <div class="summary-row"><span class="summary-key">Existing Conditions</span><span class="summary-val">${tagData.conditions.length ? tagData.conditions.join(', ') : '—'}</span></div>
        <div class="summary-row"><span class="summary-key">Allergies</span><span class="summary-val">${tagData.allergies.length ? tagData.allergies.join(', ') : 'None recorded'}</span></div>
        <div class="summary-row"><span class="summary-key">Current Medications</span><span class="summary-val">${tagData.medications.length ? tagData.medications.join(' · ') : '—'}</span></div>
        <div class="summary-row"><span class="summary-key">Family History</span><span class="summary-val">${g('f_family')}</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-section-title">📡 Vitals & Lifestyle</div>
        <div class="summary-row"><span class="summary-key">Heart Rate</span><span class="summary-val">${g('f_hr')} bpm</span></div>
        <div class="summary-row"><span class="summary-key">Blood Pressure</span><span class="summary-val">${g('f_bp')} mmHg</span></div>
        <div class="summary-row"><span class="summary-key">SpO₂</span><span class="summary-val">${g('f_spo2')}%</span></div>
        <div class="summary-row"><span class="summary-key">Temperature</span><span class="summary-val">${g('f_temp')} °C</span></div>
        <div class="summary-row"><span class="summary-key">Weight / Height</span><span class="summary-val">${g('f_weight')} kg / ${g('f_height')} cm${bmi ? ' · BMI: ' + bmi : ''}</span></div>
        <div class="summary-row"><span class="summary-key">Fasting Blood Sugar</span><span class="summary-val">${g('f_fbs')} mg/dL</span></div>
        <div class="summary-row"><span class="summary-key">Smoking</span><span class="summary-val">${g('f_smoke')}</span></div>
        <div class="summary-row"><span class="summary-key">Physical Activity</span><span class="summary-val">${g('f_activity')}</span></div>
        <div class="summary-row"><span class="summary-key">Diet</span><span class="summary-val">${g('f_diet')}</span></div>
        <div class="summary-row"><span class="summary-key">Sleep / Stress</span><span class="summary-val">${g('f_sleep')} · ${g('f_stress')} stress</span></div>
      </div>`;
    document.getElementById('summaryContent').innerHTML = html;
  }

  function generatePatientId() {
    const year = new Date().getFullYear();
    const rand = Math.floor(10000 + Math.random() * 90000);
    return `MM-${year}-${rand}`;
  }

  function getGenderCode() {
    const g = radioValues['f_gender'] || 'Male';
    return g === 'Male' ? 'M' : g === 'Female' ? 'F' : 'O';
  }

  function getSpecColor(spec) {
    const map = {
      'Cardiology': 'teal', 'Neurology': '#60A5FA', 'Pulmonology': '#2DD4BF',
      'Endocrinology & Diabetology': '#FB923C', 'Gastroenterology': '#34D399',
      'Oncology': '#F87171', 'Psychiatry': '#A78BFA', 'Dermatology': '#FCD34D',
      'Orthopedics': '#9CA3AF', 'Ophthalmology': '#67E8F9',
    };
    return map[spec] || 'teal';
  }

  // ── PATIENT REGISTRY — single source of truth ──────────────────────────────
  let newPatientData = null;

  // ── Patient persistence ──────────────────────────────────────────
  const _DEMO_PATIENTS = [
    { id: 'MM-2024-04521', name: 'Priya Krishnamurthy', key: 'PK', demo: true },
    { id: 'MM-2023-01892', name: 'Ramesh Singh',        key: 'RS', demo: true },
    { id: 'MM-2025-09341', name: 'Anita Mehta',         key: 'AM', demo: true },
    { id: 'MM-2024-07234', name: 'Vikram Nair',         key: 'VN', demo: true },
    { id: 'MM-2025-02218', name: 'Sunita Gupta',        key: 'SG', demo: true },
    { id: 'MM-2025-08876', name: 'Nandini Bose',        key: 'NB', demo: true },
    { id: 'MM-2026-03345', name: 'Deepak Kumar',        key: 'DK', demo: true },
    { id: 'MM-2026-08876', name: 'Meena Iyer',          key: 'MI', demo: true },
    { id: 'MM-2024-05512', name: 'Mohan Pillai',        key: 'MP', demo: true },
    { id: 'MM-2025-11203', name: 'Karthik Reddy',       key: 'KR', demo: true },
  ];
  const _LS_PATIENTS  = 'sm_patients_v1';   // registry entries
  const _LS_PROFILES  = 'sm_profiles_v1';   // full patientProfiles data
  const _LS_ROWS      = 'sm_rows_v1';       // table row data for restoration

  function _lsGet(key) { try { return JSON.parse(localStorage.getItem(key) || 'null'); } catch(e) { return null; } }
  function _lsSet(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {} }

  // Live registry = registered patients (on top) + demo patients
  const _savedPatients = _lsGet(_LS_PATIENTS) || [];
  const patientRegistry = [..._savedPatients, ..._DEMO_PATIENTS];

  // After patientProfiles is defined, merge in any saved profiles
  function _restoreProfiles() {
    const saved = _lsGet(_LS_PROFILES) || {};
    Object.assign(patientProfiles, saved);
  }

  // Restore registered patients into the table + consultation chips
  function restoreRegisteredPatients() {
    const rows = _lsGet(_LS_ROWS) || [];
    if (!rows.length) return;
    rows.forEach(p => {
      addPatientToTable(p);
      const prof = patientProfiles[p.key];
      if (prof) addPatientChipToConsult(p.key, p.fullName, prof.avatarColor);
    });
    updatePatientCount();
    showToast('📂', 'Patients Restored', rows.length + ' registered patient' + (rows.length > 1 ? 's' : '') + ' reloaded');
  }

  function syncAllPatientDropdowns() {
    const selects = [
      document.getElementById('labPatientSelect'),
      document.getElementById('labModalPatientSelect'),
      document.getElementById('imagingPatientSelect'),
      document.querySelector('.risk-patient-selector select'),
    ];
    selects.forEach(sel => {
      if (!sel) return;
      const prevIdx = sel.selectedIndex;
      const needsBlank = sel.id === 'imagingPatientSelect' || sel.closest('.risk-patient-selector');
      const blankOption = needsBlank ? '<option value="">— Select patient —</option>' : '';
      sel.innerHTML = blankOption + patientRegistry
        .map(p => `<option value="${p.key}">${p.name} · ${p.id}</option>`)
        .join('');
      sel.selectedIndex = Math.min(prevIdx, sel.options.length - 1);
    });
  }

  function addToPatientRegistry(fname, lname, patientId) {
    const initials = (fname[0] || 'N') + (lname[0] || 'P');
    const uniqueKey = initials.toUpperCase() + '_' + Date.now().toString(36).toUpperCase();
    const entry = { id: patientId, name: fname + ' ' + lname, key: uniqueKey };
    patientRegistry.unshift(entry);
    // Persist registry entry
    const saved = _lsGet(_LS_PATIENTS) || [];
    saved.unshift(entry);
    _lsSet(_LS_PATIENTS, saved);
    syncAllPatientDropdowns();
    refreshRiskPatientSelector();
    return uniqueKey;
  }

  function openConsultForPatient(key, name) {
    showView('consult');
    setTimeout(() => {
      const chips = document.querySelectorAll('.patient-chip');
      let matched = false;
      chips.forEach(chip => {
        const oc = chip.getAttribute('onclick') || '';
        if (oc.includes(`'${key}'`)) {
          const match = oc.match(/switchConsultPatient\(this,'([\w]+)','([^']+)','([^']+)'\)/);
          if (match) {
            chips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            switchConsultPatient(chip, match[1], match[2], match[3]);
            matched = true;
          }
        }
      });
      if (!matched) {
        // No chip found — load from patientProfiles if available
        const p = typeof patientProfiles !== 'undefined' ? patientProfiles[key] : null;
        document.getElementById('topbar-sub').textContent = name + ' · Active Session';
        const nameEl = document.querySelector('.consult-patient-name');
        if (nameEl) nameEl.textContent = p ? p.name : name;
        const metaEl = document.querySelector('.consult-patient-meta');
        if (metaEl) metaEl.textContent = p ? p.meta : 'Patient record loaded';
        const avatarEl = document.querySelector('.consult-patient-avatar');
        if (avatarEl && p) { avatarEl.textContent = p.initials; avatarEl.style.background = p.avatarColor; }
        if (p) {
          const vitMinis = document.querySelectorAll('.vital-mini .vval');
          if (vitMinis.length >= 4) {
            vitMinis[0].textContent = p.vitals.hr;
            vitMinis[1].textContent = p.vitals.bp;
            vitMinis[2].textContent = p.vitals.spo2;
            vitMinis[3].textContent = p.vitals.temp;
          }
        }
        const msgs = document.getElementById('chatMessages');
        const typing = document.getElementById('typingIndicator');
        if (msgs && typing) {
          const msg = document.createElement('div');
          msg.className = 'msg ai';
          msg.style.animation = 'fadeIn .3s ease';
          msg.innerHTML = `<div class="msg-avatar">🧬</div><div><div class="msg-bubble" style="border-left:3px solid var(--teal);padding-left:12px">
            <strong style="color:var(--teal)">Consultation opened → ${p ? p.name : name}</strong><br>
            <span style="font-size:0.78rem;color:var(--text3)">${p ? p.meta : 'Patient record loaded. Type your clinical query below.'}</span>
            ${p ? `<br><br>Vitals: HR ${p.vitals.hr} · BP ${p.vitals.bp} · SpO₂ ${p.vitals.spo2}<br>How can I assist?` : ''}
          </div><div class="msg-time">Samarthaa · Just now</div></div>`;
          msgs.insertBefore(msg, typing);
          msgs.scrollTop = msgs.scrollHeight;
        }
        showToast('🩺', 'Consultation opened', p ? p.name : name);
      }
    }, 50);
  }

  function registerPatient() {
    const fname = document.getElementById('f_fname').value.trim();
    const lname = document.getElementById('f_lname').value.trim();
    const dob   = document.getElementById('f_dob').value;
    const spec  = document.getElementById('f_spec').value;
    const complaint = document.getElementById('f_complaint').value.trim();
    const genderCode = getGenderCode();
    const age = calcAge(dob);
    const patientId = generatePatientId();
    const today = new Date().toLocaleDateString('en-IN', { day:'numeric', month:'short', year:'numeric' });
    const conds = tagData.conditions.join(', ') || complaint.substring(0, 40);
    const bmi = calcBMI(document.getElementById('f_weight').value, document.getElementById('f_height').value);
    const fullName = fname + ' ' + lname;

    // Generate unique key and add to registry + all dropdowns
    const newKey = addToPatientRegistry(fname, lname, patientId);
    newPatientData = { fname, lname, patientId, age, genderCode, spec, conds, complaint, bmi, today, fullName, key: newKey };

    // Build a full patientProfiles entry so AI Consultation, Risk, Labs etc. have real data
    if (typeof patientProfiles !== 'undefined') {
      const colors = ['#EF4444','#3B82F6','#10B981','#8B5CF6','#F59E0B','#06B6D4','#EC4899'];
      const c1 = colors[Math.floor(Math.random() * colors.length)];
      const c2 = colors[Math.floor(Math.random() * colors.length)];
      const avatarColor = `linear-gradient(135deg,${c1},${c2})`;
      patientProfiles[newKey] = {
        name: fullName,
        meta: `${age}${genderCode} · ID: ${patientId} · ${spec || 'General'}`,
        initials: (fname[0]||'N').toUpperCase() + (lname[0]||'P').toUpperCase(),
        avatarColor,
        vitals: { hr: '—', bp: '—', spo2: '—', temp: '—' },
        hbColor: c1,
        complaints: complaint ? [complaint] : ['New registration'],
        complaintTypes: [''],
        history: conds ? conds.split(',').map(s => s.trim()).filter(Boolean) : ['No history recorded'],
        historyTypes: (conds ? conds.split(',') : ['']).map(() => ''),
        meds: 'Not yet prescribed',
        scores: [
          ['BMI',          bmi ? `${bmi} kg/m²` : '—', ''],
          ['Registered',   today,                        ''],
          ['Status',       'New Patient',                'teal'],
        ],
      };
      // Add chip to AI Consultation switcher bar
      addPatientChipToConsult(newKey, fullName, avatarColor);

      // Persist profile to localStorage
      const savedProfiles = _lsGet(_LS_PROFILES) || {};
      savedProfiles[newKey] = patientProfiles[newKey];
      _lsSet(_LS_PROFILES, savedProfiles);
    }

    // Show success screen
    document.getElementById('summaryContent').style.display = 'none';
    document.getElementById('modalFooter').style.display = 'none';
    document.getElementById('successId').textContent = patientId;
    document.getElementById('successOverlay').classList.add('show');
    document.getElementById('step-panel-4').style.display = 'block';

    addPatientToTable(newPatientData);
    // Persist row data for table restoration on next session
    const savedRows = _lsGet(_LS_ROWS) || [];
    savedRows.unshift(newPatientData);
    _lsSet(_LS_ROWS, savedRows);
    updatePatientCount();
    showToast('✅', 'Patient Registered!', `${fullName} · ID: ${patientId}`);
  }

  function addPatientChipToConsult(key, fullName, avatarColor) {
    const switcher = document.querySelector('#view-consult .patient-switcher');
    if (!switcher) return;
    const p = (typeof patientProfiles !== 'undefined') ? patientProfiles[key] : null;
    const initials = p ? p.initials : (fullName.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase());
    const parts = fullName.split(' ');
    const shortName = parts[0] + (parts[1] ? ' ' + parts[1][0] + '.' : '');
    const chip = document.createElement('div');
    chip.className = 'patient-chip';
    chip.setAttribute('onclick', `switchConsultPatient(this,'${key}','${fullName}','new')`);
    chip.innerHTML = `<div class="patient-chip-avatar" style="background:${avatarColor}">${initials}</div>
      <span class="patient-chip-name">${shortName}</span>
      <span class="status-badge active" style="margin-left:4px;font-size:0.6rem">New</span>`;
    switcher.appendChild(chip);
  }

  function addPatientToTable(p) {
    const tbody = document.querySelector('.data-table tbody');
    if (!tbody) return;
    const specColor = getSpecColor(p.spec);
    const pillStyle = specColor === 'teal'
      ? 'class="pill teal"'
      : `style="background:rgba(96,165,250,0.1);color:${specColor};border:1px solid rgba(96,165,250,0.2)"`;
    const initials  = (p.fname[0] || '') + (p.lname[0] || '');
    const colors    = ['#EF4444','#3B82F6','#10B981','#8B5CF6','#F59E0B','#06B6D4','#EC4899'];
    const color     = colors[Math.floor(Math.random() * colors.length)];
    const fullName  = p.fullName || (p.fname + ' ' + p.lname);
    const safeFullName = fullName.replace(/'/g, "\\'");
    const tr = document.createElement('tr');
    tr.style.animation = 'fadeIn .4s ease';
    tr.innerHTML = `
      <td>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,${color},${color}cc);display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:#fff;flex-shrink:0">${initials}</div>
          <div>
            <div class="td-name">${fullName}</div>
            <div style="font-size:0.72rem;color:var(--text3)">${p.conds || (p.complaint||'').substring(0,40)}</div>
          </div>
        </div>
      </td>
      <td class="td-id">${p.patientId}</td>
      <td>${p.age}${p.genderCode}</td>
      <td><span ${pillStyle}>${p.spec || 'General'}</span></td>
      <td>Today</td>
      <td><span style="color:var(--teal);font-family:var(--mono);font-weight:600">—</span></td>
      <td><span class="status-badge active">New</span></td>
      <td><button class="action-btn" onclick="openConsultForPatient('${p.key}','${safeFullName}')">Consult</button></td>`;
    tbody.insertBefore(tr, tbody.firstChild);
  }

  function updatePatientCount() {
    const countEl = document.querySelector('#view-patients .section-sub');
    if (countEl) {
      const rows = document.querySelectorAll('.data-table tbody tr').length;
      countEl.textContent = `${482 + rows - 8} total patients · Updated just now`;
    }
  }

  function goToNewConsult() {
    closeModal();
    showView('consult');
  }

  function showToast(icon, text, sub) {
    const toast     = document.getElementById('toast');
    const toastIcon = document.getElementById('toastIcon');
    const toastText = document.getElementById('toastText');
    const toastSub  = document.getElementById('toastSub');
    if (!toast || !toastIcon || !toastText) return;
    toastIcon.textContent = icon;
    toastText.textContent = text;
    if (toastSub) toastSub.textContent = sub || '';
    const bar = toast.querySelector('.toast-bar');
    if (bar) {
      bar.style.animation = 'none';
      bar.offsetHeight;
      bar.style.animation = 'toastBar 4s linear forwards';
    }
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4200);
  }

  /* ══ TOPBAR FUNCTIONS ══ */
  
  function showNotifications() {
    // Show notifications toast
    showToast('🔔', 'Notifications', '3 new notifications • 2 lab results ready • 1 imaging report');
    
    // In a real implementation, this could open a notifications panel
    console.log('Notifications clicked');
  }

  function showAlerts() {
    // Show alerts toast
    showToast('⚡', 'System Alerts', '3 urgent patients require immediate attention • Click to view details');
    
    // Optionally open the urgent cases modal
    setTimeout(() => {
      showUrgentPanel();
    }, 1000);
  }

  function showLiveMonitoring() {
    // Show live monitoring toast
    const activePatients = 7; // Based on current patient count
    showToast('📊', 'Live Monitoring', `${activePatients} patients monitored • All vitals within normal range • Real-time updates active`);
    
    // In a real implementation, this could open a live monitoring dashboard
    console.log('Live monitoring clicked');
  }

  function handleSearch(event) {
    const searchInput = event.target;
    const query = searchInput.value.trim().toLowerCase();
    
    // Search on Enter key
    if (event.key === 'Enter' && query) {
      performSearch(query);
    }
  }

  function performSearch(query) {
    // Define searchable patient data
    const patients = [
      { id: 'PK', name: 'Priya Krishnamurthy', condition: 'NSTEMI', specialty: 'Cardiology' },
      { id: 'DK', name: 'Deepak Kumar', condition: 'COPD', specialty: 'Pulmonology' },
      { id: 'MI', name: 'Meena Iyer', condition: 'Hypertensive crisis', specialty: 'Emergency' },
      { id: 'RS', name: 'Ramesh Singh', condition: 'CAD post CABG', specialty: 'Cardiology' },
      { id: 'AM', name: 'Anita Mehta', condition: 'Palpitations', specialty: 'Cardiology' },
      { id: 'VN', name: 'Vikram Nair', condition: 'Hypertension', specialty: 'Cardiology' },
      { id: 'SG', name: 'Sunita Gupta', condition: 'Post-STEMI', specialty: 'Cardiology' },
      { id: 'NB', name: 'Nandini Bose', condition: 'Hypothyroidism', specialty: 'Endocrinology' }
    ];

    // Search in patients
    const results = patients.filter(p => 
      p.name.toLowerCase().includes(query) ||
      p.condition.toLowerCase().includes(query) ||
      p.specialty.toLowerCase().includes(query) ||
      p.id.toLowerCase().includes(query)
    );

    // Common drugs for search
    const drugs = ['aspirin', 'metformin', 'amlodipine', 'atorvastatin', 'metoprolol', 'ramipril', 'clopidogrel', 'rosuvastatin', 'levothyroxine', 'thyroxine'];
    const drugMatch = drugs.some(drug => drug.includes(query) || query.includes(drug));

    // Common conditions for search
    const conditions = ['diabetes', 'hypertension', 'copd', 'asthma', 'heart', 'cardiac', 'nstemi', 'stemi', 'hypothyroidism', 'thyroid', 'pcos', 'endocrine'];
    const conditionMatch = conditions.some(condition => condition.includes(query) || query.includes(condition));

    // Display results
    if (results.length > 0) {
      const firstResult = results[0];
      showToast('🔍', `Found ${results.length} result(s)`, `${firstResult.name} • ${firstResult.condition}`);
      
      // If only one result, open that patient
      if (results.length === 1) {
        setTimeout(() => {
          openConsultForPatient(firstResult.id, firstResult.name);
        }, 1500);
      }
    } else if (drugMatch) {
      showToast('🔍', 'Drug found', `"${query}" • Opening Prescription view...`);
      setTimeout(() => {
        showView('prescription');
      }, 1500);
    } else if (conditionMatch) {
      showToast('🔍', 'Condition found', `"${query}" • Check Patients or Risk Prediction`);
    } else {
      showToast('🔍', 'No results found', `No matches for "${query}" • Try: patient names, conditions, or drugs`);
    }
  }

  /* ══════════════════════════════════════════════════════════
     COMPREHENSIVE ENHANCEMENTS
     ══════════════════════════════════════════════════════════ */

  // 1. Dynamic SOAP Note Generation
  function generateDynamicSoapNote() {
    // Get current active patient from consultation view
    const activeChip = document.querySelector('.patient-chip.active');
    if (!activeChip) {
      showToast('⚠️', 'No Patient Selected', 'Please select a patient first');
      return;
    }
    
    const onclick = activeChip.getAttribute('onclick');
    const match = onclick.match(/'(\w+)'/);
    const patientKey = match ? match[1] : 'PK';
    const patient = patientProfiles[patientKey];
    
    if (!patient) return;
    
    // Generate dynamic SOAP sections
    const soapData = {
      S: `Chief Complaint: ${patient.complaints[0]}

History of Present Illness: ${patient.name}, ${patient.meta}
Presenting with: ${patient.complaints.join(', ')}

Current Medications: ${patient.meds}`,
      
      O: `Vitals: BP ${patient.vitals.bp} | HR ${patient.vitals.hr} | SpO₂ ${patient.vitals.spo2} | Temp ${patient.vitals.temp}

Clinical Findings:
${patient.history.join('\n')}

Risk Scores:
${patient.scores.map(s => `${s[0]}: ${s[1]}`).join('\n')}`,
      
      A: `Primary Assessment: ${patient.complaints[0]}

Clinical History:
${patient.history.map((h, i) => `${i + 1}. ${h}`).join('\n')}

Risk Stratification:
${patient.scores.map(s => `• ${s[0]}: ${s[1]} (${s[2] === 'red' ? 'High Risk' : s[2] === 'gold' ? 'Moderate' : 'Normal'})`).join('\n')}`,
      
      P: `CURRENT MANAGEMENT:
${patient.meds}

MONITORING:
• Continue current vitals monitoring
• Serial assessments as indicated
• Follow-up as per risk stratification

INVESTIGATIONS:
• Based on clinical presentation and risk scores
• Lab work and imaging as indicated`,
      
      ICD: patient.scores.map(s => `${s[0]} — ${s[1]}`).join('\n')
    };
    
    // Update SOAP modal
    document.getElementById('soapS').textContent = soapData.S;
    document.getElementById('soapO').textContent = soapData.O;
    document.getElementById('soapA').textContent = soapData.A;
    document.getElementById('soapP').textContent = soapData.P;
    document.getElementById('soapICD').textContent = soapData.ICD;
    document.getElementById('soapModal').classList.add('open');
    
    showToast('📋', 'SOAP Note Generated', `For ${patient.name}`);
  }

  // Override the original generateSoapNote function
  window.generateSoapNote = generateDynamicSoapNote;

  // 2. Patient-Specific Lab Results
  let patientLabData = {};
  
  function openLabEntryWithPatient() {
    const modal = document.getElementById('labEntryModal');
    const patientSelect = document.getElementById('labModalPatientSelect');
    
    if (patientSelect) {
      // Update patient list
      patientSelect.innerHTML = '<option value="">Select Patient</option>' +
        Object.keys(patientProfiles).map(key => {
          const p = patientProfiles[key];
          return `<option value="${key}">${p.name} (${key})</option>`;
        }).join('');
      
      // Set to current patient if in consultation
      const activeChip = document.querySelector('.patient-chip.active');
      if (activeChip) {
        const onclick = activeChip.getAttribute('onclick');
        const match = onclick.match(/'(\w+)'/);
        if (match) {
          patientSelect.value = match[1];
          loadPatientLabData(match[1]);
        }
      }
      
      patientSelect.onchange = function() {
        loadPatientLabData(this.value);
      };
    }
    
    modal.classList.add('open');
  }
  
  function loadPatientLabData(patientKey) {
    if (!patientKey) return;
    
    const labData = patientLabData[patientKey];
    if (labData) {
      showToast('📊', 'Lab Data Loaded', `Showing results for ${patientProfiles[patientKey].name}`);
      // Populate fields with saved data
    } else {
      showToast('📋', 'New Lab Entry', `Ready to enter results for ${patientProfiles[patientKey].name}`);
    }
  }
  
  // Override openLabModal
  const originalOpenLabModal = window.openLabModal;
  window.openLabModal = openLabEntryWithPatient;

  // 3. Multiple Image Upload
  let uploadedImages = [];
  
  function handleMultipleImageUpload(event) {
    const files = Array.from(event.target.files);
    
    if (files.length === 0) return;
    
    showToast('📤', `Uploading ${files.length} file(s)`, 'Processing images...');
    
    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedImages.push({
          src: e.target.result,
          filename: file.name,
          analyzed: false
        });
        
        if (index === 0) {
          // Display first image
          document.getElementById('uploadedImage').src = e.target.result;
          document.getElementById('uploadedImage').style.display = 'block';
        }
        
        if (index === files.length - 1) {
          showToast('✅', 'Upload Complete', `${files.length} file(s) uploaded successfully`);
          renderImageGallery();
        }
      };
      reader.readAsDataURL(file);
    });
  }
  
  function renderImageGallery() {
    // Create gallery container if it doesn't exist
    let gallery = document.getElementById('imageGallery');
    if (!gallery) {
      const container = document.querySelector('#view-imaging .card-body');
      if (container) {
        gallery = document.createElement('div');
        gallery.id = 'imageGallery';
        gallery.style.cssText = 'display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;';
        container.appendChild(gallery);
      }
    }
    
    if (gallery) {
      gallery.innerHTML = uploadedImages.map((img, idx) => `
        <div style="position:relative;width:100px;height:100px;border:2px solid var(--border);border-radius:8px;overflow:hidden;cursor:pointer" onclick="selectUploadedImage(${idx})">
          <img src="${img.src}" style="width:100%;height:100%;object-fit:cover" alt="${img.filename}">
          <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);color:white;font-size:0.65rem;padding:2px 4px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap">${img.filename}</div>
          ${img.analyzed ? '<div style="position:absolute;top:4px;right:4px;background:var(--teal);color:var(--navy);border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.7rem">✓</div>' : ''}
        </div>
      `).join('');
    }
  }
  
  function selectUploadedImage(index) {
    const img = uploadedImages[index];
    document.getElementById('uploadedImage').src = img.src;
    showToast('🖼️', 'Image Selected', img.filename);
  }

  // 4. Dynamic Analytics
  function renderDynamicAnalytics() {
    const patients = Object.values(patientProfiles);
    
    // Calculate stats
    const stats = {
      total: patients.length,
      urgent: patients.filter(p => p.complaintTypes.includes('red')).length,
      male: patients.filter(p => p.meta.includes('M')).length,
      female: patients.filter(p => p.meta.includes('F')).length,
      cardiology: patients.filter(p => p.meta.includes('Cardiology')).length,
    };
    
    // Update analytics view when opened
    const analyticsView = document.getElementById('view-analytics');
    if (analyticsView) {
      // Find or create stats container
      let statsContainer = analyticsView.querySelector('.analytics-stats');
      if (!statsContainer) {
        statsContainer = document.createElement('div');
        statsContainer.className = 'analytics-stats';
        statsContainer.style.cssText = 'display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:24px;';
        analyticsView.insertBefore(statsContainer, analyticsView.firstChild);
      }
      
      statsContainer.innerHTML = `
        <div class="stat-card" style="--accent-color: var(--teal)">
          <div class="icon">👥</div>
          <div class="value">${stats.total}</div>
          <div class="label">Total Patients</div>
        </div>
        <div class="stat-card" style="--accent-color: var(--red)">
          <div class="icon">🚨</div>
          <div class="value">${stats.urgent}</div>
          <div class="label">Urgent Cases</div>
        </div>
        <div class="stat-card" style="--accent-color: var(--purple)">
          <div class="icon">👨</div>
          <div class="value">${stats.male}</div>
          <div class="label">Male Patients</div>
        </div>
        <div class="stat-card" style="--accent-color: var(--gold)">
          <div class="icon">👩</div>
          <div class="value">${stats.female}</div>
          <div class="label">Female Patients</div>
        </div>
      `;
    }
    
    showToast('📊', 'Analytics Updated', 'Showing real patient data');
  }

  // 5. Risk Prediction - Patient Selection
  // ══════════════════════════════════════════════════════════════════
  // RISK PREDICTION ENGINE — fully dynamic, driven by patientProfiles
  // ══════════════════════════════════════════════════════════════════

  /* Compute risk percentages (0–100) from a patient profile object */
  function _computeRisk(p) {
    const meta      = p.meta || '';
    const history   = (p.history  || []).join(' ').toLowerCase();
    const complaints= (p.complaints || []).join(' ').toLowerCase();
    const meds      = (p.meds || '').toLowerCase();
    const vitals    = p.vitals || {};
    const scoreArr  = p.scores  || [];

    const ageM  = meta.match(/(\d+)([MF])/i);
    const age   = ageM ? parseInt(ageM[1]) : 45;
    const male  = ageM ? ageM[2].toUpperCase() === 'M' : true;

    const bpM   = (vitals.bp || '').match(/(\d+)\/(\d+)/);
    const sys   = bpM ? parseInt(bpM[1]) : 120;
    const hr    = parseInt((vitals.hr  || '0').replace(/\D/g,'')) || 72;
    const spo2  = parseInt((vitals.spo2|| '98').replace(/\D/g,'')) || 98;

    const hasDM    = /diabet|dm type|t2dm|hba1c/i.test(history);
    const hasHTN   = /hyperten|\bhtn\b/i.test(history) || sys >= 140;
    const hasCAD   = /\bcad\b|coronary|cabg|\bmi\b|angina/i.test(history);
    const hasCKD   = /\bckd\b|kidney|renal|nephro/i.test(history);
    const hasSmoke = /smok|tobacco|bidi/i.test(history);
    const hasDys   = /dyslipid|cholesterol/i.test(history);
    const famCard  = /family.*heart|father.*mi|mother.*stroke/i.test(history);
    const famDM    = /family.*diabet/i.test(history);
    const famHTN   = /family.*htn|family.*hyper/i.test(history);
    const hasCOPD  = /copd|asthma/i.test(history);

    const heartS   = scoreArr.find(s => /heart score/i.test(s[0]));
    const highHEART= heartS ? /\b[5-9]\b|10/.test(heartS[1]) : false;

    // ── Cardiac (0-100) ──
    let cardiac = 8;
    if (age > 60)  cardiac += 18; else if (age > 50) cardiac += 10; else if (age > 40) cardiac += 5;
    if (male)      cardiac += 7;
    if (hasDM)     cardiac += 14;
    if (hasHTN)    cardiac += 12;
    if (hasDys)    cardiac += 10;
    if (hasSmoke)  cardiac += 11;
    if (hasCAD)    cardiac += 22;
    if (famCard)   cardiac += 8;
    if (highHEART) cardiac += 14;
    if (hr > 100)  cardiac += 5;
    if (/chest pain|dyspnea|diaphor/i.test(complaints)) cardiac += 8;
    cardiac = Math.min(95, cardiac);

    // ── Diabetes (0-100) ──
    let diabetes = 7;
    if (hasDM) { diabetes = 95; }
    else {
      if (age > 45)  diabetes += 14;
      if (hasHTN)    diabetes += 8;
      if (hasDys)    diabetes += 7;
      if (famDM)     diabetes += 18;
      if (hasSmoke)  diabetes += 5;
      if (male)      diabetes += 4;
      const bmiS = scoreArr.find(s => s[0] === 'BMI');
      if (bmiS && parseFloat(bmiS[1]) > 27) diabetes += 12;
      diabetes = Math.min(82, diabetes);
    }

    // ── Hypertension (0-100) ──
    let htn = 7;
    if (hasHTN) { htn = Math.max(88, sys > 160 ? 95 : 88); }
    else {
      if (sys > 130)  htn += 28; else if (sys > 120) htn += 14;
      if (age > 50)   htn += 12;
      if (male)       htn += 5;
      if (hasDM)      htn += 9;
      if (famHTN)     htn += 15;
      if (hasSmoke)   htn += 7;
      if (/headache|visual/i.test(complaints)) htn += 8;
      htn = Math.min(82, htn);
    }

    // ── CKD progression (0-100) ──
    let ckd = 5;
    if (hasCKD)  ckd += 32;
    if (hasDM)   ckd += 18;
    if (hasHTN)  ckd += 13;
    if (age > 60)ckd += 10;
    if (hasCAD)  ckd += 7;
    if (hasDM && hasHTN) ckd += 12;
    ckd = Math.min(90, ckd);

    // ── Overall weighted ──
    const overall = Math.min(95, Math.round(cardiac*0.35 + diabetes*0.25 + htn*0.2 + ckd*0.2));
    return { cardiac, diabetes, htn, ckd, overall };
  }

  function _riskColour(v) {
    return v >= 65 ? 'var(--red)' : v >= 40 ? 'var(--gold)' : 'var(--teal)';
  }
  function _riskLabel(v) {
    return v >= 65 ? 'Critical' : v >= 40 ? 'High' : v >= 20 ? 'Moderate' : 'Low';
  }
  function _riskPillCSS(v) {
    if (v >= 65) return 'background:rgba(220,38,38,0.12);color:var(--red);border:1px solid rgba(220,38,38,0.3)';
    if (v >= 40) return 'background:rgba(245,158,11,0.12);color:var(--gold);border:1px solid rgba(245,158,11,0.3)';
    return 'background:var(--teal-dim);color:var(--teal);border:1px solid rgba(0,212,180,0.25)';
  }

  /* Build list of risk factors from the profile */
  function _riskFactors(p, sc) {
    const h = (p.history || []).join(' ');
    const v = p.vitals || {};
    const m = p.meta   || '';
    const ageM = m.match(/(\d+)([MF])/i);
    const age  = ageM ? parseInt(ageM[1]) : 45;
    const sys  = parseInt((v.bp||'120').match(/(\d+)/)?.[1]||'120');
    const spo2 = parseInt((v.spo2||'98').replace(/\D/g,''))||98;
    const hr   = parseInt((v.hr||'72').replace(/\D/g,''))||72;
    const items = [];

    if (sc.cardiac  >= 65) items.push({ icon:'❤️', text:'High cardiac event probability — urgent cardiology review', sev:'red'  });
    else if (sc.cardiac  >= 40) items.push({ icon:'❤️', text:'Elevated cardiac risk — routine cardiology assessment advised', sev:'gold' });
    if (sc.ckd      >= 50) items.push({ icon:'🩺', text:'Significant CKD progression risk — nephrology referral', sev:'red'  });
    if (sc.diabetes >= 40 && sc.diabetes < 95) items.push({ icon:'🩸', text:'Elevated T2DM risk — fasting glucose & HbA1c monitoring', sev:'gold' });
    if (sc.diabetes === 95) items.push({ icon:'🩸', text:'Active Type 2 Diabetes — glycaemic control critical', sev:'red' });
    if (sc.htn      >= 88) items.push({ icon:'💉', text:'Active hypertension — BP control essential', sev:'red'  });
    else if (sc.htn >= 40) items.push({ icon:'💉', text:'Hypertension risk — home BP monitoring recommended', sev:'gold' });
    if (sys > 160) items.push({ icon:'📈', text:'BP ' + v.bp + ' — Stage 3 hypertension, immediate action', sev:'red' });
    else if (sys > 140) items.push({ icon:'📊', text:'BP ' + v.bp + ' — Stage 2 hypertension', sev:'gold' });
    if (spo2 < 94)  items.push({ icon:'🫁', text:'SpO₂ ' + v.spo2 + ' — hypoxia, respiratory evaluation needed', sev:'red' });
    if (hr > 100)   items.push({ icon:'💓', text:'HR ' + v.hr + ' — tachycardia, evaluate cause', sev:'gold' });
    if (age > 60)   items.push({ icon:'👤', text:'Age ' + age + ' — age-related elevated baseline risk', sev:'gold' });
    if (/smok/i.test(h))  items.push({ icon:'🚬', text:'Smoking history — significant modifiable risk factor', sev:'gold' });
    if (/dyslipid|cholesterol/i.test(h)) items.push({ icon:'🧪', text:'Dyslipidaemia — statin review per ICMR 2024', sev:'gold' });
    if (/family.*heart|father.*mi/i.test(h)) items.push({ icon:'🧬', text:'Family history of cardiac disease', sev:'gold' });
    if (/family.*diabet/i.test(h)) items.push({ icon:'🧬', text:'Family history of diabetes', sev:'gold' });
    if (!items.length) items.push({ icon:'✅', text:'No major risk factors identified from available data', sev:'teal' });
    return items.slice(0, 8);
  }

  /* Build recommended interventions */
  function _riskInterventions(p, sc) {
    const ivs = [];
    if (sc.cardiac >= 65) {
      ivs.push('🫀 Urgent cardiology referral — stress ECG / echo / coronary angiography');
      ivs.push('💊 Optimise antiplatelet + statin therapy per ICMR 2024 ACS protocol');
    } else if (sc.cardiac >= 40) {
      ivs.push('🫀 Cardiology review within 4 weeks — resting ECG + lipid panel');
    }
    if (sc.diabetes >= 40 && sc.diabetes < 95) {
      ivs.push('🩸 FBS + HbA1c every 3 months — early DM prevention');
      ivs.push('🥗 Low-GI diet + 150 min/week moderate exercise (NHP guidelines)');
    }
    if (sc.htn >= 40 && sc.htn < 88) {
      ivs.push('📊 Home BP monitoring twice daily — DASH diet, salt <5 g/day');
    }
    if (sc.ckd >= 40) {
      ivs.push('🩺 Nephrology review — eGFR + urine ACR every 6 months');
      ivs.push('💧 Avoid nephrotoxic drugs; maintain adequate hydration');
    }
    const hist = (p.history||[]).join(' ').toLowerCase();
    if (/smok/i.test(hist)) ivs.push('🚭 Smoking cessation counselling — NHP / AYUSH resources');
    if (sc.overall >= 60)   ivs.push('📅 4-weekly follow-up due to high overall risk score');
    else if (sc.overall >= 35) ivs.push('📅 3-monthly risk reassessment recommended');
    else                    ivs.push('📅 Annual risk reassessment — maintain healthy lifestyle');
    if (!ivs.length) ivs.push('✅ Continue current management — low risk profile');
    return ivs.slice(0, 7);
  }

  // ── Main render: called when a patient is selected ──────────────
  function renderRiskPage(key) {
    const dashboard = document.getElementById('riskPatientDashboard');
    const overview  = document.getElementById('riskOverviewPanel');
    if (!key) {
      dashboard.style.display = 'none';
      overview.style.display  = '';
      _renderRiskTable();
      return;
    }
    const p = patientProfiles[key];
    if (!p) return;
    const sc = _computeRisk(p);

    dashboard.style.display = '';
    overview.style.display  = 'none';

    // ── Patient banner ──
    document.getElementById('riskBanner').innerHTML = `
      <div style="width:46px;height:46px;border-radius:12px;background:${p.avatarColor||'var(--teal)'};display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;flex-shrink:0">${p.initials||'?'}</div>
      <div style="flex:1;min-width:0">
        <div style="font-family:var(--syne);font-size:1.05rem;font-weight:700;color:var(--text1)">${p.name}</div>
        <div style="font-size:0.78rem;color:var(--text3);margin-top:2px">${p.meta}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${[['HR',p.vitals?.hr],['BP',p.vitals?.bp],['SpO₂',p.vitals?.spo2],['Temp',p.vitals?.temp]].map(([lbl,val])=>`
        <div style="text-align:center;padding:7px 12px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px">
          <div style="font-size:0.62rem;color:var(--text3);text-transform:uppercase;letter-spacing:.7px">${lbl}</div>
          <div style="font-family:var(--mono);font-weight:600;font-size:0.82rem;color:var(--text1)">${val||'—'}</div>
        </div>`).join('')}
      </div>`;

    // ── Gauge tiles ──
    const gauges = [
      { label:'Cardiac',     icon:'❤️', val:sc.cardiac  },
      { label:'Diabetes',    icon:'🩸', val:sc.diabetes },
      { label:'Hypertension',icon:'💉', val:sc.htn      },
      { label:'CKD Prog.',   icon:'🩺', val:sc.ckd      },
    ];
    document.getElementById('riskGauges').innerHTML = gauges.map(g => `
      <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;position:relative;overflow:hidden">
        <div style="position:absolute;top:0;left:0;right:0;height:3px;background:${_riskColour(g.val)}"></div>
        <div style="font-size:1.4rem;margin-bottom:6px">${g.icon}</div>
        <div style="font-family:var(--syne);font-size:1.9rem;font-weight:800;color:${_riskColour(g.val)}">${g.val}%</div>
        <div style="font-size:0.72rem;color:var(--text3);margin:3px 0 8px">${g.label} Risk</div>
        <div style="height:5px;background:var(--navy3);border-radius:3px;overflow:hidden">
          <div style="height:100%;width:${g.val}%;background:${_riskColour(g.val)};border-radius:3px"></div>
        </div>
        <div style="font-size:0.65rem;font-weight:700;margin-top:5px;color:${_riskColour(g.val)}">${_riskLabel(g.val)}</div>
      </div>`).join('');

    // ── Overall badge ──
    const badge = document.getElementById('overallRiskBadge');
    badge.textContent = _riskLabel(sc.overall) + ' — ' + sc.overall + '% overall';
    badge.style.cssText = _riskPillCSS(sc.overall) + ';font-size:0.72rem';

    // ── Risk factors ──
    const factors = _riskFactors(p, sc);
    document.getElementById('riskFactorsList').innerHTML = factors.map((f,i) => `
      <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;${i<factors.length-1?'border-bottom:1px solid var(--border)':''}">
        <span style="font-size:0.95rem;flex-shrink:0;margin-top:1px">${f.icon}</span>
        <span style="font-size:0.82rem;color:${f.sev==='red'?'var(--red)':f.sev==='gold'?'var(--gold)':'var(--teal)'}">${f.text}</span>
      </div>`).join('');

    // ── Interventions ──
    const ivs = _riskInterventions(p, sc);
    document.getElementById('riskInterventionsList').innerHTML = ivs.map((iv,i) => `
      <div style="display:flex;align-items:flex-start;gap:8px;padding:8px 0;${i<ivs.length-1?'border-bottom:1px solid var(--border)':''}">
        <span style="font-size:0.82rem;color:var(--text2)">${iv}</span>
      </div>`).join('');

    // Reset AI panel
    const narr = document.getElementById('riskAINarrative');
    const stat = document.getElementById('riskAIStatusBadge');
    narr.innerHTML = 'Click <strong>AI Risk Analysis</strong> above to generate a personalised clinical risk narrative for this patient.';
    stat.textContent = 'Click AI Risk Analysis →';
    stat.style.cssText = 'background:var(--navy3);color:var(--text3);font-size:0.72rem';

    showToast('🎯', 'Risk Profile Loaded', p.name + ' · ' + _riskLabel(sc.overall) + ' risk (' + sc.overall + '%)');
  }

  // ── All-patients table ──────────────────────────────────────────
  function _renderRiskTable() {
    const tbody   = document.getElementById('riskTableBody');
    const countEl = document.getElementById('riskTableCount');
    if (!tbody) return;
    const keys = Object.keys(patientProfiles);
    if (countEl) countEl.textContent = keys.length + ' patients';
    tbody.innerHTML = keys.map((key, i) => {
      const p  = patientProfiles[key];
      const sc = _computeRisk(p);
      return `<tr style="${i%2?'background:rgba(255,255,255,0.015)':''}">
        <td style="padding:11px 16px">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:30px;height:30px;border-radius:8px;background:${p.avatarColor||'var(--teal)'};display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:#fff;flex-shrink:0">${p.initials||'?'}</div>
            <div>
              <div style="font-weight:600;color:var(--text1);font-size:0.85rem">${p.name}</div>
              <div style="font-size:0.7rem;color:var(--text3)">${p.meta.split('·')[0].trim()}</div>
            </div>
          </div>
        </td>
        <td style="padding:10px;text-align:center"><span style="font-family:var(--mono);font-weight:700;font-size:0.9rem;color:${_riskColour(sc.cardiac)}">${sc.cardiac}%</span></td>
        <td style="padding:10px;text-align:center"><span style="font-family:var(--mono);font-weight:700;font-size:0.9rem;color:${_riskColour(sc.diabetes)}">${sc.diabetes}%</span></td>
        <td style="padding:10px;text-align:center"><span style="font-family:var(--mono);font-weight:700;font-size:0.9rem;color:${_riskColour(sc.htn)}">${sc.htn}%</span></td>
        <td style="padding:10px;text-align:center"><span style="font-family:var(--mono);font-weight:700;font-size:0.9rem;color:${_riskColour(sc.ckd)}">${sc.ckd}%</span></td>
        <td style="padding:10px;text-align:center">
          <span style="padding:3px 10px;border-radius:20px;font-size:0.72rem;font-weight:600;${_riskPillCSS(sc.overall)}">${_riskLabel(sc.overall)} &nbsp;${sc.overall}%</span>
        </td>
        <td style="padding:10px;text-align:center">
          <button onclick="document.getElementById('riskPatientSelect').value='${key}';renderRiskPage('${key}')"
            class="btn btn-ghost btn-sm" style="font-size:0.72rem;padding:5px 10px">Analyse →</button>
        </td>
      </tr>`;
    }).join('');
  }

  // ── AI Risk Analysis (calls Claude) ────────────────────────────
  async function runAIRiskAnalysis() {
    const sel = document.getElementById('riskPatientSelect');
    if (!sel || !sel.value) { showToast('⚠️', 'No Patient', 'Select a patient first'); return; }
    const key = sel.value;
    const p   = patientProfiles[key];
    if (!p) return;
    const sc  = _computeRisk(p);

    const apiKey = getApiKey();
    if (!apiKey) { showToast('⚠️', 'API Key', 'Enter your Anthropic key in Settings'); return; }

    const statEl = document.getElementById('riskAIStatusBadge');
    const narrEl = document.getElementById('riskAINarrative');
    statEl.textContent = '⏳ Generating…';
    statEl.style.cssText = 'background:var(--teal-dim);color:var(--teal);font-size:0.72rem';
    narrEl.innerHTML = '<span style="color:var(--text3);font-style:italic">AI is analysing patient data…</span>';

    const prompt = `You are a senior Indian physician reviewing ML-computed risk predictions.

PATIENT: ${p.name}
DETAILS: ${p.meta}
VITALS: HR ${p.vitals?.hr||'—'} | BP ${p.vitals?.bp||'—'} | SpO₂ ${p.vitals?.spo2||'—'} | Temp ${p.vitals?.temp||'—'}
COMPLAINTS: ${(p.complaints||[]).join(', ')||'None recorded'}
HISTORY: ${(p.history||[]).join(', ')||'None'}
MEDICATIONS: ${p.meds||'None'}
CLINICAL SCORES: ${(p.scores||[]).map(s=>s[0]+': '+s[1]).join(' | ')||'None'}
COMPUTED RISK: Cardiac ${sc.cardiac}% | Diabetes ${sc.diabetes}% | HTN ${sc.htn}% | CKD ${sc.ckd}% | Overall ${sc.overall}%

Write a 3–4 sentence clinical risk narrative for the treating physician covering: (1) the primary risk concern and clinical reasoning, (2) the single most important immediate action, (3) 6-month prognosis outlook. Reference ICMR 2024 or NHP guidelines. Be direct, evidence-based, no bullet points.`;

    try {
      const text = await callClaudeAI([{ role:'user', content:prompt }],
        'You are a senior Indian physician specialising in preventive medicine. Be concise, clinical, evidence-based.');
      narrEl.innerHTML  = text.replace(/\n\n/g,'<br><br>').replace(/\n/g,' ');
      statEl.textContent = '✅ AI Analysis Complete';
      statEl.style.cssText = 'background:var(--teal-dim);color:var(--teal);font-size:0.72rem';
    } catch(err) {
      narrEl.innerHTML  = '<span style="color:var(--red)">AI analysis failed: ' + err.message + '</span>';
      statEl.textContent = '❌ Error';
      statEl.style.cssText = 'background:var(--red-dim);color:var(--red);font-size:0.72rem';
    }
  }

  // ── Patient selector helpers (called from registry/login hooks) ─
  function addRiskPatientSelector() { _populateRiskSelect(); _renderRiskTable(); }
  function refreshRiskPatientSelector() { _populateRiskSelect(); }

  function _populateRiskSelect() {
    const sel = document.getElementById('riskPatientSelect');
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">— Select patient to analyse —</option>' +
      Object.keys(patientProfiles).map(key => {
        const p  = patientProfiles[key];
        const sc = _computeRisk(p);
        return `<option value="${key}">${p.name} · ${p.meta.split('·')[0].trim()} — ${_riskLabel(sc.overall)} (${sc.overall}%)</option>`;
      }).join('');
    if (prev) { sel.value = prev; }
  }

  // Legacy alias kept for any remaining callers
  function updateRiskPrediction(k) { renderRiskPage(k); }


  // 6. Language Support
  const translations = {
    en: {
      dashboard: 'Clinical Dashboard',
      consult: 'AI Consultation',
      patients: 'Patients',
      prescription: 'Prescription',
      labs: 'Lab Results',
      imaging: 'Medical Imaging',
      analytics: 'Analytics',
      settings: 'Settings',
    },
    hi: {
      dashboard: 'क्लिनिकल डैशबोर्ड',
      consult: 'एआई परामर्श',
      patients: 'मरीज़',
      prescription: 'नुस्खा',
      labs: 'लैब परिणाम',
      imaging: 'मेडिकल इमेजिंग',
      analytics: 'विश्लेषण',
      settings: 'सेटिंग्स',
    },
    ta: {
      dashboard: 'மருத்துவ டாஷ்போர்டு',
      consult: 'AI ஆலோசனை',
      patients: 'நோயாளிகள்',
      prescription: 'மருந்து பரிந்துரை',
      labs: 'ஆய்வக முடிவுகள்',
      imaging: 'மருத்துவ இமேஜிங்',
      analytics: 'பகுப்பாய்வு',
      settings: 'அமைப்புகள்',
    }
  };

  let currentLanguage = 'en';

  function changeLanguage(lang) {
    if (!translations[lang]) return;
    
    currentLanguage = lang;
    
    // Update view titles (simplified version)
    const viewTitles = {
      dashboard: translations[lang].dashboard,
      consult: translations[lang].consult,
      patients: translations[lang].patients,
      prescription: translations[lang].prescription,
      labs: translations[lang].labs,
      imaging: translations[lang].imaging,
      analytics: translations[lang].analytics,
      settings: translations[lang].settings,
    };
    
    // Update the views object
    Object.keys(viewTitles).forEach(key => {
      if (views[key]) {
        views[key].title = viewTitles[key];
      }
    });
    
    // Update current view title
    const currentView = document.querySelector('.view.active');
    if (currentView) {
      const viewId = currentView.id.replace('view-', '');
      if (viewTitles[viewId]) {
        document.getElementById('topbar-title').textContent = viewTitles[viewId];
      }
    }
    
    localStorage.setItem('preferredLanguage', lang);
    showToast('🌐', 'Language Changed', `Interface set to ${lang.toUpperCase()}`);
  }

  // Function to change language from settings page
  function changeLanguageFromSettings(lang) {
    changeLanguage(lang);
    
    // Update the dropdown to show selected value
    const dropdown = document.getElementById('interfaceLanguageSelect');
    if (dropdown) {
      dropdown.value = lang;
    }
    
    // Update navigation items if needed
    updateNavigationLanguage(lang);
  }

  // Function to change AI response language
  let aiLanguage = 'en';
  function changeAILanguage(lang) {
    aiLanguage = lang;
    localStorage.setItem('aiLanguage', lang);
    
    const langNames = {
      en: 'English',
      hi: 'Hindi/Hinglish',
      ta: 'Tamil',
      te: 'Telugu',
      kn: 'Kannada'
    };
    
    showToast('🤖', 'AI Language Updated', `AI will respond in ${langNames[lang] || lang}`);
  }

  // Update navigation items with current language
  function updateNavigationLanguage(lang) {
    if (!translations[lang]) return;
    
    const navItems = document.querySelectorAll('.nav-item');
    const viewKeys = ['dashboard', 'consult', 'patients', 'risk', 'specs', 'prescription', 'labs', 'imaging', 'analytics', 'settings'];
    
    navItems.forEach((item, index) => {
      if (viewKeys[index] && translations[lang][viewKeys[index]]) {
        const textNode = item.childNodes[2]; // Text after icon
        if (textNode && textNode.nodeType === 3) {
          textNode.textContent = translations[lang][viewKeys[index]];
        }
      }
    });
  }

  // Expand translations to include Telugu, Kannada, Bengali
  if (!translations.te) {
    translations.te = {
      dashboard: 'క్లినికల్ డాష్‌బోర్డ్',
      consult: 'AI సంప్రదింపు',
      patients: 'రోగులు',
      prescription: 'ప్రిస్క్రిప్షన్',
      labs: 'ల్యాబ్ ఫలితాలు',
      imaging: 'మెడికల్ ఇమేజింగ్',
      analytics: 'విశ్లేషణ',
      settings: 'సెట్టింగ్‌లు',
      risk: 'రిస్క్ అంచనా',
      specs: 'ప్రత్యేకతలు',
    };
  }

  if (!translations.kn) {
    translations.kn = {
      dashboard: 'ಕ್ಲಿನಿಕಲ್ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್',
      consult: 'AI ಸಮಾಲೋಚನೆ',
      patients: 'ರೋಗಿಗಳು',
      prescription: 'ಪ್ರಿಸ್ಕ್ರಿಪ್ಷನ್',
      labs: 'ಲ್ಯಾಬ್ ಫಲಿತಾಂಶಗಳು',
      imaging: 'ವೈದ್ಯಕೀಯ ಇಮೇಜಿಂಗ್',
      analytics: 'ವಿಶ್ಲೇಷಣೆ',
      settings: 'ಸೆಟ್ಟಿಂಗ್‌ಗಳು',
      risk: 'ಅಪಾಯ ಮುನ್ಸೂಚನೆ',
      specs: 'ವಿಶೇಷತೆಗಳು',
    };
  }

  if (!translations.bn) {
    translations.bn = {
      dashboard: 'ক্লিনিক্যাল ড্যাশবোর্ড',
      consult: 'AI পরামর্শ',
      patients: 'রোগীরা',
      prescription: 'প্রেসক্রিপশন',
      labs: 'ল্যাব ফলাফল',
      imaging: 'মেডিকেল ইমেজিং',
      analytics: 'বিশ্লেষণ',
      settings: 'সেটিংস',
      risk: 'ঝুঁকি পূর্বাভাস',
      specs: 'বিশেষীকরণ',
    };
  }

  // 7. Conversational AI Assistant
  function initConversationalAI() {
    // Add floating chat button
    const chatBtn = document.createElement('div');
    chatBtn.id = 'floatingChatBtn';
    chatBtn.style.cssText = 'position:fixed;bottom:24px;right:24px;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:14px 20px;border-radius:30px;cursor:pointer;box-shadow:0 4px 20px rgba(16,185,129,0.3);display:flex;align-items:center;gap:8px;z-index:1000;transition:all 0.3s;';
    chatBtn.innerHTML = '<span>💬</span><span style="font-weight:600;font-size:0.85rem">Ask AI</span>';
    chatBtn.onclick = toggleAIAssistant;
    document.body.appendChild(chatBtn);
    
    // Add chat panel
    const chatPanel = document.createElement('div');
    chatPanel.id = 'aiAssistantPanel';
    chatPanel.style.cssText = 'position:fixed;bottom:90px;right:24px;width:400px;height:600px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);display:none;flex-direction:column;z-index:999;';
    chatPanel.innerHTML = `
      <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--navy2);border-radius:12px 12px 0 0">
        <span style="font-weight:700;color:var(--teal)">🧬 Samarthaa AI</span>
        <button onclick="toggleAIAssistant()" style="background:none;border:none;color:var(--text2);font-size:1.5rem;cursor:pointer;padding:0;width:32px;height:32px">×</button>
      </div>
      <div id="aiChatHistory" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px"></div>
      <div style="padding:16px;border-top:1px solid var(--border);display:flex;gap:8px">
        <input type="text" id="aiChatInput" placeholder="Ask anything... 'Show Priya', 'Generate SOAP', etc." style="flex:1;padding:10px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);outline:none" onkeypress="if(event.key==='Enter') sendAIMessage()">
        <button onclick="sendAIMessage()" style="padding:10px 16px;background:var(--teal);color:var(--navy);border:none;border-radius:8px;cursor:pointer;font-weight:600">→</button>
      </div>
    `;
    document.body.appendChild(chatPanel);
    
    // Add welcome message
    addAIMessage('ai', 'Hello! I\'m Samarthaa, your AI clinical assistant. I can help you with:\n\n• Opening patient consultations\n• Generating SOAP notes\n• Searching for patients, drugs, or conditions\n• Opening lab results or prescriptions\n• Showing analytics\n\nJust ask me anything!');
  }

  function toggleAIAssistant() {
    const panel = document.getElementById('aiAssistantPanel');
    panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
  }

  function sendAIMessage() {
    const input = document.getElementById('aiChatInput');
    const message = input.value.trim();
    if (!message) return;
    
    input.value = '';
    addAIMessage('user', message);
    
    // Process command
    setTimeout(() => processAICommand(message), 500);
  }

  function addAIMessage(role, text) {
    const history = document.getElementById('aiChatHistory');
    const msg = document.createElement('div');
    msg.style.cssText = 'display:flex;gap:10px;align-items:flex-start;' + (role === 'user' ? 'flex-direction:row-reverse' : '');
    msg.innerHTML = `
      <div style="width:32px;height:32px;border-radius:50%;background:${role === 'user' ? 'var(--teal-dim)' : 'var(--teal)'};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.9rem">${role === 'user' ? '👤' : '🧬'}</div>
      <div style="background:${role === 'user' ? 'var(--teal-dim)' : 'var(--navy3)'};padding:10px 14px;border-radius:12px;max-width:70%;font-size:0.85rem;line-height:1.4;${role === 'user' ? 'color:var(--teal)' : 'color:var(--text1)'}">${text}</div>
    `;
    history.appendChild(msg);
    history.scrollTop = history.scrollHeight;
  }

  function processAICommand(cmd) {
    const lower = cmd.toLowerCase();
    
    // Show patient
    if (lower.match(/show|open|view.*(?:priya|deepak|meena|ramesh|anita|vikram|sunita)/)) {
      const names = {
        priya: 'PK', deepak: 'DK', meena: 'MI',
        ramesh: 'RS', anita: 'AM', vikram: 'VN', sunita: 'SG'
      };
      for (const [name, key] of Object.entries(names)) {
        if (lower.includes(name)) {
          openConsultForPatient(key, patientProfiles[key].name);
          addAIMessage('ai', `Opening consultation for ${patientProfiles[key].name}. How can I assist?`);
          return;
        }
      }
    }
    
    // SOAP note
    if (lower.match(/soap|note|summary|generate/)) {
      generateDynamicSoapNote();
      addAIMessage('ai', 'I\'ve generated a SOAP note based on the current patient\'s data. You can review it in the modal.');
      return;
    }
    
    // Labs
    if (lower.match(/lab|test|result/)) {
      showView('labs');
      addAIMessage('ai', 'Opening Lab Results view. You can enter or view lab data here.');
      return;
    }
    
    // Prescription
    if (lower.match(/prescri|medicine|drug/)) {
      showView('prescription');
      addAIMessage('ai', 'Opening Prescription Builder. What medication would you like to prescribe?');
      return;
    }
    
    // Analytics
    if (lower.match(/analytics|stats|report/)) {
      showView('analytics');
      renderDynamicAnalytics();
      addAIMessage('ai', `Analytics dashboard showing data for ${Object.keys(patientProfiles).length} patients.`);
      return;
    }
    
    // Search
    if (lower.match(/search|find/)) {
      const query = cmd.replace(/search|find|for/gi, '').trim();
      performSearch(query);
      addAIMessage('ai', `Searching for "${query}"...`);
      return;
    }
    
    // Default
    addAIMessage('ai', 'I can help you with:\n• "Show Priya" - Open patient consultation\n• "Generate SOAP" - Create SOAP note\n• "Open labs" - View lab results\n• "Search COPD" - Search for conditions\n• "Show analytics" - View statistics');
  }

  // Initialize enhancements on load
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize conversational AI
    initConversationalAI();
    
    // Add risk patient selector
    addRiskPatientSelector();
    
    // Update image upload input to support multiple files
    const imageInput = document.getElementById('imageUploadInput');
    if (imageInput) {
      imageInput.setAttribute('multiple', 'multiple');
      imageInput.onchange = handleMultipleImageUpload;
    }
    
    // Load saved language
    const savedLang = localStorage.getItem('preferredLanguage');
    const savedAILang = localStorage.getItem('aiLanguage');
    
    if (savedLang && translations[savedLang]) {
      changeLanguage(savedLang);
      // Set the dropdown value in settings
      const interfaceDropdown = document.getElementById('interfaceLanguageSelect');
      if (interfaceDropdown) {
        interfaceDropdown.value = savedLang;
      }
    }
    
    if (savedAILang) {
      aiLanguage = savedAILang;
      const aiDropdown = document.getElementById('aiLanguageSelect');
      if (aiDropdown) {
        aiDropdown.value = savedAILang;
      }
    }
    
    console.log('✅ SamarthaaMed Enhanced Features Loaded');
  });

  /* ══════════════════════════════════════════════════════════
     MOBILE MENU FUNCTIONS
     ══════════════════════════════════════════════════════════ */

  function toggleMobileSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    if (sidebar && overlay) {
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('show');
      
      // Prevent body scroll when sidebar is open
      if (sidebar.classList.contains('mobile-open')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
  }

  // Close mobile sidebar when clicking on navigation items
  document.addEventListener('DOMContentLoaded', function() {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
      item.addEventListener('click', function() {
        // On mobile, close sidebar after clicking nav item
        if (window.innerWidth <= 768) {
          setTimeout(() => {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (sidebar && sidebar.classList.contains('mobile-open')) {
              sidebar.classList.remove('mobile-open');
              overlay.classList.remove('show');
              document.body.style.overflow = '';
            }
          }, 300);
        }
      });
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('mobileOverlay');
        if (sidebar) sidebar.classList.remove('mobile-open');
        if (overlay) overlay.classList.remove('show');
        document.body.style.overflow = '';
      }
    });
  });

  /* ══════════════════════════════════════════════════════════
     LOGIN & AUTHENTICATION SYSTEM (Invitation Only)
     ══════════════════════════════════════════════════════════ */

   // Valid invitation codes with organization, role, and doctor name
  const validInvitations = {
    'INV-2026-OWNER-001': { name: 'Rekha Jayaram', org: 'SAMARTHAA MED', role: 'OWNER', email: 'rekhajayaram20@samarthaa.med' },
    'INV-2026-OWNER-002': { name: 'Govardhanswamy GN', org: 'SAMARTHAA MED', role: 'Owner', email: 'govardhangn@samarthaa.med' },
    'INV-2026-FAMILY-001': { name: 'Dr. Prasad N', org: 'Fortis Healthcare', role: 'Internal Medicine', email: 'dr.prasad@samarthaa.med' },
    'INV-2026-FAMILY-002': { name: 'Dr. Punya N Raj', org: 'Apollo Hospitals', role: 'General Medicine', email: 'dr.punya_n_raj@samarthaa.med' },
    'INV-2026-MEDPARTNER-001': { name: 'Dr. Nagendra Prasad', org: 'Max Healthcare', role: 'Emergency Medicine', email: 'dr.nagendra_prasad@samarthaa.med' },
    'INV-2026-DENTALPARTNER-001': { name: 'Dr. Tarulatha', org: 'Max Healthcare', role: 'Dental Surgeon', email: 'dr.tarulatha@samarthaa.med' },
  };

  // Store invitation requests (in production, this would be a database)
  const invitationRequests = JSON.parse(localStorage.getItem('samarthaamed_requests') || '[]');

  // Check if user is already logged in
  function checkExistingSession() {
    const sessionToken = localStorage.getItem('samarthaamed_session');
    const sessionExpiry = localStorage.getItem('samarthaamed_session_expiry');
    
    if (sessionToken && sessionExpiry) {
      const expiryDate = new Date(sessionExpiry);
      const now = new Date();
      
      if (now < expiryDate) {
        // Valid session exists
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        
        // Hide login screen
        if (loginScreen) loginScreen.style.display = 'none';
        
        // Show main app - CSS handles the layout
        if (mainApp) {
          mainApp.style.display = 'grid';
          mainApp.style.opacity = '1';
          
          // Initialize app
          setTimeout(() => {
            initializeApp();
          }, 100);
        }
        
        return true;
      } else {
        // Session expired
        clearSession();
        return false;
      }
    }
    return false;
  }

  // Handle login form submission
  function handleLogin(event) {
    event.preventDefault();
    
    const invitationCode = document.getElementById('invitationCode').value.trim();
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    
    // Show loading state
    const loginBtn = document.getElementById('loginBtn');
    const loginBtnText = document.getElementById('loginBtnText');
    const loginBtnLoader = document.getElementById('loginBtnLoader');
    const loginError = document.getElementById('loginError');
    
    loginBtn.disabled = true;
    loginBtnText.style.display = 'none';
    loginBtnLoader.style.display = 'inline';
    loginError.style.display = 'none';
    
    // Simulate authentication delay
    setTimeout(() => {
      // Validate invitation code
      if (!validInvitations[invitationCode]) {
        showLoginError('Invalid invitation code. Please check and try again.');
        resetLoginButton();
        return;
      }
      
      const invitation = validInvitations[invitationCode];

      // Validate password minimum length
      if (password.length < 6) {
        showLoginError('Password must be at least 6 characters.');
        resetLoginButton();
        return;
      }
      
      // Authentication successful
      authenticateUser(invitationCode, email, invitation, rememberMe);
      
    }, 1500); // Simulate network delay
  }

  function authenticateUser(invitationCode, email, invitation, rememberMe) {
    // Generate session token
    const sessionToken = generateSessionToken();
    
    // Set session expiry
    const expiryDays = rememberMe ? 30 : 1;
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + expiryDays);
    
    // Store session with doctor name
    localStorage.setItem('samarthaamed_session', sessionToken);
    localStorage.setItem('samarthaamed_session_expiry', expiryDate.toISOString());
    localStorage.setItem('samarthaamed_user_name', invitation.name);
    localStorage.setItem('samarthaamed_user_email', email);
    localStorage.setItem('samarthaamed_user_org', invitation.org);
    localStorage.setItem('samarthaamed_user_role', invitation.role);
    localStorage.setItem('samarthaamed_invitation_code', invitationCode);
    
    // Show success and redirect
    showToast('✅', 'Login Successful', `Welcome, ${invitation.name}!`);
    
    setTimeout(() => {
      showMainApp();
    }, 800);
  }

  function generateSessionToken() {
    return 'SAM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  function showLoginError(message) {
    const loginError = document.getElementById('loginError');
    loginError.textContent = '⚠️ ' + message;
    loginError.style.display = 'block';
  }

  function resetLoginButton() {
    const loginBtn = document.getElementById('loginBtn');
    const loginBtnText = document.getElementById('loginBtnText');
    const loginBtnLoader = document.getElementById('loginBtnLoader');
    
    loginBtn.disabled = false;
    loginBtnText.style.display = 'inline';
    loginBtnLoader.style.display = 'none';
  }

  function showMainApp() {
    const loginScreen = document.getElementById('loginScreen');
    const mainApp = document.getElementById('mainApp');
    
    // Fade out login screen
    loginScreen.style.opacity = '0';
    loginScreen.style.transition = 'opacity 0.5s ease';
    
    setTimeout(() => {
      loginScreen.style.display = 'none';
      
      // Show main app - CSS will handle the grid layout
      mainApp.style.display = 'grid';
      
      // Fade in main app
      mainApp.style.opacity = '0';
      setTimeout(() => {
        mainApp.style.transition = 'opacity 0.5s ease';
        mainApp.style.opacity = '1';
        
        // Initialize any required components
        initializeApp();
        // Restore registered patients into table
        setTimeout(restoreRegisteredPatients, 600);
      }, 50);
    }, 500);
  }

  function initializeApp() {
    // Ensure dashboard is visible
    const dashboard = document.getElementById('view-dashboard');
    if (dashboard) {
      dashboard.classList.add('active');
    }
    
    // Add logout button to sidebar
    addLogoutButton();
    
    // Update topbar subtitle with doctor name
    updateTopbarWithDoctorName();
    
    // Show welcome message
    const userName = localStorage.getItem('samarthaamed_user_name') || 'Healthcare Professional';
    const userOrg = localStorage.getItem('samarthaamed_user_org') || 'SamarthaaMed';
    
    setTimeout(() => {
      showToast('👋', `Welcome back, ${userName}!`, `${userOrg}`);
    }, 1000);
  }

  function updateTopbarWithDoctorName() {
    const userName = localStorage.getItem('samarthaamed_user_name');
    const userRole = localStorage.getItem('samarthaamed_user_role');
    const topbarSub = document.getElementById('topbar-sub');
    
    if (topbarSub && userName) {
      const today = new Date().toLocaleDateString('en-US', { 
        weekday: 'long', 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
      });
      topbarSub.textContent = `${userName} • ${userRole || 'Healthcare Professional'} • ${today}`;
    }
  }

  function clearSession() {
    localStorage.removeItem('samarthaamed_session');
    localStorage.removeItem('samarthaamed_session_expiry');
    localStorage.removeItem('samarthaamed_user_name');
    localStorage.removeItem('samarthaamed_user_email');
    localStorage.removeItem('samarthaamed_user_org');
    localStorage.removeItem('samarthaamed_user_role');
    localStorage.removeItem('samarthaamed_invitation_code');
  }

  // Logout function
  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      clearSession();
      location.reload();
    }
  }

  // Request invitation modal functions
  function showRequestInvitation() {
    document.getElementById('requestInvitationModal').style.display = 'flex';
  }

  function closeRequestInvitation() {
    document.getElementById('requestInvitationModal').style.display = 'none';
  }

  function submitInvitationRequest(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = {
      id: 'REQ-' + Date.now(),
      name: form[0].value,
      email: form[1].value,
      institution: form[2].value,
      specialty: form[3].value,
      reason: form[4].value,
      submittedDate: new Date().toISOString(),
      status: 'pending'
    };
    
    // Show processing state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Submitting...';
    
    // Simulate API call and email sending
    setTimeout(() => {
      // Store request
      const requests = JSON.parse(localStorage.getItem('samarthaamed_requests') || '[]');
      requests.push(formData);
      localStorage.setItem('samarthaamed_requests', JSON.stringify(requests));
      
      // Send confirmation email to applicant
      sendConfirmationEmail(formData);
      
      // Send notification to admin
      sendAdminNotificationEmail(formData);
      
      // Show success messages
      showToast('✅', 'Request Submitted Successfully', `Request ID: ${formData.id}`);
      
      setTimeout(() => {
        showToast('📧', 'Confirmation Email Sent', `Check ${formData.email} for details`);
      }, 1500);
      
      setTimeout(() => {
        showToast('ℹ️', 'What\'s Next?', 'Admin will review within 24-48 hours and email invitation code if approved');
      }, 3000);
      
      // Show email preview modal
      setTimeout(() => {
        showEmailPreview(formData);
      }, 4000);
      
      // Reset form
      setTimeout(() => {
        closeRequestInvitation();
        form.reset();
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }, 5000);
      
    }, 1500); // Simulate network delay
  }

  // ── Email via EmailJS (works directly from browser — no backend needed) ──
  // Setup: emailjs.com → free account → Gmail service → two templates
  // Paste your IDs below or into Settings once the app is live
  const EMAILJS_SERVICE_ID  = localStorage.getItem('emailjs_service')  || 'YOUR_SERVICE_ID';
  const EMAILJS_TEMPLATE_APPLICANT = localStorage.getItem('emailjs_tpl_applicant') || 'YOUR_TEMPLATE_APPLICANT';
  const EMAILJS_TEMPLATE_ADMIN    = localStorage.getItem('emailjs_tpl_admin')    || 'YOUR_TEMPLATE_ADMIN';
  const EMAILJS_PUBLIC_KEY  = localStorage.getItem('emailjs_pubkey')   || 'YOUR_PUBLIC_KEY';

  async function sendConfirmationEmail(requestData) {
    try {
      // Check if EmailJS is configured
      if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
        console.warn('EmailJS not configured — skipping email send');
        showToast('📋', 'Request Recorded', 'Email not configured yet — request saved locally');
        return { success: true, skipped: true };
      }

      if (typeof emailjs === 'undefined') {
        throw new Error('EmailJS library not loaded');
      }

      const templateParams = {
        request_id:      requestData.id,
        applicant_name:  requestData.name,
        applicant_email: requestData.email,
        to_email:        requestData.email,
        institution:     requestData.institution,
        specialty:       requestData.specialty,
        submitted_date:  new Date(requestData.submittedDate).toLocaleString('en-IN'),
        reason:          requestData.reason || 'Not provided',
        support_email:   'govardhangn@samarthaa.med',
        reply_to:        'govardhangn@gmail.com'
      };

      // Send confirmation to applicant
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_APPLICANT, templateParams, EMAILJS_PUBLIC_KEY);
      console.log('✅ Confirmation email sent to:', requestData.email);

      // Send admin notification
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ADMIN, templateParams, EMAILJS_PUBLIC_KEY);
      console.log('✅ Admin notification sent to: govardhangn@gmail.com');

      showToast('📧', 'Emails Sent', `Confirmation sent to ${requestData.email}`);
      return { success: true };

    } catch (error) {
      console.error('Email error:', error);
      // Fail gracefully — access request was already recorded
      showToast('⚠️', 'Email Notice', 'Request recorded. Email delivery failed — check EmailJS config.');
      return { success: false, error: error.message };
    }
  }

  async function sendAdminNotificationEmail(requestData) {
    // Admin email is sent inside sendConfirmationEmail above
    return { success: true };
  }

  function generateConfirmationEmailHTML(requestData) {
    return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #10b981, #06b6d4); color: white; padding: 30px 20px; text-align: center; border-radius: 10px 10px 0 0; }
    .logo { font-size: 2rem; margin-bottom: 10px; }
    .content { background: #f9fafb; padding: 30px 20px; border-radius: 0 0 10px 10px; }
    .info-box { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #10b981; }
    .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
    .label { font-weight: 600; color: #6b7280; }
    .value { color: #111827; }
    .next-steps { background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin: 20px 0; }
    .footer { text-align: center; color: #6b7280; font-size: 0.875rem; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
    .button { display: inline-block; background: #10b981; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; margin: 20px 0; font-weight: 600; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">🧬 SamarthaaMed</div>
    <h1 style="margin: 0; font-size: 1.5rem;">Access Request Received</h1>
  </div>
  
  <div class="content">
    <p>Dear <strong>${requestData.name}</strong>,</p>
    
    <p>Thank you for your interest in SamarthaaMed Clinical Intelligence Platform. We have received your access request and it is now under review.</p>
    
    <div class="info-box">
      <h3 style="margin-top: 0; color: #10b981;">📋 Request Details</h3>
      <div class="info-row">
        <span class="label">Request ID:</span>
        <span class="value">${requestData.id}</span>
      </div>
      <div class="info-row">
        <span class="label">Name:</span>
        <span class="value">${requestData.name}</span>
      </div>
      <div class="info-row">
        <span class="label">Email:</span>
        <span class="value">${requestData.email}</span>
      </div>
      <div class="info-row">
        <span class="label">Institution:</span>
        <span class="value">${requestData.institution}</span>
      </div>
      <div class="info-row">
        <span class="label">Specialty:</span>
        <span class="value">${requestData.specialty}</span>
      </div>
      <div class="info-row">
        <span class="label">Submitted:</span>
        <span class="value">${new Date(requestData.submittedDate).toLocaleString()}</span>
      </div>
    </div>
    
    <div class="next-steps">
      <h3 style="margin-top: 0; color: #92400e;">⏱️ What Happens Next?</h3>
      <ol style="margin: 0; padding-left: 20px;">
        <li><strong>Review Process:</strong> Our team will review your request within 24-48 hours</li>
        <li><strong>Verification:</strong> We may contact your institution to verify credentials</li>
        <li><strong>Invitation Code:</strong> If approved, you'll receive an invitation code via email</li>
        <li><strong>Access Granted:</strong> Use the invitation code to create your account</li>
      </ol>
    </div>
    
    <p style="text-align: center;">
      <a href="https://samarthaa.med/track?id=${requestData.id}" class="button">Track Request Status</a>
    </p>
    
    <p style="color: #6b7280; font-size: 0.875rem;">
      <strong>Important:</strong> Please keep this email for your records. You'll need the Request ID if you need to follow up with us.
    </p>
  </div>
  
  <div class="footer">
    <p>
      <strong>SamarthaaMed Clinical Intelligence Platform</strong><br>
      For Healthcare Professionals Only<br>
      📧 govardhangn@gmail.com | 📞 +91-11-2658-8500<br>
      AIIMS Delhi, Fortis, Apollo, Max Healthcare Partner Network
    </p>
    <p style="font-size: 0.75rem; color: #9ca3af;">
      Questions? Reply directly to this email or contact govardhangn@gmail.com<br>
      If you did not request access, please ignore this email.
    </p>
  </div>
</body>
</html>
    `;
  }

  function generateAdminNotificationEmailHTML(requestData) {
    return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: #1f2937; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
    .content { background: #f9fafb; padding: 20px; border-radius: 0 0 8px 8px; }
    .alert { background: #fef2f2; border-left: 4px solid #ef4444; padding: 15px; margin: 15px 0; border-radius: 4px; }
    .info-box { background: white; padding: 15px; border-radius: 6px; margin: 15px 0; }
    .actions { text-align: center; margin: 20px 0; }
    .button { display: inline-block; padding: 10px 20px; margin: 5px; text-decoration: none; border-radius: 6px; font-weight: 600; }
    .approve { background: #10b981; color: white; }
    .reject { background: #ef4444; color: white; }
    .review { background: #6b7280; color: white; }
  </style>
</head>
<body>
  <div class="header">
    <h2 style="margin: 0;">🔔 New Access Request</h2>
  </div>
  
  <div class="content">
    <div class="alert">
      <strong>⚠️ Action Required:</strong> New SamarthaaMed access request pending review
    </div>
    
    <div class="info-box">
      <h3 style="margin-top: 0;">📋 Applicant Information</h3>
      <p><strong>Request ID:</strong> ${requestData.id}</p>
      <p><strong>Name:</strong> ${requestData.name}</p>
      <p><strong>Email:</strong> ${requestData.email}</p>
      <p><strong>Institution:</strong> ${requestData.institution}</p>
      <p><strong>Specialty:</strong> ${requestData.specialty}</p>
      <p><strong>Submitted:</strong> ${new Date(requestData.submittedDate).toLocaleString()}</p>
      
      <h4>Reason for Access:</h4>
      <p style="background: #f3f4f6; padding: 10px; border-radius: 4px; font-style: italic;">
        "${requestData.reason}"
      </p>
    </div>
    
    <div class="actions">
      <a href="https://admin.samarthaa.med/approve/${requestData.id}" class="button approve">✅ Approve</a>
      <a href="https://admin.samarthaa.med/review/${requestData.id}" class="button review">👁️ Review</a>
      <a href="https://admin.samarthaa.med/reject/${requestData.id}" class="button reject">❌ Reject</a>
    </div>
    
    <p style="font-size: 0.875rem; color: #6b7280;">
      Verification checklist:<br>
      ☐ Email domain matches institution<br>
      ☐ Institution is partner network member<br>
      ☐ Specialty credentials verified<br>
      ☐ No duplicate requests from same email
    </p>
  </div>
</body>
</html>
    `;
  }

  function showEmailPreview(requestData) {
    // Create email preview modal
    const modal = document.createElement('div');
    modal.id = 'emailPreviewModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10002;padding:20px;overflow-y:auto;';
    
    modal.innerHTML = `
      <div style="background:var(--panel);border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;position:relative;">
        <div style="position:sticky;top:0;background:var(--panel);padding:20px;border-bottom:1px solid var(--border);z-index:1;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h2 style="margin:0;color:var(--text1);">📧 Confirmation Email Preview</h2>
              <p style="margin:4px 0 0 0;color:var(--text3);font-size:0.85rem;">This email has been sent to: ${requestData.email}</p>
            </div>
            <button onclick="this.closest('#emailPreviewModal').remove()" style="background:none;border:none;color:var(--text2);font-size:1.5rem;cursor:pointer;width:32px;height:32px;">×</button>
          </div>
        </div>
        
        <div style="padding:20px;">
          <iframe srcdoc='${generateConfirmationEmailHTML(requestData).replace(/'/g, "\\'")}' style="width:100%;height:600px;border:1px solid var(--border2);border-radius:8px;"></iframe>
          
          <div style="margin-top:20px;padding:15px;background:var(--teal-dim);border-radius:8px;border-left:4px solid var(--teal);">
            <p style="margin:0;color:var(--teal);font-size:0.9rem;font-weight:600;">
              ✅ Email Sent Successfully
            </p>
            <p style="margin:8px 0 0 0;color:var(--text2);font-size:0.85rem;">
              Confirmation sent to: <strong>${requestData.email}</strong><br>
              Admin notification sent to: <strong>govardhangn@gmail.com</strong>
            </p>
          </div>
          
          <div style="text-align:center;margin-top:20px;">
            <button onclick="this.closest('#emailPreviewModal').remove()" style="padding:12px 24px;background:var(--teal);color:var(--navy);border:none;border-radius:8px;cursor:pointer;font-weight:600;">
              Close Preview
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  // Function to view sent emails (for testing/demo)
  window.viewSentEmails = function() {
    const sentEmails = JSON.parse(localStorage.getItem('samarthaamed_sent_emails') || '[]');
    console.log('📧 Sent Emails:', sentEmails);
    return sentEmails;
  };

  // Function to simulate email approval (for testing)
  window.approveRequest = function(requestId) {
    const requests = JSON.parse(localStorage.getItem('samarthaamed_requests') || '[]');
    const requestIndex = requests.findIndex(r => r.id === requestId);
    
    if (requestIndex !== -1) {
      requests[requestIndex].status = 'approved';
      localStorage.setItem('samarthaamed_requests', JSON.stringify(requests));
      
      // Generate invitation code
      const invitationCode = 'INV-' + Date.now();
      
      // Send approval email
      const approvalEmail = {
        to: requests[requestIndex].email,
        from: 'govardhangn@gmail.com',
        replyTo: 'govardhangn@gmail.com',
        subject: '✅ Access Approved - Your SamarthaaMed Invitation Code',
        body: `Your invitation code is: ${invitationCode}`,
        sentAt: new Date().toISOString(),
        type: 'approval'
      };
      
      const sentEmails = JSON.parse(localStorage.getItem('samarthaamed_sent_emails') || '[]');
      sentEmails.push(approvalEmail);
      localStorage.setItem('samarthaamed_sent_emails', JSON.stringify(sentEmails));
      
      showToast('✅', 'Request Approved', `Invitation code sent to ${requests[requestIndex].email}`);
      console.log('📧 Approval email sent with code:', invitationCode);
      
      return { success: true, invitationCode, email: requests[requestIndex].email };
    }
    
    return { success: false, error: 'Request not found' };
  };

  // Check session on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Always merge saved profiles into patientProfiles on load
    _restoreProfiles();
    if (!checkExistingSession()) {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    } else {
      // Valid session — restore registered patients to table after UI renders
      setTimeout(restoreRegisteredPatients, 500);
    }
  });

  // Add logout button to sidebar (we'll add this to the HTML too)
  window.addLogoutButton = function() {
    const userName = localStorage.getItem('samarthaamed_user_name');
    const userEmail = localStorage.getItem('samarthaamed_user_email');
    const userOrg = localStorage.getItem('samarthaamed_user_org');
    const userRole = localStorage.getItem('samarthaamed_user_role');
    
    if (userName) {
      const sidebar = document.querySelector('.sidebar-nav');
      if (sidebar && !document.getElementById('logoutBtn')) {
        const logoutDiv = document.createElement('div');
        logoutDiv.id = 'logoutBtn';
        logoutDiv.style.cssText = 'margin-top: auto; padding: 16px; border-top: 1px solid var(--border);';
        logoutDiv.innerHTML = `
          <div style="margin-bottom: 12px; padding: 12px; background: var(--navy3); border-radius: 8px;">
            <div style="font-weight: 700; font-size: 0.9rem; color: var(--text1); margin-bottom: 4px;">${userName}</div>
            <div style="font-size: 0.75rem; color: var(--text3); margin-bottom: 2px;">${userRole || ''}</div>
            <div style="font-size: 0.7rem; color: var(--text3);">${userOrg || ''}</div>
          </div>
          <button onclick="logout()" style="width: 100%; padding: 10px; background: var(--red-dim); color: var(--red); border: 1px solid var(--red); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.background='var(--red)';this.style.color='var(--navy)'" onmouseout="this.style.background='var(--red-dim)';this.style.color='var(--red)'">
            🚪 Logout
          </button>
        `;
        sidebar.appendChild(logoutDiv);
      }
    }
  };

  // Call after login
  setTimeout(() => {
    if (localStorage.getItem('samarthaamed_session')) {
      addLogoutButton();
    }
  }, 1000);

  /* ══════════════════════════════════════════════════════════
     RADIOLOGY FUNCTIONS
     ══════════════════════════════════════════════════════════ */

  // ─────────────────────────────────────────────────────────────────
  // RADIOLOGY & IMAGING INTELLIGENCE — Real Claude AI Analysis
  // ─────────────────────────────────────────────────────────────────
  // ── Shared AI Infrastructure ──────────────────────────────────────

  // ═══════════════════════════════════════════════════════════════
  // SECURE KEY VAULT  — sessionStorage + XOR obfuscation
  // Keys are never readable as plain text anywhere in storage
  // ═══════════════════════════════════════════════════════════════
  const _vault = (() => {
    const _getSalt = () => {
      let s = sessionStorage.getItem('__vs');
      if (!s) {
        s = Array.from(crypto.getRandomValues(new Uint8Array(32)))
               .map(b => b.toString(16).padStart(2,'0')).join('');
        sessionStorage.setItem('__vs', s);
      }
      return s;
    };
    const _xor = (str, key) => {
      const k = [...key].map(c => c.charCodeAt(0));
      return [...str].map((c,i) => String.fromCharCode(c.charCodeAt(0) ^ k[i % k.length])).join('');
    };
    const enc = (v, salt) => btoa(unescape(encodeURIComponent(_xor(v, salt))));
    const dec = (v, salt) => { try { return _xor(decodeURIComponent(escape(atob(v))), salt); } catch(e) { return ''; } };
    return {
      set(k, v) { const s=_getSalt(); sessionStorage.setItem('__vk_'+k, v ? enc(v,s) : ''); },
      get(k)    { const s=_getSalt(); const r=sessionStorage.getItem('__vk_'+k); return r ? dec(r,s) : ''; },
      del(k)    { sessionStorage.removeItem('__vk_'+k); },
    };
  })();

  // ─── KEYS LOADED FROM NETLIFY ENVIRONMENT (never hardcoded) ──────────────
  // Fetched once at startup from /api/config (Netlify serverless function).
  // Set keys in: Netlify Dashboard → Site → Environment variables
  //   ANTHROPIC_API_KEY, ELEVENLABS_API_KEY, ELEVENLABS_VOICE_ID
  // ─────────────────────────────────────────────────────────────────────────

  let _anthropicApiKey = '';
  let _configLoaded    = false;
  let _configLoadPromise = null;

  // Shadow _anthropicApiKey on window so console enumeration won't expose it
  try {
    Object.defineProperty(window, '_anthropicApiKey', {
      get() { return _anthropicApiKey; },
      set(v){ _anthropicApiKey = v; },
      enumerable: false, configurable: false
    });
  } catch(e){}

  // Orthanc/PACS state — populated by _loadConfig
  // _orthancBase is kept only to know whether Orthanc is configured.
  // All actual requests go through /api/orthanc-proxy (Netlify function)
  // so there are zero CORS issues regardless of ngrok / IP / port.
  let _orthancBase = '';
  let _orthancAuth = '';       // unused by proxy (auth happens server-side)
  const PROXY = '/api/orthanc-proxy';

  async function _loadConfig() {
    if (_configLoaded) return;
    if (_configLoadPromise) return _configLoadPromise;
    _configLoadPromise = fetch('/api/config')
      .then(r => {
        // If we get HTML back (no serverless function deployed), treat as no config
        const ct = r.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          _configLoaded = true;
          _updatePacsBadge();
          return; // no backend config — user can set key in Settings
        }
        return r.json();
      })
      .then(cfg => {
        if (!cfg) return; // no config available (static deploy)
        const ak = cfg.anthropicKey       || '';
        const ek = cfg.elevenLabsKey      || '';
        const ev = cfg.elevenLabsVoiceId  || '';
        _anthropicApiKey = ak;
        if (ak) _vault.set('smak', ak);
        if (ek) _vault.set('elak', ek);
        if (ev) _vault.set('elvi', ev);
        // Just store whether Orthanc is configured — proxy handles credentials
        _orthancBase = (cfg.orthancUrl || '').replace(/\/$/, '');
        _configLoaded = true;
        _updatePacsBadge();
      })
      .catch(() => {
        // /api/config not available — static deploy mode, silently continue
        _configLoaded = true;
        _updatePacsBadge();
      });
    return _configLoadPromise;
  }

  function _updatePacsBadge() {
    const badge = document.getElementById('pacsBadge');
    const btn   = document.getElementById('pacsConnectBtn');
    if (!badge || !btn) return;
    if (_orthancBase) {
      badge.textContent = '● Connected';
      badge.style.cssText = 'background:var(--teal-dim);color:var(--teal);font-size:0.72rem;padding:3px 10px;border-radius:20px;font-weight:600';
      btn.textContent = '🔗 View PACS';
      btn.onclick = () => showView('radiology');
    } else {
      badge.textContent = '○ Not configured';
      badge.style.cssText = 'background:var(--navy3);color:var(--text3);font-size:0.72rem;padding:3px 10px;border-radius:20px;font-weight:600';
    }
  }

  // ── Orthanc REST helpers — all routed through Netlify proxy ────────────────
  // Browser → /api/orthanc-proxy?path=... → Netlify function → Orthanc
  // This avoids ALL CORS issues, regardless of ngrok/IP/port.

  async function orthancGet(path) {
    await _loadConfig();
    if (!_orthancBase) throw new Error('Orthanc not configured');
    const res = await fetch(`${PROXY}?path=${encodeURIComponent(path)}`);
    if (!res.ok) throw new Error(`Orthanc proxy ${res.status} on ${path}`);
    return res.json();
  }

  async function orthancPost(path, body) {
    await _loadConfig();
    if (!_orthancBase) throw new Error('Orthanc not configured');
    const res = await fetch(`${PROXY}?path=${encodeURIComponent(path)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!res.ok) throw new Error(`Orthanc proxy ${res.status} on POST ${path}`);
    return res.json();
  }

  async function orthancUploadDicom(file) {
    await _loadConfig();
    if (!_orthancBase) throw new Error('Orthanc not configured');
    // Upload goes directly to proxy with raw binary body
    const buf = await file.arrayBuffer();
    const res = await fetch(`${PROXY}?path=${encodeURIComponent('/instances')}&upload=1`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/dicom' },
      body: buf,
    });
    if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
    return res.json();
  }

  // For <img src> — proxy returns the image as base64 via the binary=1 flag
  function orthancFrameUrl(instanceId, frame = 0) {
    return `${PROXY}?path=${encodeURIComponent(`/instances/${instanceId}/frames/${frame}/rendered`)}&binary=1`;
  }

  function orthancThumbUrl(instanceId) {
    return `${PROXY}?path=${encodeURIComponent(`/instances/${instanceId}/preview`)}&binary=1`;
  }

  async function orthancFindStudies(query = {}) {
    return orthancPost('/tools/find', { Level: 'Study', Limit: 50, Query: query });
  }

  async function orthancGetStudy(studyId) {
    return orthancGet(`/studies/${studyId}`);
  }

  async function orthancGetSeries(seriesId) {
    return orthancGet(`/series/${seriesId}`);
  }

  async function orthancGetInstance(instanceId) {
    return orthancGet(`/instances/${instanceId}`);
  }

  async function orthancSystemInfo() {
    return orthancGet('/system');
  }

  // Kick off immediately
  _loadConfig().then(() => {
    // After config loads, update the key input status in Settings
    const status = document.getElementById('anthropicKeyStatus');
    if (status && _anthropicApiKey) {
      status.textContent = '✅ Active';
      status.style.cssText = 'font-size:0.72rem;padding:4px 10px;border-radius:20px;font-weight:600;background:var(--teal-dim);color:var(--teal);white-space:nowrap';
    }
  });

  function getApiKey() {
    if (_anthropicApiKey) return _anthropicApiKey;
    // Try vault (populated after config loads)
    const stored = _vault.get('smak');
    if (stored) { _anthropicApiKey = stored; return _anthropicApiKey; }
    showToast('⚠️', 'AI Not Ready', 'Configuration is still loading — please try again in a moment');
    return null;
  }

  // LOCKED — key is system-configured; UI cannot change it
  function saveAnthropicKeyManual() {
    const input = document.getElementById('anthropicKeyInput');
    const status = document.getElementById('anthropicKeyStatus');
    if (!input) return;
    const key = input.value.trim();
    if (!key || !key.startsWith('sk-ant-')) {
      if (status) {
        status.textContent = '✗ Invalid key';
        status.style.cssText = 'font-size:0.72rem;padding:4px 10px;border-radius:20px;font-weight:600;background:var(--red-dim);color:var(--red);white-space:nowrap';
      }
      return;
    }
    _anthropicApiKey = key;
    _vault.set('smak', key);
    _configLoaded = true;
    input.value = '';
    input.placeholder = 'sk-ant-•••••••• (saved)';
    if (status) {
      status.textContent = '✅ Saved';
      status.style.cssText = 'font-size:0.72rem;padding:4px 10px;border-radius:20px;font-weight:600;background:var(--teal-dim);color:var(--teal);white-space:nowrap';
    }
    showToast('✅', 'API Key Saved', 'Claude AI features are now active');
  }
  function saveAnthropicKey() { saveAnthropicKeyManual(); }
  function toggleAnthropicKeyVisibility() { /* no-op */ }
  function restoreAnthropicKey()      {
    const stored = _vault.get('smak');
    if (stored) _anthropicApiKey = stored;
  }

  function getActivePatientContext() {
    const nameEl = document.querySelector('.consult-patient-name');
    const name   = nameEl?.textContent?.trim() || 'Unknown';
    const profile = Object.values(patientProfiles || {}).find(p => p.name === name);
    if (!profile) return `Active patient: ${name} (no detailed profile loaded)`;
    return `ACTIVE PATIENT CONTEXT:
Name: ${profile.name}
Details: ${profile.meta}
Vitals: HR ${profile.vitals?.hr} | BP ${profile.vitals?.bp} | SpO2 ${profile.vitals?.spo2}
Chief Complaints: ${(profile.complaints||[]).join(', ')}
Medical History: ${(profile.history||[]).join(', ')}
Medications: ${profile.meds||'None recorded'}
Clinical Scores: ${(profile.scores||[]).map(s=>`${s[0]}: ${s[1]}`).join(' | ')}`;
  }

  async function callClaudeAI(messages, systemPrompt) {
    await _loadConfig(); // ensure keys are loaded
    const apiKey = getApiKey();
    if (!apiKey) throw new Error('API keys not yet loaded. Please wait a moment and try again.');
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 4096,
        system: systemPrompt,
        messages: messages
      })
    });
    if (!response.ok) {
      if (response.status === 401) {
        _anthropicApiKey = '';
        // Re-seed from system key on next call rather than destroying it
        showToast('⚠️', 'API Key Error', 'The configured API key was rejected. Contact your administrator.');
        throw new Error('Invalid API key — contact your administrator.');
      }
      const err = await response.json().catch(() => ({}));
      throw new Error(err?.error?.message || `API error ${response.status}`);
    }
    const data = await response.json();
    return data.content[0].text.trim();
  }

  let radiologyReports = [];
  let currentRadiologyReport = null;

  // ── Loading skeleton ──────────────────────────────────────────────
  function showRadiologyLoading() {
    const skelly = `
      <div style="display:flex;flex-direction:column;gap:14px;padding:4px 0">
        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--teal-dim);border-radius:10px;border:1px solid rgba(0,212,180,0.2)">
          <div style="width:36px;height:36px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0">🧬</div>
          <div>
            <div style="font-weight:700;font-size:0.85rem;color:var(--teal)">Analysing with Claude AI…</div>
            <div style="font-size:0.75rem;color:var(--text3);margin-top:2px">Reading report content and cross-referencing clinical context</div>
          </div>
        </div>
        <div style="height:10px;background:var(--navy3);border-radius:6px;width:90%;opacity:0.6"></div>
        <div style="height:10px;background:var(--navy3);border-radius:6px;width:70%;opacity:0.5"></div>
        <div style="height:10px;background:var(--navy3);border-radius:6px;width:85%;opacity:0.4"></div>
        <div style="height:10px;background:var(--navy3);border-radius:6px;width:60%;opacity:0.3"></div>
      </div>`;
    document.getElementById('radiologyAnalysisContent').innerHTML = skelly;
    document.getElementById('radiologyGuidanceContent').innerHTML = skelly;
    document.getElementById('radiologyAnalysisSection').style.display = 'grid';
    document.getElementById('radiologyActionsCard').style.display = 'block';
  }

  // ── Render analysis panel from AI JSON ───────────────────────────
  function renderRadiologyAnalysis(data) {
    const sevMap = {
      critical: { bg:'var(--red-dim)',  border:'var(--red)',  color:'var(--red)',  icon:'🔴' },
      high:     { bg:'var(--red-dim)',  border:'var(--red)',  color:'var(--red)',  icon:'⚠️' },
      moderate: { bg:'var(--gold-dim)', border:'var(--gold)', color:'var(--gold)', icon:'🟡' },
      normal:   { bg:'var(--panel2)',   border:'var(--teal)', color:'var(--teal)', icon:'✅' },
      low:      { bg:'var(--panel2)',   border:'var(--teal)', color:'var(--teal)', icon:'✅' },
    };
    const findings = (data.findings || []).map((f, i) => {
      const s = sevMap[(f.severity||'normal').toLowerCase()] || sevMap.moderate;
      return `<div style="padding:12px 14px;background:${s.bg};border-left:3px solid ${s.border};border-radius:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px">
          <span>${s.icon}</span>
          <span style="font-weight:700;font-size:0.85rem;color:${s.color}">${i+1}. ${f.title}</span>
        </div>
        <div style="font-size:0.78rem;color:var(--text2);line-height:1.65;padding-left:22px">${f.detail}</div>
      </div>`;
    }).join('');
    const conf = Math.min(99, Math.max(50, parseInt(data.confidence) || 88));
    return `
      <div style="margin-bottom:18px">
        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--teal);font-weight:700;margin-bottom:5px">Imaging Modality</div>
        <div style="font-size:0.9rem;font-weight:600;color:var(--text1)">${data.modality||'Radiology Report'}</div>
        ${data.quality ? `<div style="font-size:0.73rem;color:var(--text3);margin-top:3px">Quality: ${data.quality}</div>` : ''}
      </div>
      <div style="margin-bottom:18px">
        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--teal);font-weight:700;margin-bottom:10px">Key Findings</div>
        <div style="display:flex;flex-direction:column;gap:10px">${findings}</div>
      </div>
      ${data.impression ? `<div style="margin-bottom:18px">
        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--teal);font-weight:700;margin-bottom:6px">Radiological Impression</div>
        <div style="font-size:0.83rem;color:var(--text1);line-height:1.7;padding:12px;background:var(--navy3);border-radius:8px">${data.impression}</div>
      </div>` : ''}
      <div style="padding:12px;background:var(--panel2);border-radius:8px">
        <div style="font-weight:600;font-size:0.82rem;color:var(--text1);margin-bottom:6px">AI Confidence: ${conf}%</div>
        <div style="height:6px;background:var(--navy3);border-radius:3px;overflow:hidden">
          <div style="width:${conf}%;height:100%;background:linear-gradient(90deg,var(--teal),var(--cyan));border-radius:3px;transition:width 0.8s ease"></div>
        </div>
        <div style="font-size:0.68rem;color:var(--text3);margin-top:6px">Verify AI findings against original imaging and clinical presentation.</div>
      </div>`;
  }

  // ── Render guidance panel from AI JSON ────────────────────────────
  function renderRadiologyGuidance(data) {
    const urgencyMap = {
      critical: { bg:'var(--red-dim)',  color:'var(--red)',  label:'CRITICAL — IMMEDIATE ACTION REQUIRED' },
      urgent:   { bg:'var(--red-dim)',  color:'var(--red)',  label:'URGENT' },
      high:     { bg:'var(--gold-dim)', color:'var(--gold)', label:'HIGH PRIORITY' },
      moderate: { bg:'var(--gold-dim)', color:'var(--gold)', label:'MODERATE' },
      routine:  { bg:'var(--panel2)',   color:'var(--teal)', label:'ROUTINE' },
    };
    const u = urgencyMap[(data.urgency||'routine').toLowerCase()] || urgencyMap.routine;
    const numColors = ['var(--red)','var(--gold)','var(--teal)','var(--purple)','var(--green)'];
    const actions = (data.actions||[]).map((a,i) => `
      <div style="display:flex;align-items:flex-start;gap:12px">
        <div style="width:24px;height:24px;border-radius:50%;background:${numColors[i%numColors.length]};color:white;font-weight:700;font-size:0.72rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px">${i+1}</div>
        <div>
          <div style="font-weight:600;font-size:0.85rem;color:var(--text1)">${a.step}</div>
          <div style="font-size:0.78rem;color:var(--text2);margin-top:3px;line-height:1.6">${a.detail}</div>
        </div>
      </div>`).join('');
    return `
      <div style="margin-bottom:18px">
        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--teal);font-weight:700;margin-bottom:8px">🎯 Clinical Impression</div>
        <div style="padding:12px;background:${u.bg};border-radius:8px">
          <div style="font-weight:700;font-size:0.82rem;color:${u.color};margin-bottom:4px">${u.label}</div>
          <div style="font-size:0.83rem;color:var(--text1);line-height:1.65">${data.impression||''}</div>
        </div>
      </div>
      ${actions ? `<div style="margin-bottom:18px">
        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--teal);font-weight:700;margin-bottom:12px">🩺 Recommended Actions</div>
        <div style="display:flex;flex-direction:column;gap:12px">${actions}</div>
      </div>` : ''}
      ${data.followUp ? `<div style="margin-bottom:18px">
        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--teal);font-weight:700;margin-bottom:8px">📅 Follow-up Plan</div>
        <div style="padding:12px;background:var(--panel2);border-radius:8px;font-size:0.82rem;color:var(--text1);line-height:1.7">${data.followUp.replace(/\n/g,'<br>')}</div>
      </div>` : ''}
      ${data.redFlags ? `<div style="padding:12px;background:var(--gold-dim);border-left:3px solid var(--gold);border-radius:8px;margin-bottom:14px">
        <div style="font-weight:700;font-size:0.82rem;color:var(--gold);margin-bottom:4px">⚠️ Red Flags — Escalate immediately if:</div>
        <div style="font-size:0.78rem;color:var(--text2);line-height:1.7">${data.redFlags.replace(/\n/g,'<br>')}</div>
      </div>` : ''}
      ${data.guidelines ? `<div style="font-size:0.7rem;color:var(--text3);font-style:italic">📚 Guidelines: ${data.guidelines}</div>` : ''}`;
  }

  // ── Core AI call ───────────────────────────────────────────────────
  async function runRadiologyAI(report) {
    const patientCtx = getActivePatientContext();
    const isImage = report.type && report.type.startsWith('image/');

    const systemPrompt = `You are SamarthaaMed Radiology AI, an expert radiologist assistant embedded in a clinical platform.
${patientCtx}

Respond ONLY with a valid JSON object with exactly two keys: "analysis" and "guidance".

"analysis" object schema:
{
  "modality": "imaging type and view e.g. Chest X-Ray PA View",
  "quality": "technical quality comment",
  "findings": [ { "severity": "critical|high|moderate|normal", "title": "finding name", "detail": "clinical description with measurements" } ],
  "impression": "overall radiological impression, 2-3 sentences",
  "confidence": 88
}

"guidance" object schema:
{
  "impression": "clinical diagnosis or differential",
  "urgency": "critical|urgent|high|moderate|routine",
  "actions": [ { "step": "action title", "detail": "specific instruction with drug names/doses/timing" } ],
  "followUp": "follow-up plan with timeline",
  "redFlags": "warning signs requiring immediate escalation",
  "guidelines": "guideline references used"
}

Rules:
- List 3-6 findings including BOTH abnormal AND normal/reassuring findings
- Actions must reference current ICMR, ESC, AHA or WHO guidelines by name
- Do NOT output any text outside the JSON object
- Do NOT use markdown code fences`;

    let msgContent;
    if (report.isSample) {
      msgContent = `Analyse this radiology report and return the JSON:\n\n${report.reportText}`;
    } else if (isImage) {
      msgContent = [
        { type: 'image', source: { type: 'base64', media_type: report.type, data: report.data.split(',')[1] } },
        { type: 'text', text: `Analyse this medical image (${report.filename}) and return the JSON object only.` }
      ];
    } else {
      msgContent = `Analyse this radiology report file: "${report.filename}" (type: ${report.type||'PDF'}).\n\nUse the patient context and filename to infer the modality and generate a clinically accurate structured analysis. Return the JSON only.`;
    }

    const messages = [{ role: 'user', content: msgContent }];
    const raw = await callClaudeAI(messages, systemPrompt);
    const clean = raw.replace(/^```(?:json)?\s*/i,'').replace(/\s*```$/,'').trim();
    return JSON.parse(clean);
  }

  // ── Main orchestrator ──────────────────────────────────────────────
  async function analyzeRadiologyReport(report) {
    currentRadiologyReport = report;
    showRadiologyLoading();
    showToast('🔍', 'Analysing', `${report.filename} — Claude AI processing…`);
    const t0 = Date.now();
    try {
      const result = await runRadiologyAI(report);
      const elapsed = ((Date.now()-t0)/1000).toFixed(1);
      const stamp = `<div style="font-size:0.68rem;color:var(--text3);margin-bottom:12px;display:flex;gap:8px;align-items:center">
        <span style="background:var(--teal-dim);color:var(--teal);padding:2px 10px;border-radius:20px;font-weight:600;font-size:0.65rem">✓ Claude AI</span>
        <span>${elapsed}s · ${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}</span></div>`;
      const analysisHtml = stamp + renderRadiologyAnalysis(result.analysis);
      const guidanceHtml = stamp.replace('Claude AI','ICMR/ESC Referenced') + renderRadiologyGuidance(result.guidance);
      document.getElementById('radiologyAnalysisContent').innerHTML = analysisHtml;
      document.getElementById('radiologyGuidanceContent').innerHTML  = guidanceHtml;
      const idx = radiologyReports.findIndex(r => r.id === report.id);
      if (idx !== -1) {
        radiologyReports[idx].analyzed    = true;
        radiologyReports[idx].analysisHtml = analysisHtml;
        radiologyReports[idx].guidanceHtml = guidanceHtml;
        radiologyReports[idx].parsedResult = result;
        displayRadiologyFiles();
      }
      showToast('✅', 'Analysis Complete', `${(result.analysis.findings||[]).length} findings · ${elapsed}s`);
    } catch(err) {
      console.error('Radiology AI error:', err);
      const errHtml = `<div style="padding:20px;background:var(--red-dim);border:1px solid var(--red);border-radius:10px;text-align:center">
        <div style="font-size:1.8rem;margin-bottom:8px">⚠️</div>
        <div style="font-weight:700;color:var(--red);font-size:0.9rem">Analysis Failed</div>
        <div style="font-size:0.8rem;color:var(--text2);margin-top:6px">${err.message}</div>
        <div style="font-size:0.72rem;color:var(--text3);margin-top:8px">Check your Anthropic API key in Settings, then try again.</div>
      </div>`;
      document.getElementById('radiologyAnalysisContent').innerHTML = errHtml;
      document.getElementById('radiologyGuidanceContent').innerHTML  = errHtml;
      showToast('❌', 'Analysis Failed', err.message);
    }
  }

  function analyzeRadiologyReportByIndex(index) {
    const r = radiologyReports[index];
    if (r) analyzeRadiologyReport(r);
  }

  // ── File upload handler ────────────────────────────────────────────
  function handleRadiologyUpload(event) {
    const files = Array.from(event.target.files);
    if (!files.length) return;
    event.target.value = '';
    showToast('📤', `Uploading ${files.length} file(s)`, 'Reading content…');
    let loaded = 0;
    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        radiologyReports.push({
          id: Date.now() + index,
          filename: file.name,
          type: file.type || 'application/pdf',
          size: file.size,
          uploadDate: new Date(),
          data: e.target.result,
          analyzed: false,
          isSample: false
        });
        loaded++;
        if (loaded === files.length) {
          showToast('✅', 'Upload Complete', `${files.length} report(s) ready`);
          displayRadiologyFiles();
          analyzeRadiologyReport(radiologyReports[radiologyReports.length - 1]);
        }
      };
      reader.readAsDataURL(file);
    });
  }

  // ── File list display ──────────────────────────────────────────────
  function displayRadiologyFiles() {
    const container = document.getElementById('radiologyFilesContainer');
    const filesList  = document.getElementById('radiologyFilesList');
    if (!radiologyReports.length) { filesList.style.display = 'none'; return; }
    filesList.style.display = 'block';
    container.innerHTML = radiologyReports.map((r, i) => `
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--panel);border:1px solid var(--border2);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.2s"
           onclick="selectRadiologyReport(${i})"
           onmouseover="this.style.borderColor='var(--teal)'"
           onmouseout="this.style.borderColor='var(--border2)'">
        <div style="font-size:1.8rem">${getFileIcon(r.type)}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:0.84rem;color:var(--text1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.filename}</div>
          <div style="font-size:0.72rem;color:var(--text3);margin-top:2px">${formatFileSize(r.size)} · ${formatDate(r.uploadDate)}</div>
        </div>
        ${r.analyzed
          ? '<span style="background:var(--teal-dim);color:var(--teal);padding:4px 10px;border-radius:6px;font-size:0.7rem;font-weight:600;flex-shrink:0">✓ Analysed</span>'
          : `<button class="btn btn-primary btn-sm" style="flex-shrink:0" onclick="event.stopPropagation();analyzeRadiologyReportByIndex(${i})">Analyse</button>`}
      </div>`).join('');
  }

  function selectRadiologyReport(index) {
    const r = radiologyReports[index];
    if (!r) return;
    currentRadiologyReport = r;
    document.getElementById('radiologyAnalysisSection').style.display = 'grid';
    document.getElementById('radiologyActionsCard').style.display     = 'block';
    if (r.analyzed && r.analysisHtml) {
      document.getElementById('radiologyAnalysisContent').innerHTML = r.analysisHtml;
      document.getElementById('radiologyGuidanceContent').innerHTML  = r.guidanceHtml;
    } else {
      analyzeRadiologyReport(r);
    }
  }

  function getFileIcon(type) {
    if (!type) return '📋';
    if (type.includes('pdf'))   return '📄';
    if (type.includes('image')) return '🖼️';
    if (type.includes('dicom')) return '🩻';
    return '📋';
  }
  function formatFileSize(bytes) {
    if (bytes < 1024)       return bytes + ' B';
    if (bytes < 1048576)    return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1048576).toFixed(1) + ' MB';
  }
  function formatDate(date) {
    const diff = Date.now() - date;
    if (diff < 60000)    return 'Just now';
    if (diff < 3600000)  return Math.floor(diff/60000) + ' min ago';
    if (diff < 86400000) return Math.floor(diff/3600000) + ' hours ago';
    return new Date(date).toLocaleDateString('en-IN');
  }

  // ── Sample reports with real clinical text ─────────────────────────
  function loadSampleRadiology(type) {
    const samples = {
      'chest-xray': {
        filename: 'Chest_XRay_PA_Sample.pdf',
        reportText: `RADIOLOGY REPORT — Chest X-Ray PA View
Clinical indication: Chest pain, breathlessness, hypertension, known DM Type 2

FINDINGS:
Heart: Cardiomegaly. Cardiothoracic ratio 0.58 (normal <0.50). Globular cardiac silhouette.
Lungs: Bilateral perihilar haziness. Upper lobe vascular diversion. Kerley B lines at costophrenic angles. No focal consolidation. No pneumothorax.
Pleura: Mild blunting of bilateral costophrenic angles — possible early pleural effusion.
Mediastinum: Normal width. Trachea central.
Bones: Mild thoracic spondylosis. No fracture.

IMPRESSION: Cardiomegaly with pulmonary venous congestion / early pulmonary oedema. Echocardiography recommended.`
      },
      'ct-brain': {
        filename: 'CT_Brain_NonContrast_Sample.pdf',
        reportText: `RADIOLOGY REPORT — CT Brain Non-Contrast (NCCT Head)
Clinical indication: Sudden right hemiplegia and aphasia, onset 90 minutes ago

FINDINGS:
Parenchyma: Hypodense area in left MCA territory (frontal-parietal). Loss of grey-white differentiation. Insular ribbon sign positive. Hyperdense MCA sign in left M1 segment.
ASPECTS score: 6/10 (M1, M2, M3 and insular territories involved).
Ventricles: Mild left lateral ventricle compression. No midline shift.
Haemorrhage: No intracranial haemorrhage. No subarachnoid blood.
Posterior fossa: Normal.

IMPRESSION: Acute large vessel ischaemic stroke — left MCA territory. Hyperdense MCA sign suggests proximal occlusion. ASPECTS 6/10. Evaluate for thrombolysis/thrombectomy within time window. Urgent neurology review.`
      },
      'mri-spine': {
        filename: 'MRI_Lumbar_Spine_T2_Sample.pdf',
        reportText: `RADIOLOGY REPORT — MRI Lumbar Spine T1/T2/STIR
Clinical indication: Low back pain radiating to left leg, foot weakness, 3 months duration

FINDINGS:
L1-L3: Normal disc height and signal. No nerve root compromise.
L4-L5: Large posterior-central disc extrusion with cranial migration. >50% thecal sac compromise. Left L5 nerve root compression. Bilateral foraminal narrowing. Facet joint hypertrophy.
L5-S1: Diffuse disc bulge with annular fissure. Mild thecal sac indentation. Mild bilateral foraminal narrowing.
Canal: Moderate-severe stenosis at L4-L5.
Conus: Normal at L1. No intrinsic cord signal change.
Marrow: No Modic changes. No fracture or lytic lesion.

IMPRESSION: Large L4-L5 disc extrusion with severe canal stenosis and left L5 nerve root compression. L5-S1 disc bulge with mild stenosis. Surgical evaluation recommended given motor deficit.`
      },
      'ultrasound-abdomen': {
        filename: 'USG_Abdomen_Complete_Sample.pdf',
        reportText: `RADIOLOGY REPORT — Ultrasound Abdomen & Pelvis Complete
Clinical indication: RUQ pain, elevated liver enzymes, DM Type 2, obesity

FINDINGS:
Liver: Hepatomegaly — span 16.4 cm (normal 12-15 cm). Diffusely increased echogenicity vs renal cortex. Grade II hepatic steatosis (NAFLD). Coarse echotexture. No focal lesion. Portal vein 12 mm.
Gallbladder: Two calculi (6 mm, 9 mm) with posterior acoustic shadowing. No wall thickening (3 mm). No pericholecystic fluid. Murphy's sign equivocal.
CBD: 5 mm — upper normal limit.
Pancreas: Partially visualised. No calcification or ductal dilatation.
Spleen: 11.2 cm — normal.
Kidneys: Right 10.4 cm, left 10.6 cm. Normal echogenicity. No hydronephrosis or calculi.
Ascites: None.

IMPRESSION: Grade II NAFLD with hepatomegaly. Cholelithiasis without acute cholecystitis. Clinical correlation advised.`
      }
    };
    const s = samples[type];
    if (!s) return;
    const report = {
      id: Date.now(),
      filename: s.filename,
      type: 'application/pdf',
      size: s.reportText.length,
      uploadDate: new Date(),
      data: '',
      reportText: s.reportText,
      analyzed: false,
      isSample: true
    };
    radiologyReports.push(report);
    showToast('📋', 'Sample Loaded', s.filename);
    displayRadiologyFiles();
    analyzeRadiologyReport(report);
  }

  // ── Action buttons ─────────────────────────────────────────────────
  async function regenerateGuidance() {
    if (!currentRadiologyReport) { showToast('⚠️','No Report','Analyse a report first'); return; }
    showToast('🔄','Regenerating','Asking Claude for fresh recommendations…');
    document.getElementById('radiologyGuidanceContent').innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;padding:14px;background:var(--teal-dim);border-radius:10px">
        <span style="font-size:1.1rem">🔄</span>
        <span style="font-size:0.85rem;color:var(--teal);font-weight:600">Generating new guidance…</span>
      </div>`;
    try {
      const result = await runRadiologyAI(currentRadiologyReport);
      const stamp = `<div style="font-size:0.68rem;color:var(--text3);margin-bottom:12px;display:flex;gap:8px;align-items:center">
        <span style="background:var(--teal-dim);color:var(--teal);padding:2px 10px;border-radius:20px;font-weight:600;font-size:0.65rem">✓ Regenerated</span>
        <span>${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}</span></div>`;
      const guidanceHtml = stamp + renderRadiologyGuidance(result.guidance);
      document.getElementById('radiologyGuidanceContent').innerHTML = guidanceHtml;
      const idx = radiologyReports.findIndex(r => r.id === currentRadiologyReport.id);
      if (idx !== -1) radiologyReports[idx].guidanceHtml = guidanceHtml;
      showToast('✅','Guidance Updated','New AI recommendations ready');
    } catch(err) { showToast('❌','Failed',err.message); }
  }

  function addRadiologyToConsult() {
    if (!currentRadiologyReport) { showToast('⚠️','No Report','Analyse a report first'); return; }
    const analysis = document.getElementById('radiologyAnalysisContent').innerText;
    const guidance = document.getElementById('radiologyGuidanceContent').innerText;
    const summary  = `📋 Radiology: ${currentRadiologyReport.filename}\n\n${analysis.slice(0,500)}…\n\nGuidance: ${guidance.slice(0,400)}…`;
    const msgs = document.getElementById('chatMessages');
    if (msgs) {
      const div = document.createElement('div');
      div.className = 'msg ai';
      div.innerHTML = `<div class="msg-avatar">🩻</div><div><div class="msg-bubble" style="border-left:3px solid var(--teal);font-size:0.8rem;white-space:pre-line;color:var(--text2)">${summary}</div><div class="msg-time">Radiology · Just now</div></div>`;
      const typing = document.getElementById('typingIndicator');
      if (typing) msgs.insertBefore(div, typing); else msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }
    navigator.clipboard?.writeText(summary);
    showView('consult');
    showToast('📋','Added to Consultation','Radiology findings attached to patient chat');
  }

  function copyRadiologyAnalysis() {
    navigator.clipboard?.writeText(document.getElementById('radiologyAnalysisContent').innerText);
    showToast('📋','Copied','Analysis copied to clipboard');
  }

  async function generateRadiologySOAP() {
    if (!currentRadiologyReport) { showToast('⚠️','No Report','Analyse a report first'); return; }
    showToast('📝','Generating SOAP','Building note from radiology findings…');
    const analysis = document.getElementById('radiologyAnalysisContent').innerText;
    const guidance = document.getElementById('radiologyGuidanceContent').innerText;
    try {
      const soap = await callClaudeAI(
        [{ role:'user', content:`Write a clinical SOAP note incorporating these radiology findings.\n\nAnalysis:\n${analysis}\n\nGuidance:\n${guidance}\n\nFormat: four sections labelled SUBJECTIVE, OBJECTIVE, ASSESSMENT, PLAN. Plain text only.` }],
        `You are a clinical documentation assistant. ${getActivePatientContext()}`
      );
      const sec = { S:'', O:'', A:'', P:'' };
      let cur = null;
      soap.split('\n').forEach(line => {
        if (/^SUBJECTIVE/i.test(line)) cur='S';
        else if (/^OBJECTIVE/i.test(line)) cur='O';
        else if (/^ASSESSMENT/i.test(line)) cur='A';
        else if (/^PLAN/i.test(line)) cur='P';
        else if (cur) sec[cur] += line + '\n';
      });
      ['S','O','A','P'].forEach(k => { const el=document.getElementById('soap'+k); if(el&&sec[k]) el.textContent=sec[k].trim(); });
      document.getElementById('soapModal')?.classList.add('open');
      showToast('✅','SOAP Ready','Review and edit in the modal');
    } catch(err) { showToast('❌','SOAP Failed',err.message); }
  }

  function printRadiologyReport() {
    if (!currentRadiologyReport) { showToast('⚠️','No Report','Analyse a report first'); return; }
    const analysis = document.getElementById('radiologyAnalysisContent').innerHTML;
    const guidance = document.getElementById('radiologyGuidanceContent').innerHTML;
    const win = window.open('','_blank');
    win.document.write(`<!DOCTYPE html><html><head><title>Radiology Report</title>
    <style>body{font-family:Arial,sans-serif;padding:24px;max-width:900px;margin:0 auto;color:#1f2937}
    .hdr{text-align:center;border-bottom:3px solid #0d9488;padding-bottom:18px;margin-bottom:28px}
    .logo{font-size:1.4rem;font-weight:800;color:#0d9488}.grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    h2{color:#0d9488;font-size:0.85rem;text-transform:uppercase;letter-spacing:1px;margin:24px 0 10px}
    @media print{.noprint{display:none}}</style></head><body>
    <div class="hdr"><div class="logo">🧬 SamarthaaMed</div>
    <div style="color:#666;margin-top:4px">Radiology Intelligence Report</div>
    <div style="font-size:0.78rem;color:#999;margin-top:4px">${currentRadiologyReport.filename} · ${new Date().toLocaleDateString('en-IN')}</div></div>
    <div class="grid"><div><h2>Report Analysis</h2>${analysis}</div><div><h2>Clinical Guidance</h2>${guidance}</div></div>
    <div class="noprint" style="text-align:center;margin-top:28px;display:flex;gap:12px;justify-content:center">
    <button onclick="window.print()" style="padding:10px 24px;background:#0d9488;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">🖨 Print</button>
    <button onclick="window.close()" style="padding:10px 24px;background:#666;color:white;border:none;border-radius:8px;cursor:pointer">Close</button>
    </div></body></html>`);
    win.document.close();
    showToast('🖨','Print Ready','Report opened in new window');
  }

  function compareWithPrevious() {
    const analysed = radiologyReports.filter(r => r.analyzed);
    if (analysed.length < 2) { showToast('📊','Compare','Analyse at least 2 reports to compare'); return; }
    showToast('📊','Compare','Select a second report from the list to compare');
  }

  function orderFollowUp() {
    if (!currentRadiologyReport) { showToast('⚠️','No Report','Analyse a report first'); return; }
    showToast('📅','Follow-up Noted','Recommendation noted from guidance panel');
  }


  /* ══════════════════════════════════════════════════════════
     PRINT RX & WHATSAPP FUNCTIONS (AI Consultation)
     ══════════════════════════════════════════════════════════ */

  function printPrescriptionFromConsult() {
    // Get current patient
    const activeChip = document.querySelector('.patient-chip.active');
    if (!activeChip) {
      showToast('⚠️', 'No Patient Selected', 'Please select a patient first');
      return;
    }

    const onclick = activeChip.getAttribute('onclick');
    const match = onclick.match(/'(\w+)'/);
    const patientKey = match ? match[1] : 'PK';
    const patient = patientProfiles[patientKey];

    if (!patient) {
      showToast('⚠️', 'Patient Not Found', 'Unable to load patient data');
      return;
    }

    showToast('🖨', 'Generating Prescription', 'Creating printable prescription...');

    // Get medications from the Rx tab
    const rxTabContent = document.getElementById('tab-rx');
    const medications = rxTabContent ? extractMedicationsFromTab(rxTabContent) : [];

    // Create prescription print window
    setTimeout(() => {
      const printWindow = window.open('', '_blank');
      const prescriptionHTML = generatePrescriptionHTML(patient, medications);
      printWindow.document.write(prescriptionHTML);
      printWindow.document.close();
      showToast('✅', 'Prescription Ready', 'Print window opened');
    }, 500);
  }

  function extractMedicationsFromTab(tabContent) {
    const medications = [];
    const rxItems = tabContent.querySelectorAll('.rx-item');
    
    rxItems.forEach(item => {
      const drugName = item.querySelector('.rx-drug')?.textContent || '';
      const dose = item.querySelector('.rx-dose')?.textContent || '';
      if (drugName) {
        medications.push({ drug: drugName, dose: dose });
      }
    });

    // If no items in UI, use patient's current medications
    if (medications.length === 0) {
      return null; // Will use patient.meds instead
    }

    return medications;
  }

  function generatePrescriptionHTML(patient, medications) {
    const today = new Date().toLocaleDateString('en-IN', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric' 
    });

    // Get logged-in doctor details
    const doctorName = localStorage.getItem('samarthaamed_user_name') || 'Dr. Physician';
    const doctorOrg = localStorage.getItem('samarthaamed_user_org') || 'Healthcare Institution';
    const doctorEmail = localStorage.getItem('samarthaamed_user_email') || 'doctor@hospital.com';

    // Use extracted medications or fall back to patient's current meds
    let medicationsList = '';
    if (medications && medications.length > 0) {
      medicationsList = medications.map((med, index) => `
        <tr>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;text-align:center">${index + 1}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;font-weight:600">${med.drug}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb">${med.dose}</td>
        </tr>
      `).join('');
    } else {
      // Parse patient.meds string
      const medsArray = patient.meds.split('\n').filter(m => m.trim());
      medicationsList = medsArray.map((med, index) => `
        <tr>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;text-align:center">${index + 1}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;font-weight:600;font-size:0.95rem" colspan="2">${med}</td>
        </tr>
      `).join('');
    }

    return `
<!DOCTYPE html>
<html>
<head>
  <title>Prescription - ${patient.name}</title>
  <style>
    @page { margin: 1.5cm; }
    body { 
      font-family: 'Arial', sans-serif; 
      line-height: 1.6; 
      color: #000;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      border-bottom: 3px solid #10b981;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #10b981;
      margin-bottom: 5px;
    }
    .doctor-info {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    .patient-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #10b981;
    }
    .patient-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .label {
      font-weight: 600;
      color: #333;
    }
    .value {
      color: #666;
    }
    .rx-symbol {
      font-size: 36px;
      color: #10b981;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th {
      background: #10b981;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
    }
    .instructions {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
      margin-bottom: 25px;
    }
    .footer {
      margin-top: 60px;
      padding-top: 20px;
      border-top: 2px solid #ddd;
    }
    .signature-line {
      margin-top: 50px;
      border-top: 2px solid #000;
      width: 250px;
      float: right;
      text-align: center;
      padding-top: 10px;
    }
    @media print {
      .no-print { display: none; }
      body { padding: 0; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">🧬 SamarthaaMed</div>
    <div style="font-size: 16px; color: #333;">Clinical Intelligence Platform</div>
    <div class="doctor-info">
      <strong>${doctorName}</strong><br>
      ${doctorOrg}<br>
      📧 ${doctorEmail}
    </div>
  </div>

  <div style="text-align:right;color:#666;font-size:14px;margin-bottom:20px">
    Date: ${today}
  </div>

  <div class="patient-section">
    <div class="patient-row">
      <span class="label">Patient Name:</span>
      <span class="value">${patient.name}</span>
    </div>
    <div class="patient-row">
      <span class="label">Age/Gender:</span>
      <span class="value">${patient.meta.split('·')[0]}</span>
    </div>
    <div class="patient-row">
      <span class="label">Patient ID:</span>
      <span class="value">${patient.meta.match(/ID: ([\w-]+)/)?.[1] || 'N/A'}</span>
    </div>
    <div class="patient-row">
      <span class="label">Department:</span>
      <span class="value">${patient.meta.split('·')[2] || 'General Medicine'}</span>
    </div>
  </div>

  <div class="rx-symbol">℞</div>

  <table>
    <thead>
      <tr>
        <th style="width:50px">#</th>
        <th>Medication</th>
        <th style="width:250px">Dosage & Instructions</th>
      </tr>
    </thead>
    <tbody>
      ${medicationsList}
    </tbody>
  </table>

  <div class="instructions">
    <strong style="color:#856404">📋 General Instructions:</strong><br>
    • Take medications as prescribed at the specified times<br>
    • Do not skip doses or stop medications without consulting your doctor<br>
    • Store medications in a cool, dry place away from direct sunlight<br>
    • Follow up as scheduled for review and monitoring<br>
    • Contact immediately if you experience any adverse reactions
  </div>

  <div style="padding:15px;background:#e8f5e9;border-radius:8px;margin-bottom:25px">
    <strong style="color:#1b5e20">📅 Follow-up:</strong> Review in 2 weeks or earlier if symptoms worsen<br>
    <strong style="color:#1b5e20">🔬 Investigations:</strong> As discussed during consultation
  </div>

  <div class="footer">
    <div style="font-size:12px;color:#666;margin-bottom:20px">
      This is a computer-generated prescription and does not require a physical signature.<br>
      Verified electronically by SamarthaaMed AI-Assisted Clinical System.
    </div>
    <div class="signature-line">
      <strong>${doctorName}</strong><br>
      Consulting Physician
    </div>
  </div>

  <div class="no-print" style="clear:both;margin-top:80px;text-align:center">
    <button onclick="window.print()" style="padding:12px 30px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;margin-right:10px">🖨 Print</button>
    <button onclick="window.close()" style="padding:12px 30px;background:#666;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600">Close</button>
  </div>
</body>
</html>
    `;
  }

  function shareViaWhatsApp() {
    // Get current patient
    const activeChip = document.querySelector('.patient-chip.active');
    if (!activeChip) {
      showToast('⚠️', 'No Patient Selected', 'Please select a patient first');
      return;
    }

    const onclick = activeChip.getAttribute('onclick');
    const match = onclick.match(/'(\w+)','([^']+)'/);
    if (!match) {
      showToast('⚠️', 'Error', 'Unable to get patient information');
      return;
    }

    const patientKey = match[1];
    const patientName = match[2];
    const patient = patientProfiles[patientKey];

    if (!patient) {
      showToast('⚠️', 'Patient Not Found', 'Unable to load patient data');
      return;
    }

    // Create prescription summary for WhatsApp
    const today = new Date().toLocaleDateString('en-IN', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric' 
    });

    // Get logged-in doctor details
    const doctorName = localStorage.getItem('samarthaamed_user_name') || 'Dr. Physician';
    const doctorOrg = localStorage.getItem('samarthaamed_user_org') || 'Healthcare Institution';

    // Get medications
    const medsArray = patient.meds.split('\n').filter(m => m.trim());
    const medsList = medsArray.map((med, i) => `${i + 1}. ${med}`).join('\n');

    const message = `🧬 *SamarthaaMed Prescription*

📋 *Patient:* ${patient.name}
📅 *Date:* ${today}
🏥 *Department:* ${patient.meta.split('·')[2] || 'General Medicine'}

℞ *PRESCRIPTION*
${medsList}

📝 *General Instructions:*
• Take medications as prescribed
• Do not skip doses
• Follow up in 2 weeks
• Contact if any adverse reactions

👨‍⚕️ *${doctorName}*
${doctorOrg}

_This is a digital prescription from SamarthaaMed AI-Assisted Clinical System_`;

    // Encode message for WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    
    // For demo: show WhatsApp modal/dialog
    showWhatsAppDialog(patientName, message, encodedMessage);
  }

  function showWhatsAppDialog(patientName, message, encodedMessage) {
    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.2s';
    
    modal.innerHTML = `
      <div style="background:var(--panel);border-radius:16px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
        <div style="padding:24px;border-bottom:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:1.2rem;font-weight:700;color:var(--text1);margin-bottom:4px">📲 Share via WhatsApp</div>
              <div style="font-size:0.85rem;color:var(--text3)">Send prescription to ${patientName}</div>
            </div>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.5rem;color:var(--text2);cursor:pointer;padding:0;width:32px;height:32px">×</button>
          </div>
        </div>
        
        <div style="padding:24px">
          <div style="margin-bottom:20px">
            <label style="display:block;font-size:0.85rem;font-weight:600;color:var(--text2);margin-bottom:8px">Patient Phone Number</label>
            <input type="tel" id="whatsappPhone" placeholder="+91 98765 43210" style="width:100%;padding:12px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);font-size:0.95rem" value="+91 98765 43210">
          </div>

          <div style="margin-bottom:20px">
            <label style="display:block;font-size:0.85rem;font-weight:600;color:var(--text2);margin-bottom:8px">Preview Message</label>
            <div style="background:var(--navy3);padding:16px;border-radius:8px;font-size:0.8rem;color:var(--text2);max-height:300px;overflow-y:auto;white-space:pre-wrap;border:1px solid var(--border2);font-family:monospace">${message}</div>
          </div>

          <div style="display:flex;gap:12px">
            <button onclick="sendWhatsAppMessage('${encodedMessage}')" style="flex:1;padding:14px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.95rem">
              📱 Open WhatsApp
            </button>
            <button onclick="copyWhatsAppMessage(\`${message.replace(/`/g, '\\`')}\`)" style="flex:1;padding:14px;background:var(--teal);color:var(--navy);border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.95rem">
              📋 Copy Message
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  function sendWhatsAppMessage(encodedMessage) {
    const phone = document.getElementById('whatsappPhone')?.value.replace(/[^0-9+]/g, '') || '';
    
    // Open WhatsApp with message
    const whatsappURL = `https://wa.me/${phone}?text=${encodedMessage}`;
    window.open(whatsappURL, '_blank');
    
    // Close modal
    document.querySelector('div[style*="position:fixed"]')?.remove();
    
    showToast('✅', 'WhatsApp Opened', 'Prescription ready to send');
  }

  function copyWhatsAppMessage(message) {
    navigator.clipboard?.writeText(message);
    showToast('📋', 'Copied to Clipboard', 'Message copied successfully');
    
    // Close modal after short delay
    setTimeout(() => {
      document.querySelector('div[style*="position:fixed"]')?.remove();
    }, 1000);
  }

  /* ══════════════════════════════════════════════════════════
     PRINT SOAP NOTE FUNCTION
     ══════════════════════════════════════════════════════════ */

  function printSOAPNote() {
    // Get SOAP content
    const soapS = document.getElementById('soapS')?.textContent || '';
    const soapO = document.getElementById('soapO')?.textContent || '';
    const soapA = document.getElementById('soapA')?.textContent || '';
    const soapP = document.getElementById('soapP')?.textContent || '';
    const soapICD = document.getElementById('soapICD')?.textContent || '';
    
    // Get patient info from label
    const patientLabel = document.getElementById('soapPatientLabel')?.textContent || 'Patient';
    
    // Get current patient details if available
    const activeChip = document.querySelector('.patient-chip.active');
    let patientName = 'Patient';
    let patientMeta = '';
    
    if (activeChip) {
      const onclick = activeChip.getAttribute('onclick');
      const match = onclick.match(/'(\w+)','([^']+)'/);
      if (match) {
        const patientKey = match[1];
        const patient = patientProfiles[patientKey];
        if (patient) {
          patientName = patient.name;
          patientMeta = patient.meta;
        }
      }
    }

    const today = new Date().toLocaleDateString('en-IN', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric',
      weekday: 'long'
    });

    // Get logged-in doctor details
    const doctorName = localStorage.getItem('samarthaamed_user_name') || 'Dr. Physician';
    const doctorOrg = localStorage.getItem('samarthaamed_user_org') || 'Healthcare Institution';
    const doctorEmail = localStorage.getItem('samarthaamed_user_email') || 'doctor@hospital.com';

    // Create print window
    const printWindow = window.open('', '_blank');
    
    const printHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>SOAP Note - ${patientName}</title>
  <style>
    @page { 
      margin: 2cm;
      size: A4;
    }
    
    body { 
      font-family: 'Arial', 'Helvetica', sans-serif; 
      line-height: 1.6; 
      color: #000;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      border-bottom: 3px solid #10b981;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    
    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #10b981;
      margin-bottom: 5px;
    }
    
    .doc-info {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    
    .patient-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #10b981;
    }
    
    .patient-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .label {
      font-weight: 600;
      color: #333;
    }
    
    .value {
      color: #666;
    }
    
    .soap-section {
      margin-bottom: 30px;
      page-break-inside: avoid;
    }
    
    .soap-header {
      background: #10b981;
      color: white;
      padding: 12px 15px;
      font-weight: 700;
      font-size: 16px;
      border-radius: 6px 6px 0 0;
      margin-bottom: 0;
    }
    
    .soap-content {
      border: 2px solid #10b981;
      border-top: none;
      padding: 15px;
      background: white;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.8;
      border-radius: 0 0 6px 6px;
    }
    
    .footer {
      margin-top: 60px;
      padding-top: 20px;
      border-top: 2px solid #ddd;
    }
    
    .signature-section {
      display: flex;
      justify-content: space-between;
      margin-top: 50px;
    }
    
    .signature-box {
      text-align: center;
    }
    
    .signature-line {
      border-top: 2px solid #000;
      width: 200px;
      margin-top: 60px;
      padding-top: 10px;
    }
    
    @media print {
      .no-print { 
        display: none; 
      }
      body { 
        padding: 0; 
      }
      .soap-section {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">🧬 SamarthaaMed</div>
    <div style="font-size: 16px; color: #333; font-weight: 600;">Clinical Intelligence Platform - SOAP Note</div>
    <div class="doc-info">
      <strong>${doctorName}</strong><br>
      ${doctorOrg}<br>
      📧 ${doctorEmail}
    </div>
  </div>

  <div style="text-align:right;color:#666;font-size:14px;margin-bottom:20px">
    <strong>Date:</strong> ${today}
  </div>

  <div class="patient-section">
    <div class="patient-row">
      <span class="label">Patient Name:</span>
      <span class="value">${patientName}</span>
    </div>
    ${patientMeta ? `
    <div class="patient-row">
      <span class="label">Patient Details:</span>
      <span class="value">${patientMeta}</span>
    </div>` : ''}
    <div class="patient-row">
      <span class="label">Consultation Date:</span>
      <span class="value">${patientLabel}</span>
    </div>
  </div>

  <div class="soap-section">
    <div class="soap-header">S — SUBJECTIVE</div>
    <div class="soap-content">${soapS || 'No subjective data recorded.'}</div>
  </div>

  <div class="soap-section">
    <div class="soap-header">O — OBJECTIVE</div>
    <div class="soap-content">${soapO || 'No objective data recorded.'}</div>
  </div>

  <div class="soap-section">
    <div class="soap-header">A — ASSESSMENT</div>
    <div class="soap-content">${soapA || 'No assessment recorded.'}</div>
  </div>

  <div class="soap-section">
    <div class="soap-header">P — PLAN</div>
    <div class="soap-content">${soapP || 'No plan recorded.'}</div>
  </div>

  ${soapICD ? `
  <div class="soap-section">
    <div class="soap-header">ICD-11 CODES</div>
    <div class="soap-content">${soapICD}</div>
  </div>` : ''}

  <div class="footer">
    <div style="font-size:12px;color:#666;margin-bottom:30px">
      This SOAP note was generated using SamarthaaMed AI-Assisted Clinical Documentation System.<br>
      All clinical data should be verified by the attending physician.
    </div>
    
    <div class="signature-section">
      <div class="signature-box">
        <div class="signature-line">
          <strong>Patient Signature</strong><br>
          <span style="font-size:11px;color:#999">(if applicable)</span>
        </div>
      </div>
      
      <div class="signature-box">
        <div class="signature-line">
          <strong>${doctorName}</strong><br>
          <span style="font-size:11px;color:#999">Consulting Physician</span>
        </div>
      </div>
    </div>
  </div>

  <div class="no-print" style="position:fixed;bottom:30px;right:30px;display:flex;gap:12px">
    <button onclick="window.print()" style="padding:14px 28px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;box-shadow:0 4px 12px rgba(16,185,129,0.3)">
      🖨 Print
    </button>
    <button onclick="window.close()" style="padding:14px 28px;background:#666;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600">
      Close
    </button>
  </div>
</body>
</html>
    `;

    printWindow.document.write(printHTML);
    printWindow.document.close();
    
    showToast('🖨', 'Print Ready', 'SOAP note opened in new window');
  }

  // ═══════════════════════════════════════════════════════════════
  // TWO-WAY VOICE CONSULTATION SYSTEM
  // ═══════════════════════════════════════════════════════════════

  let voiceConsultation = {
    active: false,
    recognition: null,
    synthesis: window.speechSynthesis,
    currentLanguage: 'en-US',
    conversationHistory: [],
    isListening: false,
    isSpeaking: false,
    autoListen: true
  };

  // Start voice consultation
  // ══════════════════════════════════════════════════════════════
  // EMERGENCY VOICE AI — no patient registration required
  // ══════════════════════════════════════════════════════════════
  let _emergencyMode = false;
  let _emergencyContext = {};

  function startEmergencyVoice() {
    // Show quick triage form before launching voice
    const overlay = document.createElement('div');
    overlay.id = 'emergencyTriageOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:10001;padding:20px;';
    overlay.innerHTML = `
      <div style="background:var(--panel);border-radius:18px;width:100%;max-width:480px;overflow:hidden;box-shadow:0 24px 80px rgba(220,38,38,0.3);border:2px solid rgba(220,38,38,0.4);">
        <!-- Red header -->
        <div style="background:linear-gradient(135deg,var(--red),#991b1b);padding:20px 24px;display:flex;align-items:center;gap:12px;">
          <span style="font-size:2rem;animation:pulse 1s infinite;">🚨</span>
          <div>
            <div style="font-family:var(--syne);font-size:1.25rem;font-weight:800;color:#fff;">Emergency Voice AI</div>
            <div style="font-size:0.78rem;color:rgba(255,255,255,0.8);margin-top:2px;">Rapid AI consultation — no patient registration needed</div>
          </div>
        </div>
        <!-- Quick triage inputs -->
        <div style="padding:22px 24px 16px;">
          <p style="font-size:0.82rem;color:var(--text3);margin:0 0 16px;">Enter what you know. All fields optional — speak the rest aloud once the session starts.</p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
            <div>
              <label style="font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.6px;display:block;margin-bottom:4px;">Age</label>
              <input id="emAge" type="number" placeholder="e.g. 55" min="0" max="120"
                style="width:100%;padding:9px 12px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);font-size:0.9rem;outline:none;box-sizing:border-box;"
                onfocus="this.style.borderColor='var(--red)'" onblur="this.style.borderColor='var(--border2)'">
            </div>
            <div>
              <label style="font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.6px;display:block;margin-bottom:4px;">Sex</label>
              <select id="emSex"
                style="width:100%;padding:9px 12px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);font-size:0.9rem;outline:none;box-sizing:border-box;cursor:pointer;"
                onfocus="this.style.borderColor='var(--red)'" onblur="this.style.borderColor='var(--border2)'">
                <option value="">Unknown</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </div>
          </div>
          <div style="margin-bottom:12px;">
            <label style="font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.6px;display:block;margin-bottom:4px;">Chief Complaint / Presenting Problem</label>
            <input id="emComplaint" type="text" placeholder="e.g. Chest pain with radiation to left arm, 30 mins"
              style="width:100%;padding:9px 12px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);font-size:0.9rem;outline:none;box-sizing:border-box;"
              onfocus="this.style.borderColor='var(--red)'" onblur="this.style.borderColor='var(--border2)'"
              onkeydown="if(event.key==='Enter') _launchEmergencyVoice()">
          </div>
          <div style="margin-bottom:16px;">
            <label style="font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.6px;display:block;margin-bottom:4px;">Known Vitals / Allergies (optional)</label>
            <input id="emVitals" type="text" placeholder="e.g. BP 180/110, HR 115, Penicillin allergy"
              style="width:100%;padding:9px 12px;background:var(--navy3);border:1px solid var(--border2);border-radius:8px;color:var(--text1);font-size:0.9rem;outline:none;box-sizing:border-box;"
              onfocus="this.style.borderColor='var(--red)'" onblur="this.style.borderColor='var(--border2)'">
          </div>
          <div style="display:flex;gap:10px;">
            <button onclick="document.getElementById('emergencyTriageOverlay').remove()" 
              style="flex:1;padding:12px;background:var(--navy3);color:var(--text2);border:1px solid var(--border2);border-radius:8px;cursor:pointer;font-weight:600;font-size:0.9rem;">
              Cancel
            </button>
            <button onclick="_launchEmergencyVoice()"
              style="flex:2;padding:12px;background:var(--red);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.95rem;box-shadow:0 4px 16px rgba(220,38,38,0.4);">
              🎤 Start Emergency Session
            </button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(overlay);
    // Focus chief complaint
    setTimeout(() => document.getElementById('emComplaint')?.focus(), 200);
  }

  function _launchEmergencyVoice() {
    const age       = document.getElementById('emAge')?.value?.trim() || '';
    const sex       = document.getElementById('emSex')?.value || '';
    const complaint = document.getElementById('emComplaint')?.value?.trim() || '';
    const vitals    = document.getElementById('emVitals')?.value?.trim() || '';
    document.getElementById('emergencyTriageOverlay')?.remove();

    _emergencyMode = true;
    _emergencyContext = { age, sex, complaint, vitals };

    // Launch the standard voice modal but in emergency mode
    startVoiceConsultation(true);
  }

  function _buildEmergencySystemPrompt(ctx) {
    const who = [ctx.age && (ctx.age + ' yr'), ctx.sex].filter(Boolean).join(' ') || 'Unknown age/sex';
    const complaint = ctx.complaint || 'not yet stated';
    const vitals = ctx.vitals || 'not yet measured';
    return `You are Samarthaa, an emergency AI clinical decision-support assistant helping an Indian doctor in a time-critical situation.

EMERGENCY PATIENT (UNREGISTERED):
Patient: ${who}
Presenting: ${complaint}
Vitals known: ${vitals}

CRITICAL RULES FOR EMERGENCY MODE:
1. This is a real emergency — be fast, decisive, and direct.
2. Lead with the most critical action first (ABCDE approach, STEMI protocol, sepsis bundle etc.).
3. Replies must be 1–3 short spoken sentences MAXIMUM. No preamble.
4. Cite ICMR 2024, NHP, or WHO emergency protocols when applicable.
5. If patient details are unknown, make clinically safe assumptions and state them.
6. Flag red-flag symptoms immediately (STEMI, stroke, anaphylaxis, sepsis).
7. Match the language the doctor speaks (English/Hindi/Kannada etc.).
8. Never refuse to answer due to missing information — work with what you have.`;
  }

  function _getEmergencyContext() {
    const ctx = _emergencyContext;
    const who = [ctx.age && (ctx.age + ' yr'), ctx.sex].filter(Boolean).join(' ') || 'Unknown';
    return `EMERGENCY — UNREGISTERED PATIENT: ${who} | Presenting: ${ctx.complaint || 'not yet stated'} | Vitals: ${ctx.vitals || 'not yet measured'}`;
  }

  function _clearEmergencyMode() {
    _emergencyMode = false;
    _emergencyContext = {};
  }

  function startVoiceConsultation(emergencyMode) {
    // Show voice consultation modal
    const modal = document.createElement('div');
    modal.id = 'voiceConsultModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
    
    // Determine display info (emergency vs normal)
    const isEmergency = emergencyMode === true || _emergencyMode;
    let patientName, patientMeta, headerBg, headerIcon, headerTitle;
    if (isEmergency) {
      const ctx = _emergencyContext;
      const who = [ctx.age && (ctx.age + ' yr'), ctx.sex].filter(Boolean).join(' ') || 'Unknown patient';
      patientName = '🚨 EMERGENCY — ' + who;
      patientMeta = ctx.complaint ? ctx.complaint : 'Speak symptoms aloud to begin';
      headerBg = 'linear-gradient(135deg,rgba(220,38,38,0.15),var(--panel))';
      headerIcon = '🚨';
      headerTitle = 'Emergency Voice AI';
    } else {
      patientName = document.querySelector('.consult-patient-name')?.textContent || 'Patient';
      patientMeta = document.querySelector('.consult-patient-meta')?.textContent || '';
      headerBg = 'linear-gradient(135deg,var(--teal-dim),var(--panel))';
      headerIcon = '🎤';
      headerTitle = 'Voice Consultation';
    }
    
    modal.innerHTML = `
      <div style="background:var(--panel);border-radius:16px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px;border-bottom:1px solid var(--border);background:${headerBg};">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h2 style="margin:0;color:var(--text1);font-size:1.5rem;font-family:var(--syne);">${headerIcon} ${headerTitle}</h2>
              <p style="margin:4px 0 0 0;color:var(--text3);font-size:0.85rem;">${patientName} • ${patientMeta}</p>
            </div>
            <button onclick="endVoiceConsultation()" style="background:var(--red-dim);color:var(--red);border:1px solid var(--red);padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
              End Session
            </button>
          </div>
        </div>

        <!-- Voice Controls -->
        <div style="padding:20px;background:var(--panel2);border-bottom:1px solid var(--border);">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;">
            <!-- Microphone Button -->
            <button id="voiceMicBtn" onclick="toggleVoiceListening()" style="width:80px;height:80px;border-radius:50%;background:var(--teal);border:4px solid var(--teal-dim);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:2rem;transition:all 0.3s;box-shadow:0 4px 20px rgba(185,28,28,0.3);">
              🎤
            </button>
            
            <!-- Status Display -->
            <div style="flex:1;min-width:200px;">
              <div id="voiceStatus" style="font-size:1.1rem;font-weight:600;color:var(--text1);margin-bottom:6px;">
                Ready to listen...
              </div>
              <div id="voiceSubStatus" style="font-size:0.85rem;color:var(--text3);">
                Click microphone to start conversation
              </div>
            </div>

            <!-- Language Selector -->
            <select id="voiceLangSelect" onchange="changeVoiceLanguage(this.value)" style="padding:10px 16px;border-radius:8px;border:1px solid var(--border2);background:var(--panel);color:var(--text1);font-size:0.9rem;cursor:pointer;">
              <option value="en-US">🇺🇸 English (US)</option>
              <option value="en-GB">🇬🇧 English (UK)</option>
              <option value="hi-IN">🇮🇳 Hindi</option>
              <option value="kn-IN">🇮🇳 Kannada</option>
              <option value="ta-IN">🇮🇳 Tamil</option>
              <option value="te-IN">🇮🇳 Telugu</option>
              <option value="ml-IN">🇮🇳 Malayalam</option>
              <option value="mr-IN">🇮🇳 Marathi</option>
              <option value="bn-IN">🇮🇳 Bengali</option>
              <option value="gu-IN">🇮🇳 Gujarati</option>
              <option value="pa-IN">🇮🇳 Punjabi</option>
            </select>

            <!-- Auto-Listen Toggle -->
            <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--panel);border-radius:8px;border:1px solid var(--border2);cursor:pointer;">
              <input type="checkbox" id="autoListenToggle" checked onchange="voiceConsultation.autoListen=this.checked" style="width:18px;height:18px;cursor:pointer;">
              <span style="font-size:0.85rem;color:var(--text2);">Auto-continue</span>
            </label>
          </div>

          <!-- Waveform Visualizer -->
          <div id="voiceWaveform" style="margin-top:16px;height:60px;background:var(--navy3);border-radius:8px;display:flex;align-items:center;justify-content:center;gap:3px;padding:0 20px;overflow:hidden;">
            ${Array.from({length:40}, () => '<div style="width:3px;height:20px;background:var(--border);border-radius:2px;transition:all 0.1s;"></div>').join('')}
          </div>
        </div>

        <!-- Conversation History -->
        <div style="padding:20px;">
          <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:1rem;color:var(--text2);font-weight:600;">Conversation Transcript</h3>
            <button onclick="clearVoiceHistory()" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.85rem;text-decoration:underline;">
              Clear transcript
            </button>
          </div>
          <div id="voiceTranscript" style="background:var(--navy3);border-radius:12px;padding:20px;max-height:400px;overflow-y:auto;min-height:200px;">
            <div style="text-align:center;color:var(--text3);padding:60px 20px;">
              <div style="font-size:3rem;margin-bottom:12px;">🎙️</div>
              <p style="margin:0;font-size:0.9rem;">Start speaking to begin the conversation...</p>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div style="padding:20px;border-top:1px solid var(--border);background:var(--panel2);display:flex;gap:12px;flex-wrap:wrap;">
          <button onclick="saveVoiceTranscript()" style="flex:1;min-width:150px;padding:12px;background:var(--teal-dim);color:var(--teal);border:1px solid var(--teal);border-radius:8px;cursor:pointer;font-weight:600;">
            💾 Save Transcript
          </button>
          <button onclick="generateSOAPFromVoice()" style="flex:1;min-width:150px;padding:12px;background:var(--teal);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
            📋 Generate SOAP Note
          </button>
          <button onclick="shareVoiceTranscript()" style="flex:1;min-width:150px;padding:12px;background:var(--panel);color:var(--text1);border:1px solid var(--border2);border-radius:8px;cursor:pointer;font-weight:600;">
            📤 Share
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    initializeVoiceRecognition();
    voiceConsultation.active = true;
    
    // Auto-start listening
    setTimeout(() => {
      toggleVoiceListening();
    }, 500);
  }

  // Initialize speech recognition
  function initializeVoiceRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
      showToast('⚠️', 'Not Supported', 'Voice recognition is not supported in this browser. Try Chrome or Edge.');
      return;
    }

    voiceConsultation.recognition = new SpeechRecognition();
    voiceConsultation.recognition.continuous = true;
    voiceConsultation.recognition.interimResults = true;
    voiceConsultation.recognition.lang = voiceConsultation.currentLanguage;
    voiceConsultation.recognition.maxAlternatives = 3;

    voiceConsultation.recognition.onstart = () => {
      voiceConsultation.isListening = true;
      updateVoiceStatus('Listening...', 'Speak now');
      animateWaveform(true);
      document.getElementById('voiceMicBtn').style.background = 'var(--red)';
      document.getElementById('voiceMicBtn').style.transform = 'scale(1.1)';
    };

    voiceConsultation.recognition.onresult = (event) => {
      let interimTranscript = '';
      let finalTranscript = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript;
        } else {
          interimTranscript += transcript;
        }
      }

      if (interimTranscript) {
        updateVoiceStatus('Listening...', interimTranscript);
      }

      if (finalTranscript) {
        addToVoiceTranscript('user', finalTranscript);
        processVoiceInput(finalTranscript);
      }
    };

    voiceConsultation.recognition.onerror = (event) => {
      console.error('Voice recognition error:', event.error);
      if (event.error === 'no-speech') {
        updateVoiceStatus('No speech detected', 'Please speak clearly');
      } else if (event.error === 'not-allowed') {
        showToast('⚠️', 'Microphone Access Denied', 'Please allow microphone access');
        voiceConsultation.isListening = false;
      }
    };

    voiceConsultation.recognition.onend = () => {
      voiceConsultation.isListening = false;
      document.getElementById('voiceMicBtn').style.background = 'var(--teal)';
      document.getElementById('voiceMicBtn').style.transform = 'scale(1)';
      animateWaveform(false);
      
      // Auto-restart if auto-listen is enabled and not speaking
      if (voiceConsultation.autoListen && !voiceConsultation.isSpeaking && voiceConsultation.active) {
        setTimeout(() => {
          if (!voiceConsultation.isSpeaking && voiceConsultation.active) {
            voiceConsultation.recognition.start();
          }
        }, 1000);
      } else {
        updateVoiceStatus('Stopped', 'Click microphone to continue');
      }
    };
  }

  // Toggle voice listening
  function toggleVoiceListening() {
    if (!voiceConsultation.recognition) {
      initializeVoiceRecognition();
      return;
    }

    if (voiceConsultation.isListening) {
      voiceConsultation.recognition.stop();
      voiceConsultation.autoListen = false;
      document.getElementById('autoListenToggle').checked = false;
    } else {
      try {
        voiceConsultation.recognition.start();
      } catch (e) {
        console.error('Failed to start recognition:', e);
      }
    }
  }

  // Process voice input with AI
  async function processVoiceInput(text) {
    updateVoiceStatus('Processing…', 'AI is thinking…');
    const apiKey = getApiKey();
    if (!apiKey) {
      updateVoiceStatus('API Key Missing', 'Enter Anthropic key in Settings');
      return;
    }
    // Build multi-turn context from voice history
    const history = voiceConsultation.conversationHistory.slice(-10)
      .map(m => ({ role: m.type === 'user' ? 'user' : 'assistant', content: m.text }));
    if (!history.length || history[history.length-1].role !== 'user') {
      history.push({ role: 'user', content: text });
    }
    // Ensure alternating roles
    const msgs = [];
    for (const m of history) {
      if (msgs.length && msgs[msgs.length-1].role === m.role) {
        msgs[msgs.length-1].content += ' ' + m.content;
      } else { msgs.push(m); }
    }
    // Use emergency system prompt if in emergency mode, otherwise standard
    let systemPrompt;
    if (_emergencyMode) {
      systemPrompt = _buildEmergencySystemPrompt(_emergencyContext);
    } else {
      const patientCtx = getActivePatientContext();
      systemPrompt = `You are Samarthaa, an AI clinical decision-support assistant speaking aloud to an Indian doctor during a patient consultation. ${patientCtx}
Rules: Reply in 1–2 short spoken sentences only. Be direct, clinical, and empathetic. Cite ICMR 2024 or NHP guidelines when relevant. Match the language the doctor speaks (English/Hindi/Kannada etc.). No bullet points — this is spoken.`;
    }
    try {
      const raw = await callClaudeAI(msgs, systemPrompt);
      const aiResponse = raw.replace(/<[^>]+>/g, '').trim();
      addToVoiceTranscript('ai', aiResponse);
      speakText(aiResponse);
    } catch(err) {
      console.error('Voice AI error:', err);
      updateVoiceStatus('Error', err.message);
      const fallback = generateFallbackResponse ? generateFallbackResponse(text) : 'I could not process that. Please try again.';
      addToVoiceTranscript('ai', fallback);
      speakText(fallback);
    }
  }

  // Fallback response generator (when AI is unavailable)
  function generateFallbackResponse(input) {
    const lowerInput = input.toLowerCase();
    
    if (lowerInput.includes('pain') || lowerInput.includes('hurt')) {
      return "I understand you're experiencing pain. Can you describe the location and intensity on a scale of 1 to 10?";
    } else if (lowerInput.includes('fever') || lowerInput.includes('temperature')) {
      return "Fever noted. Have you measured your temperature? Any other symptoms like chills or body aches?";
    } else if (lowerInput.includes('cough') || lowerInput.includes('cold')) {
      return "I see you have respiratory symptoms. Is the cough dry or productive? Any difficulty breathing?";
    } else if (lowerInput.includes('medicine') || lowerInput.includes('medication')) {
      return "Regarding medications, please tell me what you're currently taking and any allergies you have.";
    } else {
      return "Thank you for sharing. Can you provide more details about your symptoms and when they started?";
    }
  }

  // ── Text-to-Speech: ElevenLabs → browser Web Speech API fallback ──
  async function speakText(text) {
    // Stop any ongoing speech
    voiceConsultation.synthesis.cancel();
    if (window._elCurrentAudio) {
      window._elCurrentAudio.pause();
      window._elCurrentAudio = null;
    }
    if (window._elAudioCtx)  { window._elAudioCtx.close().catch(()=>{}); window._elAudioCtx = null; }
    if (window._ttsAudioCtx) { window._ttsAudioCtx.close().catch(()=>{}); window._ttsAudioCtx = null; }
    voiceConsultation.isSpeaking = true;
    updateVoiceStatus('AI Speaking…', text.substring(0, 100) + '…');
    animateWaveform(true);

    // Stop mic while speaking
    if (voiceConsultation.isListening) {
      try { voiceConsultation.recognition.stop(); } catch(e) {}
    }

    const elKey    = _vault.get('elak');
    const elVoice  = _vault.get('elvi');
    const useEL    = elKey && elVoice && document.getElementById('elUseVoiceConsult')?.checked !== false;

    if (useEL) {
      try {
        await _speakElevenLabs(text, elKey, elVoice);
        return; // ElevenLabs handled onend itself
      } catch(err) {
        console.warn('ElevenLabs TTS failed, falling back to browser:', err.message);
      }
    }
    // Fallback: browser Web Speech API
    _speakBrowser(text);
  }

  async function _speakElevenLabs(text, apiKey, voiceId) {
    const model      = localStorage.getItem('el_model')      || 'eleven_multilingual_v2';
    const stability  = parseFloat(localStorage.getItem('el_stability'))  || 0.5;
    const similarity = parseFloat(localStorage.getItem('el_similarity')) || 0.85;

    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
      method: 'POST',
      headers: {
        'xi-api-key': apiKey,
        'Content-Type': 'application/json',
        'Accept': 'audio/mpeg'
      },
      body: JSON.stringify({
        text: text,
        model_id: model,
        voice_settings: {
          stability: stability,
          similarity_boost: similarity,
          style: 0.25,
          use_speaker_boost: true
        }
      })
    });

    if (!response.ok) {
      const errBody = await response.json().catch(() => ({}));
      throw new Error(errBody?.detail?.message || `ElevenLabs error ${response.status}`);
    }

    const blob    = await response.blob();
    const url     = URL.createObjectURL(blob);
    const audio   = new Audio(url);
    audio.volume  = 1.0;
    window._elCurrentAudio = audio;

    // Amplify to 1.5× using Web Audio API GainNode (goes beyond browser's 1.0 vol cap)
    try {
      const actx = new (window.AudioContext || window.webkitAudioContext)();
      const src  = actx.createMediaElementSource(audio);
      const gain = actx.createGain();
      gain.gain.value = 1.5;
      src.connect(gain);
      gain.connect(actx.destination);
      window._elAudioCtx = actx;
    } catch(e) { /* fallback: native volume */ }

    audio.onended = () => {
      URL.revokeObjectURL(url);
      window._elCurrentAudio = null;
      if (window._elAudioCtx) { window._elAudioCtx.close().catch(()=>{}); window._elAudioCtx = null; }
      _onSpeakEnd();
    };
    audio.onerror = (e) => {
      URL.revokeObjectURL(url);
      window._elCurrentAudio = null;
      if (window._elAudioCtx) { window._elAudioCtx.close().catch(()=>{}); window._elAudioCtx = null; }
      _onSpeakEnd();
    };

    await audio.play();
  }

  function _speakBrowser(text) {
    // Strategy: use Web Audio API to boost volume 1.5×.
    // SpeechSynthesis → MediaStreamDestination → GainNode(1.5) → speakers.
    // Falls back to plain utterance if Web Audio or MediaStream APIs are unavailable.
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang  = voiceConsultation.currentLanguage;
    utterance.rate  = 0.95;
    utterance.pitch = 1.0;
    utterance.volume = 1.0; // keep at max before the gain stage

    const voices = voiceConsultation.synthesis.getVoices();
    const best   = voices.find(v =>
      v.lang.startsWith(voiceConsultation.currentLanguage.split('-')[0]) &&
      (v.name.includes('Google') || v.name.includes('Microsoft'))
    ) || voices.find(v => v.lang.startsWith(voiceConsultation.currentLanguage.split('-')[0]));
    if (best) utterance.voice = best;

    utterance.onend = () => {
      if (window._ttsAudioCtx) {
        window._ttsAudioCtx.close().catch(() => {});
        window._ttsAudioCtx = null;
      }
      if (window._ttsAudioEl) {
        window._ttsAudioEl.pause();
        window._ttsAudioEl = null;
      }
      _onSpeakEnd();
    };

    // Try boosted path via MediaStreamDestination
    try {
      const actx = new (window.AudioContext || window.webkitAudioContext)();
      const dest  = actx.createMediaStreamDestination();
      const gain  = actx.createGain();
      gain.gain.value = 1.5;

      // Route: utterance → MediaStream → MediaElement → GainNode → output
      // We play the utterance silently into the destination, then re-emit it amplified
      const srcNode = actx.createMediaStreamSource(dest.stream);
      srcNode.connect(gain);
      gain.connect(actx.destination);

      window._ttsAudioCtx = actx;

      // Speak normally — the gain node on the MediaStreamDestination path amplifies it
      // NOTE: Chrome/Edge require an active AudioContext started by a user gesture.
      // We resume in case it was suspended.
      actx.resume().then(() => {
        voiceConsultation.synthesis.speak(utterance);
      });
    } catch (e) {
      // Fallback: plain speech at native volume
      voiceConsultation.synthesis.speak(utterance);
    }
  }

  function _onSpeakEnd() {
    voiceConsultation.isSpeaking = false;
    animateWaveform(false);
    updateVoiceStatus('Ready', 'Your turn to speak');
    if (voiceConsultation.autoListen && voiceConsultation.active) {
      setTimeout(() => {
        if (!voiceConsultation.isListening && voiceConsultation.active) {
          toggleVoiceListening();
        }
      }, 500);
    }
  }

  // Add message to transcript
  function addToVoiceTranscript(type, text) {
    const transcriptDiv = document.getElementById('voiceTranscript');
    
    // Remove placeholder if exists
    if (transcriptDiv.querySelector('div[style*="text-align:center"]')) {
      transcriptDiv.innerHTML = '';
    }

    const messageDiv = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    if (type === 'user') {
      messageDiv.style.cssText = 'margin-bottom:16px;display:flex;justify-content:flex-end;';
      messageDiv.innerHTML = `
        <div style="max-width:70%;background:var(--teal-dim);border:1px solid var(--teal);border-radius:12px 12px 0 12px;padding:12px 16px;">
          <div style="font-size:0.75rem;color:var(--text3);margin-bottom:4px;">You • ${timestamp}</div>
          <div style="color:var(--text1);font-size:0.9rem;line-height:1.5;">${text}</div>
        </div>
      `;
    } else {
      messageDiv.style.cssText = 'margin-bottom:16px;display:flex;justify-content:flex-start;';
      messageDiv.innerHTML = `
        <div style="max-width:70%;background:var(--panel2);border:1px solid var(--border2);border-radius:12px 12px 12px 0;padding:12px 16px;">
          <div style="font-size:0.75rem;color:var(--text3);margin-bottom:4px;">🤖 AI Assistant • ${timestamp}</div>
          <div style="color:var(--text1);font-size:0.9rem;line-height:1.5;">${text}</div>
        </div>
      `;
    }

    transcriptDiv.appendChild(messageDiv);
    transcriptDiv.scrollTop = transcriptDiv.scrollHeight;

    // Store in history
    voiceConsultation.conversationHistory.push({ type, text, timestamp });
  }

  // Update voice status display
  function updateVoiceStatus(status, substatus) {
    const statusDiv = document.getElementById('voiceStatus');
    const substatusDiv = document.getElementById('voiceSubStatus');
    
    if (statusDiv) statusDiv.textContent = status;
    if (substatusDiv) substatusDiv.textContent = substatus;
  }

  // Animate waveform
  function animateWaveform(active) {
    const waveform = document.getElementById('voiceWaveform');
    if (!waveform) return;

    const bars = waveform.querySelectorAll('div');
    
    if (active) {
      bars.forEach((bar, i) => {
        setInterval(() => {
          const height = Math.random() * 50 + 10;
          bar.style.height = height + 'px';
          bar.style.background = 'var(--teal)';
        }, 100 + i * 20);
      });
    } else {
      bars.forEach(bar => {
        bar.style.height = '20px';
        bar.style.background = 'var(--border)';
      });
    }
  }

  // Change voice language
  function changeVoiceLanguage(lang) {
    voiceConsultation.currentLanguage = lang;
    if (voiceConsultation.recognition) {
      voiceConsultation.recognition.lang = lang;
      showToast('🌐', 'Language Changed', `Now using ${lang}`);
    }
  }

  // Clear voice history
  function clearVoiceHistory() {
    if (confirm('Clear the entire conversation transcript?')) {
      voiceConsultation.conversationHistory = [];
      document.getElementById('voiceTranscript').innerHTML = `
        <div style="text-align:center;color:var(--text3);padding:60px 20px;">
          <div style="font-size:3rem;margin-bottom:12px;">🎙️</div>
          <p style="margin:0;font-size:0.9rem;">Transcript cleared. Start speaking to begin a new conversation...</p>
        </div>
      `;
      showToast('🗑️', 'Cleared', 'Transcript cleared');
    }
  }

  // Save voice transcript
  function saveVoiceTranscript() {
    if (voiceConsultation.conversationHistory.length === 0) {
      showToast('⚠️', 'Nothing to Save', 'No conversation to save yet');
      return;
    }

    const patientName = document.querySelector('.consult-patient-name')?.textContent || 'Patient';
    const today = new Date().toLocaleString();
    
    let transcript = `Voice Consultation Transcript\n`;
    transcript += `Patient: ${patientName}\n`;
    transcript += `Date: ${today}\n`;
    transcript += `Language: ${voiceConsultation.currentLanguage}\n`;
    transcript += `\n${'='.repeat(60)}\n\n`;

    voiceConsultation.conversationHistory.forEach(msg => {
      const speaker = msg.type === 'user' ? 'USER' : 'AI ASSISTANT';
      transcript += `[${msg.timestamp}] ${speaker}:\n${msg.text}\n\n`;
    });

    // Download as text file
    const blob = new Blob([transcript], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Voice_Consultation_${patientName.replace(/\s/g, '_')}_${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    showToast('💾', 'Saved', 'Transcript downloaded');
  }

  // Generate SOAP note from voice conversation
  function generateSOAPFromVoice() {
    if (voiceConsultation.conversationHistory.length === 0) {
      showToast('⚠️', 'No Conversation', 'Have a conversation first to generate SOAP note');
      return;
    }

    showToast('📋', 'Generating SOAP Note', 'Analyzing conversation...');
    
    // Extract conversation text
    const conversationText = voiceConsultation.conversationHistory
      .map(msg => `${msg.type === 'user' ? 'Patient' : 'AI'}: ${msg.text}`)
      .join('\n');

    // In a real implementation, this would call an AI to structure the SOAP note
    // For now, show a placeholder
    setTimeout(() => {
      showToast('✅', 'SOAP Note Ready', 'Check the SOAP modal in AI Consultation');
      // You can trigger the SOAP modal here and populate it
    }, 2000);
  }

  // Share voice transcript
  function shareVoiceTranscript() {
    if (voiceConsultation.conversationHistory.length === 0) {
      showToast('⚠️', 'Nothing to Share', 'No conversation to share yet');
      return;
    }

    const transcript = voiceConsultation.conversationHistory
      .map(msg => `${msg.type === 'user' ? '👤' : '🤖'} ${msg.text}`)
      .join('\n\n');

    if (navigator.share) {
      navigator.share({
        title: 'Voice Consultation Transcript',
        text: transcript
      }).then(() => {
        showToast('📤', 'Shared', 'Transcript shared successfully');
      }).catch(() => {
        copyToClipboard(transcript);
      });
    } else {
      copyToClipboard(transcript);
    }
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('📋', 'Copied', 'Transcript copied to clipboard');
    });
  }

  // End voice consultation
  function endVoiceConsultation() {
    _clearEmergencyMode();
    if (confirm('End voice consultation session?')) {
      voiceConsultation.active = false;
      
      // Stop recognition and speech
      if (voiceConsultation.recognition) {
        voiceConsultation.recognition.stop();
      }
      voiceConsultation.synthesis.cancel();

      // Remove modal
      const modal = document.getElementById('voiceConsultModal');
      if (modal) {
        modal.remove();
      }

      showToast('✅', 'Session Ended', 'Voice consultation completed');
    }
  }


  /* ══════════════════════════════════════════════════════════
     DENTISTRY MODULE — Full AI Implementation
     FDI Chart · Perio · Radiograph AI · Diagnosis AI · Rx AI
     ══════════════════════════════════════════════════════════ */

  // ── State ──────────────────────────────────────────────────────
  const _dc = {
    chart:     {},          // { "18": "caries", "21": "filled", … }
    perio:     {},          // { "16": 3, "15": 5, … }
    procs:     [],          // planned procedure strings
    activeCond: 'healthy',  // currently selected condition
    built:     false        // whether DOM was initialised
  };

  const DC_COLORS = {
    healthy: 'var(--green)',
    caries:  'var(--red)',
    filled:  'var(--gold)',
    crown:   'var(--purple)',
    missing: '#444',
    rct:     'var(--cyan)'
  };

  // FDI notation — upper: right→midline then midline→left; lower: same
  const DC_UPPER = [18,17,16,15,14,13,12,11, 21,22,23,24,25,26,27,28];
  const DC_LOWER = [48,47,46,45,44,43,42,41, 31,32,33,34,35,36,37,38];
  // Representative index teeth for perio charting (Ramfjord sextants extended)
  const DC_PERIO_TEETH = [16,15,11,21,25,26, 46,45,41,31,35,36];

  // ── Build interactive chart ────────────────────────────────────
  function dcBuild() {
    if (_dc.built) return;
    _dc.built = true;
    _buildArch('dcUpper', DC_UPPER);
    _buildArch('dcLower', DC_LOWER);
    _buildPerioGrid();
    dcUpdateStats();
  }

  function _buildArch(containerId, teeth) {
    const wrap = document.getElementById(containerId);
    if (!wrap) return;
    wrap.innerHTML = '';
    teeth.forEach(num => {
      _dc.chart[num] = _dc.chart[num] || 'healthy';
      const el = document.createElement('div');
      el.id = `dct-${num}`;
      el.title = `Tooth ${num} — click to mark`;
      el.style.cssText = [
        'width:26px;height:34px',
        'border-radius:5px 5px 9px 9px',
        `background:${DC_COLORS.healthy}`,
        'cursor:pointer',
        'display:flex;align-items:center;justify-content:center',
        'font-size:0.52rem;font-weight:700;color:var(--navy)',
        'transition:transform 0.12s,box-shadow 0.12s',
        'border:1.5px solid rgba(255,255,255,0.08)',
        'flex-shrink:0;user-select:none'
      ].join(';');
      el.textContent = num;
      el.addEventListener('click',      () => dcMarkTooth(num));
      el.addEventListener('mouseover',  () => { el.style.transform='scale(1.2)'; el.style.boxShadow='0 0 8px rgba(0,212,180,0.5)'; });
      el.addEventListener('mouseout',   () => { el.style.transform=''; el.style.boxShadow=''; });
      wrap.appendChild(el);
    });
  }

  function _buildPerioGrid() {
    const grid = document.getElementById('perioGrid');
    if (!grid) return;
    grid.innerHTML = '';
    DC_PERIO_TEETH.forEach(num => {
      const cell = document.createElement('div');
      cell.style.cssText = 'background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:8px 4px;text-align:center';
      cell.innerHTML = `
        <div style="font-size:0.65rem;font-weight:700;color:var(--teal);margin-bottom:4px">${num}</div>
        <input id="perio-${num}" type="number" min="0" max="15" placeholder="mm"
          style="width:44px;background:transparent;border:none;border-bottom:1px solid var(--border2);color:var(--text1);font-size:0.82rem;text-align:center;outline:none;padding:2px 0"
          oninput="dcUpdatePerio()">`;
      grid.appendChild(cell);
    });
  }

  // ── Condition selector ─────────────────────────────────────────
  function dcSetCond(btn) {
    _dc.activeCond = btn.dataset.cond;
    ['healthy','caries','filled','crown','missing','rct'].forEach(c => {
      const b = document.getElementById(`dcCondBtn-${c}`);
      if (!b) return;
      if (c === _dc.activeCond) {
        b.style.opacity = '1';
        b.style.fontWeight = '700';
        b.style.boxShadow = '0 0 0 2px rgba(0,212,180,0.5)';
      } else {
        b.style.opacity = '0.55';
        b.style.fontWeight = '500';
        b.style.boxShadow = 'none';
      }
    });
  }

  function dcMarkTooth(num) {
    _dc.chart[num] = _dc.activeCond;
    const el = document.getElementById(`dct-${num}`);
    if (el) el.style.background = DC_COLORS[_dc.activeCond];
    dcUpdateStats();
    showToast('🦷', `Tooth ${num}`, `Marked as ${_dc.activeCond}`);
  }

  function dcUpdateStats() {
    const vals   = Object.values(_dc.chart);
    const caries  = vals.filter(v => v === 'caries').length;
    const missing = vals.filter(v => v === 'missing').length;
    const teeth   = 32 - missing;

    const kc = document.getElementById('kpiCaries');
    const kt = document.getElementById('kpiTeeth');
    if (kc) kc.textContent = caries;
    if (kt) kt.textContent = teeth;

    // Chart summary
    const abnormal = Object.entries(_dc.chart).filter(([,v]) => v !== 'healthy');
    const summary  = document.getElementById('dcSummary');
    if (summary) {
      if (!abnormal.length) {
        summary.textContent = 'All teeth currently marked Healthy. Click a tooth then select a condition.';
      } else {
        summary.innerHTML = abnormal.map(([k,v]) =>
          `<span style="display:inline-block;margin:2px 3px;padding:2px 7px;border-radius:4px;background:var(--navy2);border:1px solid ${DC_COLORS[v]};font-size:0.7rem;color:${DC_COLORS[v]};font-weight:600">${k}: ${v}</span>`
        ).join('');
      }
    }
  }

  function dcClear() {
    [...DC_UPPER, ...DC_LOWER].forEach(n => {
      _dc.chart[n] = 'healthy';
      const el = document.getElementById(`dct-${n}`);
      if (el) el.style.background = DC_COLORS.healthy;
    });
    dcUpdateStats();
    showToast('🗑', 'Chart Cleared', 'All teeth reset to Healthy');
  }

  // ── Perio depth tracking ───────────────────────────────────────
  function dcUpdatePerio() {
    const depths = DC_PERIO_TEETH.map(n => {
      const v = parseInt(document.getElementById(`perio-${n}`)?.value) || 0;
      _dc.perio[n] = v;
      return v;
    }).filter(v => v > 0);

    const p4  = depths.filter(d => d >= 4).length;
    const p6  = depths.filter(d => d >= 6).length;
    const avg = depths.length ? (depths.reduce((a,b)=>a+b,0)/depths.length).toFixed(1) : 0;
    const kp  = document.getElementById('kpiPockets');
    if (kp) kp.textContent = p4;

    const sum = document.getElementById('perioSummary');
    if (!sum) return;
    if (!depths.length) {
      sum.textContent = 'Enter pocket depths to see automated classification';
      return;
    }
    let cls = 'Gingivitis / Healthy', clsColor = 'var(--green)';
    if (p6 > 0)      { cls = 'Stage III–IV Periodontitis';   clsColor = 'var(--red)'; }
    else if (p4 >= 3){ cls = 'Stage II Periodontitis';       clsColor = 'var(--gold)'; }
    else if (p4 > 0) { cls = 'Stage I / Early Periodontitis'; clsColor = 'var(--gold)'; }
    sum.innerHTML =
      `Avg depth: <strong style="color:var(--teal)">${avg} mm</strong> &nbsp;·&nbsp;
       Pockets ≥4 mm: <strong style="color:var(--gold)">${p4}</strong> &nbsp;·&nbsp;
       Pockets ≥6 mm: <strong style="color:var(--red)">${p6}</strong> &nbsp;·&nbsp;
       Classification: <strong style="color:${clsColor}">${cls}</strong>`;
  }

  // ── Perio AI Classification ────────────────────────────────────
  async function runPerioAI() {
    const depths = DC_PERIO_TEETH.map(n => {
      const v = document.getElementById(`perio-${n}`)?.value;
      return v ? `Tooth ${n}: ${v}mm` : null;
    }).filter(Boolean);
    if (!depths.length) { showToast('⚠️','No Data','Enter pocket depths first'); return; }

    showToast('🔍','Perio AI','Classifying…');
    const sys = `You are a periodontology AI assistant. Classify periodontal disease using the 2018 World Workshop system (Staging I–IV, Grading A–C). Be concise and actionable. 3–5 sentences max.`;
    try {
      const txt = await callClaudeAI(
        [{ role:'user', content:`Pocket depths recorded:\n${depths.join('\n')}\n\nProvide: 1) Classification (Stage/Grade), 2) Clinical significance, 3) Priority treatment recommendation.` }],
        sys
      );
      document.getElementById('perioSummary').innerHTML =
        `<span style="color:var(--teal);font-weight:700">🤖 AI Classification:</span> ${txt.replace(/\n/g,'<br>')}`;
      showToast('✅','Perio Classified','AI classification ready');
    } catch(e) { showToast('❌','Failed',e.message); }
  }

  // ── Dental X-ray AI ────────────────────────────────────────────
  function handleDentalXray(e) {
    handleDentalXrayFiles(e.target.files);
    e.target.value = '';
  }
  function handleDentalXrayFiles(files) {
    const file = files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
      const zone   = document.getElementById('xrayDropZone');
      const result = document.getElementById('xrayResult');

      zone.innerHTML = `
        <img src="${ev.target.result}" style="max-width:100%;max-height:260px;border-radius:8px;object-fit:contain;background:#000">
        <div style="margin-top:8px;font-size:0.76rem;color:var(--teal);font-weight:600;text-align:center">Analysing with Claude Vision AI…</div>`;
      result.style.display = 'block';
      result.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--teal-dim);border-radius:8px">
          <span style="font-size:1rem">🔍</span>
          <span style="font-size:0.82rem;color:var(--teal);font-weight:600">Processing radiograph…</span>
        </div>`;

      const isImage = file.type.startsWith('image/');
      if (!isImage) {
        result.innerHTML = `<div style="padding:12px;background:var(--gold-dim);border-radius:8px;font-size:0.8rem;color:var(--gold)">⚠️ For best results upload a JPEG or PNG image. PDF analysis uses filename heuristics only.</div>`;
        return;
      }

      const sys = `You are a dental radiograph AI. Analyse the uploaded dental radiograph image. Respond ONLY with valid JSON — no markdown fences, no extra text.
Schema: { "modality": "string", "findings": [{"severity":"critical|moderate|normal","tooth":"FDI number or region","detail":"description"}], "impression":"string", "recommendations":["string"], "confidence":85 }`;
      try {
        const base64 = ev.target.result.split(',')[1];
        const raw = await callClaudeAI([{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: file.type, data: base64 } },
            { type: 'text', text: 'Analyse this dental radiograph. Return JSON only.' }
          ]
        }], sys);
        const parsed = JSON.parse(raw.replace(/^```(?:json)?\s*/i,'').replace(/\s*```$/i,'').trim());
        const sevColor = { critical:'var(--red)', moderate:'var(--gold)', normal:'var(--teal)' };
        const fHtml = (parsed.findings||[]).map(f =>
          `<div style="padding:8px 10px;background:var(--navy3);border-left:3px solid ${sevColor[f.severity]||'var(--teal)'};border-radius:6px;margin-bottom:6px">
            <div style="font-weight:600;font-size:0.8rem;color:var(--text1)">Tooth ${f.tooth}</div>
            <div style="font-size:0.74rem;color:var(--text2);margin-top:2px">${f.detail}</div>
           </div>`
        ).join('');
        result.innerHTML = `
          <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--teal);margin-bottom:8px">${parsed.modality||'Radiograph'} · AI Analysis</div>
          ${fHtml}
          <div style="padding:10px;background:var(--navy3);border-radius:8px;font-size:0.78rem;color:var(--text2);line-height:1.6;margin-top:8px">
            <strong style="color:var(--text1)">Impression:</strong> ${parsed.impression||''}
          </div>
          ${(parsed.recommendations||[]).length ? `
          <div style="margin-top:10px">
            ${parsed.recommendations.map(r=>`<div style="font-size:0.76rem;color:var(--text2);margin-bottom:3px">• ${r}</div>`).join('')}
          </div>` : ''}
          <div style="margin-top:8px;font-size:0.68rem;color:var(--text3)">AI Confidence: ${parsed.confidence||'N/A'}% · Verify against clinical examination</div>`;
        zone.innerHTML = `
          <img src="${ev.target.result}" style="max-width:100%;max-height:260px;border-radius:8px;object-fit:contain;background:#000">
          <div style="margin-top:8px;text-align:center">
            <span style="font-size:0.7rem;background:var(--teal-dim);color:var(--teal);padding:2px 10px;border-radius:20px;font-weight:600">✓ Analysed</span>
            <span class="btn btn-ghost btn-sm" style="margin-left:8px;font-size:0.7rem;cursor:pointer" onclick="document.getElementById('dentalXrayInput').click()">Change</span>
          </div>`;
        showToast('✅','Radiograph Analysed',`${(parsed.findings||[]).length} findings identified`);
      } catch(err) {
        result.innerHTML = `<div style="padding:12px;background:var(--red-dim);border-radius:8px;font-size:0.8rem;color:var(--red)">Analysis failed: ${err.message}</div>`;
        showToast('❌','X-ray AI Failed',err.message);
      }
    };
    reader.readAsDataURL(file);
  }

  // ── Main dental AI diagnosis ───────────────────────────────────
  async function runDentalAI() {
    const complaint  = document.getElementById('dcComplaint')?.value   || 'Not specified';
    const pain       = document.getElementById('dcPain')?.value        || '0';
    const duration   = document.getElementById('dcDuration')?.value    || 'Not specified';
    const medHx      = document.getElementById('dcMedHx')?.value       || 'None';
    const notes      = document.getElementById('dcNotes')?.value       || '';

    const chartFindings = Object.entries(_dc.chart)
      .filter(([,v]) => v !== 'healthy')
      .map(([k,v]) => `Tooth ${k}: ${v}`)
      .join(', ') || 'No marked conditions';

    const perioFindings = DC_PERIO_TEETH
      .map(n => { const v = document.getElementById(`perio-${n}`)?.value; return v ? `${n}: ${v}mm` : null; })
      .filter(Boolean).join(', ') || 'Not recorded';

    const output = document.getElementById('dcAIOutput');
    output.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--teal-dim);border-radius:10px">
        <div style="font-size:1.1rem">🔍</div>
        <div>
          <div style="font-weight:700;font-size:0.85rem;color:var(--teal)">Generating dental assessment…</div>
          <div style="font-size:0.72rem;color:var(--text3);margin-top:2px">Analysing chart, pocket depths and clinical history</div>
        </div>
      </div>`;

    const sys = `You are SamarthaaMed Dental AI, an expert dental clinical decision support assistant embedded in a clinical platform for trained dentists and oral medicine specialists. Follow IDA (Indian Dental Association), ICMR, and WHO Oral Health 2030 guidelines.

Respond ONLY with a valid JSON object — no markdown, no text outside JSON.

Schema:
{
  "diagnosis": {
    "primary": "main diagnosis",
    "differential": ["differential 1", "differential 2"],
    "icd": "ICD-11 or ICD-10 code"
  },
  "urgency": "immediate|urgent|routine",
  "clinical_notes": "key clinical reasoning in 2-3 sentences",
  "treatment_plan": [
    { "phase": "Phase label", "procedures": ["procedure 1", "procedure 2"] }
  ],
  "medications": [
    { "drug": "Name dose frequency duration", "indication": "reason" }
  ],
  "referral": "referral recommendation or null",
  "patient_instructions": ["instruction 1", "instruction 2", "instruction 3"]
}`;

    const msg = `Dental clinical intake:
- Chief Complaint: ${complaint}
- Pain (0–10): ${pain}
- Duration: ${duration}
- Medical/Drug History: ${medHx}
- Additional Notes: ${notes}
- Dental Chart Findings: ${chartFindings}
- Periodontal Pocket Depths: ${perioFindings}

Generate a structured dental diagnosis and phased treatment plan. Return JSON only.`;

    try {
      const raw = await callClaudeAI([{ role:'user', content:msg }], sys);
      const parsed = JSON.parse(raw.replace(/^```(?:json)?\s*/i,'').replace(/\s*```$/i,'').trim());
      renderDentalAssessment(parsed);
    } catch(err) {
      output.innerHTML = `
        <div style="padding:14px;background:var(--red-dim);border:1px solid var(--red);border-radius:10px">
          <div style="font-weight:700;color:var(--red)">Assessment Failed</div>
          <div style="font-size:0.8rem;color:var(--text2);margin-top:6px">${err.message}</div>
          <div style="font-size:0.72rem;color:var(--text3);margin-top:4px">Check your API key in Settings and try again.</div>
        </div>`;
      showToast('❌','Dental AI Failed',err.message);
    }
  }

  function renderDentalAssessment(d) {
    const urgMap = {
      immediate: { bg:'var(--red-dim)',  tc:'var(--red)',  label:'⚡ IMMEDIATE — Treat today' },
      urgent:    { bg:'var(--gold-dim)', tc:'var(--gold)', label:'⚠️ URGENT — Within 24–48 hours' },
      routine:   { bg:'var(--teal-dim)', tc:'var(--teal)', label:'📅 ROUTINE — Schedule appointment' }
    };
    const urg = urgMap[(d.urgency||'routine').toLowerCase()] || urgMap.routine;
    const numColors = ['var(--red)','var(--gold)','var(--teal)','var(--purple)','var(--cyan)'];

    const phasesHtml = (d.treatment_plan||[]).map((phase,i) => `
      <div style="margin-bottom:10px">
        <div style="font-weight:700;font-size:0.76rem;color:var(--teal);margin-bottom:5px">${phase.phase}</div>
        ${(phase.procedures||[]).map(p =>
          `<div style="font-size:0.77rem;color:var(--text2);padding:5px 8px;background:var(--navy3);border-radius:6px;margin-bottom:3px;display:flex;align-items:center;gap:6px">
             <span style="color:var(--teal);font-size:0.8rem">›</span>${p}
           </div>`
        ).join('')}
      </div>`).join('');

    const medsHtml = (d.medications||[]).map(m =>
      `<div style="padding:8px 10px;background:var(--navy3);border-radius:8px;margin-bottom:5px">
        <div style="font-weight:600;font-size:0.8rem;color:var(--text1)">${m.drug}</div>
        <div style="font-size:0.7rem;color:var(--teal);margin-top:2px">${m.indication}</div>
       </div>`
    ).join('');

    const instrHtml = (d.patient_instructions||[]).map(s =>
      `<div style="font-size:0.77rem;color:var(--text2);margin-bottom:3px">• ${s}</div>`
    ).join('');

    document.getElementById('dcAIOutput').innerHTML = `
      <!-- Urgency + Diagnosis -->
      <div style="padding:12px 14px;background:${urg.bg};border-radius:8px;margin-bottom:14px">
        <div style="font-weight:700;font-size:0.8rem;color:${urg.tc};margin-bottom:4px">${urg.label}</div>
        <div style="font-weight:700;font-size:0.92rem;color:var(--text1)">${d.diagnosis?.primary||''}</div>
        ${(d.diagnosis?.differential||[]).length ? `<div style="font-size:0.7rem;color:var(--text3);margin-top:3px">DDx: ${d.diagnosis.differential.join(' · ')}</div>` : ''}
        ${d.diagnosis?.icd ? `<div style="font-size:0.68rem;color:var(--text3);margin-top:2px">ICD: ${d.diagnosis.icd}</div>` : ''}
      </div>

      <!-- Clinical notes -->
      ${d.clinical_notes ? `
      <div style="margin-bottom:14px">
        <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--teal);font-weight:700;margin-bottom:5px">Clinical Reasoning</div>
        <div style="font-size:0.8rem;color:var(--text2);line-height:1.6;padding:10px;background:var(--navy3);border-radius:8px">${d.clinical_notes}</div>
      </div>` : ''}

      <!-- Treatment plan -->
      ${phasesHtml ? `
      <div style="margin-bottom:14px">
        <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--teal);font-weight:700;margin-bottom:8px">Treatment Plan</div>
        ${phasesHtml}
      </div>` : ''}

      <!-- Medications -->
      ${medsHtml ? `
      <div style="margin-bottom:14px">
        <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--teal);font-weight:700;margin-bottom:8px">Medications</div>
        ${medsHtml}
      </div>` : ''}

      <!-- Referral -->
      ${d.referral ? `
      <div style="margin-bottom:14px;padding:10px;background:var(--gold-dim);border-left:3px solid var(--gold);border-radius:8px">
        <div style="font-weight:700;font-size:0.76rem;color:var(--gold)">Referral Recommended</div>
        <div style="font-size:0.76rem;color:var(--text2);margin-top:3px">${d.referral}</div>
      </div>` : ''}

      <!-- Patient instructions -->
      ${instrHtml ? `
      <div style="margin-bottom:10px">
        <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--teal);font-weight:700;margin-bottom:6px">Patient Instructions</div>
        ${instrHtml}
      </div>` : ''}

      <div style="font-size:0.65rem;color:var(--text3);margin-top:6px;padding-top:8px;border-top:1px solid var(--border2)">
        🤖 Claude AI · IDA / ICMR Guidelines · ${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}
      </div>`;

    // Populate procedure planner from treatment plan
    (d.treatment_plan||[]).flatMap(p=>p.procedures||[]).forEach(p => addProc(p, false));

    showToast('✅','Dental Assessment Ready', d.diagnosis?.primary || 'Diagnosis generated');
  }

  // ── Procedure planner ──────────────────────────────────────────
  function addProc(name, notify = true) {
    if (_dc.procs.includes(name)) return;
    _dc.procs.push(name);
    const kp = document.getElementById('kpiProcs');
    if (kp) kp.textContent = _dc.procs.length;
    _renderProcList();
    if (notify) showToast('📋','Procedure Added', name);
  }

  function removeProc(idx) {
    _dc.procs.splice(idx, 1);
    const kp = document.getElementById('kpiProcs');
    if (kp) kp.textContent = _dc.procs.length;
    _renderProcList();
  }

  function _renderProcList() {
    const el = document.getElementById('procList');
    if (!el) return;
    if (!_dc.procs.length) {
      el.innerHTML = '<div style="font-size:0.76rem;color:var(--text3);text-align:center;padding:14px">No procedures planned yet</div>';
      return;
    }
    el.innerHTML = _dc.procs.map((p,i) => `
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--navy3);border-radius:8px">
        <span style="width:20px;height:20px;border-radius:50%;background:var(--teal);color:var(--navy);font-size:0.62rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0">${i+1}</span>
        <span style="flex:1;font-size:0.79rem;color:var(--text1)">${p}</span>
        <button style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.9rem;padding:0 3px;line-height:1" onclick="removeProc(${i})">×</button>
      </div>`).join('');
  }

  function generateTxSummary() {
    if (!_dc.procs.length) { showToast('⚠️','No Procedures','Add procedures first'); return; }
    const win = window.open('','_blank');
    const abnormal = Object.entries(_dc.chart).filter(([,v]) => v!=='healthy')
      .map(([k,v]) => `<span style="padding:2px 7px;margin:2px;border-radius:4px;background:#f3f4f6;font-size:0.78rem;display:inline-block"><strong>${k}</strong>: ${v}</span>`).join('');
    const ai = document.getElementById('dcAIOutput')?.innerHTML || '';
    win.document.write(`<!DOCTYPE html><html><head><title>Dental Treatment Summary</title>
    <style>body{font-family:Arial,sans-serif;padding:24px;max-width:800px;margin:0 auto;color:#1f2937}
    .hdr{text-align:center;border-bottom:2px solid #0d9488;padding-bottom:16px;margin-bottom:24px}
    h2{color:#0d9488;font-size:0.85rem;text-transform:uppercase;letter-spacing:1px;margin:20px 0 8px}
    li{margin-bottom:4px;font-size:0.85rem}@media print{.np{display:none}}</style></head><body>
    <div class="hdr"><div style="font-size:1.3rem;font-weight:800;color:#0d9488">🦷 SamarthaaMed · Dental Treatment Summary</div>
    <div style="font-size:0.78rem;color:#666;margin-top:4px">${new Date().toLocaleDateString('en-IN')}</div></div>
    <h2>Chart Findings</h2><div style="margin-bottom:16px">${abnormal || '<em>All teeth healthy</em>'}</div>
    <h2>Planned Procedures</h2><ol>${_dc.procs.map(p=>`<li>${p}</li>`).join('')}</ol>
    <h2>AI Clinical Assessment</h2><div style="font-size:0.83rem;line-height:1.7">${ai}</div>
    <div class="np" style="margin-top:24px;text-align:center;display:flex;gap:10px;justify-content:center">
    <button onclick="window.print()" style="padding:10px 22px;background:#0d9488;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">🖨 Print</button>
    <button onclick="window.close()" style="padding:10px 22px;background:#666;color:white;border:none;border-radius:8px;cursor:pointer">Close</button>
    </div></body></html>`);
    win.document.close();
  }

  // ── Drug AI ────────────────────────────────────────────────────
  async function runDentalDrugAI() {
    const complaint = document.getElementById('dcComplaint')?.value || 'dental pain';
    const medHx     = document.getElementById('dcMedHx')?.value    || 'none';
    showToast('💊','Drug AI','Generating prescription…');
    const sys = `You are a dental pharmacology AI for Indian clinical practice. Prescribe drugs per IDA and ICMR guidelines. Respect the patient's medical history and allergy profile. Provide drug name, dose, frequency, duration and brief indication. Max 5 drugs. Plain text, no JSON.`;
    try {
      const res = await callClaudeAI(
        [{ role:'user', content:`Dental condition: ${complaint}\nMedical history/allergies: ${medHx}\nRecommend appropriate dental medications.` }],
        sys
      );
      const el = document.getElementById('dcDrugAIOutput');
      if (el) {
        el.style.display = 'block';
        el.innerHTML = `
          <div style="margin-top:8px;padding:12px;background:var(--teal-dim);border-radius:8px;border-left:3px solid var(--teal)">
            <div style="font-weight:700;font-size:0.76rem;color:var(--teal);margin-bottom:6px">🤖 AI Prescription</div>
            <div style="font-size:0.79rem;color:var(--text2);line-height:1.7">${res.replace(/\n/g,'<br>')}</div>
          </div>`;
      }
      showToast('✅','Prescription Ready','AI drug recommendation generated');
    } catch(e) { showToast('❌','Drug AI Failed',e.message); }
  }

  // ── Utilities ──────────────────────────────────────────────────
  function copyDentalAssessment() {
    const txt = document.getElementById('dcAIOutput')?.innerText;
    if (!txt || txt.includes('Fill in')) { showToast('⚠️','Nothing to copy','Generate an assessment first'); return; }
    navigator.clipboard?.writeText(txt);
    showToast('📋','Copied','Assessment copied to clipboard');
  }

  function dcPrint() { generateTxSummary(); }

  // ── Hook into onViewChange to build chart on first open ────────
  const _origOnViewChange = onViewChange;
  window.onViewChange = onViewChange = function(id) {
    if (typeof _origOnViewChange === 'function') _origOnViewChange(id);
    if (id === 'dentistry' && !_dc.built) dcBuild();
  };


  /* ══════════════════════════════════════════════════════════════
     ELEVENLABS VOICE ENGINE
     Settings persistence · Test voice · Read-aloud for chat/dental
     ══════════════════════════════════════════════════════════════ */

  // ── Load saved settings into Settings UI on page load ───────────
  function elLoadSettings() {
    // Keys are system-configured — just show badge status
    const key     = _vault.get('elak') || '';
    const voiceId = _vault.get('elvi') || '';
    const model   = localStorage.getItem('el_model')      || 'eleven_multilingual_v2';
    const stab    = localStorage.getItem('el_stability')  || '0.5';
    const sim     = localStorage.getItem('el_similarity') || '0.85';

    // model/stability/similarity sliders are still user-adjustable
    const ms = document.getElementById('elModelSelect');
    const sl = document.getElementById('elStability');
    const si = document.getElementById('elSimilarity');
    const sv = document.getElementById('elStabilityVal');
    const siv= document.getElementById('elSimilarityVal');

    if (ms) ms.value = model;
    if (sl) { sl.value = Math.round(parseFloat(stab)*100); if(sv) sv.textContent = sl.value+'%'; }
    if (si) { si.value = Math.round(parseFloat(sim)*100);  if(siv) siv.textContent = si.value+'%'; }

    elUpdateBadge(key ? '✅ Configured' : '', voiceId ? '✅ Configured' : '');
  }

  function elUpdateBadge(key, voiceId) {
    const badge = document.getElementById('elStatusBadge');
    if (!badge) return;
    if (key && voiceId) {
      badge.style.background = 'var(--teal-dim)';
      badge.style.color = 'var(--teal)';
      badge.textContent = '● System Configured';
    } else {
      badge.style.background = 'var(--navy3)';
      badge.style.color = 'var(--text3)';
      badge.textContent = 'Not configured';
    }
  }

  // LOCKED — ElevenLabs key & voice ID are system-configured; UI cannot change them
  function elSaveSettings()        { showToast('🔒', 'Locked', 'API key & Voice ID are system-configured — contact your administrator'); }
  function elClearSettings()       { showToast('🔒', 'Locked', 'API key & Voice ID are system-configured — contact your administrator'); }
  function elToggleKeyVisibility() { /* no-op */ }

  async function elTestVoice() {
    const key     = _vault.get('elak') || '';
    const voiceId = _vault.get('elvi') || '';

    if (!key || !voiceId) {
      showToast('⚠️', 'Not Configured', 'Enter your API key and Voice ID first');
      return;
    }
    showToast('🎙️', 'Testing Voice', 'Connecting to ElevenLabs…');
    try {
      await _speakElevenLabs(
        'Hello! This is Samarthaa. Your ElevenLabs voice clone is working perfectly.',
        key, voiceId
      );
      showToast('✅', 'Voice Test Successful', 'Your ElevenLabs voice is working perfectly');
    } catch(err) {
      console.error('EL test error:', err);
      showToast('❌', 'Voice Test Failed', err.message);
    }
  }

  // ── Read-aloud button injected into chat AI responses ────────────
  function elAddReadAloudButton(msgBubble, text) {
    const useChat = document.getElementById('elUseChatRead');
    if (!useChat?.checked) return;
    const apiKey = _vault.get('elak');
    const voiceId = _vault.get('elvi');
    if (!apiKey || !voiceId) return; // only show if configured

    const btn = document.createElement('button');
    btn.title = 'Read aloud with your ElevenLabs voice';
    btn.style.cssText = [
      'background:none;border:none;cursor:pointer',
      'color:var(--teal);font-size:0.78rem',
      'padding:3px 6px;border-radius:6px',
      'margin-top:6px;display:inline-flex;align-items:center;gap:4px',
      'transition:background 0.15s'
    ].join(';');
    btn.innerHTML = '🔊 <span style="font-size:0.7rem">Read aloud</span>';
    btn.onmouseover = () => btn.style.background = 'var(--teal-dim)';
    btn.onmouseout  = () => btn.style.background = 'none';
    btn.onclick = async () => {
      if (window._elCurrentAudio) {
        window._elCurrentAudio.pause();
        window._elCurrentAudio = null;
        btn.innerHTML = '🔊 <span style="font-size:0.7rem">Read aloud</span>';
        return;
      }
      btn.innerHTML = '⏹ <span style="font-size:0.7rem">Stop</span>';
      try {
        await _speakElevenLabs(text, apiKey, voiceId);
      } catch(e) {
        showToast('⚠️', 'Playback Error', e.message);
      }
      btn.innerHTML = '🔊 <span style="font-size:0.7rem">Read aloud</span>';
    };
    msgBubble.appendChild(btn);
  }

  // ── Read-aloud helper callable from dental/radiology AI ──────────
  async function elReadAloud(text, context) {
    const apiKey  = _vault.get('elak');
    const voiceId = _vault.get('elvi');

    // Check the right checkbox for this context
    const checkboxId = context === 'dental' ? 'elUseDentalRead' : 'elUseChatRead';
    const cb = document.getElementById(checkboxId);
    if (!cb?.checked) { showToast('ℹ️','Read Aloud Disabled',`Enable "${cb?.parentElement?.textContent?.trim() || context}" in Settings → ElevenLabs Voice`); return; }
    if (!apiKey || !voiceId) { showToast('⚠️','Not Configured','Add your ElevenLabs API key and Voice ID in Settings'); return; }

    showToast('🔊', 'Reading Aloud', 'Your ElevenLabs voice is speaking…');
    try {
      await _speakElevenLabs(text, apiKey, voiceId);
    } catch(e) {
      showToast('❌', 'Playback Failed', e.message);
      // Fallback to browser TTS
      const utt = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.speak(utt);
    }
  }

  // ── Initialise on load ───────────────────────────────────────────
  document.addEventListener('DOMContentLoaded', () => {
    elLoadSettings();

    // Auto-load when Settings view is opened
    const origOnVC = typeof onViewChange === 'function' ? onViewChange : null;
    // Use a MutationObserver pattern instead of patching onViewChange again
    // Settings view will call elLoadSettings via onViewChange extension below
  });

  // Extend onViewChange to reload EL settings when Settings is opened
  const _elOrigOnVC = typeof onViewChange === 'function' ? onViewChange : null;
  if (_elOrigOnVC) {
    window.onViewChange = onViewChange = function(id) {
      _elOrigOnVC(id);
      if (id === 'settings')   setTimeout(elLoadSettings, 50);
      if (id === 'radiology')  setTimeout(pacsInit, 80);
    };
  }

  // ══════════════════════════════════════════════════════════════════════════
  //  PACS / DICOM VIEWER  (Orthanc integration)
  // ══════════════════════════════════════════════════════════════════════════

  // ── state ──────────────────────────────────────────────────────────────────
  let _pacsStudies       = [];   // full study list from Orthanc
  let _pacsCurrentStudy  = null; // selected study object
  let _pacsCurrentSeries = null; // selected series object
  let _pacsInstances     = [];   // instances of current series
  let _pacsFrameIdx      = 0;    // current frame index
  let _pacsFrameTotal    = 1;
  let _pacsZoom          = 1;
  let _pacsInverted      = false;
  let _pacsDemoActive    = false;

  // ── DEMO data (shown when no Orthanc configured) ───────────────────────────
  const PACS_DEMO_STUDIES = [
    { ID:'demo-1', MainDicomTags:{ PatientName:'Priya Krishnamurthy', PatientID:'MM-2024-04521', StudyDate:'20240215', StudyDescription:'Chest X-Ray PA', StudyInstanceUID:'1.2.3.4.1' }, Series:['demo-s1'], Modalities:['CR'] },
    { ID:'demo-2', MainDicomTags:{ PatientName:'Ramesh Singh',        PatientID:'MM-2023-01892', StudyDate:'20240110', StudyDescription:'CT Head Plain',  StudyInstanceUID:'1.2.3.4.2' }, Series:['demo-s2'], Modalities:['CT'] },
    { ID:'demo-3', MainDicomTags:{ PatientName:'Anita Mehta',         PatientID:'MM-2025-09341', StudyDate:'20250118', StudyDescription:'MRI Knee Left',   StudyInstanceUID:'1.2.3.4.3' }, Series:['demo-s3'], Modalities:['MR'] },
    { ID:'demo-4', MainDicomTags:{ PatientName:'Vikram Nair',         PatientID:'MM-2024-07234', StudyDate:'20240322', StudyDescription:'USG Abdomen',     StudyInstanceUID:'1.2.3.4.4' }, Series:['demo-s4'], Modalities:['US'] },
    { ID:'demo-5', MainDicomTags:{ PatientName:'Nandini Bose',        PatientID:'MM-2025-08876', StudyDate:'20250201', StudyDescription:'Thyroid USG',     StudyInstanceUID:'1.2.3.4.5' }, Series:['demo-s5'], Modalities:['US'] },
  ];

  // ── init ───────────────────────────────────────────────────────────────────
  async function pacsInit() {
    await _loadConfig();
    if (_orthancBase) {
      pacsConnect();
    } else {
      pacsShowNotConnected();
    }
    _updatePacsBadge();
  }

  async function pacsConnect() {
    const sub = document.getElementById('pacsSubtitle');
    const notConn = document.getElementById('pacsNotConnected');
    const main    = document.getElementById('pacsMain');
    if (sub) sub.textContent = 'Connecting to Orthanc…';
    try {
      const sys = await orthancSystemInfo();
      if (sub) sub.textContent = `Connected · Orthanc ${sys.Version} · ${sys.Name || 'PACS'}`;
      if (notConn) notConn.style.display = 'none';
      if (main)    main.style.display    = 'block';
      const ohifBtn = document.getElementById('pacsOhifBtn');
      if (ohifBtn) ohifBtn.style.display = 'inline-flex';
      _pacsDemoActive = false;
      await orthancRefreshStudies();
    } catch(e) {
      if (sub) sub.textContent = 'Could not reach Orthanc — check URL / CORS';
      pacsShowNotConnected();
    }
  }

  function pacsShowNotConnected() {
    const el = document.getElementById('pacsNotConnected');
    const main = document.getElementById('pacsMain');
    const sub  = document.getElementById('pacsSubtitle');
    if (el)   el.style.display   = 'block';
    if (main) main.style.display = 'none';
    if (sub && !_orthancBase) sub.textContent = 'Not connected — configure Orthanc credentials';
  }

  async function orthancTestConnection() {
    showToast('🔌','Testing connection…','Reaching out to Orthanc');
    await _loadConfig();
    if (!_orthancBase) {
      showToast('⚠️','Not configured','Add ORTHANC_URL to Netlify environment variables');
      return;
    }
    try {
      const sys = await orthancSystemInfo();
      showToast('✅','Connected!',`Orthanc ${sys.Version} · ${sys.Name}`);
      _updatePacsBadge();
    } catch(e) {
      showToast('❌','Connection failed', e.message || 'Check URL and credentials');
    }
  }

  // ── study list ─────────────────────────────────────────────────────────────
  async function orthancRefreshStudies() {
    pacsSetStudyListLoading(true);
    try {
      // fetch all study IDs then bulk-expand
      const ids = await orthancGet('/studies');
      const studies = await Promise.all(
        ids.slice(0, 100).map(id => orthancGet(`/studies/${id}`))
      );
      _pacsStudies = studies;
      pacsRenderStudyList(studies);
    } catch(e) {
      pacsSetStudyListLoading(false);
      showToast('❌','PACS Error', e.message);
    }
  }

  function pacsSetStudyListLoading(on) {
    const el = document.getElementById('pacsStudyList');
    const ct = document.getElementById('pacsStudyCount');
    if (!el) return;
    if (on) {
      el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:0.8rem">Loading studies…</div>';
      if (ct) ct.textContent = '…';
    }
  }

  function pacsRenderStudyList(studies) {
    const el = document.getElementById('pacsStudyList');
    const ct = document.getElementById('pacsStudyCount');
    if (!el) return;
    if (ct) ct.textContent = `${studies.length} studies`;
    if (!studies.length) {
      el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:0.8rem">No studies found</div>';
      return;
    }
    const modIcon = { CR:'🫁', DX:'🫁', CT:'🧠', MR:'🧲', US:'🔊', PT:'☢️', NM:'☢️', MG:'🩺', OT:'📋' };
    el.innerHTML = studies.map(s => {
      const t = s.MainDicomTags || {};
      const name = (t.PatientName || 'Unknown Patient').replace(/\^/g,' ');
      const desc = t.StudyDescription || t.StudyInstanceUID?.slice(-8) || '—';
      const date = t.StudyDate ? t.StudyDate.replace(/(\d{4})(\d{2})(\d{2})/, '$3/$2/$1') : '—';
      const mods = (s.Modalities || [s.RequestedProcedureDescription]).filter(Boolean);
      const icon = modIcon[mods[0]] || '🩻';
      const serCount = (s.Series || []).length;
      return `<div class="pacs-study-row" onclick="pacsSelectStudy('${s.ID}')" style="padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='var(--teal-dim)'" onmouseout="this.style.background=''">
        <div style="display:flex;align-items:flex-start;gap:10px">
          <div style="font-size:1.4rem;flex-shrink:0;margin-top:2px">${icon}</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:0.82rem;font-weight:700;color:var(--text1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
            <div style="font-size:0.75rem;color:var(--teal);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${desc}</div>
            <div style="display:flex;gap:6px;margin-top:4px;align-items:center;flex-wrap:wrap">
              <span style="font-size:0.68rem;color:var(--text3)">${date}</span>
              ${mods.map(m=>`<span style="font-size:0.65rem;background:var(--navy3);color:var(--text2);padding:1px 6px;border-radius:3px;border:1px solid var(--border2)">${m}</span>`).join('')}
              <span style="font-size:0.68rem;color:var(--text3)">${serCount} series</span>
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  async function pacsSearch(query) {
    const modality = document.getElementById('pacsModalityFilter')?.value || '';
    let filtered = _pacsStudies;
    if (query) {
      const q = query.toLowerCase();
      filtered = filtered.filter(s => {
        const t = s.MainDicomTags || {};
        return (t.PatientName||'').toLowerCase().includes(q) ||
               (t.PatientID||'').toLowerCase().includes(q) ||
               (t.StudyDescription||'').toLowerCase().includes(q);
      });
    }
    if (modality) {
      filtered = filtered.filter(s => (s.Modalities||[]).includes(modality));
    }
    pacsRenderStudyList(filtered);
  }

  // ── select study → load series ─────────────────────────────────────────────
  async function pacsSelectStudy(studyId) {
    // Highlight selected row
    document.querySelectorAll('.pacs-study-row').forEach(r => r.style.background = '');
    const rows = document.querySelectorAll('.pacs-study-row');
    rows.forEach(r => { if ((r.getAttribute('onclick')||'').includes(studyId)) r.style.background = 'var(--teal-dim)'; });

    const viewer = document.getElementById('pacsDicomViewer');
    const placeholder = document.getElementById('pacsViewerPlaceholder');
    if (placeholder) {
      placeholder.innerHTML = '<div style="font-size:0.85rem;color:var(--text3)">Loading series…</div>';
      placeholder.style.display = 'flex';
    }

    try {
      const study = _pacsDemoActive
        ? PACS_DEMO_STUDIES.find(s => s.ID === studyId)
        : await orthancGetStudy(studyId);

      _pacsCurrentStudy = study;
      pacsRenderMeta(study);

      // Load series bar
      const seriesBar  = document.getElementById('pacsSeriesBar');
      const seriesList = document.getElementById('pacsSeriesList');
      if (seriesBar) seriesBar.style.display = 'block';
      if (seriesList) seriesList.innerHTML = '<span style="font-size:0.78rem;color:var(--text3)">Loading…</span>';

      const seriesIds = study.Series || [];
      const seriesObjs = _pacsDemoActive
        ? seriesIds.map(id => ({ ID: id, MainDicomTags: { SeriesDescription: 'Demo Series', Modality: 'CR' }, Instances: ['demo-inst-1'] }))
        : await Promise.all(seriesIds.map(id => orthancGetSeries(id)));

      if (seriesList) {
        const modIcon = { CR:'🫁', DX:'🫁', CT:'🧠', MR:'🧲', US:'🔊', PT:'☢️', NM:'☢️', MG:'🩺', OT:'📋' };
        seriesList.innerHTML = seriesObjs.map((s, i) => {
          const desc = s.MainDicomTags?.SeriesDescription || s.MainDicomTags?.Modality || `Series ${i+1}`;
          const mod  = s.MainDicomTags?.Modality || '';
          const icon = modIcon[mod] || '🩻';
          return `<button onclick="pacsSelectSeries('${s.ID}')" style="background:var(--navy3);border:1px solid var(--border2);border-radius:8px;padding:6px 12px;color:var(--text1);cursor:pointer;font-size:0.75rem;display:flex;align-items:center;gap:6px;transition:all 0.15s" onmouseover="this.style.background='var(--teal-dim)';this.style.borderColor='var(--teal)'" onmouseout="this.style.background='var(--navy3)';this.style.borderColor='var(--border2)'">${icon} ${desc}<span style="color:var(--text3);font-size:0.68rem">${(s.Instances||[]).length} img</span></button>`;
        }).join('');
      }

      // Auto-select first series
      if (seriesObjs.length) pacsSelectSeries(seriesObjs[0].ID, seriesObjs[0]);
    } catch(e) {
      showToast('❌', 'Load error', e.message);
    }
  }

  async function pacsSelectSeries(seriesId, seriesObj) {
    try {
      const series = seriesObj || (_pacsDemoActive
        ? { ID: seriesId, MainDicomTags: { Modality: 'CR' }, Instances: ['demo-inst-1'] }
        : await orthancGetSeries(seriesId));

      _pacsCurrentSeries = series;
      _pacsInstances = series.Instances || [];
      _pacsFrameIdx  = 0;
      _pacsFrameTotal = _pacsInstances.length;
      pacsLoadFrame(0);

      // Highlight selected series button
      document.querySelectorAll('#pacsSeriesList button').forEach(b => {
        const active = (b.getAttribute('onclick')||'').includes(seriesId);
        b.style.background   = active ? 'var(--teal-dim)' : 'var(--navy3)';
        b.style.borderColor  = active ? 'var(--teal)'     : 'var(--border2)';
        b.style.color        = active ? 'var(--teal)'     : 'var(--text1)';
      });
    } catch(e) {
      showToast('❌', 'Series error', e.message);
    }
  }

  function pacsLoadFrame(frameIdx) {
    const img        = document.getElementById('pacsDicomImg');
    const placeholder = document.getElementById('pacsViewerPlaceholder');
    const frameLabel  = document.getElementById('pacsFrameLabel');
    const frameNav    = document.getElementById('pacsFrameNav');
    const toolbar     = document.getElementById('pacsToolbar');

    if (!img) return;
    _pacsFrameIdx = Math.max(0, Math.min(frameIdx, _pacsInstances.length - 1));
    const instanceId = _pacsInstances[_pacsFrameIdx];
    if (!instanceId) return;

    if (placeholder) placeholder.style.display = 'none';
    img.style.display = 'block';
    img.style.transform = `scale(1)`;
    _pacsZoom = 1;
    _pacsInverted = false;
    img.style.filter = '';

    if (_pacsDemoActive) {
      // Demo: use public sample chest X-ray images
      const demos = [
        'https://upload.wikimedia.org/wikipedia/commons/thumb/9/96/CXR_NIH_PA_Chest.jpg/768px-CXR_NIH_PA_Chest.jpg',
        'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Chest_Xray_PA_3-8-2010.png/768px-Chest_Xray_PA_3-8-2010.png',
      ];
      img.src = demos[_pacsFrameIdx % demos.length];
    } else {
      // Route through Netlify proxy — no CORS, auth handled server-side
      img.src = orthancThumbUrl(instanceId);
    }

    if (frameLabel) frameLabel.textContent = `Image ${_pacsFrameIdx + 1} / ${_pacsInstances.length}`;
    if (frameNav)  frameNav.style.display   = _pacsInstances.length > 1 ? 'flex' : 'none';
    if (toolbar)   toolbar.style.display    = 'flex';
  }

  function pacsImgLoaded(img) { img.style.opacity = 1; }
  function pacsImgError(img) {
    img.style.display = 'none';
    const p = document.getElementById('pacsViewerPlaceholder');
    if (p) {
      p.style.display = 'flex';
      p.innerHTML = `<div style="text-align:center;padding:20px"><div style="font-size:2rem;margin-bottom:10px">⚠️</div><div style="font-size:0.85rem;color:var(--gold)">Could not load image</div><div style="font-size:0.75rem;color:var(--text3);margin-top:6px">Orthanc may require basic-auth on the /instances endpoint.<br>Consider using OHIF Viewer for authenticated access.</div><button class="btn btn-primary btn-sm" onclick="pacsOpenOhifStudy()" style="margin-top:12px">🖥 Open in OHIF Viewer</button></div>`;
    }
  }

  function pacsFrame(delta) {
    pacsLoadFrame(_pacsFrameIdx + delta);
  }

  // ── viewer controls ────────────────────────────────────────────────────────
  function pacsZoom(factor) {
    _pacsZoom = Math.max(0.2, Math.min(6, _pacsZoom * factor));
    const img = document.getElementById('pacsDicomImg');
    if (img) img.style.transform = `scale(${_pacsZoom})`;
  }

  function pacsResetView() {
    _pacsZoom = 1;
    _pacsInverted = false;
    const img = document.getElementById('pacsDicomImg');
    if (img) { img.style.transform = 'scale(1)'; img.style.filter = ''; }
  }

  function pacsInvert() {
    _pacsInverted = !_pacsInverted;
    const img = document.getElementById('pacsDicomImg');
    if (img) img.style.filter = _pacsInverted ? 'invert(1)' : '';
  }

  function pacsDownload() {
    const img = document.getElementById('pacsDicomImg');
    if (!img || !img.src) return;
    const a = document.createElement('a');
    a.href = img.src;
    a.download = `dicom-${Date.now()}.jpg`;
    a.click();
  }

  // ── metadata panel ─────────────────────────────────────────────────────────
  function pacsRenderMeta(study) {
    const panel = document.getElementById('pacsMetaPanel');
    const content = document.getElementById('pacsMetaContent');
    if (!panel || !content) return;
    panel.style.display = 'block';
    const t = study.MainDicomTags || {};
    const fields = [
      ['Patient',      (t.PatientName||'—').replace(/\^/g,' ')],
      ['Patient ID',   t.PatientID||'—'],
      ['Date of Birth',t.PatientBirthDate||'—'],
      ['Study Date',   (t.StudyDate||'—').replace(/(\d{4})(\d{2})(\d{2})/,'$3/$2/$1')],
      ['Study',        t.StudyDescription||'—'],
      ['Study ID',     t.StudyID||t.StudyInstanceUID?.slice(-12)||'—'],
      ['Modality',     (study.Modalities||[]).join(', ')||'—'],
      ['# Series',     (study.Series||[]).length],
      ['Accession',    t.AccessionNumber||'—'],
      ['Referring Dr', t.ReferringPhysicianName||'—'],
      ['Institution',  t.InstitutionName||'—'],
      ['Description',  t.StudyDescription||'—'],
    ];
    content.innerHTML = fields.map(([k,v]) => `
      <div style="background:var(--navy3);border-radius:8px;padding:8px 10px">
        <div style="font-size:0.65rem;color:var(--text3);text-transform:uppercase;letter-spacing:0.6px;margin-bottom:2px">${k}</div>
        <div style="font-size:0.8rem;color:var(--text1);font-weight:600;word-break:break-all">${v}</div>
      </div>`).join('');
  }

  // ── OHIF viewer ────────────────────────────────────────────────────────────
  function pacsOpenOhif() {
    if (!_orthancBase) { showToast('⚠️','Not connected','Configure Orthanc first'); return; }
    const url = `${_orthancBase}/app/explorer.html`;
    window.open(url, '_blank');
  }

  function pacsOpenOhifStudy() {
    if (!_pacsCurrentStudy) { showToast('⚠️','No study selected','Select a study first'); return; }
    if (_pacsDemoActive) { showToast('ℹ️','Demo mode','OHIF opens with real Orthanc connection'); return; }
    const url = `${_orthancBase}/app/explorer.html#study?uuid=${_pacsCurrentStudy.ID}`;
    window.open(url, '_blank');
  }

  // ── upload ─────────────────────────────────────────────────────────────────
  async function pacsUploadFiles(event) {
    const files = Array.from(event.target.files);
    if (!files.length) return;
    if (!_orthancBase) { showToast('⚠️','Not connected','Configure Orthanc to upload'); return; }

    const prog    = document.getElementById('pacsUploadProgress');
    const bar     = document.getElementById('pacsUploadBar');
    const msg     = document.getElementById('pacsUploadMsg');
    if (prog) prog.style.display = 'block';

    let done = 0;
    for (const file of files) {
      if (msg) msg.textContent = `Uploading ${file.name} (${done+1}/${files.length})…`;
      try {
        await orthancUploadDicom(file);
        done++;
        if (bar) bar.style.width = `${(done/files.length)*100}%`;
      } catch(e) {
        showToast('❌', `Upload failed: ${file.name}`, e.message);
      }
    }

    setTimeout(() => { if (prog) prog.style.display = 'none'; if (bar) bar.style.width = '0%'; }, 1500);
    showToast('✅', `${done}/${files.length} files uploaded`, 'Refreshing study list…');
    event.target.value = '';
    await orthancRefreshStudies();
  }

  // ── add to consult ─────────────────────────────────────────────────────────
  function pacsAddToConsult() {
    if (!_pacsCurrentStudy) return;
    const t = _pacsCurrentStudy.MainDicomTags || {};
    const summary = `📷 Imaging: ${t.StudyDescription||'Study'} · ${t.PatientName?.replace(/\^/g,' ')||''} · ${(t.StudyDate||'').replace(/(\d{4})(\d{2})(\d{2})/,'$3/$2/$1')}`;
    showView('consult');
    setTimeout(() => {
      const input = document.getElementById('chatInput');
      if (input) { input.value = `Please review this imaging study: ${summary}`; input.focus(); }
    }, 200);
    showToast('📋','Added to Consultation', t.StudyDescription||'Imaging study');
  }

  // ── AI analyze from PACS ───────────────────────────────────────────────────
  async function pacsAiAnalyze() {
    if (!_pacsCurrentStudy) { showToast('⚠️','No study selected','Select a study first'); return; }

    const t          = _pacsCurrentStudy.MainDicomTags || {};
    const patientName = (t.PatientName||'Unknown').replace(/\^/g,' ');
    const studyDesc  = t.StudyDescription || 'Medical Image';
    const studyDate  = (t.StudyDate||'').replace(/(\d{4})(\d{2})(\d{2})/,'$3/$2/$1');
    const modality   = (_pacsCurrentStudy.Modalities||[]).join(', ') || 'Unknown';

    // Get current instance ID
    const instanceId = _pacsInstances[_pacsFrameIdx];
    if (!instanceId && !_pacsDemoActive) {
      showToast('⚠️','No image loaded','Select a series first'); return;
    }

    // Show analyzing state in the viewer area
    const metaPanel = document.getElementById('pacsMetaPanel');
    const prevMeta  = metaPanel ? metaPanel.innerHTML : '';
    if (metaPanel) {
      metaPanel.style.display = 'block';
      metaPanel.innerHTML = `
        <div style="display:flex;align-items:center;gap:14px;padding:8px 0">
          <div class="pulse-ring" style="width:20px;height:20px;flex-shrink:0"></div>
          <div>
            <div style="font-size:0.88rem;font-weight:700;color:var(--teal)">🤖 AI Analyzing Image…</div>
            <div style="font-size:0.75rem;color:var(--text3);margin-top:2px">Fetching DICOM → sending to Claude AI</div>
          </div>
        </div>`;
    }

    try {
      // ── Step 1: fetch the image as base64 via proxy ──
      let b64data, mimeType = 'image/jpeg';

      if (_pacsDemoActive) {
        // Demo: fetch a public chest X-ray and convert to base64
        const demoUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/96/CXR_NIH_PA_Chest.jpg/600px-CXR_NIH_PA_Chest.jpg';
        const r = await fetch(demoUrl);
        const buf = await r.arrayBuffer();
        b64data = btoa(String.fromCharCode(...new Uint8Array(buf)));
        mimeType = 'image/jpeg';
      } else {
        // Real Orthanc: fetch preview via proxy (returns base64 encoded binary)
        const proxyUrl = `${PROXY}?path=${encodeURIComponent(`/instances/${instanceId}/preview`)}&binary=1`;
        const r = await fetch(proxyUrl);
        if (!r.ok) throw new Error(`Image fetch failed: ${r.status}`);
        const blob = await r.blob();
        mimeType = blob.type || 'image/jpeg';
        b64data = await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload  = () => res(reader.result.split(',')[1]);
          reader.onerror = rej;
          reader.readAsDataURL(blob);
        });
      }

      // ── Step 2: build Claude API prompt ──
      await _loadConfig();
      const apiKey = getApiKey();
      if (!apiKey) throw new Error('AI not ready — check API key');

      const systemPrompt = `You are Samarthaa, a senior AI radiologist and clinical decision-support assistant for Indian doctors.
Patient: ${patientName}
Study: ${studyDesc} | Modality: ${modality} | Date: ${studyDate}
Follow ICMR 2024, AERB, and WHO SEARO imaging guidelines.`;

      const userContent = [
        { type: 'image', source: { type: 'base64', media_type: mimeType, data: b64data } },
        { type: 'text', text: `Analyse this ${modality} image for ${patientName}.

Return a JSON object ONLY (no markdown, no text outside JSON):
{
  "modality": "${modality}",
  "urgency": "routine|urgent|critical",
  "quality": "Adequate|Limited|Non-diagnostic",
  "findings": [
    { "label": "Finding name", "detail": "Description", "level": "high|med|low" }
  ],
  "impression": "One-sentence radiological impression",
  "recommendation": "Clinical action recommended",
  "guidelines": "Relevant guideline referenced"
}` }
      ];

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'content-type': 'application/json',
          'anthropic-dangerous-direct-browser-access': 'true',
        },
        body: JSON.stringify({
          model: 'claude-opus-4-5',
          max_tokens: 1024,
          system: systemPrompt,
          messages: [{ role: 'user', content: userContent }],
        }),
      });

      if (!response.ok) throw new Error(`Claude API ${response.status}`);
      const result = await response.json();
      const raw    = result.content?.[0]?.text || '';
      const clean  = raw.replace(/^```(?:json)?\s*/i,'').replace(/\s*```$/,'').trim();
      const data   = JSON.parse(clean);

      // ── Step 3: render results in the meta panel ──
      const urgColor = data.urgency === 'critical' ? 'var(--red)' : data.urgency === 'urgent' ? 'var(--gold)' : 'var(--teal)';
      const urgIcon  = data.urgency === 'critical' ? '🚨' : data.urgency === 'urgent' ? '⚠️' : '✅';
      const levelMap = { high:'#EF4444', med:'#F59E0B', low:'#10B981' };

      if (metaPanel) {
        metaPanel.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap;gap:8px">
            <div>
              <div style="font-size:0.78rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px">🤖 AI Radiology Analysis</div>
              <div style="font-size:0.75rem;color:var(--text3);margin-top:2px">${patientName} · ${studyDesc} · ${studyDate}</div>
            </div>
            <div style="display:flex;gap:8px">
              <span style="background:var(--navy3);border:1px solid ${urgColor};color:${urgColor};font-size:0.72rem;padding:3px 10px;border-radius:20px;font-weight:600">${urgIcon} ${(data.urgency||'routine').toUpperCase()}</span>
              <button class="btn btn-ghost btn-sm" onclick="pacsAddToConsult()">📋 Add to Consult</button>
            </div>
          </div>

          <div style="background:var(--navy3);border-left:3px solid ${urgColor};border-radius:8px;padding:10px 14px;margin-bottom:12px">
            <div style="font-size:0.78rem;font-weight:700;color:var(--text2);margin-bottom:4px">Impression</div>
            <div style="font-size:0.85rem;color:var(--text1)">${data.impression||'—'}</div>
          </div>

          <div style="font-size:0.75rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Findings</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">
            ${(data.findings||[]).map(f => `
              <div style="display:flex;align-items:flex-start;gap:10px;background:var(--navy3);border-radius:8px;padding:8px 10px">
                <span style="width:8px;height:8px;border-radius:50%;background:${levelMap[f.level]||'#10B981'};flex-shrink:0;margin-top:5px"></span>
                <div>
                  <div style="font-size:0.8rem;font-weight:600;color:var(--text1)">${f.label||''}</div>
                  <div style="font-size:0.75rem;color:var(--text2);margin-top:2px">${f.detail||''}</div>
                </div>
              </div>`).join('')}
          </div>

          <div style="background:var(--teal-dim);border:1px solid rgba(0,212,180,0.2);border-radius:8px;padding:10px 14px;margin-bottom:10px">
            <div style="font-size:0.75rem;font-weight:700;color:var(--teal);margin-bottom:4px">Recommendation</div>
            <div style="font-size:0.82rem;color:var(--text1)">${data.recommendation||'—'}</div>
          </div>

          ${data.guidelines ? `<div style="font-size:0.72rem;color:var(--text3)">📋 ${data.guidelines}</div>` : ''}

          <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">
            <button class="btn btn-primary btn-sm" onclick="pacsSendAnalysisToChat(${JSON.stringify(data).replace(/"/g,'&quot;')})">💬 Discuss in Chat</button>
            <button class="btn btn-ghost btn-sm" onclick="pacsOpenOhifStudy()">🖥 OHIF Viewer</button>
          </div>`;
      }

      showToast('✅','Analysis Complete', data.urgency === 'critical' ? '🚨 Critical finding!' : data.impression?.slice(0,50)||'Done');

    } catch(e) {
      console.error('[pacsAiAnalyze]', e);
      if (metaPanel) metaPanel.innerHTML = prevMeta;
      showToast('❌','Analysis failed', e.message);
    }
  }

  function pacsSendAnalysisToChat(data) {
    const t = _pacsCurrentStudy?.MainDicomTags || {};
    const name = (t.PatientName||'Patient').replace(/\^/g,' ');
    const text = `Imaging AI Result for ${name} — ${t.StudyDescription||'Study'}:

Impression: ${data.impression||'—'}
Urgency: ${data.urgency||'routine'}
Recommendation: ${data.recommendation||'—'}

Findings:
${(data.findings||[]).map(f=>`• ${f.label}: ${f.detail}`).join('\n')}

Please provide clinical guidance on management.`;
    showView('consult');
    setTimeout(() => {
      const input = document.getElementById('chatInput');
      if (input) { input.value = text; input.focus(); }
    }, 200);
  }

  // ── demo mode ──────────────────────────────────────────────────────────────
  function pacsDemoMode() {
    _pacsDemoActive = true;
    const sub = document.getElementById('pacsSubtitle');
    if (sub) sub.textContent = '🎭 Demo mode — sample studies (no real PACS connected)';
    const notConn = document.getElementById('pacsNotConnected');
    const main    = document.getElementById('pacsMain');
    if (notConn) notConn.style.display = 'none';
    if (main)    main.style.display    = 'block';
    _pacsStudies = PACS_DEMO_STUDIES;
    pacsRenderStudyList(PACS_DEMO_STUDIES);
    const ct = document.getElementById('pacsStudyCount');
    if (ct) ct.textContent = `${PACS_DEMO_STUDIES.length} studies (demo)`;
    showToast('🎭','Demo mode active','Showing sample studies — connect Orthanc for real DICOM');
  }

</script>
</body>
</html>
